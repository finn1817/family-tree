<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-badge {
            background: #e74c3c;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .requests-badge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            font-weight: bold;
            min-width: 1.2rem;
            text-align: center;
            display: inline-block;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #f8f9ff;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            border-bottom-color: #4a5fd8;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .upcoming-birthdays {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .birthday-item:last-child {
            border-bottom: none;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 250px;
        }
        
        .filter-select {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .family-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .family-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .family-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .family-info div {
            padding: 0.25rem 0;
        }
        
        .family-info strong {
            color: #333;
        }
        
        /* Modern Family Groups Redesign */
        .family-groups-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }
        
        .family-groups-header h2 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .family-groups-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .family-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }
        
        .view-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .view-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
        }
        
        .view-btn .icon {
            font-size: 1.1rem;
        }
        
        /* Enhanced Family Tree Cards */
        .family-tree-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .modern-family-card {
            background: white;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .modern-family-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.12);
        }
        
        .family-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .family-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }
        
        .family-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0.25rem 0 0 0;
        }
        
        .family-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        
        .family-body {
            padding: 1.5rem;
        }
        
        .generation-section {
            margin-bottom: 1.5rem;
        }
        
        .generation-section:last-child {
            margin-bottom: 0;
        }
        
        .generation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .generation-icon {
            font-size: 1.2rem;
        }
        
        .generation-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .generation-count {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        
        .member-pill {
            background: #f8f9ff;
            border: 1px solid #e8ecff;
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .member-pill:hover {
            background: #667eea;
            color: white;
            transform: scale(1.02);
        }
        
        .member-name {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
            line-height: 1.2;
        }
        
        .member-age {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.3);
            padding: 0.15rem 0.4rem;
            border-radius: 0.3rem;
            margin-top: 0.25rem;
            display: inline-block;
        }
        
        .family-actions {
            padding: 1rem 1.5rem;
            background: #f8f9ff;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 0.75rem;
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .action-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .action-btn.secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }
        
        .action-btn.secondary:hover {
            background: #667eea;
            color: white;
        }
        
        /* Small View Enhanced */
        .small-view-modern {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .small-family-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .small-family-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .small-family-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.15);
        }
        
        .small-family-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #667eea;
        }
        
        .small-family-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .small-family-stats {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .small-stat {
            text-align: center;
        }
        
        .small-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .small-stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        /* Mobile Responsiveness for New Design */
        @media (max-width: 768px) {
            .family-groups-header {
                padding: 1.5rem;
            }
            
            .family-groups-header h2 {
                font-size: 1.8rem;
            }
            
            .family-tree-grid {
                grid-template-columns: 1fr;
            }
            
            .view-controls {
                gap: 0.5rem;
            }
            
            .view-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .members-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .small-view-modern {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Branch View Modal Specific Styles */
        #branchViewModal .modal-content {
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #branchMembersGrid {
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1rem;
        }

        #branchMembersGrid .family-card {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }

        #branchMembersGrid .family-card:hover {
            border-left-color: #20c997;
            transform: translateX(5px);
        }

        #branchSearchInput {
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        #branchSearchInput:focus {
            outline: none;
            border-color: #28a745;
            background: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        /* Management Modal Styles */
        .manage-tab-content {
            min-height: 300px;
        }

        #manageBranchModal .tab {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 0.25rem;
            font-size: 0.9rem;
        }

        #manageBranchModal .tab.active {
            background: white;
            border-bottom: 2px solid #007bff;
        }

        #moveCandidates input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Image Upload Styling */
        .form-group input[type="file"] {
            border: 2px dashed #667eea !important;
            background: #f8f9ff !important;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .form-group input[type="file"]:hover {
            border-color: #5a6fd8 !important;
            background: #eef1ff !important;
        }
        
        .form-group input[type="file"]:focus {
            outline: none;
            border-color: #4a5fd8 !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Image Modal Styling */
        #imageModal .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        #imageModal {
            background: rgba(0, 0, 0, 0.8);
        }
        
        /* Message Images */
        .message img {
            transition: transform 0.3s ease;
        }
        
        .message img:hover {
            transform: scale(1.02);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .message-board {
            background: #f8f9ff;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .message {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-author {
            font-weight: 600;
            color: #667eea;
        }
        
        .message-date {
            font-size: 0.8rem;
            color: #666;
        }

        /* Social Media Style Message Board */
        .social-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }

        .social-header h2 {
            color: white !important;
        }

        .message-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 2rem;
            background: white;
            border-radius: 10px;
            padding: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #666;
        }

        .message-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-count {
            background: rgba(255,255,255,0.2);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .message-tab.active .tab-count {
            background: rgba(255,255,255,0.3);
        }

        .message-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
            padding: 0.8rem 1rem;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sort-section {
            display: flex;
            justify-content: flex-end;
        }

        .message-feed {
            min-height: 400px;
        }

        .message {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            border: 1px solid #e0e6ed;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .message:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .message-author {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        .message-date {
            font-size: 0.9rem;
            color: #888;
            font-weight: 500;
        }

        .message-content {
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #333;
        }

        .message-image {
            margin-top: 1rem;
            border-radius: 10px;
            overflow: hidden;
        }

        .message img {
            max-width: 100%;
            height: auto;
            cursor: pointer;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .message img:hover {
            transform: scale(1.02);
        }

        .message-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.8rem;
            border-top: 1px solid #f0f0f0;
        }

        /* Comment System Styles */
        .message-interactions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.8rem 0;
            border-top: 1px solid #f0f0f0;
        }

        .interaction-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .interaction-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .interaction-btn.delete-btn {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .interaction-btn.delete-btn:hover {
            background: #f5c6cb;
        }

        .add-comment-form {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 10px;
            border: 1px solid #e0e6ed;
        }

        .comment-input-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .comment-input-container textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
        }

        .comment-input-container textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .comment-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .comments-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }

        .no-comments {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .comment {
            background: #f8f9ff;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9rem;
        }

        .comment-date {
            font-size: 0.8rem;
            color: #888;
        }

        .comment-content {
            margin-bottom: 0.8rem;
            line-height: 1.5;
            color: #333;
        }

        .comment-actions {
            display: flex;
            gap: 0.5rem;
        }

        .comment-action-btn {
            background: transparent;
            border: none;
            color: #667eea;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .comment-action-btn:hover {
            background: #e9ecef;
        }

        .comment-action-btn.delete-btn {
            color: #dc3545;
        }

        .comment-action-btn.delete-btn:hover {
            background: #f8d7da;
        }

        .reply-form {
            margin-top: 0.8rem;
            padding: 0.8rem;
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
        }

        .reply-input-container {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .reply-input-container textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 50px;
        }

        .reply-input-container textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .reply-actions {
            display: flex;
            gap: 0.4rem;
            justify-content: flex-end;
        }

        .replies-section {
            margin-top: 1rem;
            margin-left: 1.5rem;
            border-left: 3px solid #e0e6ed;
            padding-left: 1rem;
        }

        .reply {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .reply-author {
            font-weight: 600;
            color: #667eea;
            font-size: 0.85rem;
        }

        .reply-date {
            font-size: 0.75rem;
            color: #888;
        }

        .reply-content {
            line-height: 1.4;
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .reply-actions {
            display: flex;
            justify-content: flex-end;
        }

        /* Hidden Comment Styles */
        .comment-hidden {
            opacity: 0.6;
            background: #f8f9fa !important;
            border: 1px dashed #dee2e6 !important;
        }

        .reply-hidden {
            opacity: 0.6;
            background: #f1f3f4 !important;
            border: 1px dashed #dee2e6 !important;
        }

        .hidden-indicator {
            background: #fff3cd;
            color: #856404;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            text-align: center;
            border: 1px solid #ffeaa7;
        }

        .moderate-btn {
            background: #fff3cd !important;
            border-color: #ffeaa7 !important;
            color: #856404 !important;
        }

        .moderate-btn:hover {
            background: #ffeaa7 !important;
            color: #6c5300 !important;
        }

        /* Responsive design for comments */
        @media (max-width: 768px) {
            .message-interactions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .interaction-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            .replies-section {
                margin-left: 0.8rem;
                padding-left: 0.8rem;
            }
            
            .comment-actions,
            .reply-actions {
                flex-wrap: wrap;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .message-controls {
                padding: 1rem;
            }
            
            .search-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .social-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .message-tab {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
        }
        
        /* New Relationship System Styles */
        .relationship-section {
            display: none;
        }
        
        .relationship-section.active {
            display: block;
        }
        
        .relationship-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .relationship-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            background: #f8f9fa;
        }
        
        .relationship-tab:hover {
            background: #e9ecef;
        }
        
        .relationship-tab.active {
            background: #28a745;
            color: white;
            border-bottom-color: #20c997;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .family-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Desktop tab text - show full text */
        .tab-text {
            display: inline;
        }
        .tab-text-mobile {
            display: none;
        }

        /* Enhanced Mobile and iOS Optimization Styles */
        @media screen and (max-width: 768px) {
            /* Navigation improvements for mobile - FIXED FOR IPHONE */
            .tabs {
                flex-wrap: wrap;
                border-radius: 15px;
                margin-bottom: 15px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .tab {
                flex: 1;
                min-width: 0; /* Allow shrinking */
                padding: 8px 4px;
                font-size: 11px;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
                line-height: 1.2;
            }
            
            .tab:hover {
                background: #f8f9ff;
            }
            
            .tab.active {
                background: #667eea;
                color: white;
                border-bottom-color: #4a5fd8;
            }
            
            /* Make tabs even smaller on very narrow screens */
            @media screen and (max-width: 375px) {
                .tab {
                    padding: 6px 2px;
                    font-size: 10px;
                    min-height: 40px;
                }
            }
            
            /* Show mobile text, hide desktop text */
            .tab-text {
                display: none;
            }
            .tab-text-mobile {
                display: inline;
            }
            
            /* Container and layout adjustments */
            .container-fluid {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .row {
                margin-left: -5px;
                margin-right: -5px;
            }
            
            .col-md-6, .col-md-4, .col-md-8, .col-12 {
                padding-left: 5px;
                padding-right: 5px;
            }
            
            /* Family member cards for mobile */
            .family-member-card {
                margin-bottom: 12px;
                font-size: 14px;
                padding: 12px;
            }
            
            .family-member-card h5 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .family-member-card p {
                margin-bottom: 4px;
                font-size: 13px;
            }
            
            /* Button improvements for touch */
            .btn {
                min-height: 44px;
                margin-bottom: 8px;
                font-size: 14px;
                padding: 10px 15px;
                border-radius: 8px;
            }
            
            .btn-sm {
                min-height: 36px;
                font-size: 13px;
                padding: 8px 12px;
            }
            
            /* Form improvements for mobile */
            .form-control {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px 12px;
                border-radius: 8px;
            }
            
            .form-control-sm {
                min-height: 36px;
                font-size: 14px;
                padding: 8px 10px;
            }
            
            /* Modal improvements for mobile */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .modal-content {
                border-radius: 12px;
                border: none;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }
            
            .modal-header {
                padding: 15px 20px;
                border-bottom: 1px solid #e9ecef;
            }
            
            .modal-body {
                padding: 20px;
                max-height: calc(100vh - 200px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .modal-footer {
                padding: 15px 20px;
                border-top: 1px solid #e9ecef;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .modal-footer .btn {
                margin: 0;
                flex: 1;
                min-width: 120px;
            }
            
            /* Family tree improvements for mobile */
            .family-tree-container {
                padding: 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .generation {
                margin-bottom: 20px;
            }
            
            .generation h4 {
                font-size: 16px;
                margin-bottom: 10px;
                padding: 8px 12px;
                background: #f8f9fa;
                border-radius: 6px;
            }
            
            .member-card {
                margin-bottom: 10px;
                padding: 12px;
                font-size: 13px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* Small view optimizations */
            .small-view-container {
                padding: 8px;
            }
            
            .family-group-card {
                margin-bottom: 10px;
                padding: 12px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .family-group-header {
                font-size: 15px;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .member-count {
                font-size: 12px;
                opacity: 0.8;
            }
            
            /* Search and filter improvements */
            .search-container {
                margin-bottom: 15px;
            }
            
            .search-container input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            /* Table improvements for mobile */
            .table-responsive {
                border: none;
                font-size: 13px;
                border-radius: 8px;
                overflow: hidden;
            }
            
            .table td, .table th {
                padding: 10px 8px;
                vertical-align: middle;
                font-size: 13px;
            }
            
            .table th {
                background-color: #f8f9fa;
                font-weight: 600;
            }
            
            /* Checkbox and radio improvements */
            .form-check-input {
                width: 20px;
                height: 20px;
                margin-top: 2px;
            }
            
            .form-check-label {
                font-size: 14px;
                margin-left: 8px;
                line-height: 1.4;
            }
            
            /* Badge and alert improvements */
            .badge {
                font-size: 11px;
                padding: 4px 8px;
                border-radius: 12px;
            }
            
            .alert {
                margin-bottom: 15px;
                padding: 12px;
                font-size: 14px;
                border-radius: 8px;
            }
            
            /* Loading indicators */
            .spinner-border-sm {
                width: 1.2rem;
                height: 1.2rem;
            }
            
            /* Prevent zoom on input focus for iOS */
            input[type="text"], input[type="email"], input[type="password"], 
            input[type="number"], input[type="tel"], input[type="url"], 
            textarea, select {
                font-size: 16px !important;
                -webkit-appearance: none;
            }
            
            /* Touch-friendly dropdown improvements */
            .dropdown-menu {
                font-size: 14px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: none;
            }
            
            .dropdown-item {
                padding: 12px 16px;
                font-size: 14px;
                line-height: 1.4;
            }
            
            .dropdown-item:hover, .dropdown-item:focus {
                background-color: #f8f9fa;
            }
            
            /* Header improvements for mobile */
            .header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 18px;
                margin: 0;
            }
            
            .user-info {
                flex-direction: row;
                justify-content: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            
            .admin-badge {
                font-size: 10px;
                padding: 2px 6px;
            }
            
            .requests-badge {
                font-size: 10px;
                min-width: 16px;
                padding: 2px 4px;
            }
            
            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            /* Improved spacing for mobile layout */
            .mb-3 {
                margin-bottom: 15px !important;
            }
            
            .mt-3 {
                margin-top: 15px !important;
            }
            
            .p-3 {
                padding: 15px !important;
            }
            
            /* Tab content improvements */
            .tab-content {
                padding: 15px 0;
            }
            
            .tab-pane {
                min-height: 200px;
            }
        }
        
        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .form-control, .btn {
                -webkit-appearance: none;
                border-radius: 8px;
            }
            
            .modal-content {
                -webkit-transform: translate3d(0,0,0);
            }
            
            /* Fix iOS scroll issues */
            .modal-body {
                -webkit-overflow-scrolling: touch;
                overflow-y: scroll;
            }
        }
        
        /* Landscape orientation adjustments for mobile */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .modal-body {
                max-height: calc(100vh - 140px);
            }
            
            .nav-tabs .nav-link {
                padding: 8px 6px;
                font-size: 12px;
                min-height: 36px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
        
        /* Very small screens (iPhone SE, older devices) */
        @media screen and (max-width: 375px) {
            .container-fluid {
                padding-left: 8px;
                padding-right: 8px;
            }
            
            .btn {
                font-size: 13px;
                padding: 8px 12px;
                min-height: 40px;
            }
            
            .modal-dialog {
                margin: 8px;
                max-width: calc(100% - 16px);
            }
            
            .table td, .table th {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            .nav-tabs .nav-link {
                font-size: 11px;
                padding: 8px 4px;
            }
            
            .family-member-card {
                padding: 10px;
                font-size: 13px;
            }
            
            /* Make tabs even more compact on iPhone SE */
            .tabs {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                display: inline-flex;
                flex: none;
                min-width: 80px;
                padding: 8px 6px;
                font-size: 9px;
                vertical-align: top;
            }
            
            .main-container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }
        }
        
        /* Extra large screens - optimize for desktop */
        @media screen and (min-width: 1200px) {
            .family-tree-container {
                padding: 20px;
            }
            
            .member-card {
                margin-bottom: 15px;
                padding: 15px;
            }
            
            .modal-dialog {
                max-width: 800px;
            }
        }
        
        /* Manual Family Card Styles */
        .member-selection-item {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .member-selection-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .member-selection-item.selected {
            border-color: #27ae60 !important;
            background: #e8f5e8 !important;
        }
        
        .selection-checkbox {
            transition: all 0.3s ease;
        }
        
        .memorial-family-card {
            background: linear-gradient(135deg, #ffe6e6 0%, #fff 50%);
            border: 3px solid #e74c3c;
        }
        
        .memorial-family-card .family-title {
            color: #e74c3c !important;
        }
        
        .memorial-member-pill {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #e74c3c;
        }
        
        .living-member-pill {
            background: #e8f5e8;
            color: #2d5a2d;
            border: 1px solid #b8e6b8;
        }
        
        /* Developer Test Popup Animations */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Virtual Family Group Modal Styles */
        .status-filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #ddd;
            background: white;
            color: #666;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .status-filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }
        
        .status-filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .virtual-person-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }
        
        .virtual-person-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
        }
        
        .virtual-person-item.selected {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        
        .virtual-person-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        
        .virtual-person-info {
            flex: 1;
        }
        
        .virtual-person-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .virtual-person-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .virtual-person-status {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-living {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-deceased {
            background: #ffebee;
            color: #c62828;
        }
        
        .selected-person-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #bbdefb;
        }
        
        .remove-tag {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #f44336;
            font-weight: bold;
        }

        /* Analytics Modal Styles */
        .analytics-modal {
            max-width: 95%;
            width: 1200px;
            max-height: 90vh;
        }

        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px 15px 0 0;
            margin: -2rem -2rem 2rem -2rem;
        }

        .analytics-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }

        .analytics-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .analytics-tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }

        .analytics-content {
            min-height: 400px;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .log-table th,
        .log-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .log-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .log-table tbody {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-action {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .log-action.login { background: #d4edda; color: #155724; }
        .log-action.login-failed { background: #f8d7da; color: #721c24; }
        .log-action.logout { background: #e2e3e5; color: #495057; }
        .log-action.edit { background: #fff3cd; color: #856404; }
        .log-action.add { background: #d1ecf1; color: #0c5460; }
        .log-action.delete { background: #f5c6cb; color: #721c24; }
        .log-action.password-reset-request { background: #fce4ec; color: #c2185b; }
        .log-action.security-questions { background: #e8f5e8; color: #2e7d32; }
        .log-action.clear-logs { background: #fff3e0; color: #f57c00; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card-analytics {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number-analytics {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label-analytics {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Password Management Modal Styles */
        .password-modal {
            max-width: 98vw;
            width: 1600px;
            max-height: 95vh;
            overflow: hidden;
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .password-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .password-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .password-tabs {
            display: flex;
            gap: 0;
            margin: 0;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
            padding: 0 2rem;
        }

        .password-tab {
            padding: 1.2rem 2.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
            color: #6c757d;
            border-radius: 10px 10px 0 0;
            margin-top: 0.5rem;
        }

        .password-tab.active {
            border-bottom-color: #28a745;
            color: #28a745;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .password-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .user-password-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .user-password-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            border-color: #28a745;
        }

        .user-info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-info-section h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .user-info-section p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .password-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .password-hidden {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: #495057;
            border: 1px solid #dee2e6;
            min-width: 120px;
            text-align: center;
            font-weight: 600;
        }

        .password-revealed {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: #856404;
            border: 1px solid #ffeaa7;
            min-width: 120px;
            text-align: center;
            font-weight: 600;
            word-break: break-all;
        }

        .reveal-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .reveal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }

        .change-password-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .change-password-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .reset-request-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
        }

        .reset-request-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        .reset-request-card h4 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .reset-request-card p {
            margin: 0.5rem 0;
            color: #6c757d;
            line-height: 1.5;
        }

        .request-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .approve-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .approve-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .deny-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .deny-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220,53,69,0.3);
        }

        /* Add proper content area styling */
        .password-content {
            padding: 2rem;
            background: white;
            max-height: calc(95vh - 180px);
            overflow-y: auto;
            border-radius: 0 0 15px 15px;
        }

        .password-content::-webkit-scrollbar {
            width: 8px;
        }

        .password-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .password-content::-webkit-scrollbar-thumb {
            background: #28a745;
            border-radius: 4px;
        }

        /* Add responsive grid for password management */
        .password-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Mobile responsiveness for password modal */
        @media (max-width: 768px) {
            .password-modal {
                max-width: 95vw;
                width: 95vw;
                margin: 0;
            }

            .password-header {
                padding: 1.5rem;
            }

            .password-header h2 {
                font-size: 1.4rem;
            }

            .password-tabs {
                padding: 0 1.5rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .password-tab {
                padding: 1rem;
                text-align: center;
                border-radius: 8px;
                margin-top: 0;
            }

            .password-content {
                padding: 1.5rem;
            }

            .password-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .user-password-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .password-section {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Large screen optimizations */
        @media (min-width: 1400px) {
            .password-modal {
                max-width: 90vw;
                width: 1800px;
            }

            .password-grid {
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 2rem;
            }

            .password-content {
                padding: 2.5rem;
            }
        }

        /* Security Questions Modal Styles */
        .security-modal {
            max-width: 95vw;
            width: 1000px;
            max-height: 95vh;
            overflow: hidden;
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .security-header {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .security-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .security-content {
            padding: 2rem;
            background: white;
            max-height: calc(95vh - 140px);
            overflow-y: auto;
            border-radius: 0 0 15px 15px;
        }

        .security-content::-webkit-scrollbar {
            width: 8px;
        }

        .security-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .security-content::-webkit-scrollbar-thumb {
            background: #6f42c1;
            border-radius: 4px;
        }

        .security-content::-webkit-scrollbar-thumb:hover {
            background: #5a32a3;
            position: relative;
        }

        #securityQuestionsModal {
            z-index: 10001 !important;
        }

        #securityQuestionsModal .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            max-height: 90vh;
            overflow-y: auto;
        }

        .question-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #6f42c1;
            transition: all 0.3s;
        }

        .question-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            border-left-color: #5a32a3;
        }

        .question-item h4 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-input, .answer-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .question-input:focus, .answer-input:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
        }

        .remove-question-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .remove-question-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220,53,69,0.3);
        }

        .user-dropdown {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1> Family Tree Dashboard</h1>
        <div class="user-info">
            <span id="username"></span>
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-container">
        <div class="upcoming-birthdays">
            <h2> Upcoming Birthdays</h2>
            <div id="upcomingBirthdays"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('family')">
                <span class="tab-text"> Family Members</span>
                <span class="tab-text-mobile"> Family</span>
            </div>
            <div class="tab" onclick="switchTab('branches')">
                <span class="tab-text"> Family Groups</span>
                <span class="tab-text-mobile"> Groups</span>
            </div>
            <div class="tab" onclick="switchTab('messages')">
                <span class="tab-text"> Message Board</span>
                <span class="tab-text-mobile"> Messages</span>
            </div>
            <div class="tab admin-only" onclick="switchTab('users')" style="display: none;">
                <span class="tab-text"> Manage Users</span>
                <span class="tab-text-mobile"> Users</span>
            </div>
            <div class="tab admin-only" onclick="switchTab('requests')" style="display: none;">
                <span class="tab-text"> Account Requests <span id="requestsBadge" class="requests-badge" style="display: none;">0</span></span>
                <span class="tab-text-mobile"> Requests <span id="requestsBadgeMobile" class="requests-badge" style="display: none;">0</span></span>
            </div>
            <div class="tab developer-only" onclick="switchTab('hidden')" style="display: none;">
                <span class="tab-text"> Hidden Families <span id="hiddenBadge" class="requests-badge" style="display: none;">0</span></span>
                <span class="tab-text-mobile"> Hidden <span id="hiddenBadgeMobile" class="requests-badge" style="display: none;">0</span></span>
            </div>
        </div>

        <div class="tab-content">
            <!-- Family Members Section -->
            <div id="family" class="section active">
                <div class="controls">
                    <div class="search-controls">
                        <input type="text" class="search-input" placeholder="Search family members..." id="searchInput">
                        <select class="filter-select" id="monthFilter">
                            <option value="">All Months</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                        <select class="filter-select" id="sortOrder">
                            <option value="name">Sort by Name</option>
                            <option value="age-oldest">Sort by Age (Oldest First)</option>
                            <option value="age-youngest">Sort by Age (Youngest First)</option>
                            <option value="birthday">Sort by Upcoming Birthday</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-primary" onclick="openAddMemberModal()">+ Add Family Member</button>
                    </div>
                </div>
                <div id="familyGrid" class="family-grid"></div>
            </div>

            <!-- Family Groups Section -->
            <div id="branches" class="section">
                <div id="branchesGrid"></div>
            </div>

            <!-- Message Board Section -->
            <div id="messages" class="section">
                <!-- Social Media Header -->
                <div class="social-header">
                    <div class="social-header-left">
                        <h2 style="margin: 0; color: #667eea; font-size: 1.8rem;"> Family Message Board</h2>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">Share memories, updates, and stay connected with family</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddMessageModal()" style="margin-left: auto;">
                         Create Post
                    </button>
                </div>

                <!-- Message Board Tabs -->
                <div class="message-tabs">
                    <button class="message-tab active" onclick="switchMessageTab('public')" id="publicTab">
                         Public Feed
                        <span class="tab-count" id="publicCount">0</span>
                    </button>
                    <button class="message-tab" onclick="switchMessageTab('my-posts')" id="myPostsTab">
                         My Posts
                        <span class="tab-count" id="myPostsCount">0</span>
                    </button>
                </div>

                <!-- Search and Filter Controls -->
                <div class="message-controls">
                    <div class="search-section">
                        <input type="text" id="messageSearch" placeholder=" Search posts, authors, or content..." 
                               oninput="filterMessages()" class="search-input" style="flex: 1;">
                        <select id="authorFilter" onchange="filterMessages()" class="filter-select" style="margin-left: 1rem;">
                            <option value=""> All Authors</option>
                        </select>
                    </div>
                    <div class="sort-section">
                        <select id="sortOrder" onchange="filterMessages()" class="filter-select">
                            <option value="newest"> Newest First</option>
                            <option value="oldest"> Oldest First</option>
                            <option value="author"> By Author</option>
                        </select>
                    </div>
                </div>

                <!-- Message Feed -->
                <div class="message-feed" id="messageFeed">
                    <div id="messagesContainer"></div>
                    <div id="noMessagesPlaceholder" style="display: none; text-align: center; padding: 3rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3>No posts found</h3>
                        <p>Be the first to share something with the family!</p>
                    </div>
                </div>
            </div>

            <!-- Users Management Section (Admin Only) -->
            <div id="users" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddUserModal()">+ Add New User</button>
                </div>
                <div id="usersGrid" class="family-grid"></div>
            </div>

            <!-- Account Requests Section (Admin Only) -->
            <div id="requests" class="section">
                <div class="controls">
                    <h2> Account Requests</h2>
                    <div id="requestsStats" style="margin: 1rem 0;"></div>
                </div>
                <div id="requestsGrid" class="family-grid"></div>
            </div>

            <!-- Hidden Families Section (Developer Only - dfinn12) -->
            <div id="hidden" class="section">
                <div class="controls">
                    <h2 style="color: #e74c3c;"> Hidden Families</h2>
                    <p style="color: #666; margin: 1rem 0;">Families hidden from public view. Only you can see and manage them.</p>
                </div>
                <div id="hiddenFamiliesGrid" class="family-tree-grid"></div>
                <div id="noHiddenFamilies" style="display: none; text-align: center; padding: 3rem; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                    <h3 style="color: #667eea; margin-bottom: 1rem;">No Hidden Families</h3>
                    <p style="color: #666;">All family groups are currently visible to everyone.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Member</h2>
            <form id="addMemberForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="birthMonth">Birth Month *</label>
                        <select id="birthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDay">Birth Day *</label>
                        <input type="number" id="birthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="birthYear">Birth Year *</label>
                        <input type="number" id="birthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="familyBranch">Family Branch</label>
                        <select id="familyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="marriedTo"> Married To</label>
                        <select id="marriedTo">
                            <option value="">Select someone</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="parents"> Parents (Select up to 2)</label>
                        <div id="addParentsSelection" style="border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; max-height: 200px; overflow-y: auto; background: #f9f9f9;">
                            <!-- Parents checkboxes will be populated by JavaScript -->
                        </div>
                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                            Selected: <span id="addParentsCount">0</span>/2 parents  Sorted by age (oldest first)
                        </small>
                    </div>
                    <div class="form-group full-width">
                        <label for="children"> Children (Select up to 15)</label>
                        <div id="addChildrenSelection" style="border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; max-height: 200px; overflow-y: auto; background: #f9f9f9;">
                            <!-- Children checkboxes will be populated by JavaScript -->
                        </div>
                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                            Selected: <span id="addChildrenCount">0</span>/15 children  Sorted by age (youngest first)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="mobilePhone">Mobile Phone</label>
                        <input type="tel" id="mobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="homePhone">Home Phone</label>
                        <input type="tel" id="homePhone">
                    </div>
                    <div class="form-group">
                        <label for="workPhone">Work Phone</label>
                        <input type="tel" id="workPhone">
                    </div>
                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" id="state">
                    </div>
                    <div class="form-group">
                        <label for="zipCode">Zip Code</label>
                        <input type="text" id="zipCode">
                    </div>
                    <div class="form-group">
                        <label for="anniversaryDate">Anniversary Date</label>
                        <input type="date" id="anniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h2>Edit Family Member</h2>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFirstName">First Name *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name *</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthMonth">Birth Month *</label>
                        <select id="editBirthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBirthDay">Birth Day *</label>
                        <input type="number" id="editBirthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthYear">Birth Year *</label>
                        <input type="number" id="editBirthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="editFamilyBranch">Family Branch</label>
                        <select id="editFamilyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMarriedTo"> Currently Married To</label>
                        <select id="editMarriedTo">
                            <option value="">Select someone</option>
                        </select>
                    </div>
                    
                    <!-- Marriage History Section -->
                    <div class="form-group full-width">
                        <label> Marriage History</label>
                        <div id="editMarriageHistoryContainer" style="border: 1px solid #ddd; padding: 1rem; border-radius: 8px; background: #f9f9f9;">
                            <div id="editMarriageHistoryEntries"></div>
                            <button type="button" onclick="addEditMarriageHistoryEntry()" style="background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-top: 0.5rem;">
                                 Add Marriage History Entry
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editMobilePhone">Mobile Phone</label>
                        <input type="tel" id="editMobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="editHomePhone">Home Phone</label>
                        <input type="tel" id="editHomePhone">
                    </div>
                    <div class="form-group">
                        <label for="editWorkPhone">Work Phone</label>
                        <input type="tel" id="editWorkPhone">
                    </div>
                    <div class="form-group">
                        <label for="editAddress">Street Address</label>
                        <input type="text" id="editAddress">
                    </div>
                    <div class="form-group">
                        <label for="editCity">City</label>
                        <input type="text" id="editCity">
                    </div>
                    <div class="form-group">
                        <label for="editState">State</label>
                        <input type="text" id="editState">
                    </div>
                    <div class="form-group">
                        <label for="editZipCode">Zip Code</label>
                        <input type="text" id="editZipCode">
                    </div>
                    <div class="form-group">
                        <label for="editAnniversaryDate">Anniversary Date</label>
                        <input type="date" id="editAnniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('editMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Branch Modal -->
    <div id="addBranchModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Branch</h2>
            <form id="addBranchForm">
                <div class="form-group">
                    <label for="branchName">Branch Name *</label>
                    <input type="text" id="branchName" required placeholder="e.g., Finn - Danny's Nuclear Family">
                </div>
                <div class="form-group">
                    <label for="branchDescription">Description</label>
                    <textarea id="branchDescription" placeholder="Description of this family branch"></textarea>
                </div>
                <div class="form-group">
                    <label for="generationLevel">Generation Level *</label>
                    <select id="generationLevel" required>
                        <option value="">Select Generation</option>
                        <option value="1"> Grandparents (Generation 1)</option>
                        <option value="2"> Parents (Generation 2)</option>
                        <option value="3"> Children (Generation 3)</option>
                        <option value="4"> Grandchildren (Generation 4)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="branchType">Branch Type *</label>
                    <select id="branchType" required>
                        <option value="">Select Type</option>
                        <option value="nuclear_family"> Nuclear Family (Parents + Children)</option>
                        <option value="extended_family"> Extended Family (Multiple Generations)</option>
                        <option value="cousin_branch"> Cousin Branch (Same Generation)</option>
                        <option value="grandparent_branch"> Grandparent Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parentBranch">Parent Branch (Optional)</label>
                    <select id="parentBranch">
                        <option value="">No Parent Branch</option>
                    </select>
                </div>
                <div id="smartSuggestions" style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; display: none;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;"> Smart Suggestions:</h4>
                    <div id="suggestionsList"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addBranchModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Branch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Family Unit Modal -->
    <div id="createFamilyUnitModal" class="modal">
        <div class="modal-content">
            <h2>Create Family Unit</h2>
            <form id="createFamilyUnitForm">
                <div class="form-group">
                    <label for="unitName">Family Unit Name *</label>
                    <input type="text" id="unitName" required placeholder="e.g., The Finn Family, Smith Extended Family">
                </div>
                <div class="form-group">
                    <label for="unitDescription">Description</label>
                    <textarea id="unitDescription" placeholder="Description of this family unit"></textarea>
                </div>
                <div class="form-group">
                    <label for="unitType">Unit Type *</label>
                    <select id="unitType" required>
                        <option value="">Select Type</option>
                        <option value="nuclear">Nuclear Family (Parents + Children)</option>
                        <option value="extended">Extended Family (Multiple Generations)</option>
                        <option value="ancestral">Ancestral Line (Historical Family Tree)</option>
                        <option value="mixed">Mixed Family (Blended/Complex)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Branches to Include:</label>
                    <div id="branchCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                        <!-- Will be populated with available branches -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('createFamilyUnitModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Family Unit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal (Admin Only) -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Add New User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUsername">Username * (min 5 characters)</label>
                    <input type="text" id="newUsername" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password * (min 5 characters)</label>
                    <input type="password" id="newPassword" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="userPhone">Phone</label>
                    <input type="tel" id="userPhone">
                </div>
                <div class="form-group">
                    <label for="isAdmin">Admin Status</label>
                    <select id="isAdmin">
                        <option value="0">Regular User</option>
                        <option value="1">Administrator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Message Modal -->
    <div id="addMessageModal" class="modal">
        <div class="modal-content">
            <h2> Post Message</h2>
            <form id="addMessageForm">
                <div class="form-group">
                    <label for="messageTitle">Title</label>
                    <input type="text" id="messageTitle" placeholder="Message title (optional)">
                </div>
                <div class="form-group">
                    <label for="messageContent">Message *</label>
                    <textarea id="messageContent" required placeholder="Write your message here..."></textarea>
                </div>
                <div class="form-group">
                    <label for="messageImage"> Add Photo (Optional)</label>
                    <input type="file" id="messageImage" accept="image/*" style="
                        padding: 0.5rem;
                        border: 2px dashed #667eea;
                        border-radius: 8px;
                        background: #f8f9ff;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                    <small style="color: #666; font-size: 0.8rem; display: block; margin-top: 0.5rem;">
                         Supports JPEG, PNG, GIF  Max 5MB  Images will be compressed automatically
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMessageModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Post Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Branch View Modal -->
    <div id="branchViewModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="branchViewTitle">Branch Members</h2>
                <button class="btn" onclick="closeModal('branchViewModal')" style="background: #6c757d; color: white;"> Close</button>
            </div>
            
            <div id="branchStats" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: white;" id="branchStatsName">Branch Name</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;" id="branchStatsCount">0 family members</p>
                    </div>
                    <div style="font-size: 3rem; opacity: 0.7;"></div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <input type="text" id="branchSearchInput" placeholder="Search branch members..." style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
            </div>

            <div id="branchMembersGrid" class="family-grid" style="max-height: 70vh; overflow-y: auto;"></div>
            
            <div id="noBranchMembers" style="display: none; text-align: center; padding: 2rem; color: #6c757d;">
                <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                <h3>No family members in this branch yet</h3>
                <p>Add family members and assign them to this branch to see them here.</p>
            </div>
        </div>
    </div>

    <!-- Manage Branch Modal -->
    <div id="manageBranchModal" class="modal">
        <div class="modal-content" style="max-width: 80%; width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="manageBranchTitle">Manage Branch</h2>
                <button class="btn" onclick="closeModal('manageBranchModal')" style="background: #6c757d; color: white;"> Close</button>
            </div>
            
            <div class="tabs" style="margin-bottom: 1rem;">
                <div class="tab active" onclick="switchManageTab('moveMembers')"> Move Members</div>
                <div class="tab" onclick="switchManageTab('shareMembers')"> Share Members</div>
                <div class="tab" onclick="switchManageTab('suggestions')"> Smart Suggestions</div>
            </div>

            <!-- Move Members Tab -->
            <div id="moveMembers" class="manage-tab-content active">
                <h4>Move Members to This Branch</h4>
                <p>Select family members from other branches to move to this branch:</p>
                
                <div style="margin-bottom: 1rem;">
                    <label for="sourceBranch">From Branch:</label>
                    <select id="sourceBranch" onchange="loadMoveCandidates()" style="margin-left: 0.5rem; padding: 0.5rem;">
                        <option value="">Select source branch</option>
                    </select>
                </div>
                
                <div id="moveCandidates" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <p style="text-align: center; color: #666;">Select a source branch to see members</p>
                </div>
                
                <button id="moveSelectedBtn" class="btn btn-primary" onclick="moveSelectedMembers()" style="margin-top: 1rem; display: none;">
                    Move Selected Members
                </button>
            </div>

            <!-- Share Members Tab -->
            <div id="shareMembers" class="manage-tab-content" style="display: none;">
                <h4>Share Members with Other Branches</h4>
                <p>Add members from this branch to appear in other branches (like parents appearing in children's families):</p>
                
                <div id="shareableMembersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated with current branch members -->
                </div>
            </div>

            <!-- Smart Suggestions Tab -->
            <div id="suggestions" class="manage-tab-content" style="display: none;">
                <h4>Smart Organization Suggestions</h4>
                <div id="branchSuggestions">
                    <!-- Will be populated with AI suggestions -->
                </div>
            </div>
        </div>
    </div>

    <!-- Family Detail Modal -->
    <div id="familyDetailModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="familyDetailTitle">Family Details</h2>
                <button class="btn" onclick="closeModal('familyDetailModal')" style="background: #6c757d; color: white;"> Close</button>
            </div>
            
            <div id="familyDetailContent">
                <!-- Family detail content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Manual Family Card Creation Modal -->
    <div id="manualFamilyCardModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: #e74c3c;"> Create Memorial Family Tree</h2>
                <button class="btn" onclick="closeModal('manualFamilyCardModal')" style="background: #6c757d; color: white;"> Close</button>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <p style="margin: 0; color: #856404;">
                    <strong> Memorial Family Trees:</strong> Create special family cards to honor deceased family members and preserve their family connections. 
                    This allows you to document complete family structures without affecting automatic family tree generation.
                </p>
            </div>

            <form id="manualFamilyForm" onsubmit="createManualFamilyCard(event)">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Family Name</label>
                        <input type="text" id="manualFamilyName" placeholder="e.g., Memorial [Family Name]" required>
                    </div>

                    <div class="form-group full-width">
                        <label>Family Description</label>
                        <textarea id="manualFamilyDescription" rows="3" placeholder="Brief description of this memorial family tree..."></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label>Select Family Members</label>
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; max-height: 300px; overflow-y: auto;">
                            <div style="margin-bottom: 1rem;">
                                <input type="text" id="memberSearchInput" placeholder="Search family members..." 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                                       oninput="filterManualFamilyMembers()">
                            </div>
                            <div id="memberSelectionGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem;">
                                <!-- Members will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label>Selected Members Preview</label>
                        <div id="selectedMembersPreview" style="background: #e8f5e8; border: 1px solid #b8e6b8; border-radius: 8px; padding: 1rem; min-height: 60px;">
                            <p style="color: #666; font-style: italic; margin: 0;">No members selected yet...</p>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="closeModal('manualFamilyCardModal')" class="btn" style="background: #6c757d; color: white;">Cancel</button>
                    <button type="submit" class="btn btn-danger"> Create Memorial Family</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Family Group Modal (Developer Only) -->
    <div id="createFamilyGroupModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 95vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0;">
                <div>
                    <h2 style="margin: 0; color: #667eea; font-size: 1.8rem;"> Create Virtual Family Group</h2>
                    <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 1rem;">Create memorial or alternative family groupings without affecting actual relationship data</p>
                </div>
                <button type="button" onclick="closeModal('createFamilyGroupModal')" style="background: none; border: none; font-size: 2rem; color: #999; cursor: pointer; padding: 0.5rem;"></button>
            </div>
            
            <div style="background: #fff8e1; border: 1px solid #ffcc02; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <span style="font-size: 2rem;"></span>
                    <h3 style="margin: 0; color: #e65100;">Virtual Family Groups</h3>
                </div>
                <p style="margin: 0; color: #bf360c; line-height: 1.5;">
                    <strong>Important:</strong> This creates a separate family view that won't change anyone's actual relationship data. 
                    Perfect for memorial families, alternative arrangements, or "what if" scenarios.
                </p>
            </div>

            <form id="createFamilyGroupForm" onsubmit="createCustomFamilyGroup(event)" style="display: flex; flex-direction: column; gap: 2rem;">
                <!-- Basic Info Section -->
                <div style="background: #f8f9ff; border-radius: 16px; padding: 2rem;">
                    <h3 style="margin: 0 0 1.5rem 0; color: #667eea; display: flex; align-items: center; gap: 0.5rem;">
                        <span></span> Basic Information
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">Group Name *</label>
                            <input type="text" id="virtualGroupName" required 
                                   placeholder="e.g., Uncle Tommy & Aunt Sarah Memorial Family"
                                   style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem; transition: border-color 0.3s;">
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">Group Type</label>
                            <select id="virtualGroupType" style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem;">
                                <option value="memorial">Memorial Family</option>
                                <option value="alternative">Alternative Arrangement</option>
                                <option value="historical">Historical Family</option>
                                <option value="custom">Custom Group</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">Description (Optional)</label>
                        <textarea id="virtualGroupDescription" rows="3" 
                                  placeholder="Brief description of this virtual family group..."
                                  style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Parents Section -->
                <div style="background: #fff3e0; border-radius: 16px; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #f57c00; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Parents/Heads of Family
                        </h3>
                        <span style="background: #ffcc02; color: #333; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                            Virtual Relationship Only
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <input type="text" id="parentSearch" placeholder=" Search parents by name..." 
                               oninput="filterVirtualParents()" 
                               style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem;">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button type="button" onclick="filterParentsByStatus('all')" class="status-filter-btn active" data-status="all">All People</button>
                        <button type="button" onclick="filterParentsByStatus('living')" class="status-filter-btn" data-status="living">Living Only</button>
                        <button type="button" onclick="filterParentsByStatus('deceased')" class="status-filter-btn" data-status="deceased">Deceased Only</button>
                    </div>
                    
                    <div id="virtualParentsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1rem; background: white;">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <div id="selectedParentsPreview" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 12px; display: none;">
                        <strong style="color: #2e7d32;">Selected Parents:</strong>
                        <div id="selectedParentsList" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <!-- Children Section -->
                <div style="background: #f3e5f5; border-radius: 16px; padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #7b1fa2; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Children/Family Members
                        </h3>
                        <span style="background: #ce93d8; color: #fff; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                            Optional
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <input type="text" id="childrenSearch" placeholder=" Search children by name..." 
                               oninput="filterVirtualChildren()" 
                               style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem;">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <button type="button" onclick="filterChildrenByStatus('all')" class="status-filter-btn active" data-status="all">All People</button>
                        <button type="button" onclick="filterChildrenByStatus('living')" class="status-filter-btn" data-status="living">Living Only</button>
                        <button type="button" onclick="filterChildrenByStatus('deceased')" class="status-filter-btn" data-status="deceased">Deceased Only</button>
                    </div>
                    
                    <div id="virtualChildrenList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; padding: 1rem; background: white;">
                        <!-- Populated by JavaScript -->
                    </div>
                    
                    <div id="selectedChildrenPreview" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 12px; display: none;">
                        <strong style="color: #2e7d32;">Selected Children:</strong>
                        <div id="selectedChildrenList" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid #f0f0f0;">
                    <button type="button" onclick="closeModal('createFamilyGroupModal')" 
                            style="padding: 1rem 2rem; background: #f5f5f5; color: #666; border: 2px solid #ddd; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        Cancel
                    </button>
                    
                    <button type="submit" 
                            style="padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                         Create Virtual Family Group
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analytics Modal (Developer Only) -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content analytics-modal">
            <div class="analytics-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.8rem;"> System Analytics</h2>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Comprehensive logging and analytics dashboard</p>
                    </div>
                    <button type="button" onclick="closeModal('analyticsModal')" style="background: none; border: none; font-size: 2rem; color: rgba(255,255,255,0.8); cursor: pointer; padding: 0.5rem;"></button>
                </div>
            </div>

            <div class="analytics-tabs">
                <button class="analytics-tab active" onclick="switchAnalyticsTab('overview')" data-tab="overview">
                     Overview
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('activity')" data-tab="activity">
                     Activity Logs
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('security')" data-tab="security">
                     Security Events
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('requests')" data-tab="requests">
                     Account Requests
                </button>
                <button class="analytics-tab" onclick="switchAnalyticsTab('users')" data-tab="users">
                     User Activity
                </button>
            </div>

            <div class="analytics-content">
                <!-- Overview Tab -->
                <div id="analytics-overview" class="analytics-tab-content">
                    <div class="stats-grid">
                        <div class="stat-card-analytics">
                            <div class="stat-number-analytics" id="totalLogins">-</div>
                            <div class="stat-label-analytics">Total Logins</div>
                        </div>
                        <div class="stat-card-analytics">
                            <div class="stat-number-analytics" id="failedLogins">-</div>
                            <div class="stat-label-analytics">Failed Logins</div>
                        </div>
                        <div class="stat-card-analytics">
                            <div class="stat-number-analytics" id="totalEdits">-</div>
                            <div class="stat-label-analytics">Total Edits</div>
                        </div>
                        <div class="stat-card-analytics">
                            <div class="stat-number-analytics" id="totalAdditions">-</div>
                            <div class="stat-label-analytics">New Additions</div>
                        </div>
                        <div class="stat-card-analytics">
                            <div class="stat-number-analytics" id="activeDays">-</div>
                            <div class="stat-label-analytics">Active Days</div>
                        </div>
                        <div class="stat-card-analytics">
                            <div class="stat-number-analytics" id="uniqueUsers">-</div>
                            <div class="stat-label-analytics">Unique Users</div>
                        </div>
                    </div>
                    <h3>Recent Activity</h3>
                    <div id="recentActivityOverview"></div>
                </div>

                <!-- Activity Logs Tab -->
                <div id="analytics-activity" class="analytics-tab-content" style="display: none;">
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="activitySearch" placeholder="Search logs..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="activityFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Actions</option>
                            <option value="login">Logins</option>
                            <option value="logout">Logouts</option>
                            <option value="edit">Edits</option>
                            <option value="add">Additions</option>
                            <option value="delete">Deletions</option>
                            <option value="password_reset_request">Password Reset</option>
                            <option value="security_questions">Security Questions</option>
                        </select>
                        <button onclick="refreshActivityLogs()" class="btn btn-primary">Refresh</button>
                        <button onclick="confirmClearAllLogs()" class="btn" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500;"> Clear All Logs</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Status</th>
                                    <th>IP Address</th>
                                    <th>User Agent</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogsBody">
                                <tr><td colspan="8" style="text-align: center; color: #666;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Security Events Tab -->
                <div id="analytics-security" class="analytics-tab-content" style="display: none;">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="securitySearch" placeholder="Search security events..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Event Type</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Browser</th>
                                    <th>OS</th>
                                    <th>Device</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="securityLogsBody">
                                <tr><td colspan="9" style="text-align: center; color: #666;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Account Requests Tab -->
                <div id="analytics-requests" class="analytics-tab-content" style="display: none;">
                    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="requestsSearch" placeholder="Search requests..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <select id="requestsFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Requests</option>
                            <option value="account_request">Account Requests</option>
                            <option value="password_reset">Password Resets</option>
                        </select>
                        <button onclick="refreshRequestsLogs()" class="btn btn-primary">Refresh</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Username</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>IP Address</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="requestsLogsBody">
                                <tr><td colspan="6" style="text-align: center; color: #666;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Activity Tab -->
                <div id="analytics-users" class="analytics-tab-content" style="display: none;">
                    <div style="margin-bottom: 1rem;">
                        <select id="userActivityFilter" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Users</option>
                        </select>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Last Login</th>
                                    <th>Total Logins</th>
                                    <th>Total Actions</th>
                                    <th>Member Edits</th>
                                    <th>Last Activity</th>
                                </tr>
                            </thead>
                            <tbody id="userActivityBody">
                                <tr><td colspan="6" style="text-align: center; color: #666;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Management Modal -->
    <div id="passwordManagementModal" class="modal">
        <div class="modal-content password-modal">
            <div class="password-header">
                <div>
                    <h2> Password Management System</h2>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Manage user passwords and reset requests</p>
                </div>
                <button class="close" onclick="closePasswordManagementModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; padding: 0.5rem; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            
            <div class="password-tabs">
                <button class="password-tab active" onclick="switchPasswordTab('manage')">
                    <span></span> Manage Passwords
                </button>
                <button class="password-tab" onclick="switchPasswordTab('requests')">
                    <span></span> Reset Requests
                </button>
            </div>

            <div class="password-content">
                <div id="managePasswordsTab" class="tab-content-password">
                    <div id="userPasswordsList"></div>
                </div>

                <div id="resetRequestsTab" class="tab-content-password" style="display: none;">
                    <div id="resetRequestsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h3>Change Password for <span id="changePasswordUser"></span></h3>
            <form id="changePasswordForm">
                <input type="hidden" id="changePasswordUserId">
                <div class="form-group">
                    <label>New Password:</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password:</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit">Change Password</button>
                    <button type="button" onclick="closeChangePasswordModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Questions Modal -->
    <div id="securityQuestionsModal" class="modal">
        <div class="modal-content security-modal">
            <div class="security-header">
                <div>
                    <h2> Security Questions & Answers</h2>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Manage security questions for password recovery</p>
                </div>
                <button class="close" onclick="closeSecurityQuestionsModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; padding: 0.5rem; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            
            <div class="security-content">
                <div id="questionsContainer"></div>
                <button class="add-question-btn" onclick="addSecurityQuestion()" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; margin: 1.5rem 0; transition: all 0.3s;">+ Add Security Question</button>
                <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef;">
                    <button onclick="saveSecurityQuestions()" class="btn btn-primary" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;"> Save Questions</button>
                    <button onclick="closeSecurityQuestionsModal()" class="btn" style="background: #6c757d; color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Detail Modal -->
    <div id="resetRequestDetailModal" class="modal">
        <div class="modal-content security-modal">
            <div class="security-header">
                <div>
                    <h2> Password Reset Request Details</h2>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Review and process password reset request</p>
                </div>
                <button class="close" onclick="closeModal('resetRequestDetailModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; padding: 0.5rem; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div class="security-content" id="resetRequestDetails">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Change Password Request Modal -->
    <div id="changePasswordRequestModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem;"> Change Password Request</h2>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Submit a request to change your password</p>
                </div>
                <button class="close" onclick="closeModal('changePasswordRequestModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; padding: 0.5rem; border-radius: 50%; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div style="padding: 2rem;">
                <form id="changePasswordRequestForm">
                    <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #2196f3;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.2rem;"></span>
                            <strong style="color: #1976d2;">Signed In Request</strong>
                        </div>
                        <p style="margin: 0; color: #1565c0; font-size: 0.9rem;">
                            Submitted as: <strong>${currentUser.username}</strong><br>
                            No security questions required since you're signed in.
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="newPasswordRequest">New Password</label>
                        <input type="password" id="newPasswordRequest" required>
                        <div class="password-requirements">Must be at least 8 characters with uppercase, lowercase, number, and special character</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPasswordRequest">Confirm New Password</label>
                        <input type="password" id="confirmPasswordRequest" required>
                        <div id="passwordMatchRequest" class="password-requirements"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="changeReason">Reason for Change (Optional)</label>
                        <textarea id="changeReason" placeholder="Why do you want to change your password?" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 500; flex: 1;">
                             Submit Change Request
                        </button>
                        <button type="button" onclick="closeModal('changePasswordRequestModal')" class="btn" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            Cancel
                        </button>
                    </div>
                </form>
                
                <div class="loading" id="changePasswordRequestLoading" style="display: none; text-align: center; margin-top: 1rem; color: #667eea;">
                    Submitting request...
                </div>
                <div class="error" id="changePasswordRequestError" style="color: #e74c3c; margin-top: 1rem; text-align: center;"></div>
                <div class="success" id="changePasswordRequestSuccess" style="color: #27ae60; margin-top: 1rem; text-align: center;"></div>
            </div>
        </div>
    </div>

    <!-- Image Modal for Full-Size View -->
    <div id="imageModal" class="modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 95%; max-height: 95%; padding: 1rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="imageModalTitle" style="margin: 0; color: #333;"> Family Photo</h3>
                <button onclick="closeImageModal()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div style="text-align: center;">
                <img id="imageModalImg" src="" alt="Full size image" style="max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            </div>
        </div>
    </div>

    <!-- Load the new relationship system -->
    <!-- Consolidated: relationship-system.js and relationship-ui.js code is now inline below -->

    <script>
        /**
         * CONSOLIDATED FAMILY RELATIONSHIP SYSTEM
         * 
         * This is a complete redesign of the family tree system from branch-based to relationship-based.
         * 
         * Core Concepts:
         * - People are individuals with basic info
         * - Families are groups of people with specific relationships
         * - Relationships define how people are connected (parent, child, spouse, etc.)
         * - One person can have multiple relationships in different families
         */

        class FamilyRelationshipSystem {
            constructor(firebaseDb, firebaseModules) {
                this.db = firebaseDb;
                // Inject Firebase modules
                Object.assign(this, firebaseModules);
                
                // Data stores
                this.people = [];
                this.families = [];
                this.relationships = [];
                
                // Collection names for the new system
                this.COLLECTIONS = {
                    PEOPLE: 'people_v2',
                    FAMILIES: 'families_v2', 
                    RELATIONSHIPS: 'family_relationships_v2'
                };
            }

            /**
             * PERSON MANAGEMENT
             */
            async addPerson(personData) {
                const person = {
                    firstName: personData.firstName,
                    lastName: personData.lastName,
                    birthMonth: personData.birthMonth,
                    birthDay: personData.birthDay,
                    birthYear: personData.birthYear,
                    mobilePhone: personData.mobilePhone || '',
                    homePhone: personData.homePhone || '',
                    workPhone: personData.workPhone || '',
                    email: personData.email || '',
                    address: personData.address || '',
                    city: personData.city || '',
                    state: personData.state || '',
                    zipCode: personData.zipCode || '',
                    anniversaryDate: personData.anniversaryDate || '',
                    notes: personData.notes || '',
                    createdAt: new Date(),
                    createdBy: personData.createdBy,
                    isActive: true
                };

                const docRef = await addDoc(collection(this.db, this.COLLECTIONS.PEOPLE), person);
                person.id = docRef.id;
                return person;
            }

            async updatePerson(personId, updateData) {
                updateData.updatedAt = new Date();
                await updateDoc(doc(this.db, this.COLLECTIONS.PEOPLE, personId), updateData);
            }

            async deletePerson(personId) {
                // Mark as inactive instead of deleting to preserve relationship history
                await this.updatePerson(personId, { isActive: false, deletedAt: new Date() });
            }

            /**
             * FAMILY MANAGEMENT
             */
            async createFamily(familyData) {
                const family = {
                    name: familyData.name,
                    description: familyData.description || '',
                    familyType: familyData.familyType || 'nuclear',
                    generationLevel: familyData.generationLevel || 0,
                    createdAt: new Date(),
                    createdBy: familyData.createdBy,
                    isActive: true
                };

                const docRef = await addDoc(collection(this.db, this.COLLECTIONS.FAMILIES), family);
                family.id = docRef.id;
                return family;
            }

            async updateFamily(familyId, updateData) {
                updateData.updatedAt = new Date();
                await updateDoc(doc(this.db, this.COLLECTIONS.FAMILIES, familyId), updateData);
            }

            async deleteFamily(familyId) {
                // Mark as inactive and remove all relationships
                await this.updateFamily(familyId, { isActive: false, deletedAt: new Date() });
                // Remove all relationships in this family
                const familyRelationships = this.relationships.filter(r => r.familyId === familyId);
                for (const relationship of familyRelationships) {
                    await this.removeRelationship(relationship.id);
                }
            }

            /**
             * RELATIONSHIP MANAGEMENT
             */
            async addRelationship(relationshipData) {
                const relationship = {
                    personId: relationshipData.personId,
                    familyId: relationshipData.familyId,
                    role: relationshipData.role,
                    relationshipToOthers: relationshipData.relationshipToOthers || '',
                    startDate: relationshipData.startDate || null,
                    endDate: relationshipData.endDate || null,
                    createdAt: new Date(),
                    createdBy: relationshipData.createdBy,
                    isActive: true
                };

                const docRef = await addDoc(collection(this.db, this.COLLECTIONS.RELATIONSHIPS), relationship);
                relationship.id = docRef.id;
                return relationship;
            }

            async updateRelationship(relationshipId, updateData) {
                updateData.updatedAt = new Date();
                await updateDoc(doc(this.db, this.COLLECTIONS.RELATIONSHIPS, relationshipId), updateData);
            }

            async removeRelationship(relationshipId) {
                await updateDoc(doc(this.db, this.COLLECTIONS.RELATIONSHIPS, relationshipId), {
                    isActive: false,
                    deletedAt: new Date()
                });
            }

            /**
             * DATA LOADING
             */
            async loadAllData() {
                await Promise.all([
                    this.loadPeople(),
                    this.loadFamilies(),
                    this.loadRelationships()
                ]);
            }

            async loadPeople() {
                try {
                    const snapshot = await getDocs(collection(this.db, this.COLLECTIONS.PEOPLE));
                    this.people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading people:', error);
                    this.people = [];
                }
            }

            async loadFamilies() {
                try {
                    const snapshot = await getDocs(collection(this.db, this.COLLECTIONS.FAMILIES));
                    this.families = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading families:', error);
                    this.families = [];
                }
            }

            async loadRelationships() {
                try {
                    const snapshot = await getDocs(collection(this.db, this.COLLECTIONS.RELATIONSHIPS));
                    this.relationships = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading relationships:', error);
                    this.relationships = [];
                }
            }

            /**
             * QUERY METHODS
             */
            getPerson(personId) {
                return this.people.find(p => p.id === personId);
            }

            getFamily(familyId) {
                return this.families.find(f => f.id === familyId);
            }

            getPersonRelationships(personId) {
                return this.relationships.filter(r => r.personId === personId && r.isActive);
            }

            getFamilyMembers(familyId) {
                const familyRelationships = this.relationships.filter(r => r.familyId === familyId && r.isActive);
                return familyRelationships.map(rel => ({
                    person: this.getPerson(rel.personId),
                    role: rel.role,
                    relationshipToOthers: rel.relationshipToOthers,
                    relationship: rel
                }));
            }

            getPersonFamilies(personId) {
                const personRelationships = this.getPersonRelationships(personId);
                return personRelationships.map(rel => ({
                    family: this.getFamily(rel.familyId),
                    role: rel.role,
                    relationshipToOthers: rel.relationshipToOthers,
                    relationship: rel
                }));
            }

            calculateAge(member) {
                if (!member.birthYear || !member.birthMonth || !member.birthDay) return 'Unknown';
                
                const today = new Date();
                const birthDate = new Date(member.birthYear, this.getMonthIndex(member.birthMonth), member.birthDay);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age;
            }

            getNextBirthday(person) {
                if (!person.birthMonth || !person.birthDay) return new Date(9999, 0, 1);
                
                const today = new Date();
                const currentYear = today.getFullYear();
                const monthIndex = this.getMonthIndex(person.birthMonth);
                
                let nextBirthday = new Date(currentYear, monthIndex, person.birthDay);
                
                if (nextBirthday < today) {
                    nextBirthday = new Date(currentYear + 1, monthIndex, person.birthDay);
                }
                
                return nextBirthday;
            }

            getMonthIndex(monthName) {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
                return months.indexOf(monthName);
            }

            renderFamiliesView() {
                if (this.families.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: #666;">No families created yet. Click "Create Family" to get started!</div>';
                }

                return this.families.map(family => this.renderFamilyCard(family)).join('');
            }

            renderFamilyCard(family) {
                const members = this.getFamilyMembers(family.id);
                const groupedMembers = this.groupMembersByRole(members);

                return `
                    <div class="family-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 0.5rem;">${this.getFamilyTypeIcon(family.familyType)} ${family.name}</h3>
                                <p style="color: #666; font-size: 0.9rem;">${this.formatFamilyType(family.familyType)}  ${members.length} member${members.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            ${Object.entries(groupedMembers).map(([role, roleMembers]) => `
                                <div style="margin-bottom: 0.5rem;">
                                    <strong style="color: #495057; font-size: 0.85rem; text-transform: capitalize;">${role}s:</strong>
                                    <div style="margin-top: 0.25rem;">
                                        ${roleMembers.map(m => `
                                            <span style="background: ${this.getFamilyTypeColor(family.familyType)}20; color: ${this.getFamilyTypeColor(family.familyType)}; 
                                                         padding: 0.2rem 0.4rem; border-radius: 4px; margin-right: 0.25rem; font-size: 0.8rem;">
                                                ${m.person.firstName} ${m.person.lastName}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="display: flex; gap: 0.5rem; font-size: 0.8rem;">
                            <button class="btn btn-primary" onclick="relationshipUI.viewFamilyDetails('${family.id}')" style="flex: 1;"> View</button>
                            <button class="btn" onclick="relationshipUI.editFamily('${family.id}')" style="background: #17a2b8; color: white; flex: 1;"> Edit</button>
                            <button class="btn" onclick="relationshipUI.manageRelationships('${family.id}')" style="background: #28a745; color: white; flex: 1;"> Manage</button>
                        </div>
                    </div>
                `;
            }

            groupMembersByRole(members) {
                const grouped = {};
                members.forEach(member => {
                    const role = member.role || 'member';
                    if (!grouped[role]) grouped[role] = [];
                    grouped[role].push(member);
                });
                return grouped;
            }

            getFamilyTypeColor(familyType) {
                const colors = {
                    'nuclear': '#007bff',
                    'extended': '#28a745',
                    'ancestral': '#6f42c1',
                    'mixed': '#fd7e14'
                };
                return colors[familyType] || '#6c757d';
            }

            getFamilyTypeIcon(familyType) {
                const icons = {
                    'nuclear': '',
                    'extended': '',
                    'ancestral': '',
                    'mixed': ''
                };
                return icons[familyType] || '';
            }

            formatFamilyType(familyType) {
                const formatted = {
                    'nuclear': 'Nuclear Family',
                    'extended': 'Extended Family',
                    'ancestral': 'Ancestral Line',
                    'mixed': 'Mixed Family'
                };
                return formatted[familyType] || 'Family';
            }
        }

        /**
         * UI COMPONENTS FOR THE FAMILY RELATIONSHIP SYSTEM
         */
        class RelationshipSystemUI {
            constructor(relationshipSystem) {
                this.system = relationshipSystem;
                this.currentUser = null;
            }

            setCurrentUser(user) {
                this.currentUser = user;
            }

            displayPeopleTab() {
                let container = document.getElementById('relationshipsPeople');
                if (!container) {
                    container = document.querySelector('#relationships .section');
                }
                if (!container) return;

                const people = this.system.people.filter(p => p.isActive);
                
                container.innerHTML = `
                    <div class="controls">
                        <div class="search-controls">
                            <input type="text" id="peopleSearchInput" class="search-input" placeholder="Search people..." onkeyup="relationshipUI.filterPeople()">
                            <select id="peopleRoleFilter" class="filter-select" onchange="relationshipUI.filterPeople()">
                                <option value="">All Roles</option>
                                <option value="parent">Parents</option>
                                <option value="child">Children</option>
                                <option value="spouse">Spouses</option>
                                <option value="adult_child">Adult Children</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="relationshipUI.openAddPersonModal()">+ Add Person</button>
                    </div>
                    <div id="peopleGrid" class="family-grid">
                        ${this.renderPeopleGrid(people)}
                    </div>
                `;
            }

            renderPeopleGrid(people) {
                if (people.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: #666;">No people added yet. Click "Add Person" to get started!</div>';
                }

                return people.map(person => this.renderPersonCard(person)).join('');
            }

            renderPersonCard(person) {
                const age = this.system.calculateAge(person);
                const personFamilies = this.system.getPersonFamilies(person.id);
                const nextBirthday = this.system.getNextBirthday(person);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div class="family-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 0.5rem;">${person.firstName} ${person.lastName}</h3>
                                <p style="color: #666; font-size: 0.9rem;">Age: ${age} | Birthday: ${person.birthMonth} ${person.birthDay}</p>
                            </div>
                            ${daysUntilBirthday <= 30 ? `
                                <span style="background: #e74c3c20; color: #e74c3c; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                     ${daysUntilBirthday} days
                                </span>
                            ` : ''}
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong style="color: #333;">Families:</strong>
                                ${personFamilies.length > 0 ? `
                                    <div style="margin-top: 0.25rem;">
                                        ${personFamilies.map(pf => `
                                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.2rem;">
                                                 ${pf.family.name} (${pf.role})
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<span style="color: #999; font-style: italic;">No families assigned</span>'}
                            </div>
                            
                            ${person.mobilePhone ? `
                                <div style="font-size: 0.8rem; color: #666;"> ${person.mobilePhone}</div>
                            ` : ''}
                            
                            ${person.email ? `
                                <div style="font-size: 0.8rem; color: #666;"> ${person.email}</div>
                            ` : ''}
                        </div>

                        <div style="display: flex; gap: 0.5rem; font-size: 0.8rem;">
                            <button class="btn btn-primary" onclick="relationshipUI.viewPersonDetails('${person.id}')" style="flex: 1;"> View</button>
                            <button class="btn" onclick="relationshipUI.editPerson('${person.id}')" style="background: #17a2b8; color: white; flex: 1;"> Edit</button>
                            <button class="btn" onclick="relationshipUI.managePersonRelationships('${person.id}')" style="background: #28a745; color: white; flex: 1;"> Families</button>
                        </div>
                    </div>
                `;
            }

            // Placeholder methods for future implementation
            viewPersonDetails(personId) {
                showMessage('Person details view coming soon!', 'info');
            }

            editPerson(personId) {
                showMessage('Person editing coming soon!', 'info');
            }

            managePersonRelationships(personId) {
                showMessage('Relationship management coming soon!', 'info');
            }

            viewFamilyDetails(familyId) {
                showMessage('Family details view coming soon!', 'info');
            }

            editFamily(familyId) {
                showMessage('Family editing coming soon!', 'info');
            }

            manageRelationships(familyId) {
                showMessage('Relationship management coming soon!', 'info');
            }

            openAddPersonModal() {
                showMessage('Add person modal coming soon!', 'info');
            }
        }

        // Make these classes globally available
        window.FamilyRelationshipSystem = FamilyRelationshipSystem;
        window.RelationshipSystemUI = RelationshipSystemUI;
    </script>

    <script type="module">
        // Import Firebase using the correct v9+ modular syntax
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCWtVYdOiggwqw5CNMJbM13BdeLtwqBhbs",
            authDomain: "family-tree-6f16b.firebaseapp.com",
            projectId: "family-tree-6f16b",
            storageBucket: "family-tree-6f16b.firebasestorage.app",
            messagingSenderId: "801170939057",
            appId: "1:801170939057:web:87d35d8156789631f69690"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Initialize the new relationship system
        let relationshipSystem = null;
        let relationshipUI = null;
        let useNewSystem = false; // Flag to switch between old and new system

        // Global variables
        let currentUser = null;
        let familyMembers = [];
        let familyBranches = [];
        let familyUnits = [];  // New: Family Units that group branches together
        let users = [];
        let messages = [];
        let accountRequests = [];
        let deniedAccounts = [];
        let manualFamilyTrees = []; // Store manual family trees separately
        let virtualFamilyGroups = []; // Store virtual family groups separately
        
        // Super Admin Functions (dfinn12 only)
        let hiddenFamilyIds = new Set(); // Track hidden family trees
        let customFamilyGroups = []; // Custom created family groups

        // Load hidden families from Firebase (shared across all users)
        async function loadHiddenFamilies() {
            try {
                const querySnapshot = await getDocs(collection(db, 'hidden_families'));
                const hiddenIds = querySnapshot.docs.map(doc => doc.data().familyId);
                hiddenFamilyIds = new Set(hiddenIds);
                console.log('Loaded hidden families from Firebase:', hiddenFamilyIds);
            } catch (error) {
                console.error('Error loading hidden families from Firebase:', error);
            }
        }

        // Initialize the app
        async function init() {
            // Check if user is logged in
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                // Temporary test user for debugging
                const testUser = {
                    username: 'testuser',
                    isAdmin: true
                };
                localStorage.setItem('currentUser', JSON.stringify(testUser));
                currentUser = testUser;
            } else {
                currentUser = JSON.parse(userData);
            }
            
            // Special privileges for dfinn12 - the developer/owner account
            if (currentUser.username === 'dfinn12') {
                currentUser.isDeveloper = true;
                currentUser.isAdmin = true;
                console.log(' Developer privileges activated for dfinn12');
            }
            
            document.getElementById('username').textContent = currentUser.username;
            
            // Add Security Questions button for all users
            addSecurityQuestionsButton();
            
            if (currentUser.isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                
                // Add Change Password button for all admins
                addChangePasswordButton();
                
                // Start real-time monitoring for account requests
                startRequestMonitoring();
            }
            
            // Add developer features for dfinn12 only
            if (currentUser.isDeveloper) {
                addDeveloperTestButton();
                // Show developer-only tabs and features
                document.querySelectorAll('.developer-only').forEach(el => el.style.display = 'block');
                console.log(' Super Admin features activated!');
            }

            // Initialize the new relationship system
            initializeRelationshipSystem();

            await loadData();
            setupEventListeners();
            
            // Log successful dashboard access
            await logUserAction('login', 'dashboard', 'Successfully accessed main dashboard', 'success');
        }

        // Real-time monitoring for new account requests
        function startRequestMonitoring() {
            if (!currentUser.isAdmin) return;
            
            // Check for new requests every 5 seconds
            setInterval(async () => {
                const oldCount = accountRequests.filter(req => req.status === 'pending').length;
                await loadAccountRequests();
                const newCount = accountRequests.filter(req => req.status === 'pending').length;
                
                // If new requests appeared, refresh the display
                if (newCount > oldCount) {
                    displayAccountRequests();
                }
            }, 5000);
        }

        // Initialize the new relationship system
        function initializeRelationshipSystem() {
            try {
                // Create the relationship system with Firebase modules
                relationshipSystem = new FamilyRelationshipSystem(db, {
                    collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc
                });
                
                // Create the UI system
                relationshipUI = new RelationshipSystemUI(relationshipSystem);
                relationshipUI.setCurrentUser(currentUser);
                
                // Make them globally accessible
                window.relationshipSystem = relationshipSystem;
                window.relationshipUI = relationshipUI;
                
                console.log('New relationship system initialized successfully');
                
                // Check if user wants to use the new system
                const useNewSystemPref = localStorage.getItem('useNewRelationshipSystem');
                if (useNewSystemPref === 'true') {
                    useNewSystem = true;
                    console.log('Using new relationship system');
                }
                
            } catch (error) {
                console.error('Failed to initialize relationship system:', error);
            }
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadFamilyMembers(),
                loadFamilyBranches(),
                loadFamilyUnits(),  // New: Load family units
                loadManualFamilyTrees(), // Load manual family trees
                loadVirtualFamilyGroups(), // Load virtual family groups
                loadUsers(),
                loadMessages(),
                loadAccountRequests(),
                loadDeniedAccounts(),
                loadHiddenFamilies() // Load hidden families from Firebase
            ]);
            
            displayFamilyMembers();
            displayBranches();
            displayUsers();
            displayMessages();
            displayAccountRequests();
            displayUpcomingBirthdays();
            populateDropdowns();
            
            // Load and display hidden families for developers
            if (currentUser?.isDeveloper) {
                displayHiddenFamilies();
            }
        }

        // Load family members
        async function loadFamilyMembers() {
            try {
                console.log('Loading family members...');
                const querySnapshot = await getDocs(collection(db, 'family_members'));
                familyMembers = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`Loaded ${familyMembers.length} family members:`, familyMembers);
            } catch (error) {
                console.error('Error loading family members:', error);
            }
        }

        // Load family branches
        async function loadFamilyBranches() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_branches'));
                familyBranches = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family branches:', error);
            }
        }

        // Load family units
        async function loadFamilyUnits() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_units'));
                familyUnits = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family units:', error);
            }
        }

        // Load users (admin only)
        async function loadUsers() {
            if (!currentUser.isAdmin) return;
            
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                users = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(20));
                const querySnapshot = await getDocs(q);
                messages = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Load account requests
        async function loadAccountRequests() {
            try {
                const q = query(collection(db, 'account_requests'), orderBy('requestDate', 'desc'));
                const querySnapshot = await getDocs(q);
                accountRequests = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateRequestsBadge();
            } catch (error) {
                console.error('Error loading account requests:', error);
            }
        }

        // Load denied accounts
        async function loadDeniedAccounts() {
            try {
                const q = query(collection(db, 'denied_accounts'));
                const querySnapshot = await getDocs(q);
                deniedAccounts = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading denied accounts:', error);
            }
        }

        // Display family members with proper relationships
        function displayFamilyMembers() {
            const grid = document.getElementById('familyGrid');
            if (!grid) {
                console.error('familyGrid element not found');
                return;
            }
            
            // Get filter values with null checks
            const searchInput = document.getElementById('searchInput');
            const monthFilterEl = document.getElementById('monthFilter');
            const branchFilterEl = document.getElementById('branchFilter');
            const sortOrderEl = document.getElementById('sortOrder');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const monthFilter = monthFilterEl ? monthFilterEl.value : '';
            const branchFilter = branchFilterEl ? branchFilterEl.value : '';
            const sortOrder = sortOrderEl ? sortOrderEl.value : 'name';

            let filtered = familyMembers.filter(member => {
                const matchesSearch = !searchTerm || 
                    (member.firstName && member.firstName.toLowerCase().includes(searchTerm)) ||
                    (member.lastName && member.lastName.toLowerCase().includes(searchTerm));
                const matchesMonth = !monthFilter || member.birthMonth === monthFilter;
                const matchesBranch = !branchFilter || member.familyBranch === branchFilter;
                
                return matchesSearch && matchesMonth && matchesBranch;
            });

            // Sort based on selected order
            filtered.sort((a, b) => {
                if (sortOrder === 'age-oldest') {
                    return getAge(b) - getAge(a);
                } else if (sortOrder === 'age-youngest') {
                    return getAge(a) - getAge(b);
                } else if (sortOrder === 'birthday') {
                    return getNextBirthday(a) - getNextBirthday(b);
                } else {
                    return `${a.firstName || ''} ${a.lastName || ''}`.localeCompare(`${b.firstName || ''} ${b.lastName || ''}`);
                }
            });

            grid.innerHTML = filtered.map(member => {
                const age = getAge(member);
                const nextBirthday = getNextBirthday(member);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));
                const deceasedStyle = member.deceased ? 'border: 3px solid #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);' : '';
                const deceasedIcon = member.deceased ? ' ' : '';
                
                return `
                <div class="family-card" style="${deceasedStyle}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: ${member.deceased ? '#e74c3c' : '#667eea'}; margin-bottom: 0.5rem;">${deceasedIcon}${member.firstName || ''} ${member.lastName || ''}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Age: ${age} | Birthday: ${member.birthMonth || 'N/A'} ${member.birthDay || 'N/A'}, ${member.birthYear || 'N/A'}</p>
                            ${member.deceased ? '<p style="color: #e74c3c; font-size: 0.8rem; font-style: italic;"> Deceased</p>' : ''}
                        </div>
                        ${daysUntilBirthday <= 30 && !member.deceased ? `
                            <span style="background: #e74c3c20; color: #e74c3c; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                 ${daysUntilBirthday} days
                            </span>
                        ` : ''}
                    </div>



                    <!-- Basic Info -->
                    <div class="family-info" style="margin-bottom: 1rem;">
                        <div><strong>Family Group:</strong> ${member.familyBranch || 'No group assigned'}</div>
                        ${member.marriedTo && member.marriedTo.length > 0 ? `<div><strong> Currently Married To:</strong> ${getSpousesNames(member.marriedTo)}</div>` : ''}
                        ${member.marriageHistory && member.marriageHistory.length > 0 ? `
                            <div><strong> Marriage History:</strong>
                                ${member.marriageHistory.map(marriage => {
                                    const spouseName = getSpouseName(marriage.spouseId);
                                    const statusEmoji = marriage.status === 'widowed' ? '' : marriage.status === 'divorced' ? '' : '';
                                    const duration = marriage.startYear && marriage.endYear ? ` (${marriage.startYear}-${marriage.endYear})` : '';
                                    return `<div style="margin-left: 1rem;">${statusEmoji} ${marriage.status}: ${spouseName}${duration}</div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                        ${member.parents && member.parents.length > 0 ? `<div><strong> Parents:</strong> ${getParentsNames(member.parents)}</div>` : ''}
                        ${member.children && member.children.length > 0 ? `<div><strong> Children:</strong> ${getChildrenNames(member.children)}</div>` : ''}
                        <div><strong>Mobile:</strong> ${member.mobilePhone || 'Not provided'}</div>
                        <div><strong>Email:</strong> ${member.email || 'Not provided'}</div>
                        <div><strong>Address:</strong> ${member.address ? `${member.address}, ${member.city || ''} ${member.state || ''}` : 'Not provided'}</div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="flex: 1;"> Edit</button>
                        <button class="btn" onclick="viewFamilyTree('${member.id}')" style="background: #28a745; color: white; flex: 1;"> Family Tree</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="flex: 1;"> Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Helper function to get spouse name
        function getSpouseName(spouseId) {
            const spouse = familyMembers.find(m => m.id === spouseId);
            return spouse ? `${spouse.firstName} ${spouse.lastName}` : 'Unknown';
        }

        // Helper function to get multiple spouses names
        function getSpousesNames(spouseIds) {
            if (!spouseIds || spouseIds.length === 0) return 'None';
            
            // Handle backward compatibility - if it's a string, convert to array
            if (typeof spouseIds === 'string') {
                spouseIds = [spouseIds];
            }
            
            const spouseNames = spouseIds.map(spouseId => {
                const spouse = familyMembers.find(m => m.id === spouseId);
                return spouse ? `${spouse.firstName} ${spouse.lastName}` : 'Unknown';
            }).filter(name => name !== 'Unknown');
            
            return spouseNames.length > 0 ? spouseNames.join(', ') : 'None';
        }

        // Helper function to get children names
        function getChildrenNames(childrenIds) {
            if (!childrenIds || childrenIds.length === 0) return 'None';
            
            const childNames = childrenIds.map(childId => {
                const child = familyMembers.find(m => m.id === childId);
                return child ? `${child.firstName} ${child.lastName}` : 'Unknown';
            }).filter(name => name !== 'Unknown');
            
            if (childNames.length === 0) return 'None';
            if (childNames.length <= 3) return childNames.join(', ');
            return `${childNames.slice(0, 3).join(', ')} and ${childNames.length - 3} more`;
        }

        // Helper function to get parents names
        function getParentsNames(parentsIds) {
            if (!parentsIds || parentsIds.length === 0) return 'None';
            
            const parentNames = parentsIds.map(parentId => {
                const parent = familyMembers.find(m => m.id === parentId);
                return parent ? `${parent.firstName} ${parent.lastName}` : 'Unknown';
            }).filter(name => name !== 'Unknown');
            
            if (parentNames.length === 0) return 'None';
            return parentNames.join(', ');
        }

        // Update bidirectional relationships and sync with spouse
        async function updateBidirectionalRelationships(memberId, parentIds, childrenIds) {
            try {
                const member = familyMembers.find(m => m.id === memberId);
                if (!member) return;

                const oldParents = member.parents || [];
                const oldChildren = member.children || [];

                // Handle parent relationships
                // Remove this member from old parents who are no longer selected
                const removedParents = oldParents.filter(id => !parentIds.includes(id));
                for (const parentId of removedParents) {
                    const parent = familyMembers.find(m => m.id === parentId);
                    if (parent) {
                        const updatedChildren = (parent.children || []).filter(id => id !== memberId);
                        await updateDoc(doc(db, 'family_members', parentId), {
                            children: updatedChildren
                        });
                        console.log(`Removed child ${member.firstName} from parent ${parent.firstName}`);
                    }
                }

                // Add this member to new parents
                const newParents = parentIds.filter(id => !oldParents.includes(id));
                for (const parentId of newParents) {
                    const parent = familyMembers.find(m => m.id === parentId);
                    if (parent) {
                        const updatedChildren = [...(parent.children || [])];
                        if (!updatedChildren.includes(memberId)) {
                            updatedChildren.push(memberId);
                            await updateDoc(doc(db, 'family_members', parentId), {
                                children: updatedChildren
                            });
                            console.log(`Added child ${member.firstName} to parent ${parent.firstName}`);
                        }

                        // If parent has a spouse, sync the children with them too
                        if (parent.marriedTo) {
                            await syncChildrenWithSpouse(parentId, parent.marriedTo, updatedChildren);
                        }
                    }
                }

                // Handle children relationships
                // Remove this member from old children who are no longer selected
                const removedChildren = oldChildren.filter(id => !childrenIds.includes(id));
                for (const childId of removedChildren) {
                    const child = familyMembers.find(m => m.id === childId);
                    if (child) {
                        const updatedParents = (child.parents || []).filter(id => id !== memberId);
                        await updateDoc(doc(db, 'family_members', childId), {
                            parents: updatedParents
                        });
                        console.log(`Removed parent ${member.firstName} from child ${child.firstName}`);
                    }
                }

                // Add this member to new children
                const newChildren = childrenIds.filter(id => !oldChildren.includes(id));
                for (const childId of newChildren) {
                    const child = familyMembers.find(m => m.id === childId);
                    if (child) {
                        const updatedParents = [...(child.parents || [])];
                        if (!updatedParents.includes(memberId)) {
                            updatedParents.push(memberId);
                            await updateDoc(doc(db, 'family_members', childId), {
                                parents: updatedParents
                            });
                            console.log(`Added parent ${member.firstName} to child ${child.firstName}`);
                        }
                    }
                }

                // If this member has a spouse, sync children with them
                if (member.marriedTo && childrenIds.length > 0) {
                    await syncChildrenWithSpouse(memberId, member.marriedTo, childrenIds);
                }

            } catch (error) {
                console.error('Error updating bidirectional relationships:', error);
            }
        }

        // Sync children between married spouses
        async function syncChildrenWithSpouse(parentId, spouseId, parentChildren) {
            try {
                const spouse = familyMembers.find(m => m.id === spouseId);
                if (!spouse) return;

                const spouseChildren = spouse.children || [];
                const combinedChildren = [...new Set([...spouseChildren, ...parentChildren])];

                // Only update if there's a difference
                if (spouseChildren.length !== combinedChildren.length || !spouseChildren.every(id => combinedChildren.includes(id))) {
                    await updateDoc(doc(db, 'family_members', spouseId), {
                        children: combinedChildren
                    });
                    console.log(`Synced children with spouse ${spouse.firstName}: added ${combinedChildren.length - spouseChildren.length} children`);

                    // Update the newly added children to have both parents
                    const newChildren = combinedChildren.filter(childId => !spouseChildren.includes(childId));
                    for (const childId of newChildren) {
                        const child = familyMembers.find(m => m.id === childId);
                        if (child) {
                            const childParents = child.parents || [];
                            if (!childParents.includes(spouseId)) {
                                const updatedParents = [...childParents, spouseId];
                                await updateDoc(doc(db, 'family_members', childId), {
                                    parents: updatedParents
                                });
                                console.log(`Added spouse ${spouse.firstName} as parent to child ${child.firstName}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error syncing children with spouse:', error);
            }
        }

        // Update bidirectional marriage relationships and synchronize children
        async function updateBidirectionalMarriage(memberId, oldSpouseId, newSpouseId) {
            try {
                const member = familyMembers.find(m => m.id === memberId);
                if (!member) return;

                // If there was an old spouse, remove the marriage connection and handle children
                if (oldSpouseId && oldSpouseId !== newSpouseId) {
                    const oldSpouse = familyMembers.find(m => m.id === oldSpouseId);
                    if (oldSpouse) {
                        await updateDoc(doc(db, 'family_members', oldSpouseId), { marriedTo: null });
                        console.log(`Removed marriage connection for old spouse: ${oldSpouse.firstName} ${oldSpouse.lastName}`);
                        
                        // Note: We don't automatically remove children from divorced spouses as they may still be co-parents
                    }
                }

                // If there's a new spouse, set up the bidirectional marriage and sync children
                if (newSpouseId && newSpouseId !== oldSpouseId) {
                    const newSpouse = familyMembers.find(m => m.id === newSpouseId);
                    if (newSpouse) {
                        // Check if the new spouse was married to someone else
                        if (newSpouse.marriedTo && newSpouse.marriedTo !== memberId) {
                            const formerSpouse = familyMembers.find(m => m.id === newSpouse.marriedTo);
                            if (formerSpouse) {
                                await updateDoc(doc(db, 'family_members', newSpouse.marriedTo), { marriedTo: null });
                                console.log(`Removed marriage connection for former spouse: ${formerSpouse.firstName} ${formerSpouse.lastName}`);
                            }
                        }

                        // Set the new spouse's marriedTo field
                        await updateDoc(doc(db, 'family_members', newSpouseId), { marriedTo: memberId });
                        console.log(`Set bidirectional marriage between ${memberId} and ${newSpouseId}`);
                        
                        // Synchronize children between the married couple
                        await synchronizeMarriedCoupleChildren(memberId, newSpouseId);
                    }
                }
            } catch (error) {
                console.error('Error updating bidirectional marriage:', error);
            }
        }

        // Synchronize children between married couples
        async function synchronizeMarriedCoupleChildren(spouse1Id, spouse2Id) {
            try {
                const spouse1 = familyMembers.find(m => m.id === spouse1Id);
                const spouse2 = familyMembers.find(m => m.id === spouse2Id);
                
                if (!spouse1 || !spouse2) return;

                // Get all children from both spouses
                const spouse1Children = spouse1.children || [];
                const spouse2Children = spouse2.children || [];
                
                // Combine and deduplicate children
                const allChildrenIds = [...new Set([...spouse1Children, ...spouse2Children])];
                
                console.log(`Synchronizing children for married couple: ${spouse1.firstName} & ${spouse2.firstName}`);
                console.log(`Combined children:`, allChildrenIds);

                // Update both spouses to have all children
                if (spouse1Children.length !== allChildrenIds.length || !spouse1Children.every(id => allChildrenIds.includes(id))) {
                    await updateDoc(doc(db, 'family_members', spouse1Id), { children: allChildrenIds });
                    console.log(`Updated ${spouse1.firstName}'s children to:`, allChildrenIds);
                }

                if (spouse2Children.length !== allChildrenIds.length || !spouse2Children.every(id => allChildrenIds.includes(id))) {
                    await updateDoc(doc(db, 'family_members', spouse2Id), { children: allChildrenIds });
                    console.log(`Updated ${spouse2.firstName}'s children to:`, allChildrenIds);
                }

                // Update each child to have both parents
                for (const childId of allChildrenIds) {
                    const child = familyMembers.find(m => m.id === childId);
                    if (child) {
                        const currentParents = child.parents || [];
                        const newParents = [...new Set([...currentParents, spouse1Id, spouse2Id])];
                        
                        if (currentParents.length !== newParents.length || !currentParents.every(id => newParents.includes(id))) {
                            await updateDoc(doc(db, 'family_members', childId), { parents: newParents });
                            console.log(`Updated ${child.firstName}'s parents to include both spouses`);
                        }
                    }
                }

                console.log(`Successfully synchronized children for married couple`);
            } catch (error) {
                console.error('Error synchronizing children for married couple:', error);
            }
        }

        // Update bidirectional marriage relationships for multiple spouses
        async function updateBidirectionalMarriageMultiple(memberId, spouseId) {
            try {
                const member = familyMembers.find(m => m.id === memberId);
                const spouse = familyMembers.find(m => m.id === spouseId);
                
                if (!member || !spouse) return;

                // Add this member to spouse's marriedTo array (if it's not already there)
                let spouseMarriedTo = spouse.marriedTo || [];
                
                // Handle backward compatibility - if it's a string, convert to array
                if (typeof spouseMarriedTo === 'string') {
                    spouseMarriedTo = spouseMarriedTo ? [spouseMarriedTo] : [];
                }
                
                if (!spouseMarriedTo.includes(memberId)) {
                    spouseMarriedTo.push(memberId);
                    await updateDoc(doc(db, 'family_members', spouseId), { marriedTo: spouseMarriedTo });
                    console.log(`Added ${member.firstName} to ${spouse.firstName}'s marriedTo array`);
                }
                
                // Update local data
                spouse.marriedTo = spouseMarriedTo;
                
            } catch (error) {
                console.error('Error updating bidirectional marriage for multiple spouses:', error);
            }
        }

        // Auto-generate family trees based on relationships - REWRITTEN FOR BETTER LOGIC
        function generateFamilyTrees() {
            const familyTrees = [];
            const familyTreeHeads = new Set(); // Track which members have been used as family heads

            // Step 1: Find all potential family heads (anyone with children OR patriarchs)
            const potentialHeads = familyMembers.filter(member => {
                // Include members who have children OR have no parents (potential patriarchs)
                const hasChildren = member.children && member.children.length > 0;
                const hasParentsInSystem = member.parents && member.parents.length > 0 && 
                    member.parents.some(parentId => familyMembers.find(m => m.id === parentId));
                
                // Must have children OR be a patriarch (no parents in system)
                return hasChildren || !hasParentsInSystem;
            });

            // Step 2: Sort by age (oldest first) and create families
            potentialHeads.sort((a, b) => getAge(b) - getAge(a)).forEach(head => {
                // Skip if this member is already used as a family head
                if (familyTreeHeads.has(head.id)) return;
                
                // Check if spouse is also a potential head - prevent both spouses from creating families
                if (head.marriedTo) {
                    const spouse = familyMembers.find(m => m.id === head.marriedTo);
                    if (spouse && potentialHeads.includes(spouse)) {
                        // If spouse is older OR if spouse already created a family, skip this one
                        if (getAge(spouse) > getAge(head) || familyTreeHeads.has(spouse.id)) return;
                        
                        // Mark spouse as used so they don't create their own family
                        familyTreeHeads.add(spouse.id);
                    }
                }
                
                // Create a new processedMembers set for each family tree
                const processedMembers = new Set();
                const familyTree = buildCompleteFamily(head, processedMembers);
                if (familyTree && familyTree.generations.length > 0) {
                    familyTrees.push(familyTree);
                    familyTreeHeads.add(head.id);
                }
            });

            // Step 3: Handle any remaining isolated members (those not in any family tree)
            const allProcessedMembers = new Set();
            familyTrees.forEach(tree => {
                tree.generations.forEach(gen => {
                    gen.members.forEach(member => {
                        allProcessedMembers.add(member.id);
                    });
                });
            });

            const remainingMembers = familyMembers.filter(member => !allProcessedMembers.has(member.id));
            remainingMembers.forEach(member => {
                const processedMembers = new Set();
                const isolatedTree = createIsolatedMemberTree(member, processedMembers);
                if (isolatedTree) {
                    familyTrees.push(isolatedTree);
                }
            });

            return familyTrees;
        }

        // Build a complete family starting from a family head
        function buildCompleteFamily(familyHead, processedMembers) {
            // Create family name with both spouses if married
            let familyName = `${familyHead.firstName} ${familyHead.lastName} Family`;
            
            if (familyHead.marriedTo) {
                const spouse = familyMembers.find(m => m.id === familyHead.marriedTo);
                if (spouse) {
                    // Determine who is the father (for the family last name)
                    const isFamilyHeadMale = familyHead.gender === 'Male';
                    const father = isFamilyHeadMale ? familyHead : spouse;
                    const mother = isFamilyHeadMale ? spouse : familyHead;
                    
                    familyName = `${father.firstName} & ${mother.firstName} ${father.lastName} Family`;
                }
            }
            
            const familyTree = {
                id: `family_${familyHead.id}`,
                name: familyName,
                generations: []
            };

            // Determine if this person is a patriarch or parent generation
            const hasParentsInSystem = familyHead.parents && familyHead.parents.length > 0 && 
                familyHead.parents.some(parentId => familyMembers.find(m => m.id === parentId));
            
            const generationType = hasParentsInSystem ? 'parents' : 'patriarch';

            // Start with the family head's generation
            const headGeneration = buildFamilyGeneration(familyHead, processedMembers, generationType);
            if (headGeneration.members.length > 0) {
                familyTree.generations.push(headGeneration);
            }

            // Build subsequent generations (children, grandchildren, etc.)
            let currentGeneration = headGeneration.members;
            let generationLevel = 1;
            let nextGenerationType = 'children';

            while (currentGeneration.length > 0) {
                const childrenGeneration = buildChildrenGeneration(currentGeneration, nextGenerationType, processedMembers);
                
                if (childrenGeneration.members.length === 0) break;
                
                familyTree.generations.push(childrenGeneration);
                
                // Don't add spouses as separate generation - they should be integrated as in-laws
                // within the children's generation in the display logic
                
                currentGeneration = childrenGeneration.members;
                generationLevel++;
                
                // Update generation type
                if (nextGenerationType === 'children') nextGenerationType = 'grandchildren';
                else if (nextGenerationType === 'grandchildren') nextGenerationType = 'great-grandchildren';
                else nextGenerationType = `generation-${generationLevel}`;
            }

            return familyTree;
        }

        // Build a family generation starting from a specific member
        function buildFamilyGeneration(member, processedMembers, type) {
            const generationMembers = [member];
            processedMembers.add(member.id);

            // Add spouse if married
            if (member.marriedTo) {
                const spouse = familyMembers.find(m => m.id === member.marriedTo);
                if (spouse && !processedMembers.has(spouse.id)) {
                    generationMembers.push(spouse);
                    processedMembers.add(spouse.id);
                }
            }

            return {
                level: 0,
                members: generationMembers.sort((a, b) => getAge(b) - getAge(a)),
                type: type
            };
        }

        // Build children generation
        function buildChildrenGeneration(currentGeneration, type, processedMembers) {
            const childrenMembers = [];
            const seenChildren = new Set();

            currentGeneration.forEach(parent => {
                if (parent.children && parent.children.length > 0) {
                    parent.children.forEach(childId => {
                        const child = familyMembers.find(m => m.id === childId);
                        if (child && !seenChildren.has(child.id) && !processedMembers.has(child.id)) {
                            childrenMembers.push(child);
                            seenChildren.add(child.id);
                            processedMembers.add(child.id);
                        }
                    });
                }
            });

            return {
                level: 1,
                members: childrenMembers.sort((a, b) => getAge(b) - getAge(a)),
                type: type
            };
        }

        // Build spouses generation for children
        function buildSpousesGeneration(childrenGeneration, processedMembers) {
            const spousesMembers = [];
            const seenSpouses = new Set();

            childrenGeneration.forEach(child => {
                if (child.marriedTo) {
                    const spouse = familyMembers.find(m => m.id === child.marriedTo);
                    // Include spouse as in-law but DON'T mark as processed so they can be head of their own family
                    if (spouse && !seenSpouses.has(spouse.id)) {
                        spousesMembers.push(spouse);
                        seenSpouses.add(spouse.id);
                        // Note: NOT adding to processedMembers so spouse can still be a family head
                    }
                }
            });

            return {
                level: 1,
                members: spousesMembers.sort((a, b) => getAge(b) - getAge(a)),
                type: 'spouse'
            };
        }

        // Find patriarchs/matriarchs (oldest generation members with no parents in the system)
        function findPatriarchs() {
            return familyMembers.filter(member => {
                // No parents or parents not in the system
                const hasParentsInSystem = member.parents && member.parents.length > 0 && 
                    member.parents.some(parentId => familyMembers.find(m => m.id === parentId));
                return !hasParentsInSystem;
            }).sort((a, b) => getAge(b) - getAge(a)); // Sort by age, oldest first
        }

        // Build a complete multi-generational tree starting from a patriarch/matriarch
        function buildMultiGenerationalTree(patriarch, processedPatriarchs) {
            const familyTree = {
                id: `family_${patriarch.id}`,
                name: `${patriarch.firstName} ${patriarch.lastName} Family`,
                generations: []
            };

            // Start with the patriarch's generation (only mark patriarch as processed to avoid duplicate trees)
            const patriarchGeneration = buildGenerationFromMember(patriarch, processedPatriarchs, 'patriarch');
            if (patriarchGeneration.members.length > 0) {
                familyTree.generations.push(patriarchGeneration);
            }

            // Build subsequent generations (children, grandchildren, etc.)
            // NOTE: We don't track processed members for descendants - they can appear in multiple trees
            let currentGeneration = patriarchGeneration.members;
            let generationLevel = 1;
            let generationType = 'children';

            while (currentGeneration.length > 0) {
                const generationResult = buildNextGenerationAllowDuplicates(currentGeneration, generationType, generationLevel);
                
                // Add children generation
                if (generationResult.childrenGeneration.members.length === 0) break;
                familyTree.generations.push(generationResult.childrenGeneration);
                
                // Add spouses generation if it exists
                if (generationResult.spousesGeneration && generationResult.spousesGeneration.members.length > 0) {
                    familyTree.generations.push(generationResult.spousesGeneration);
                }
                
                currentGeneration = generationResult.childrenGeneration.members;
                generationLevel++;
                
                // Update generation type
                if (generationType === 'children') generationType = 'grandchildren';
                else if (generationType === 'grandchildren') generationType = 'great-grandchildren';
                else generationType = `generation-${generationLevel}`;
            }

            return familyTree;
        }

        // Build a generation starting from a specific member (includes spouse)
        function buildGenerationFromMember(member, processedPatriarchs, type) {
            const generationMembers = [member];
            
            // Only mark patriarch as processed to prevent duplicate family trees
            if (type === 'patriarch') {
                processedPatriarchs.add(member.id);
            }

            // Add spouse if married
            if (member.marriedTo) {
                const spouse = familyMembers.find(m => m.id === member.marriedTo);
                if (spouse) {
                    generationMembers.push(spouse);
                    // Also mark spouse as processed if they're also a patriarch
                    if (type === 'patriarch') {
                        processedPatriarchs.add(spouse.id);
                    }
                }
            }

            return {
                level: 0,
                members: generationMembers.sort((a, b) => getAge(b) - getAge(a)), // Sort by age
                type: type
            };
        }

        // Build the next generation (children of current generation) - ALLOWS DUPLICATES FOR DESCENDANTS
        function buildNextGenerationAllowDuplicates(currentGeneration, type, level) {
            const childrenMembers = [];
            const spousesMembers = [];
            const seenChildren = new Set();
            const seenSpouses = new Set();

            currentGeneration.forEach(parent => {
                if (parent.children && parent.children.length > 0) {
                    parent.children.forEach(childId => {
                        const child = familyMembers.find(m => m.id === childId);
                        if (child && !seenChildren.has(child.id)) {
                            childrenMembers.push(child);
                            seenChildren.add(child.id);

                            // Add the child's spouse to separate spouses array
                            if (child.marriedTo) {
                                const spouse = familyMembers.find(m => m.id === child.marriedTo);
                                if (spouse && !seenSpouses.has(spouse.id)) {
                                    spousesMembers.push(spouse);
                                    seenSpouses.add(spouse.id);
                                }
                            }
                        }
                    });
                }
            });

            // Create children generation
            const childrenGeneration = {
                level: level,
                members: childrenMembers.sort((a, b) => getAge(b) - getAge(a)),
                type: type,
                isChildren: true
            };

            // Create spouses generation (if there are any spouses)
            const spousesGeneration = spousesMembers.length > 0 ? {
                level: level,
                members: spousesMembers.sort((a, b) => getAge(b) - getAge(a)),
                type: type + '-spouses',
                isSpouses: true
            } : null;

            return { childrenGeneration, spousesGeneration };
        }

        // Create tree for isolated member (no family connections)
        // Create tree for isolated member (no family connections)
        function createIsolatedMemberTree(member, processedMembers) {
            if (processedMembers.has(member.id)) return null;
            
            const familyTree = {
                id: `family_${member.id}`,
                name: `${member.firstName} ${member.lastName}`,
                generations: []
            };

            const generation = {
                level: 0,
                members: [member],
                type: 'individual'
            };
            
            processedMembers.add(member.id);
            familyTree.generations.push(generation);

            return familyTree;
        }

        function findNuclearFamilies() {
            const families = [];
            const processedParentPairs = new Set();

            familyMembers.forEach(member => {
                if (member.children && member.children.length > 0) {
                    // Check if this person has a spouse who is also a parent to the same children
                    const spouse = member.marriedTo ? familyMembers.find(m => m.id === member.marriedTo) : null;
                    
                    if (spouse && spouse.children) {
                        // Check for shared children
                        const sharedChildren = member.children.filter(childId => 
                            spouse.children.includes(childId)
                        );
                        
                        if (sharedChildren.length > 0) {
                            const pairKey = [member.id, spouse.id].sort().join('-');
                            if (!processedParentPairs.has(pairKey)) {
                                processedParentPairs.add(pairKey);
                                families.push({
                                    parents: [member, spouse],
                                    children: sharedChildren.map(id => familyMembers.find(m => m.id === id)).filter(Boolean),
                                    name: `${member.firstName} & ${spouse.firstName} ${member.lastName} Family`
                                });
                            }
                        }
                    } else {
                        // Single parent family
                        families.push({
                            parents: [member],
                            children: member.children.map(id => familyMembers.find(m => m.id === id)).filter(Boolean),
                            name: `${member.firstName} ${member.lastName} Family`
                        });
                    }
                }
            });

            return families;
        }

        function createFamilyTree(family, processedMembers) {
            // Mark parents and children as processed
            family.parents.forEach(p => processedMembers.add(p.id));
            family.children.forEach(c => processedMembers.add(c.id));

            const familyTree = {
                id: `family_${family.parents[0].id}`,
                name: family.name,
                generations: [
                    {
                        level: 0,
                        members: family.parents,
                        type: 'parents'
                    },
                    {
                        level: 1,
                        members: family.children,
                        type: 'children'
                    }
                ]
            };

            // Add grandchildren if any
            const grandchildren = [];
            family.children.forEach(child => {
                if (child.children && child.children.length > 0) {
                    child.children.forEach(grandchildId => {
                        const grandchild = familyMembers.find(m => m.id === grandchildId);
                        if (grandchild && !processedMembers.has(grandchild.id)) {
                            grandchildren.push(grandchild);
                            processedMembers.add(grandchild.id);
                        }
                    });
                }
            });

            if (grandchildren.length > 0) {
                familyTree.generations.push({
                    level: 2,
                    members: grandchildren,
                    type: 'grandchildren'
                });
            }

            return familyTree;
        }

        function findRemainingRoots(processedMembers) {
            return familyMembers.filter(member => {
                if (processedMembers.has(member.id)) return false;
                // Find people with no parents or whose parents aren't in the system
                return !member.parents || member.parents.length === 0 || 
                       !member.parents.some(parentId => familyMembers.find(m => m.id === parentId));
            });
        }

        function createSingleParentTree(rootMember, processedMembers) {
            if (processedMembers.has(rootMember.id)) return null;

            const familyTree = {
                id: `family_${rootMember.id}`,
                name: `${rootMember.firstName} ${rootMember.lastName} Family`,
                generations: []
            };

            // Add root generation
            const rootGeneration = [rootMember];
            if (rootMember.marriedTo) {
                const spouse = familyMembers.find(m => m.id === rootMember.marriedTo);
                if (spouse && !processedMembers.has(spouse.id)) {
                    rootGeneration.push(spouse);
                    processedMembers.add(spouse.id);
                }
            }

            familyTree.generations.push({
                level: 0,
                members: rootGeneration,
                type: 'parents'
            });

            processedMembers.add(rootMember.id);

            // Add children if any
            if (rootMember.children && rootMember.children.length > 0) {
                const children = rootMember.children
                    .map(id => familyMembers.find(m => m.id === id))
                    .filter(child => child && !processedMembers.has(child.id));

                if (children.length > 0) {
                    children.forEach(child => processedMembers.add(child.id));
                    familyTree.generations.push({
                        level: 1,
                        members: children,
                        type: 'children'
                    });
                }
            }

            return familyTree.generations.length > 1 ? familyTree : null;
        }

        // Display branches with auto-generated family trees - COMPLETELY REDESIGNED
        function displayBranches() {
            const branchesSection = document.getElementById('branchesGrid');
            if (!branchesSection) return;

            // Generate family trees from relationships
            const familyTrees = generateFamilyTrees();
            
            // Calculate visible stats (hide hidden families from non-developers)
            let visibleAutoTrees = familyTrees;
            let visibleManualTrees = manualFamilyTrees;
            let visibleVirtualFamilies = virtualFamilyGroups || [];
            
            // Debug logging
            console.log('Current user:', currentUser);
            console.log('Is developer?', currentUser?.isDeveloper);
            console.log('Hidden family IDs:', [...hiddenFamilyIds]);
            console.log('Total auto trees:', familyTrees.length);
            console.log('Total manual trees:', manualFamilyTrees.length);
            console.log('Total virtual families:', virtualFamilyGroups.length);
            
            // Filter families based on visibility
            if (currentUser?.username === 'dfinn12') {
                // dfinn12 sees all families (both hidden and visible)
                visibleAutoTrees = familyTrees;
                visibleManualTrees = manualFamilyTrees;
                visibleVirtualFamilies = virtualFamilyGroups;
                console.log('dfinn12 - showing all families including hidden ones');
            } else {
                // All other users only see non-hidden families
                visibleAutoTrees = familyTrees.filter(tree => {
                    const isHidden = hiddenFamilyIds.has(tree.id);
                    console.log(`Auto tree ${tree.id} (${tree.name}) - Hidden: ${isHidden}`);
                    return !isHidden;
                });
                visibleManualTrees = manualFamilyTrees.filter(tree => {
                    const isHidden = hiddenFamilyIds.has(tree.id);
                    console.log(`Manual tree ${tree.id} (${tree.name}) - Hidden: ${isHidden}`);
                    return !isHidden;
                });
                // Virtual families are not subject to hiding (they're only created by developers)
                visibleVirtualFamilies = virtualFamilyGroups;
                console.log('Non-developer - hiding hidden families from view');
            }
            
            console.log('Visible auto trees:', visibleAutoTrees.length);
            console.log('Visible manual trees:', visibleManualTrees.length);
            console.log('Visible virtual families:', visibleVirtualFamilies.length);
            
            const totalVisibleTrees = visibleAutoTrees.length + visibleManualTrees.length + visibleVirtualFamilies.length;
            
            // Create modern header
            const headerHtml = `
                <div class="family-groups-header">
                    <h2> Family Groups by Generation</h2>
                    <p>Organize your family into generational groups - perfect for grandparents to see everyone!</p>
                </div>
                
                <div class="family-stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalVisibleTrees}</div>
                        <div class="stat-label">Total Groups</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${familyMembers.length}</div>
                        <div class="stat-label">Total Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${visibleAutoTrees.reduce((sum, tree) => sum + (tree.generations ? tree.generations.length : 0), 0)}</div>
                        <div class="stat-label">Generations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${visibleManualTrees.length}</div>
                        <div class="stat-label">Memorial Trees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${visibleVirtualFamilies.length}</div>
                        <div class="stat-label">Created Groups</div>
                    </div>
                </div>
            `;

            // Create view controls
            const controlsHtml = `
                <div class="view-controls">
                    <button class="view-btn active" onclick="toggleModernDetailedView()">
                        <span class="icon"></span>
                        Detailed View
                    </button>
                    <button class="view-btn" onclick="toggleModernSmallView()">
                        <span class="icon"></span>
                        Quick View
                    </button>
                    <button class="view-btn" onclick="openManualFamilyCardModal()" style="background: #e74c3c; color: white; margin-left: 1rem;">
                        <span class="icon"></span>
                        Create Memorial Family
                    </button>
                    ${currentUser?.username === 'dfinn12' ? `
                        <button class="view-btn" onclick="openCreateFamilyGroupModal()" style="background: #667eea; color: white; margin-left: 0.5rem;">
                            <span class="icon"></span>
                            Create Family Group
                        </button>
                    ` : ''}
                </div>
            `;

            let contentHtml = '';

            if (visibleAutoTrees.length === 0 && visibleManualTrees.length === 0) {
                contentHtml = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                        <h3 style="color: #667eea; margin-bottom: 1rem;">No Family Trees Yet</h3>
                        <p style="color: #666; margin-bottom: 2rem;">Start building your family tree by adding family members!</p>
                        <button class="btn btn-primary" onclick="openAddMemberModal()">
                            <span style="margin-right: 0.5rem;"></span>
                            Add First Family Member
                        </button>
                    </div>
                `;
            } else {
                // Filter out any trees that might have issues from visible trees
                const validTrees = visibleAutoTrees.filter(tree => 
                    tree && tree.generations && tree.generations.length > 0 && 
                    tree.generations[0] && tree.generations[0].members && tree.generations[0].members.length > 0
                );
                
                // Render visible manual family trees
                const manualTreesHtml = visibleManualTrees.map(manualTree => renderManualFamilyCard(manualTree)).join('');
                const manualTreesSmallHtml = visibleManualTrees.map(manualTree => renderManualFamilySmallCard(manualTree)).join('');
                
                // Render visible virtual family groups
                const virtualFamilyHtml = (visibleVirtualFamilies && visibleVirtualFamilies.length > 0) ? 
                    visibleVirtualFamilies.map(virtualFamily => renderManualFamilyCard(virtualFamily)).join('') : '';
                const virtualFamilySmallHtml = (visibleVirtualFamilies && visibleVirtualFamilies.length > 0) ? 
                    visibleVirtualFamilies.map(virtualFamily => renderManualFamilySmallCard(virtualFamily)).join('') : '';
                
                contentHtml = `
                    <div id="detailedViewContent" class="family-tree-grid">
                        ${validTrees.map(tree => renderModernFamilyCard(tree)).join('')}
                        ${manualTreesHtml}
                        ${virtualFamilyHtml}
                    </div>
                    <div id="smallViewContent" class="small-view-modern" style="display: none;">
                        ${validTrees.map(tree => renderModernSmallCard(tree)).join('')}
                        ${manualTreesSmallHtml}
                        ${virtualFamilySmallHtml}
                    </div>
                `;
            }

            branchesSection.innerHTML = headerHtml + controlsHtml + contentHtml;
        }

        // Render modern detailed family card
        function renderModernFamilyCard(familyTree) {
            // Find the patriarch from the first generation
            const firstGeneration = familyTree.generations[0];
            if (!firstGeneration || !firstGeneration.members || firstGeneration.members.length === 0) {
                return ''; // Skip if no members
            }
            
            const patriarch = firstGeneration.members[0]; // First member of first generation
            
            // Calculate total members including in-laws
            let totalMembers = 0;
            const allInLaws = new Set();
            
            familyTree.generations.forEach(generation => {
                totalMembers += (generation.members ? generation.members.length : 0);
                
                // Count unique in-laws
                generation.members.forEach(member => {
                    if (member.marriedTo) {
                        const spouse = familyMembers.find(m => m.id === member.marriedTo);
                        if (spouse && !generation.members.find(m => m.id === spouse.id) && !allInLaws.has(spouse.id)) {
                            allInLaws.add(spouse.id);
                            totalMembers++;
                        }
                    }
                });
            });
            
            let generationsHtml = '';
            
            familyTree.generations.forEach((generation, index) => {
                if (!generation.members || generation.members.length === 0) return;
                
                const genIcon = getModernGenerationIcon(generation.type, index);
                const genTitle = getGenerationLabel(generation.type, index);
                
                // Build main generation members
                const membersHtml = generation.members.map(member => {
                    const age = getAge(member);
                    return `
                        <div class="member-pill" onclick="openEditMemberModal('${member.id}')">
                            <div class="member-name">${member.firstName} ${member.lastName}</div>
                            <div class="member-age">${age ? `Age ${age}` : 'Age unknown'}</div>
                        </div>
                    `;
                }).join('');
                
                // Build in-laws (spouses of generation members)
                const inLaws = [];
                const seenSpouses = new Set();
                generation.members.forEach(member => {
                    if (member.marriedTo) {
                        const spouse = familyMembers.find(m => m.id === member.marriedTo);
                        if (spouse && !seenSpouses.has(spouse.id) && !generation.members.find(m => m.id === spouse.id)) {
                            inLaws.push(spouse);
                            seenSpouses.add(spouse.id);
                        }
                    }
                });
                
                const inLawsHtml = inLaws.map(inLaw => {
                    const age = getAge(inLaw);
                    return `
                        <div class="member-pill" onclick="openEditMemberModal('${inLaw.id}')">
                            <div class="member-name">${inLaw.firstName} ${inLaw.lastName}</div>
                            <div class="member-age">${age ? `Age ${age}` : 'Age unknown'}</div>
                        </div>
                    `;
                }).join('');
                
                generationsHtml += `
                    <div class="generation-section">
                        <div class="generation-header">
                            <span class="generation-icon">${genIcon}</span>
                            <h4 class="generation-title">${genTitle}</h4>
                            <span class="generation-count">${generation.members.length}</span>
                        </div>
                        <div class="members-grid">
                            ${membersHtml}
                        </div>
                        ${inLaws.length > 0 ? `
                            <div class="generation-header" style="margin-top: 1rem;">
                                <span class="generation-icon"></span>
                                <h4 class="generation-title">In-Laws</h4>
                                <span class="generation-count">${inLaws.length}</span>
                            </div>
                            <div class="members-grid">
                                ${inLawsHtml}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            return `
                <div class="modern-family-card">
                    <div class="family-header">
                        <div>
                            <h3 class="family-title">${patriarch.firstName} ${patriarch.lastName} Family</h3>
                            <p class="family-subtitle">${totalMembers} members across ${familyTree.generations.length} generations</p>
                        </div>
                        <div class="family-icon"></div>
                    </div>
                    <div class="family-body">
                        ${generationsHtml}
                    </div>
                    <div class="family-actions">
                        <button class="action-btn primary" onclick="showFamilyDetail('${familyTree.id}')">
                            <span style="margin-right: 0.5rem;"></span>
                            View Details
                        </button>
                        <button class="action-btn secondary" onclick="openAddMemberModal()">
                            <span style="margin-right: 0.5rem;"></span>
                            Add Member
                        </button>
                        ${currentUser?.username === 'dfinn12' ? `
                            ${hiddenFamilyIds.has(familyTree.id) ? `
                                <button class="action-btn" onclick="unhideFamilyGroup('${familyTree.id}')" 
                                        style="background: #27ae60; color: white; border: 1px solid #27ae60;">
                                    <span style="margin-right: 0.5rem;"></span>
                                    Show
                                </button>
                            ` : `
                                <button class="action-btn" onclick="hideFamilyGroup('${familyTree.id}')" 
                                        style="background: #e74c3c; color: white; border: 1px solid #e74c3c;">
                                    <span style="margin-right: 0.5rem;"></span>
                                    Hide
                                </button>
                            `}
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Render modern small view card
        function renderModernSmallCard(familyTree) {
            // Find the patriarch from the first generation
            const firstGeneration = familyTree.generations[0];
            if (!firstGeneration || !firstGeneration.members || firstGeneration.members.length === 0) {
                return ''; // Skip if no members
            }
            
            const patriarch = firstGeneration.members[0]; // First member of first generation
            const totalMembers = familyTree.generations.reduce((sum, gen) => sum + (gen.members ? gen.members.length : 0), 0);
            const totalGenerations = familyTree.generations.length;
            
            return `
                <div class="small-family-card" onclick="showFamilyDetail('${familyTree.id}')">
                    <div class="small-family-icon"></div>
                    <div class="small-family-name">${patriarch.firstName} ${patriarch.lastName} Family</div>
                    <div class="small-family-stats">
                        <div class="small-stat">
                            <div class="small-stat-number">${totalMembers}</div>
                            <div class="small-stat-label">Members</div>
                        </div>
                        <div class="small-stat">
                            <div class="small-stat-number">${totalGenerations}</div>
                            <div class="small-stat-label">Generations</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render manual (memorial) family card - Updated to support virtual families
        function renderManualFamilyCard(manualTree) {
            // Handle both virtual and manual families
            const isVirtual = manualTree.isVirtual;
            const isCustom = manualTree.isCustom;
            const memberIds = manualTree.memberIds || [...(manualTree.parentIds || []), ...(manualTree.childrenIds || [])];
            
            // Get the actual member objects
            const members = memberIds.map(id => familyMembers.find(m => m.id === id)).filter(m => m);
            
            if (members.length === 0) return '';
            
            const totalMembers = members.length;
            const deceasedCount = members.filter(m => m.deceased).length;
            const livingCount = totalMembers - deceasedCount;
            
            // Get parents and children for virtual families
            const parents = isVirtual ? (manualTree.parentIds || []).map(id => familyMembers.find(m => m.id === id)).filter(m => m) : [];
            const children = isVirtual ? (manualTree.childrenIds || []).map(id => familyMembers.find(m => m.id === id)).filter(m => m) : [];
            
            const membersHtml = members.map(member => {
                const age = getAge(member);
                const isDeceased = member.deceased;
                const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #e8f5e8; color: #2d5a2d; border: 1px solid #b8e6b8;';
                const deceasedIcon = isDeceased ? ' ' : '';
                
                return `
                    <div class="member-pill" onclick="openEditMemberModal('${member.id}')" style="${deceasedStyle}">
                        <div class="member-name">${deceasedIcon}${member.firstName} ${member.lastName}</div>
                        <div class="member-age">${age ? `Age ${age}` : 'Age unknown'}</div>
                    </div>
                `;
            }).join('');

            // Virtual family styling
            const virtualStyle = isVirtual ? 'border: 3px solid #9c27b0; background: linear-gradient(135deg, #f3e5f5 0%, #fff 50%);' : 'border: 3px solid #e74c3c; background: linear-gradient(135deg, #ffe6e6 0%, #fff 50%);';
            const virtualIcon = isVirtual ? '' : '';
            const virtualColor = isVirtual ? '#9c27b0' : '#e74c3c';
            const familyTypeText = isVirtual ? `Virtual ${manualTree.type || 'Family'} Group` : 'Memorial Family';

            // Generate sections for virtual families
            let sectionsHtml = '';
            if (isVirtual && parents.length > 0) {
                const parentsHtml = parents.map(parent => {
                    const age = getAge(parent);
                    const isDeceased = parent.deceased;
                    const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #e8f5e8; color: #2d5a2d; border: 1px solid #b8e6b8;';
                    const deceasedIcon = isDeceased ? ' ' : '';
                    
                    return `
                        <div class="member-pill" onclick="openEditMemberModal('${parent.id}')" style="${deceasedStyle}">
                            <div class="member-name">${deceasedIcon}${parent.firstName} ${parent.lastName}</div>
                            <div class="member-age">${age ? `Age ${age}` : 'Age unknown'}</div>
                        </div>
                    `;
                }).join('');
                
                sectionsHtml += `
                    <div class="generation-section">
                        <div class="generation-header">
                            <span class="generation-icon"></span>
                            <h4 class="generation-title">Parents/Heads of Family</h4>
                            <span class="generation-count">${parents.length}</span>
                        </div>
                        <div class="members-grid">
                            ${parentsHtml}
                        </div>
                    </div>
                `;
            }
            
            if (isVirtual && children.length > 0) {
                const childrenHtml = children.map(child => {
                    const age = getAge(child);
                    const isDeceased = child.deceased;
                    const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #e8f5e8; color: #2d5a2d; border: 1px solid #b8e6b8;';
                    const deceasedIcon = isDeceased ? ' ' : '';
                    
                    return `
                        <div class="member-pill" onclick="openEditMemberModal('${child.id}')" style="${deceasedStyle}">
                            <div class="member-name">${deceasedIcon}${child.firstName} ${child.lastName}</div>
                            <div class="member-age">${age ? `Age ${age}` : 'Age unknown'}</div>
                        </div>
                    `;
                }).join('');
                
                sectionsHtml += `
                    <div class="generation-section">
                        <div class="generation-header">
                            <span class="generation-icon"></span>
                            <h4 class="generation-title">Children/Family Members</h4>
                            <span class="generation-count">${children.length}</span>
                        </div>
                        <div class="members-grid">
                            ${childrenHtml}
                        </div>
                    </div>
                `;
            }
            
            // For non-virtual families, show all members in one section
            if (!isVirtual) {
                sectionsHtml = `
                    <div class="generation-section">
                        <div class="generation-header">
                            <span class="generation-icon"></span>
                            <h4 class="generation-title">Family Members</h4>
                            <span class="generation-count">${totalMembers}</span>
                        </div>
                        <div class="members-grid">
                            ${membersHtml}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="modern-family-card" style="${virtualStyle} min-height: unset;">
                    <div class="family-header" style="padding: 1rem;">
                        <div>
                            <h3 class="family-title" style="color: ${virtualColor}; margin: 0 0 0.5rem 0; font-size: 1.1rem;">${isVirtual ? '' : ''} ${manualTree.name}</h3>
                            <p class="family-subtitle" style="margin: 0; font-size: 0.85rem;">${totalMembers} members  ${familyTypeText}</p>
                        </div>
                        <div class="family-icon" style="color: ${virtualColor}; font-size: 1.5rem;">${isVirtual ? '' : ''}</div>
                    </div>
                    <div class="family-body" style="padding: 0.75rem 1rem;">
                        <div style="margin-bottom: 0.75rem; font-size: 0.85rem;">
                            ${sectionsHtml}
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            ${deceasedCount > 0 ? ` ${deceasedCount} deceased` : ''} ${livingCount > 0 && deceasedCount > 0 ? '  ' : ''}${livingCount > 0 ? ` ${livingCount} living` : ''}
                        </div>
                    </div>
                    <div class="family-actions" style="padding: 0.75rem 1rem; gap: 0.5rem;">
                        <button class="action-btn" onclick="${isVirtual ? 'viewVirtualFamilyDetail' : 'viewManualFamilyDetail'}('${manualTree.id}')" style="background: ${virtualColor}; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; flex: 1;">
                             View
                        </button>
                        ${currentUser?.username === 'dfinn12' ? `
                            <button class="action-btn secondary" onclick="editManualFamily('${manualTree.id}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; flex: 1;">
                                 Edit
                            </button>
                            <button class="action-btn secondary" onclick="deleteManualFamily('${manualTree.id}')" style="background: #dc3545; color: white; padding: 0.4rem 0.8rem; font-size: 0.8rem; flex: 1;">
                                 Delete
                            </button>
                        ` : ''}
                        ${currentUser?.username === 'dfinn12' && hiddenFamilyIds.has(manualTree.id) ? `
                            <button class="action-btn" onclick="unhideFamilyGroup('${manualTree.id}')" 
                                    style="background: #27ae60; color: white; border: 1px solid #27ae60; padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                 Show
                            </button>
                        ` : ''}
                        ${currentUser?.username === 'dfinn12' && !hiddenFamilyIds.has(manualTree.id) ? `
                            <button class="action-btn secondary" onclick="hideFamilyGroup('${manualTree.id}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                 Hide
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Render manual family small card
        function renderManualFamilySmallCard(manualTree) {
            // Handle both virtual and manual families
            const isVirtual = manualTree.isVirtual;
            const memberIds = manualTree.memberIds || [...(manualTree.parentIds || []), ...(manualTree.childrenIds || [])];
            const members = memberIds.map(id => familyMembers.find(m => m.id === id)).filter(m => m);
            
            if (members.length === 0) return '';
            
            const totalMembers = members.length;
            const deceasedCount = members.filter(m => m.deceased).length;
            
            // Different styling for virtual vs manual families
            const cardStyle = isVirtual ? 
                'border: 2px solid #9c27b0; background: linear-gradient(135deg, #f3e5f5 0%, #fff 50%);' :
                'border: 2px solid #e74c3c; background: linear-gradient(135deg, #ffe6e6 0%, #fff 50%);';
            const iconColor = isVirtual ? '#9c27b0' : '#e74c3c';
            const icon = isVirtual ? '' : '';
            const namePrefix = isVirtual ? '' : '';
            
            return `
                <div class="small-family-card" onclick="${isVirtual ? 'viewVirtualFamilyDetail' : 'viewManualFamilyDetail'}('${manualTree.id}')" 
                     style="${cardStyle}">
                    <div class="small-family-icon" style="color: ${iconColor};">${icon}</div>
                    <div class="small-family-name">${namePrefix} ${manualTree.name}</div>
                    <div class="small-family-stats">
                        <div class="small-stat">
                            <div class="small-stat-number">${totalMembers}</div>
                            <div class="small-stat-label">Members</div>
                        </div>
                        <div class="small-stat">
                            <div class="small-stat-number">${deceasedCount}</div>
                            <div class="small-stat-label">Deceased</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get modern generation icons
        function getModernGenerationIcon(type, index) {
            if (type === 'patriarch' || type === 'matriarch') return '';
            if (type === 'spouse' || type.includes('spouse') || type.includes('spouses')) return '';
            if (type === 'children') return '';
            if (type === 'grandchildren') return '';
            if (type === 'great-grandchildren') return '';
            return '';
        }

        // Toggle functions for modern views
        window.toggleModernDetailedView = function() {
            document.getElementById('detailedViewContent').style.display = 'grid';
            document.getElementById('smallViewContent').style.display = 'none';
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
        };

        window.toggleModernSmallView = function() {
            document.getElementById('detailedViewContent').style.display = 'none';
            document.getElementById('smallViewContent').style.display = 'grid';
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
        };

        function renderCompactFamilyCard(familyTree) {
            // Get all generations and organize them
            const allGenerations = familyTree.generations;
            const patriarch = allGenerations.find(g => g.type === 'patriarch')?.members || [];
            const parents = allGenerations.find(g => g.type === 'parents')?.members || [];
            const children = allGenerations.find(g => g.type === 'children')?.members || [];
            const grandchildren = allGenerations.find(g => g.type === 'grandchildren')?.members || [];
            const greatGrandchildren = allGenerations.find(g => g.type === 'great-grandchildren')?.members || [];
            
            // Use patriarch as the main generation if available, otherwise use parents
            const mainGeneration = patriarch.length > 0 ? patriarch : parents;
            const mainGenerationLabel = patriarch.length > 0 ? 'Patriarch/Matriarch' : 'Parents';
            const mainGenerationIcon = patriarch.length > 0 ? '' : '';
            
            return `
                <div class="family-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 1rem; font-size: 1.1rem; text-align: center;">${familyTree.name}</h3>
                    
                    <!-- Main Generation (Patriarch or Parents) -->
                    ${mainGeneration.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${mainGenerationIcon} ${mainGenerationLabel} (${mainGeneration.length})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${mainGeneration.map(p => {
                                    const isDeceased = p.deceased;
                                    const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #f8f9ff; color: #667eea; border: 1px solid #e0e6ed;';
                                    const deceasedIcon = isDeceased ? ' ' : '';
                                    return `
                                    <span style="${deceasedStyle} padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                        ${deceasedIcon}${p.firstName} ${p.lastName} ${getAge(p) ? `(${getAge(p)})` : ''} ${p.marriedTo ? '' : ''}
                                    </span>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Children (only show if patriarch exists, otherwise this is the main generation) -->
                    ${children.length > 0 && patriarch.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                 Children (${children.length})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${children.map(c => {
                                    const isDeceased = c.deceased;
                                    const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #e8f5e8; color: #2d5a2d; border: 1px solid #b8e6b8;';
                                    const deceasedIcon = isDeceased ? ' ' : '';
                                    return `
                                    <span style="${deceasedStyle} padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                        ${deceasedIcon}${c.firstName} ${c.lastName} ${getAge(c) ? `(${getAge(c)})` : ''} ${c.marriedTo ? '' : ''}
                                    </span>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Show next generation as children if no patriarch -->
                    ${children.length > 0 && patriarch.length === 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                 Children (${children.length})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${children.map(c => {
                                    const isDeceased = c.deceased;
                                    const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #e8f5e8; color: #2d5a2d; border: 1px solid #b8e6b8;';
                                    const deceasedIcon = isDeceased ? ' ' : '';
                                    return `
                                    <span style="${deceasedStyle} padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                        ${deceasedIcon}${c.firstName} ${c.lastName} ${getAge(c) ? `(${getAge(c)})` : ''} ${c.marriedTo ? '' : ''}
                                    </span>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Grandchildren -->
                    ${grandchildren.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                 Grandchildren (${grandchildren.length})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${grandchildren.map(gc => {
                                    const isDeceased = gc.deceased;
                                    const deceasedStyle = isDeceased ? 'background: #ffebee; color: #c62828; border: 2px solid #e74c3c;' : 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;';
                                    const deceasedIcon = isDeceased ? ' ' : '';
                                    return `
                                    <span style="${deceasedStyle} padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                        ${deceasedIcon}${gc.firstName} ${gc.lastName} ${getAge(gc) ? `(${getAge(gc)})` : ''}
                                    </span>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Great-Grandchildren -->
                    ${greatGrandchildren.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                 Great-Grandchildren (${greatGrandchildren.length})
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${greatGrandchildren.map(ggc => `
                                    <span style="background: #f8d7da; color: #721c24; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem; border: 1px solid #f5c6cb;">
                                        ${ggc.firstName} ${ggc.lastName} ${getAge(ggc) ? `(${getAge(ggc)})` : ''}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
                        <button onclick="showDetailedFamily('${familyTree.id}')" style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                             View Tree
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDetailedFamilyTree(familyTree) {
            return `
                <div style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; text-align: center;">${familyTree.name}</h3>
                    
                    <div class="family-tree-container" style="overflow-x: auto; padding: 1rem;">
                        ${familyTree.generations.map((generation, index) => `
                            <div class="generation-${generation.type}" style="margin-bottom: 2rem;">
                                <h4 style="text-align: center; color: ${generation.type.includes('-spouses') ? '#e67e22' : '#666'}; margin-bottom: 1rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; ${generation.type.includes('-spouses') ? 'background: #fff8f0; padding: 0.5rem; border-radius: 8px; border: 1px solid #f39c12;' : ''}">
                                    ${generation.type.includes('-spouses') ? ' ' : ''}${getGenerationLabel(generation.type, index)}
                                </h4>
                                
                                <!-- Connection Lines -->
                                ${index > 0 && !generation.type.includes('-spouses') ? `
                                    <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                                        <div style="width: 2px; height: 2rem; background: #ddd;"></div>
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 1rem; ${generation.type.includes('-spouses') ? 'background: #fefcf8; padding: 1rem; border-radius: 10px; border: 1px dashed #f39c12;' : ''}">
                                    ${generation.members.map(member => renderFamilyMember(member, generation.type)).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getGenerationLabel(type, index) {
            const labels = {
                'patriarch': 'Patriarch/Matriarch',
                'parents': index === 0 ? 'Parents' : 'Ancestors',
                'children': 'Children',
                'children-spouses': 'In-Laws',
                'grandchildren': 'Grandchildren',
                'grandchildren-spouses': 'In-Laws',
                'great-grandchildren': 'Great-Grandchildren',
                'great-grandchildren-spouses': 'In-Laws',
                'spouse': 'In-Laws',
                'individual': 'Individual'
            };
            
            // Handle dynamic generation types
            if (type.startsWith('generation-')) {
                const parts = type.split('-');
                if (parts.length > 2 && parts[2] === 'spouses') {
                    return 'In-Laws';
                } else {
                    const genNum = parseInt(parts[1]);
                    return `Generation ${genNum}`;
                }
            }
            
            // Handle any spouse-related types
            if (type.includes('spouse') || type.includes('spouses')) {
                return 'In-Laws';
            }
            
            return labels[type] || `Generation ${index + 1}`;
        }

        // Toggle functions for view switching
        window.toggleCompactView = function() {
            document.getElementById('compactFamilyView').style.display = 'grid';
            document.getElementById('detailedFamilyView').style.display = 'none';
            document.getElementById('smallFamilyView').style.display = 'none';
            
            // Update button states
            const compactBtn = document.querySelector('button[onclick="toggleCompactView()"]');
            const detailedBtn = document.querySelector('button[onclick="toggleDetailedView()"]');
            const smallBtn = document.querySelector('button[onclick="toggleSmallView()"]');
            if (compactBtn && detailedBtn && smallBtn) {
                compactBtn.style.background = '#28a745';
                detailedBtn.style.background = '#6c757d';
                smallBtn.style.background = '#6c757d';
            }
        };

        window.toggleDetailedView = function() {
            document.getElementById('compactFamilyView').style.display = 'none';
            document.getElementById('detailedFamilyView').style.display = 'none';
            document.getElementById('smallFamilyView').style.display = 'none';
            document.getElementById('detailedFamilyView').style.display = 'grid';
            
            // Update button states
            const compactBtn = document.querySelector('button[onclick="toggleCompactView()"]');
            const detailedBtn = document.querySelector('button[onclick="toggleDetailedView()"]');
            const smallBtn = document.querySelector('button[onclick="toggleSmallView()"]');
            if (compactBtn && detailedBtn && smallBtn) {
                compactBtn.style.background = '#6c757d';
                detailedBtn.style.background = '#007bff';
                smallBtn.style.background = '#6c757d';
            }
        };

        window.toggleSmallView = function() {
            document.getElementById('compactFamilyView').style.display = 'none';
            document.getElementById('detailedFamilyView').style.display = 'none';
            document.getElementById('smallFamilyView').style.display = 'block';
            
            // Update button states
            const compactBtn = document.querySelector('button[onclick="toggleCompactView()"]');
            const detailedBtn = document.querySelector('button[onclick="toggleDetailedView()"]');
            const smallBtn = document.querySelector('button[onclick="toggleSmallView()"]');
            if (compactBtn && detailedBtn && smallBtn) {
                compactBtn.style.background = '#6c757d';
                detailedBtn.style.background = '#6c757d';
                smallBtn.style.background = '#6f42c1';
            }
            
            // Render small view content
            renderSmallView();
        };

        window.showDetailedFamily = function(familyId) {
            // Switch to detailed view and scroll to family
            toggleDetailedView();
            // Optional: scroll to specific family if needed
            setTimeout(() => {
                const element = document.getElementById(familyId);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };

        // Render small view with family buttons
        function renderSmallView() {
            const familyTrees = generateFamilyTrees();
            const smallViewContainer = document.querySelector('#smallFamilyView .small-view-grid');
            
            if (!smallViewContainer) return;
            
            smallViewContainer.innerHTML = familyTrees.map(tree => {
                // Calculate total member count across all generations
                const memberCount = tree.generations.reduce((total, generation) => {
                    return total + (generation.members ? generation.members.length : 0);
                }, 0);
                
                const familyName = tree.name || `${tree.patriarch?.firstName || 'Unknown'} Family`;
                
                return `
                    <button class="small-view-family-btn" onclick="showFamilyDetail('${tree.id || tree.patriarch?.id}')">
                        <div class="family-name"> ${familyName}</div>
                        <div class="member-count">${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
                    </button>
                `;
            }).join('');
        }

        // Show detailed family information in modal - MODERN REDESIGN
        window.showFamilyDetail = function(familyId) {
            const familyTrees = generateFamilyTrees();
            const familyTree = familyTrees.find(tree => tree.id === familyId);
            
            if (!familyTree || !familyTree.generations || familyTree.generations.length === 0) {
                console.error('Family tree not found or empty for ID:', familyId);
                return;
            }
            
            // Find the patriarch from the first generation
            const firstGeneration = familyTree.generations[0];
            if (!firstGeneration || !firstGeneration.members || firstGeneration.members.length === 0) {
                console.error('No members found in first generation');
                return;
            }
            
            const patriarch = firstGeneration.members[0];
            const totalMembers = familyTree.generations.reduce((sum, gen) => sum + (gen.members ? gen.members.length : 0), 0);
            
            let modalContent = `
                <div class="family-groups-header" style="margin-bottom: 2rem;">
                    <h2> ${patriarch.firstName} ${patriarch.lastName} Family Tree</h2>
                    <p>${totalMembers} members across ${familyTree.generations.length} generations</p>
                </div>
                
                <div class="family-stats" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number">${totalMembers}</div>
                        <div class="stat-label">Total Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${familyTree.generations.length}</div>
                        <div class="stat-label">Generations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${familyTree.generations.reduce((sum, gen) => sum + (gen.members ? gen.members.filter(m => !m.deceased).length : 0), 0)}</div>
                        <div class="stat-label">Living Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round(familyTree.generations.reduce((sum, gen) => sum + (gen.members ? gen.members.reduce((genSum, m) => genSum + getAge(m), 0) : 0), 0) / totalMembers) || 0}</div>
                        <div class="stat-label">Average Age</div>
                    </div>
                </div>
            `;
            
            familyTree.generations.forEach((generation, index) => {
                if (!generation.members || generation.members.length === 0) return;
                
                const genIcon = getModernGenerationIcon(generation.type, index);
                const genTitle = getGenerationLabel(generation.type, index);
                
                modalContent += `
                    <div class="generation-section" style="margin-bottom: 2rem;">
                        <div class="generation-header">
                            <span class="generation-icon">${genIcon}</span>
                            <h4 class="generation-title">${genTitle}</h4>
                            <span class="generation-count">${generation.members.length}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            ${generation.members.map(member => {
                                const age = getAge(member);
                                const spouseText = member.marriedTo ? ` (Married to ${getSpouseName(member.marriedTo)})` : '';
                                const deceasedStyle = member.deceased ? 'border: 3px solid #e74c3c; background: #ffebee;' : '';
                                const deceasedIcon = member.deceased ? ' ' : '';
                                
                                return `
                                    <div style="background: white; border: 2px solid #f0f0f0; border-radius: 15px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s; ${deceasedStyle}" onclick="openEditMemberModal('${member.id}')">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${member.deceased ? '' : ''}</div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 0.5rem;">
                                            ${deceasedIcon}${member.firstName} ${member.lastName}
                                        </div>
                                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                            ${age ? `Age ${age}` : 'Age unknown'}
                                        </div>
                                        ${spouseText ? `<div style="color: #667eea; font-size: 0.85rem; font-style: italic;">${spouseText}</div>` : ''}
                                        ${member.children && member.children.length > 0 ? `<div style="color: #28a745; font-size: 0.8rem; margin-top: 0.5rem;"> ${member.children.length} child${member.children.length !== 1 ? 'ren' : ''}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            modalContent += `
                <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                    <button class="btn btn-primary" onclick="openAddMemberModal()" style="margin-right: 1rem;">
                        <span style="margin-right: 0.5rem;"></span>
                        Add Family Member
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('familyDetailModal')">
                        <span style="margin-right: 0.5rem;"></span>
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('familyDetailModal').querySelector('.modal-content').innerHTML = modalContent;
            document.getElementById('familyDetailModal').classList.add('active');
        };

        function renderFamilyMember(member, generationType) {
            const isMarried = member.marriedTo;
            const hasChildren = member.children && member.children.length > 0;
            const marriageIcon = isMarried ? '' : '';
            const isDeceased = member.deceased;
            const deceasedStyle = isDeceased ? 'border: 4px solid #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.5);' : '';
            const backgroundColor = isDeceased ? 'background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);' : 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
            
            return `
                <div class="family-member-node" style="text-align: center; position: relative; margin: 0 1rem;">
                    <div style="
                        ${backgroundColor}
                        color: white;
                        padding: 1rem;
                        border-radius: 50%;
                        width: 100px;
                        height: 100px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 0.5rem;
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        cursor: pointer;
                        position: relative;
                        ${deceasedStyle}
                    " onclick="openEditMemberModal('${member.id}')">
                        <div style="text-align: center; font-size: 0.8rem; line-height: 1.2;">
                            <div style="font-weight: bold;">${isDeceased ? ' ' : ''}${member.firstName}</div>
                            <div>${member.lastName}</div>
                        </div>
                        ${marriageIcon ? `
                            <div style="position: absolute; top: -5px; right: -5px; background: #27ae60; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                ${marriageIcon}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="font-size: 0.9rem; color: #333; font-weight: 600; margin-bottom: 0.25rem;">
                        ${member.firstName} ${member.lastName}
                    </div>
                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.5rem;">
                        Age: ${getAge(member)}
                    </div>
                    
                    ${hasChildren ? `
                        <div style="font-size: 0.7rem; color: #28a745; font-weight: 500;">
                             ${member.children.length} child${member.children.length === 1 ? '' : 'ren'}
                        </div>
                    ` : ''}
                </div>
            `;
        }



        // Helper functions for branch display
        function getBranchColor(generationLevel) {
            const colors = {
                1: '#8e24aa', // Purple for grandparents
                2: '#1976d2', // Blue for parents  
                3: '#388e3c', // Green for children
                4: '#f57c00'  // Orange for grandchildren
            };
            return colors[generationLevel] || '#666';
        }

        function getGenerationIcon(generationLevel) {
            const icons = {
                1: '', // Grandparents
                2: '', // Parents  
                3: '', // Children
                4: ''   // Grandchildren
            };
            return icons[generationLevel] || '';
        }

        function getBranchTypeIcon(branchType) {
            const icons = {
                'nuclear_family': '',
                'extended_family': '',
                'cousin_branch': '',
                'grandparent_branch': ''
            };
            return icons[branchType] || '';
        }

        function formatBranchType(branchType) {
            const types = {
                'nuclear_family': 'Nuclear Family',
                'extended_family': 'Extended Family', 
                'cousin_branch': 'Cousin Branch',
                'grandparent_branch': 'Grandparent Branch'
            };
            return types[branchType] || 'Family Branch';
        }

        // Helper function to get potential parents for new member (anyone who could be a parent)
        function getPotentialParentsForNew() {
            return familyMembers.filter(member => {
                const memberAge = getAge(member);
                return memberAge >= 15; // Must be at least 15 to be a parent
            }).sort((a, b) => getAge(b) - getAge(a)); // Sort by age, oldest first
        }

        // Helper function to get potential children for new member (anyone who could be a child)
        function getPotentialChildrenForNew() {
            return familyMembers.filter(member => {
                const memberAge = getAge(member);
                return memberAge >= 0; // Anyone can be a child
            }).sort((a, b) => getAge(a) - getAge(b)); // Sort by age, youngest first
        }

        // Helper function to get potential parents (older than the member)
        function getPotentialParents(currentMember) {
            const currentAge = getAge(currentMember);
            return familyMembers
                .filter(fm => {
                    if (fm.id === currentMember.id) return false;
                    const parentAge = getAge(fm);
                    // Parents should be at least 15 years older (reasonable minimum)
                    return parentAge >= currentAge + 15;
                })
                .sort((a, b) => getAge(b) - getAge(a)); // Oldest first
        }

        // Helper function to get potential children (younger than the member)
        function getPotentialChildren(currentMember) {
            const currentAge = getAge(currentMember);
            return familyMembers
                .filter(fm => {
                    if (fm.id === currentMember.id) return false;
                    const childAge = getAge(fm);
                    // Children should be at least 15 years younger (reasonable minimum)
                    return childAge <= currentAge - 15;
                })
                .sort((a, b) => getAge(a) - getAge(b)); // Youngest first
        }

        // Helper functions for age and birthday calculations
        function getAge(member) {
            if (!member.birthYear || !member.birthMonth || !member.birthDay) return 0;
            
            const today = new Date();
            const birthDate = new Date(member.birthYear, getMonthIndex(member.birthMonth), member.birthDay);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function getNextBirthday(member) {
            if (!member.birthMonth || !member.birthDay) return new Date(9999, 11, 31); // Return far future date for invalid data
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const monthIndex = getMonthIndex(member.birthMonth);
            
            // Create birthday for this year
            let nextBirthday = new Date(currentYear, monthIndex, member.birthDay);
            
            // If the birthday this year has already passed, move to next year
            if (nextBirthday <= today) {
                nextBirthday = new Date(currentYear + 1, monthIndex, member.birthDay);
            }
            
            return nextBirthday;
        }

        function getMonthIndex(monthName) {
            const months = {
                'January': 0, 'February': 1, 'March': 2, 'April': 3,
                'May': 4, 'June': 5, 'July': 6, 'August': 7,
                'September': 8, 'October': 9, 'November': 10, 'December': 11
            };
            return months[monthName] || 0;
        }

        // Display users (admin only)
        function displayUsers() {
            if (!currentUser.isAdmin) return;
            
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = users.map(user => `
                <div class="family-card">
                    <h3>${user.fullName || user.username}</h3>
                    <div class="family-info">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Email:</strong> ${user.email || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${user.phone || 'N/A'}</div>
                        <div><strong>Admin:</strong> ${user.isAdmin ? 'Yes' : 'No'}</div>
                        <div><strong>Created:</strong> ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Display account requests (admin only)
        function displayAccountRequests() {
            if (!currentUser.isAdmin) return;
            
            const grid = document.getElementById('requestsGrid');
            const stats = document.getElementById('requestsStats');
            
            const pendingRequests = accountRequests.filter(req => req.status === 'pending');
            
            stats.innerHTML = `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 10px; border-left: 4px solid #2196f3;">
                    <strong> Statistics:</strong> 
                    ${pendingRequests.length} pending requests | 
                    ${accountRequests.filter(req => req.status === 'approved').length} approved | 
                    ${deniedAccounts.length} denied
                </div>
            `;
            
            if (pendingRequests.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><h3>No pending requests</h3><p>All account requests have been processed.</p></div>';
                return;
            }
            
            grid.innerHTML = pendingRequests.map(request => `
                <div class="family-card" style="border-left: 4px solid #ff9800;">
                    <h3> ${request.firstName} ${request.lastName}</h3>
                    <div class="family-info">
                        <div><strong>Username:</strong> ${request.username}</div>
                        <div><strong>Name:</strong> ${request.firstName} ${request.lastName}</div>
                        <div><strong>Requested:</strong> ${new Date(request.requestDate).toLocaleDateString()}</div>
                        <div><strong>Status:</strong> <span style="color: #ff9800; font-weight: bold;">Pending</span></div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="approveRequest('${request.id}', '${request.username}', '${request.password}', '${request.firstName}', '${request.lastName}')"> Approve</button>
                        <button class="btn btn-danger" onclick="denyRequest('${request.id}', '${request.username}')"> Deny</button>
                    </div>
                </div>
            `).join('');
        }

        // Update requests badge
        function updateRequestsBadge() {
            if (!currentUser.isAdmin) return;
            
            const badge = document.getElementById('requestsBadge');
            const mobileBadge = document.getElementById('requestsBadgeMobile');
            const pendingCount = accountRequests.filter(req => req.status === 'pending').length;
            
            if (pendingCount > 0) {
                if (badge) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-block';
                }
                if (mobileBadge) {
                    mobileBadge.textContent = pendingCount;
                    mobileBadge.style.display = 'inline-block';
                }
            } else {
                if (badge) badge.style.display = 'none';
                if (mobileBadge) mobileBadge.style.display = 'none';
            }
        }

        // Display messages
        // Global variables for message filtering
        let currentMessageTab = 'public';
        let filteredMessages = [];
        let allAuthors = new Set();

        function displayMessages() {
            console.log('=== DEBUG: Current User Info ===');
            console.log('currentUser:', currentUser);
            console.log('currentUser.username:', currentUser?.username);
            console.log('currentUser.isAdmin:', currentUser?.isAdmin);
            console.log('messages:', messages.map(m => ({ id: m.id, author: m.author })));
            filterMessages(); // This will handle the actual display
        }

        window.switchMessageTab = function(tab) {
            currentMessageTab = tab;
            
            // Update tab appearance
            document.querySelectorAll('.message-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab === 'public' ? 'publicTab' : 'myPostsTab').classList.add('active');
            
            filterMessages();
        }

        window.filterMessages = function() {
            const searchTerm = document.getElementById('messageSearch')?.value.toLowerCase() || '';
            const authorFilter = document.getElementById('authorFilter')?.value || '';
            const sortOrder = document.getElementById('sortOrder')?.value || 'newest';
            
            // Filter messages based on current tab
            let tabFilteredMessages = messages.filter(message => {
                if (currentMessageTab === 'my-posts') {
                    return message.author === currentUser.username;
                }
                return true; // public shows all messages
            });
            
            // Apply search and author filters
            filteredMessages = tabFilteredMessages.filter(message => {
                const matchesSearch = !searchTerm || 
                    message.content.toLowerCase().includes(searchTerm) ||
                    message.author.toLowerCase().includes(searchTerm) ||
                    (message.title && message.title.toLowerCase().includes(searchTerm));
                
                const matchesAuthor = !authorFilter || message.author === authorFilter;
                
                return matchesSearch && matchesAuthor;
            });
            
            // Sort messages
            filteredMessages.sort((a, b) => {
                switch (sortOrder) {
                    case 'oldest':
                        return a.createdAt.seconds - b.createdAt.seconds;
                    case 'author':
                        return a.author.localeCompare(b.author);
                    case 'newest':
                    default:
                        return b.createdAt.seconds - a.createdAt.seconds;
                }
            });
            
            renderMessages();
            updateTabCounts();
            updateAuthorFilter();
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            const placeholder = document.getElementById('noMessagesPlaceholder');
            
            console.log(' DEBUG: renderMessages called');
            console.log('Current user:', currentUser);
            
            if (filteredMessages.length === 0) {
                container.innerHTML = '';
                placeholder.style.display = 'block';
                return;
            }
            
            placeholder.style.display = 'none';
            container.innerHTML = filteredMessages.map(message => {
                console.log(` DEBUG: Rendering message by ${message.author}, current user: ${currentUser ? currentUser.username : 'null'}, isAdmin: ${currentUser ? currentUser.isAdmin : 'null'}`);
                const canDelete = currentUser.isAdmin || message.author === currentUser.username;
                console.log(` DEBUG: Can delete message: ${canDelete}`);
                
                return `
                <div class="message" id="message-${message.id}">
                    <div class="message-header">
                        <span class="message-author"> ${message.author}</span>
                        <span class="message-date">${formatRelativeTime(message.createdAt.seconds * 1000)}</span>
                    </div>
                    ${message.title ? `<h4 style="margin: 0.5rem 0; color: #333; font-size: 1.2rem;">${message.title}</h4>` : ''}
                    <div class="message-content">${message.content}</div>
                    ${message.imageUrl ? `
                        <div class="message-image">
                            <img src="${message.imageUrl}" 
                                 alt="Message photo" 
                                 onclick="openImageModal('${message.imageUrl}', '${message.title || 'Message Photo'}')">
                        </div>
                    ` : ''}
                    
                    <!-- Message Interactions -->
                    <div class="message-interactions">
                        <button class="interaction-btn" onclick="toggleComments('${message.id}')">
                             <span id="comment-count-${message.id}">${(message.comments || []).length}</span> Comments
                        </button>
                        <button class="interaction-btn" onclick="showAddComment('${message.id}')">
                             Add Comment
                        </button>
                        ${canDelete ? `
                            <button class="interaction-btn delete-btn" onclick="deleteMessage('${message.id}')">
                                 Delete
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Add Comment Form (Initially Hidden) -->
                    <div class="add-comment-form" id="add-comment-${message.id}" style="display: none;">
                        <div class="comment-input-container">
                            <textarea placeholder="Write a comment..." id="comment-text-${message.id}" rows="2"></textarea>
                            <div class="comment-actions">
                                <button class="btn btn-primary btn-sm" onclick="addComment('${message.id}')">Post Comment</button>
                                <button class="btn btn-secondary btn-sm" onclick="hideAddComment('${message.id}')">Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="comments-section" id="comments-${message.id}" style="display: none;">
                        <div class="comments-list" id="comments-list-${message.id}">
                            ${renderComments(message.comments || [], message.id)}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateTabCounts() {
            const publicCount = messages.length;
            const myPostsCount = messages.filter(m => m.author === currentUser.username).length;
            
            const publicCountElement = document.getElementById('publicCount');
            const myPostsCountElement = document.getElementById('myPostsCount');
            
            if (publicCountElement) publicCountElement.textContent = publicCount;
            if (myPostsCountElement) myPostsCountElement.textContent = myPostsCount;
        }

        function updateAuthorFilter() {
            const authorSelect = document.getElementById('authorFilter');
            if (!authorSelect) return;
            
            // Get unique authors
            allAuthors = new Set(messages.map(m => m.author));
            
            // Save current selection
            const currentSelection = authorSelect.value;
            
            // Clear and rebuild options
            authorSelect.innerHTML = '<option value=""> All Authors</option>';
            
            Array.from(allAuthors).sort().forEach(author => {
                const option = document.createElement('option');
                option.value = author;
                option.textContent = author;
                authorSelect.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (Array.from(allAuthors).includes(currentSelection)) {
                authorSelect.value = currentSelection;
            }
        }

        function formatRelativeTime(timestamp) {
            const now = new Date();
            const messageTime = new Date(timestamp);
            const diffInSeconds = Math.floor((now - messageTime) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} hour${hours === 1 ? '' : 's'} ago`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} day${days === 1 ? '' : 's'} ago`;
            } else {
                return messageTime.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        // Render comments with nested replies
        function renderComments(comments, messageId) {
            if (!comments || comments.length === 0) {
                return '<div class="no-comments">No comments yet. Be the first to comment!</div>';
            }
            
            // Find the post author to enable post-level moderation
            const post = messages.find(m => m.id === messageId);
            const isPostAuthor = post && post.author === currentUser.username;
            
            return comments.map(comment => {
                // Check if comment is hidden (only show to post author and comment author)
                const isHidden = comment.hidden === true;
                const canSeeHiddenComment = isPostAuthor || comment.author === currentUser.username || currentUser.isAdmin;
                
                // Skip hidden comments for users who can't see them
                if (isHidden && !canSeeHiddenComment) {
                    return '';
                }
                
                return `
                <div class="comment ${isHidden ? 'comment-hidden' : ''}" id="comment-${comment.id}">
                    ${isHidden ? '<div class="hidden-indicator"> This comment is hidden</div>' : ''}
                    <div class="comment-header">
                        <span class="comment-author"> ${comment.author}</span>
                        <span class="comment-date">${formatRelativeTime(comment.createdAt.seconds * 1000)}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        <button class="comment-action-btn" onclick="showReplyForm('${comment.id}', '${messageId}')">
                             Reply
                        </button>
                        
                        <!-- Comment Author Controls -->
                        ${comment.author === currentUser.username ? `
                            <button class="comment-action-btn delete-btn" onclick="deleteComment('${messageId}', '${comment.id}')">
                                 Delete
                            </button>
                        ` : ''}
                        
                        <!-- Post Author Moderation Controls -->
                        ${isPostAuthor && comment.author !== currentUser.username ? `
                            <button class="comment-action-btn moderate-btn" onclick="toggleCommentVisibility('${messageId}', '${comment.id}', ${!isHidden})">
                                ${isHidden ? ' Show' : ' Hide'}
                            </button>
                        ` : ''}
                        
                        <!-- Admin Controls -->
                        ${currentUser.isAdmin && comment.author !== currentUser.username ? `
                            <button class="comment-action-btn delete-btn" onclick="deleteComment('${messageId}', '${comment.id}')">
                                 Admin Delete
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Reply Form (Initially Hidden) -->
                    <div class="reply-form" id="reply-form-${comment.id}" style="display: none;">
                        <div class="reply-input-container">
                            <textarea placeholder="Write a reply to ${comment.author}..." id="reply-text-${comment.id}" rows="2"></textarea>
                            <div class="reply-actions">
                                <button class="btn btn-primary btn-sm" onclick="addReply('${messageId}', '${comment.id}')">Post Reply</button>
                                <button class="btn btn-secondary btn-sm" onclick="hideReplyForm('${comment.id}')">Cancel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Replies Section -->
                    ${comment.replies && comment.replies.length > 0 ? `
                        <div class="replies-section">
                            ${comment.replies.map(reply => {
                                // Check if reply is hidden
                                const isReplyHidden = reply.hidden === true;
                                const canSeeHiddenReply = isPostAuthor || reply.author === currentUser.username || currentUser.isAdmin;
                                
                                // Skip hidden replies for users who can't see them
                                if (isReplyHidden && !canSeeHiddenReply) {
                                    return '';
                                }
                                
                                return `
                                <div class="reply ${isReplyHidden ? 'reply-hidden' : ''}">
                                    ${isReplyHidden ? '<div class="hidden-indicator"> This reply is hidden</div>' : ''}
                                    <div class="reply-header">
                                        <span class="reply-author"> ${reply.author}</span>
                                        <span class="reply-date">${formatRelativeTime(reply.createdAt.seconds * 1000)}</span>
                                    </div>
                                    <div class="reply-content">${reply.content}</div>
                                    <div class="reply-actions">
                                        <!-- Reply Author Controls -->
                                        ${reply.author === currentUser.username ? `
                                            <button class="comment-action-btn delete-btn" onclick="deleteReply('${messageId}', '${comment.id}', '${reply.id}')">
                                                 Delete
                                            </button>
                                        ` : ''}
                                        
                                        <!-- Post Author Moderation Controls -->
                                        ${isPostAuthor && reply.author !== currentUser.username ? `
                                            <button class="comment-action-btn moderate-btn" onclick="toggleReplyVisibility('${messageId}', '${comment.id}', '${reply.id}', ${!isReplyHidden})">
                                                ${isReplyHidden ? ' Show' : ' Hide'}
                                            </button>
                                        ` : ''}
                                        
                                        <!-- Admin Controls -->
                                        ${currentUser.isAdmin && reply.author !== currentUser.username ? `
                                            <button class="comment-action-btn delete-btn" onclick="deleteReply('${messageId}', '${comment.id}', '${reply.id}')">
                                                 Admin Delete
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        // Comment interaction functions
        window.toggleComments = function(messageId) {
            const commentsSection = document.getElementById(`comments-${messageId}`);
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
            } else {
                commentsSection.style.display = 'none';
            }
        }

        window.showAddComment = function(messageId) {
            const addCommentForm = document.getElementById(`add-comment-${messageId}`);
            addCommentForm.style.display = 'block';
            document.getElementById(`comment-text-${messageId}`).focus();
        }

        window.hideAddComment = function(messageId) {
            const addCommentForm = document.getElementById(`add-comment-${messageId}`);
            addCommentForm.style.display = 'none';
            document.getElementById(`comment-text-${messageId}`).value = '';
        }

        window.showReplyForm = function(commentId, messageId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'block';
            document.getElementById(`reply-text-${commentId}`).focus();
        }

        window.hideReplyForm = function(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = 'none';
            document.getElementById(`reply-text-${commentId}`).value = '';
        }

        // Add comment to a message
        window.addComment = async function(messageId) {
            const commentText = document.getElementById(`comment-text-${messageId}`).value.trim();
            
            if (!commentText) {
                alert('Please enter a comment');
                return;
            }
            
            try {
                // Find the message in our local array
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) {
                    alert('Message not found');
                    return;
                }
                
                const newComment = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    author: currentUser.username,
                    content: commentText,
                    createdAt: { seconds: Math.floor(Date.now() / 1000) },
                    replies: []
                };
                
                // Update local message
                if (!messages[messageIndex].comments) {
                    messages[messageIndex].comments = [];
                }
                messages[messageIndex].comments.push(newComment);
                
                // Update Firebase
                const messageRef = doc(db, 'messages', messageId);
                await updateDoc(messageRef, {
                    comments: messages[messageIndex].comments
                });
                
                // Hide the comment form and refresh display
                hideAddComment(messageId);
                renderMessages();
                
                // Show the comments section
                document.getElementById(`comments-${messageId}`).style.display = 'block';
                
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Error adding comment: ' + error.message);
            }
        }

        // Add reply to a comment
        window.addReply = async function(messageId, commentId) {
            const replyText = document.getElementById(`reply-text-${commentId}`).value.trim();
            
            if (!replyText) {
                alert('Please enter a reply');
                return;
            }
            
            try {
                // Find the message and comment
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) {
                    alert('Message not found');
                    return;
                }
                
                const commentIndex = messages[messageIndex].comments.findIndex(c => c.id === commentId);
                if (commentIndex === -1) {
                    alert('Comment not found');
                    return;
                }
                
                const newReply = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    author: currentUser.username,
                    content: replyText,
                    createdAt: { seconds: Math.floor(Date.now() / 1000) }
                };
                
                // Update local comment
                if (!messages[messageIndex].comments[commentIndex].replies) {
                    messages[messageIndex].comments[commentIndex].replies = [];
                }
                messages[messageIndex].comments[commentIndex].replies.push(newReply);
                
                // Update Firebase
                const messageRef = doc(db, 'messages', messageId);
                await updateDoc(messageRef, {
                    comments: messages[messageIndex].comments
                });
                
                // Hide the reply form and refresh display
                hideReplyForm(commentId);
                renderMessages();
                
                // Ensure comments section is visible
                document.getElementById(`comments-${messageId}`).style.display = 'block';
                
            } catch (error) {
                console.error('Error adding reply:', error);
                alert('Error adding reply: ' + error.message);
            }
        }

        // Delete comment
        window.deleteComment = async function(messageId, commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            try {
                // Find the message
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) {
                    alert('Message not found');
                    return;
                }
                
                // Remove comment from local array
                messages[messageIndex].comments = messages[messageIndex].comments.filter(c => c.id !== commentId);
                
                // Update Firebase
                const messageRef = doc(db, 'messages', messageId);
                await updateDoc(messageRef, {
                    comments: messages[messageIndex].comments
                });
                
                // Refresh display
                renderMessages();
                
                // Keep comments section open if there are still comments
                if (messages[messageIndex].comments.length > 0) {
                    document.getElementById(`comments-${messageId}`).style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment: ' + error.message);
            }
        }

        // Delete reply
        window.deleteReply = async function(messageId, commentId, replyId) {
            if (!confirm('Are you sure you want to delete this reply?')) {
                return;
            }
            
            try {
                // Find the message and comment
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) {
                    alert('Message not found');
                    return;
                }
                
                const commentIndex = messages[messageIndex].comments.findIndex(c => c.id === commentId);
                if (commentIndex === -1) {
                    alert('Comment not found');
                    return;
                }
                
                // Remove reply from local array
                messages[messageIndex].comments[commentIndex].replies = 
                    messages[messageIndex].comments[commentIndex].replies.filter(r => r.id !== replyId);
                
                // Update Firebase
                const messageRef = doc(db, 'messages', messageId);
                await updateDoc(messageRef, {
                    comments: messages[messageIndex].comments
                });
                
                // Refresh display
                renderMessages();
                
                // Keep comments section open
                document.getElementById(`comments-${messageId}`).style.display = 'block';
                
            } catch (error) {
                console.error('Error deleting reply:', error);
                alert('Error deleting reply: ' + error.message);
            }
        }

        // Toggle comment visibility (hide/show for post authors)
        window.toggleCommentVisibility = async function(messageId, commentId, hide) {
            try {
                // Find the message
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) {
                    alert('Message not found');
                    return;
                }
                
                // Find the comment
                const commentIndex = messages[messageIndex].comments.findIndex(c => c.id === commentId);
                if (commentIndex === -1) {
                    alert('Comment not found');
                    return;
                }
                
                // Verify user is post author or admin
                const post = messages[messageIndex];
                if (post.author !== currentUser.username && !currentUser.isAdmin) {
                    alert('You can only moderate comments on your own posts');
                    return;
                }
                
                // Update comment visibility
                messages[messageIndex].comments[commentIndex].hidden = hide;
                
                // Update Firebase
                const messageRef = doc(db, 'messages', messageId);
                await updateDoc(messageRef, {
                    comments: messages[messageIndex].comments
                });
                
                // Refresh display
                renderMessages();
                
                // Keep comments section open
                document.getElementById(`comments-${messageId}`).style.display = 'block';
                
                console.log(`Comment ${hide ? 'hidden' : 'shown'} by post author`);
                
            } catch (error) {
                console.error('Error toggling comment visibility:', error);
                alert('Error updating comment visibility: ' + error.message);
            }
        }

        // Toggle reply visibility (hide/show for post authors)
        window.toggleReplyVisibility = async function(messageId, commentId, replyId, hide) {
            try {
                // Find the message and comment
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex === -1) {
                    alert('Message not found');
                    return;
                }
                
                const commentIndex = messages[messageIndex].comments.findIndex(c => c.id === commentId);
                if (commentIndex === -1) {
                    alert('Comment not found');
                    return;
                }
                
                const replyIndex = messages[messageIndex].comments[commentIndex].replies.findIndex(r => r.id === replyId);
                if (replyIndex === -1) {
                    alert('Reply not found');
                    return;
                }
                
                // Verify user is post author or admin
                const post = messages[messageIndex];
                if (post.author !== currentUser.username && !currentUser.isAdmin) {
                    alert('You can only moderate replies on your own posts');
                    return;
                }
                
                // Update reply visibility
                messages[messageIndex].comments[commentIndex].replies[replyIndex].hidden = hide;
                
                // Update Firebase
                const messageRef = doc(db, 'messages', messageId);
                await updateDoc(messageRef, {
                    comments: messages[messageIndex].comments
                });
                
                // Refresh display
                renderMessages();
                
                // Keep comments section open
                document.getElementById(`comments-${messageId}`).style.display = 'block';
                
                console.log(`Reply ${hide ? 'hidden' : 'shown'} by post author`);
                
            } catch (error) {
                console.error('Error toggling reply visibility:', error);
                alert('Error updating reply visibility: ' + error.message);
            }
        }

        // Display upcoming birthdays
        function displayUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdays');
            
            if (!container) {
                console.warn('Upcoming birthdays container not found');
                return;
            }
            
            if (!familyMembers || familyMembers.length === 0) {
                console.log('No family members found');
                container.innerHTML = '<div class="birthday-item"><span>No family members added yet</span><span>Add some family members to see birthdays</span></div>';
                return;
            }
            
            const today = new Date();
            
            // Filter members with valid birth data and calculate upcoming birthdays
            const validMembers = familyMembers.filter(member => {
                // Check if member has valid birth data
                return member.birthMonth && member.birthDay && member.birthMonth.trim() !== '' && member.birthDay > 0;
            });
            
            const upcoming = validMembers.map(member => {
                const nextBirthday = getNextBirthday(member);
                const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                
                return {
                    ...member,
                    nextBirthday: nextBirthday,
                    daysUntil: daysUntil
                };
            })
            .filter(member => member.daysUntil >= 0 && member.daysUntil < 9999) // Filter out any invalid dates
            .sort((a, b) => a.nextBirthday - b.nextBirthday) // Sort by next birthday date
            .slice(0, 5); // Show only the next 5 birthdays

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="birthday-item"><span>No upcoming birthdays</span><span>Add birth dates to family members</span></div>';
                return;
            }

            container.innerHTML = upcoming.map(member => {
                // Format the birthday display
                const dayLabel = member.daysUntil === 0 ? 'Today!' : 
                                member.daysUntil === 1 ? 'Tomorrow' : 
                                `${member.daysUntil} day${member.daysUntil === 1 ? '' : 's'}`;
                
                return `
                    <div class="birthday-item">
                        <span>${member.firstName} ${member.lastName}</span>
                        <span>${member.birthMonth} ${member.birthDay} (${dayLabel})</span>
                    </div>
                `;
            }).join('');
        }

        // Simple family tree view function
        function viewFamilyTree(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            // Find all related family members
            const parents = familyMembers.filter(m => 
                m.id !== memberId && isParentRelationship(m, member)
            );
            
            const children = familyMembers.filter(m => 
                m.id !== memberId && isChildRelationship(member, m)
            );

            // Find siblings (same parents)
            const siblings = familyMembers.filter(m => 
                m.id !== memberId && 
                parents.some(parent => isParentRelationship(parent, m))
            );

            const modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; text-align: center;"> Family Tree - ${member.firstName} ${member.lastName}</h3>
                    
                    <!-- Parents Section -->
                    ${parents.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;"> Parents</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${parents.map(p => `
                                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 2px solid #e9ecef;">
                                        <strong>${p.firstName} ${p.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(p)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Focus Person -->
                    <div style="margin: 2rem 0; text-align: center;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; display: inline-block;">
                            <h4 style="margin: 0; color: white;">${member.firstName} ${member.lastName}</h4>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Age: ${getAge(member)} | ${member.familyBranch || 'No group'}</div>
                        </div>
                    </div>

                    <!-- Siblings Section -->
                    ${siblings.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;"> Siblings</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${siblings.map(s => `
                                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 2px solid #ffeaa7;">
                                        <strong>${s.firstName} ${s.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(s)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Children Section -->
                    ${children.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;"> Children</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${children.map(c => `
                                    <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; border: 2px solid #bee5eb;">
                                        <strong>${c.firstName} ${c.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(c)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${parents.length === 0 && siblings.length === 0 && children.length === 0 ? `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No family relationships have been established yet.</p>
                            <p>Family relationships are managed through the Family Groups system.</p>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="closeModal('generalModal')" style="flex: 1; padding: 0.75rem; background: #667eea; color: white; border: none; border-radius: 6px;">Close</button>
                    </div>
                </div>
            `;

            showModal(modalContent);
        }

        // Populate dropdowns
        function populateDropdowns() {
            // Family branch dropdown
            const branchSelects = [
                document.getElementById('familyBranch'),
                document.getElementById('editFamilyBranch'),
                document.getElementById('branchFilter')
            ];
            
            branchSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Branch</option>';
                    
                    // Sort branches by generation for better organization
                    const sortedBranches = [...familyBranches].sort((a, b) => {
                        const genA = a.generationLevel || 999;
                        const genB = b.generationLevel || 999;
                        if (genA !== genB) return genA - genB;
                        return a.name.localeCompare(b.name);
                    });
                    
                    sortedBranches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.name;
                        option.textContent = `${branch.name} (Gen ${branch.generationLevel || '?'})`;
                        select.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });

            // Married to dropdown
            const marriedToSelects = [
                document.getElementById('marriedTo'),
                document.getElementById('editMarriedTo')
            ];
            
            marriedToSelects.forEach(marriedSelect => {
                if (marriedSelect) {
                    const currentValue = marriedSelect.value;
                    marriedSelect.innerHTML = '<option value="">Select someone</option>';
                    
                    // Sort family members by last name, then first name
                    const sortedMembers = [...familyMembers].sort((a, b) => {
                        const lastNameComp = a.lastName.localeCompare(b.lastName);
                        if (lastNameComp !== 0) return lastNameComp;
                        return a.firstName.localeCompare(b.firstName);
                    });
                    
                    sortedMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.firstName} ${member.lastName}`;
                        marriedSelect.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && [...marriedSelect.options].some(opt => opt.value === currentValue)) {
                        marriedSelect.value = currentValue;
                    }
                }
            });

            // Populate children checkboxes for add form (no filtering since no current member yet)
            const addChildrenContainer = document.getElementById('addChildrenSelection');
            if (addChildrenContainer) {
                const sortedChildrenCandidates = [...familyMembers].sort((a, b) => getAge(a) - getAge(b));
                addChildrenContainer.innerHTML = sortedChildrenCandidates.map(member => `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                        <input type="checkbox" name="children" value="${member.id}" 
                               onchange="updateAddChildrenCount()" style="margin-right: 0.5rem;">
                        <span>${member.firstName} ${member.lastName} (Age: ${getAge(member)})</span>
                    </div>
                `).join('');
                updateAddChildrenCount();
            }

            // Populate parents checkboxes for add form (no filtering since no current member yet)
            const addParentsContainer = document.getElementById('addParentsSelection');
            if (addParentsContainer) {
                const sortedParentCandidates = [...familyMembers].sort((a, b) => getAge(b) - getAge(a));
                addParentsContainer.innerHTML = sortedParentCandidates.map(member => `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                        <input type="checkbox" name="parents" value="${member.id}" 
                               onchange="updateAddParentsCount()" style="margin-right: 0.5rem;">
                        <span>${member.firstName} ${member.lastName} (Age: ${getAge(member)})</span>
                    </div>
                `).join('');
                updateAddParentsCount();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Search and filter
            const searchInput = document.getElementById('searchInput');
            const monthFilter = document.getElementById('monthFilter');
            const branchFilter = document.getElementById('branchFilter');
            const sortOrder = document.getElementById('sortOrder');
            
            if (searchInput) {
                searchInput.addEventListener('input', displayFamilyMembers);
                console.log('Search input listener added');
            } else {
                console.warn('searchInput element not found');
            }
            
            if (monthFilter) {
                monthFilter.addEventListener('change', displayFamilyMembers);
                console.log('Month filter listener added');
            } else {
                console.warn('monthFilter element not found');
            }
            
            if (branchFilter) {
                branchFilter.addEventListener('change', displayFamilyMembers);
                console.log('Branch filter listener added');
            } else {
                console.warn('branchFilter element not found');
            }
            
            if (sortOrder) {
                sortOrder.addEventListener('change', displayFamilyMembers);
                console.log('Sort order listener added');
            } else {
                console.warn('sortOrder element not found');
            }

            // Add member form - handled dynamically when modal opens
            console.log('Add member form will be handled when modal opens');

            // Add branch form
            const addBranchForm = document.getElementById('addBranchForm');
            if (addBranchForm) {
                addBranchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addFamilyBranch();
                });
                console.log('Add branch form listener added');
            } else {
                console.warn('addBranchForm not found');
            }

            // Create family unit form
            const createFamilyUnitForm = document.getElementById('createFamilyUnitForm');
            if (createFamilyUnitForm) {
                createFamilyUnitForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createFamilyUnit();
                });
                console.log('Create family unit form listener added');
            } else {
                console.warn('createFamilyUnitForm not found');
            }

            // Add user form
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addUser();
                });
                console.log('Add user form listener added');
            } else {
                console.warn('addUserForm not found');
            }

            // Add message form
            const addMessageForm = document.getElementById('addMessageForm');
            if (addMessageForm) {
                addMessageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addMessage();
                });
                console.log('Add message form listener added');
            } else {
                console.warn('addMessageForm not found');
            }

            // Edit member form
            const editMemberForm = document.getElementById('editMemberForm');
            if (editMemberForm) {
                editMemberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateFamilyMember();
                });
                console.log('Edit member form listener added');
            } else {
                console.warn('editMemberForm not found');
            }
            
            console.log('Event listeners setup complete');
        }

        // Add family member
        // Add family member - UPDATED FOR NEW FORM STRUCTURE
        let isAddingMember = false; // Prevent duplicate submissions
        window.addFamilyMember = async function(event) {
            if (event) event.preventDefault();
            
            // Prevent duplicate submissions
            if (isAddingMember) {
                console.log(' Add member already in progress, ignoring duplicate call');
                return;
            }
            
            isAddingMember = true;
            
            try {
                console.log(' addFamilyMember function called');
                
                // Get selected children
                const selectedChildren = [];
                const childrenCheckboxes = document.querySelectorAll('input[name="children"]:checked');
                childrenCheckboxes.forEach(checkbox => {
                    selectedChildren.push(checkbox.value);
                });

                // Get selected parents
                const selectedParents = [];
                const parentsCheckboxes = document.querySelectorAll('input[name="parents"]:checked');
                parentsCheckboxes.forEach(checkbox => {
                    selectedParents.push(checkbox.value);
                });

                console.log(' Selected parents:', selectedParents);
                console.log(' Selected children:', selectedChildren);

                // Validate parent limit
                if (selectedParents.length > 2) {
                    showMessage('Maximum 2 parents allowed', 'error');
                    return;
                }

                // Validate children limit
                if (selectedChildren.length > 15) {
                    showMessage('Maximum 15 children allowed', 'error');
                    return;
                }

                // Get selected spouses
                const selectedSpouses = [];
                const spousesCheckboxes = document.querySelectorAll('input[name="spouses"]:checked');
                spousesCheckboxes.forEach(checkbox => {
                    selectedSpouses.push(checkbox.value);
                });

                console.log(' Selected spouses:', selectedSpouses);

                const memberData = {
                    firstName: document.getElementById('addFirstName').value.trim(),
                    lastName: document.getElementById('addLastName').value.trim(),
                    birthMonth: document.getElementById('addBirthMonth').value,
                    birthDay: parseInt(document.getElementById('addBirthDay').value) || null,
                    birthYear: parseInt(document.getElementById('addBirthYear').value) || null,
                    familyBranch: document.getElementById('addFamilyBranch').value || null,
                    marriedTo: selectedSpouses, // Changed to array for multiple spouses
                    children: selectedChildren,
                    parents: selectedParents,
                    email: document.getElementById('addEmail').value?.trim() || null,
                    mobilePhone: document.getElementById('addMobilePhone').value?.trim() || null,
                    homePhone: document.getElementById('addHomePhone').value?.trim() || null,
                    workPhone: document.getElementById('addWorkPhone').value?.trim() || null,
                    address: document.getElementById('addAddress').value?.trim() || null,
                    city: document.getElementById('addCity').value?.trim() || null,
                    state: document.getElementById('addState').value?.trim() || null,
                    zipCode: document.getElementById('addZipCode').value?.trim() || null,
                    notes: document.getElementById('addNotes').value?.trim() || null,
                    deceased: document.getElementById('addDeceased')?.checked || false,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                console.log(' Form field values:', {
                    firstName: document.getElementById('addFirstName').value,
                    lastName: document.getElementById('addLastName').value,
                    birthMonth: document.getElementById('addBirthMonth').value,
                    birthDay: document.getElementById('addBirthDay').value,
                    birthYear: document.getElementById('addBirthYear').value
                });

                // Validate required fields
                if (!memberData.firstName || !memberData.lastName || !memberData.birthMonth || !memberData.birthDay || !memberData.birthYear) {
                    console.error(' Validation failed - missing required fields');
                    showMessage('Please fill in all required fields (Name, Birth Month, Day, Year)', 'error');
                    return;
                }

                console.log(' Adding family member with data:', memberData);

                // Check if Firebase is available
                if (!db) {
                    console.error(' Firebase database not initialized');
                    showMessage('Database connection error. Please refresh the page.', 'error');
                    return;
                }

                // Save to Firebase with enhanced error handling
                console.log(' Attempting to save to Firebase...');
                console.log(' Database reference:', db);
                
                const docRef = await addDoc(collection(db, 'family_members'), memberData);
                const newMemberId = docRef.id;
                
                console.log(' New member successfully added with ID:', newMemberId);
                console.log(' Document reference:', docRef);
                
                // Log the addition
                await logUserAction('add', 'family_member', `Added ${memberData.firstName} ${memberData.lastName}`, 'success');
                
                // Add the new member to local array immediately for instant UI update
                const newMember = { id: newMemberId, ...memberData };
                familyMembers.push(newMember);
                console.log(' Added to local familyMembers array. New count:', familyMembers.length);
                
                // Update bidirectional marriage relationships for multiple spouses
                const spouseIds = memberData.marriedTo;
                if (spouseIds && spouseIds.length > 0) {
                    console.log(' Updating marriage relationships for multiple spouses...');
                    for (const spouseId of spouseIds) {
                        await updateBidirectionalMarriageMultiple(newMemberId, spouseId);
                        // Synchronize children with each spouse
                        console.log(` Synchronizing children with spouse ${spouseId}...`);
                        await synchronizeMarriedCoupleChildren(newMemberId, spouseId);
                    }
                }
                
                // Update bidirectional parent/child relationships
                if (selectedParents.length > 0 || selectedChildren.length > 0) {
                    console.log(' Updating family relationships...');
                    await updateBidirectionalRelationships(newMemberId, selectedParents, selectedChildren);
                }
                
                closeModal('addMemberModal');
                
                // Refresh everything
                console.log(' Refreshing all data and UI...');
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                displayBranches(); // Refresh family trees
                populateDropdowns();
                
                showMessage(` ${memberData.firstName} ${memberData.lastName} added successfully!`, 'success');
                console.log(' All updates completed successfully!');
            } catch (error) {
                console.error(' Error adding family member:', error);
                console.error(' Error details:', error.message);
                console.error(' Error stack:', error.stack);
                showMessage('Error adding family member: ' + error.message, 'error');
            } finally {
                // Reset flag to allow future submissions
                isAddingMember = false;
            }
        };

        // Function to update children count for add form
        window.updateAddChildrenCount = function() {
            const checkboxes = document.querySelectorAll('#addChildrenSelection input[name="children"]:checked');
            const countElement = document.getElementById('addChildrenCount');
            const allCheckboxes = document.querySelectorAll('#addChildrenSelection input[name="children"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (checkboxes.length >= 15) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Function to update parents count for add form
        window.updateAddParentsCount = function() {
            const checkboxes = document.querySelectorAll('#addParentsSelection input[name="parents"]:checked');
            const countElement = document.getElementById('addParentsCount');
            const allCheckboxes = document.querySelectorAll('#addParentsSelection input[name="parents"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (checkboxes.length >= 2) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Update family member (old modal version - will be replaced by new modal)
        async function updateFamilyMember() {
            try {
                const memberId = document.getElementById('editMemberId').value;
                
                // Get original member data to detect changes
                const originalMember = familyMembers.find(m => m.id === memberId);
                const originalSpouseId = originalMember ? originalMember.marriedTo : null;
                
                // Get selected children
                const selectedChildren = [];
                const childrenCheckboxes = document.querySelectorAll('#editChildrenSelection input[name="editChildren"]:checked');
                childrenCheckboxes.forEach(checkbox => {
                    selectedChildren.push(checkbox.value);
                });

                // Get selected parents
                const selectedParents = [];
                const parentsCheckboxes = document.querySelectorAll('#editParentsSelection input[name="editParents"]:checked');
                parentsCheckboxes.forEach(checkbox => {
                    selectedParents.push(checkbox.value);
                });

                const memberData = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    birthMonth: document.getElementById('editBirthMonth').value,
                    birthDay: parseInt(document.getElementById('editBirthDay').value),
                    birthYear: parseInt(document.getElementById('editBirthYear').value),
                    familyBranch: document.getElementById('editFamilyBranch').value,
                    marriedTo: document.getElementById('editMarriedTo').value || null,
                    marriageHistory: collectEditMarriageHistory(), // Collect marriage history
                    children: selectedChildren, // Add children array
                    parents: selectedParents, // Add parents array
                    mobilePhone: document.getElementById('editMobilePhone').value,
                    homePhone: document.getElementById('editHomePhone').value,
                    workPhone: document.getElementById('editWorkPhone').value,
                    address: document.getElementById('editAddress').value,
                    city: document.getElementById('editCity').value,
                    state: document.getElementById('editState').value,
                    zipCode: document.getElementById('editZipCode').value,
                    anniversaryDate: document.getElementById('editAnniversaryDate').value,
                    notes: document.getElementById('editNotes').value,
                    updatedAt: new Date(),
                    updatedBy: currentUser.username
                };

                await updateDoc(doc(db, 'family_members', memberId), memberData);
                
                // Handle marriage changes if applicable
                const newSpouseId = memberData.marriedTo;
                if (originalSpouseId !== newSpouseId) {
                    await updateBidirectionalMarriage(memberId, originalSpouseId, newSpouseId);
                    // Synchronize children with new spouse if married
                    if (newSpouseId) {
                        await synchronizeMarriedCoupleChildren(memberId, newSpouseId);
                    }
                }
                
                // Update bidirectional relationships
                await updateBidirectionalRelationships(memberId, selectedParents, selectedChildren);
                
                closeModal('editMemberModal');
                document.getElementById('editMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                displayBranches(); // Refresh family trees
                populateDropdowns();
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member: ' + error.message, 'error');
            }
        }

        // Add family branch
        async function addFamilyBranch() {
            try {
                const branchData = {
                    name: document.getElementById('branchName').value,
                    description: document.getElementById('branchDescription').value,
                    generationLevel: parseInt(document.getElementById('generationLevel').value),
                    branchType: document.getElementById('branchType').value,
                    parentBranch: document.getElementById('parentBranch').value || null,
                    sharedMembers: [], // Array to store member IDs who appear in multiple branches
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_branches'), branchData);
                closeModal('addBranchModal');
                document.getElementById('addBranchForm').reset();
                await loadFamilyBranches();
                displayBranches();
                populateDropdowns();
                generateSmartSuggestions(); // Generate suggestions after adding
                alert('Family branch added successfully!');
            } catch (error) {
                alert('Error adding family branch: ' + error.message);
            }
        }

        // Create family unit
        async function createFamilyUnit() {
            try {
                const selectedBranches = Array.from(
                    document.querySelectorAll('#branchCheckboxes input[type="checkbox"]:checked')
                ).map(checkbox => checkbox.value);

                if (selectedBranches.length === 0) {
                    alert('Please select at least one branch for this family unit.');
                    return;
                }

                const unitData = {
                    name: document.getElementById('unitName').value,
                    description: document.getElementById('unitDescription').value,
                    type: document.getElementById('unitType').value,
                    branches: selectedBranches,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_units'), unitData);
                closeModal('createFamilyUnitModal');
                document.getElementById('createFamilyUnitForm').reset();
                await loadFamilyUnits();
                displayBranches();
                alert('Family unit created successfully!');
            } catch (error) {
                alert('Error creating family unit: ' + error.message);
            }
        }

        // Add user (admin only)
        async function addUser() {
            if (!currentUser.isAdmin) return;

            try {
                const userData = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('userPhone').value,
                    isAdmin: parseInt(document.getElementById('isAdmin').value),
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'users'), userData);
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                await loadUsers();
                displayUsers();
                alert('User added successfully!');
            } catch (error) {
                alert('Error adding user: ' + error.message);
            }
        }

        // ===== IMAGE UPLOAD FUNCTIONS =====
        
        // Upload image to Firebase Storage
        async function uploadImageToStorage(imageFile, folder = 'message-images') {
            try {
                // Create unique filename
                const timestamp = Date.now();
                const fileName = `${timestamp}_${imageFile.name}`;
                const imageRef = ref(storage, `${folder}/${fileName}`);
                
                // Upload the file
                const snapshot = await uploadBytes(imageRef, imageFile);
                
                // Get the download URL
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Compress image before upload (optional - reduces storage costs)
        function compressImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Delete image from Firebase Storage
        async function deleteImageFromStorage(imageUrl) {
            try {
                const imageRef = ref(storage, imageUrl);
                await deleteObject(imageRef);
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }

        // Add message with optional image support
        async function addMessage() {
            try {
                const title = document.getElementById('messageTitle').value;
                const content = document.getElementById('messageContent').value;
                const imageInput = document.getElementById('messageImage');
                
                if (!title || !content) {
                    alert('Please fill in both title and content');
                    return;
                }

                let imageUrl = null;
                
                // Check if an image was selected
                if (imageInput && imageInput.files && imageInput.files[0]) {
                    const imageFile = imageInput.files[0];
                    
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(imageFile.type)) {
                        alert('Please select a valid image file (JPEG, PNG, or GIF)');
                        return;
                    }
                    
                    // Validate file size (5MB limit)
                    if (imageFile.size > 5 * 1024 * 1024) {
                        alert('Image file must be less than 5MB');
                        return;
                    }
                    
                    // Show upload progress
                    const uploadingMessage = document.createElement('div');
                    uploadingMessage.textContent = 'Uploading image...';
                    uploadingMessage.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000;';
                    document.body.appendChild(uploadingMessage);
                    
                    try {
                        // Compress image if it's large
                        const processedImage = imageFile.size > 1024 * 1024 ? 
                            await compressImage(imageFile) : imageFile;
                        
                        // Upload to Firebase Storage
                        imageUrl = await uploadImageToStorage(processedImage, 'message-images');
                        
                    } catch (uploadError) {
                        document.body.removeChild(uploadingMessage);
                        alert('Error uploading image: ' + uploadError.message);
                        return;
                    }
                    
                    document.body.removeChild(uploadingMessage);
                }

                const messageData = {
                    title: title,
                    content: content,
                    author: currentUser.username,
                    createdAt: new Date(),
                    imageUrl: imageUrl // Add image URL if present
                };

                await addDoc(collection(db, 'messages'), messageData);
                closeModal('addMessageModal');
                document.getElementById('addMessageForm').reset();
                await loadMessages();
                displayMessages();
                
                // Log the action
                await logUserAction('add', 'message', `Posted message: "${title}"${imageUrl ? ' with image' : ''}`, 'success');
                
                alert('Message posted successfully!' + (imageUrl ? ' Image uploaded!' : ''));
            } catch (error) {
                console.error('Error posting message:', error);
                alert('Error posting message: ' + error.message);
            }
        }

        // Delete functions
        window.deleteFamilyMember = async function(id) {
            if (confirm('Are you sure you want to delete this family member?')) {
                try {
                    await deleteDoc(doc(db, 'family_members', id));
                    await loadFamilyMembers();
                    displayFamilyMembers();
                    displayUpcomingBirthdays();
                    alert('Family member deleted successfully!');
                } catch (error) {
                    alert('Error deleting family member: ' + error.message);
                }
            }
        };

        window.deleteBranch = async function(id) {
            if (confirm('Are you sure you want to delete this branch?')) {
                try {
                    await deleteDoc(doc(db, 'family_branches', id));
                    await loadFamilyBranches();
                    displayBranches();
                    populateDropdowns();
                    alert('Branch deleted successfully!');
                } catch (error) {
                    alert('Error deleting branch: ' + error.message);
                }
            }
        };

        // Family Unit Management Functions
        window.deleteFamilyUnit = async function(id) {
            if (confirm('Are you sure you want to delete this family unit? The branches will remain but will no longer be grouped together.')) {
                try {
                    await deleteDoc(doc(db, 'family_units', id));
                    await loadFamilyUnits();
                    displayBranches();
                    alert('Family unit deleted successfully!');
                } catch (error) {
                    alert('Error deleting family unit: ' + error.message);
                }
            }
        };

        window.manageFamilyUnit = function(id) {
            // For now, just show an alert. This could be expanded to a full management modal
            const unit = familyUnits.find(u => u.id === id);
            alert(`Managing ${unit.name}\n\nBranches: ${unit.branches.join(', ')}\n\nThis feature can be expanded to allow editing the unit, adding/removing branches, etc.`);
        };

        window.removeBranchFromUnit = async function(branchName, unitId) {
            if (confirm(`Remove ${branchName} from this family unit?`)) {
                try {
                    const unit = familyUnits.find(u => u.id === unitId);
                    const updatedBranches = unit.branches.filter(b => b !== branchName);
                    
                    await updateDoc(doc(db, 'family_units', unitId), {
                        branches: updatedBranches
                    });
                    
                    await loadFamilyUnits();
                    displayBranches();
                    alert('Branch removed from family unit successfully!');
                } catch (error) {
                    alert('Error removing branch from unit: ' + error.message);
                }
            }
        };

        window.deleteUser = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await deleteDoc(doc(db, 'users', id));
                    await loadUsers();
                    displayUsers();
                    alert('User deleted successfully!');
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        };

        // Approve account request
        window.approveRequest = async function(requestId, username, password, firstName, lastName) {
            if (!currentUser.isAdmin) return;
            
            try {
                // Add user to users collection as admin
                await addDoc(collection(db, 'users'), {
                    username: username,
                    password: password,
                    fullName: `${firstName} ${lastName}`,
                    firstName: firstName,
                    lastName: lastName,
                    isAdmin: 1,  // All approved users are admins
                    createdAt: new Date()
                });
                
                // Delete the request
                await deleteDoc(doc(db, 'account_requests', requestId));
                
                // Log the approval
                await logUserAction('approve', 'account_request', `Approved account for ${firstName} ${lastName} (${username})`, 'success');
                
                // Reload data
                await loadAccountRequests();
                await loadUsers();
                displayAccountRequests();
                displayUsers();
                
                alert(`Account approved! ${firstName} ${lastName} has been added as an admin.`);
            } catch (error) {
                await logUserAction('approve', 'account_request', `Failed to approve account for ${firstName} ${lastName}: ${error.message}`, 'failed');
                alert('Error approving request: ' + error.message);
            }
        };

        // Deny account request
        window.denyRequest = async function(requestId, username) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to deny this account request? This username will be permanently blocked.')) {
                try {
                    // Get the request data first
                    const requestData = accountRequests.find(req => req.id === requestId);
                    
                    // Add to denied accounts
                    await addDoc(collection(db, 'denied_accounts'), {
                        username: username,
                        deniedDate: new Date().toISOString(),
                        deniedBy: currentUser.username,
                        originalRequest: requestData
                    });
                    
                    // Delete the request
                    await deleteDoc(doc(db, 'account_requests', requestId));
                    
                    // Reload data
                    await loadAccountRequests();
                    await loadDeniedAccounts();
                    displayAccountRequests();
                    
                    alert(`Account request denied. ${username} has been permanently blocked from creating an account.`);
                } catch (error) {
                    alert('Error denying request: ' + error.message);
                }
            }
        };

        window.deleteMessage = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await deleteDoc(doc(db, 'messages', id));
                    await loadMessages();
                    displayMessages();
                    alert('Message deleted successfully!');
                } catch (error) {
                    alert('Error deleting message: ' + error.message);
                }
            }
        };

        // Remove all family members (admin only)
        window.removeAllFamilyMembers = async function() {
            console.log('removeAllFamilyMembers called');
            console.log('Current user:', currentUser);
            console.log('Is admin:', currentUser?.isAdmin);
            console.log('Family members count:', familyMembers.length);
            
            if (!currentUser || !currentUser.isAdmin) {
                alert('Only admin users can delete all family members');
                return;
            }
            
            if (familyMembers.length === 0) {
                alert('No family members to delete');
                return;
            }
            
            const confirmMessage = ` DANGER: This will permanently delete ALL ${familyMembers.length} family members from the database!\n\nThis action cannot be undone. Are you absolutely sure?`;
            if (!confirm(confirmMessage)) return;
            
            const doubleConfirm = prompt('Type "DELETE ALL" to confirm this dangerous action:');
            if (doubleConfirm !== 'DELETE ALL') {
                alert('Action cancelled - text did not match exactly.');
                return;
            }
            
            try {
                let deleted = 0;
                console.log('Starting deletion process...');
                
                for (const member of familyMembers) {
                    console.log('Deleting member:', member.firstName, member.lastName, 'ID:', member.id);
                    await deleteDoc(doc(db, 'family_members', member.id));
                    deleted++;
                }
                
                console.log('Deletion completed. Refreshing data...');
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully deleted ${deleted} family members. Database is now clean for proper import.`);
            } catch (error) {
                console.error('Error deleting family members:', error);
                alert('Error deleting family members: ' + error.message);
            }
        };

        // Modal functions
        window.openAddBranchModal = function() {
            populateParentBranchDropdown();
            generateSmartSuggestions();
            document.getElementById('addBranchModal').classList.add('active');
        };

        // Family Unit Modal Functions
        window.openCreateFamilyUnitModal = function() {
            populateBranchCheckboxes();
            document.getElementById('createFamilyUnitModal').classList.add('active');
        };

        function populateBranchCheckboxes() {
            const container = document.getElementById('branchCheckboxes');
            
            // Get branches that are not already in a family unit
            const branchesInUnits = familyUnits.flatMap(unit => unit.branches || []);
            const availableBranches = familyBranches.filter(branch => 
                !branchesInUnits.includes(branch.name)
            );

            if (availableBranches.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No available branches to add to a family unit.</p>';
                return;
            }

            container.innerHTML = availableBranches.map(branch => `
                <div style="margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #e9ecef; border-radius: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${branch.name}" style="margin-right: 0.5rem;">
                        <div>
                            <strong>${branch.name}</strong>
                            <div style="font-size: 0.8rem; color: #666;">
                                Generation ${branch.generationLevel || '?'}  ${formatBranchType(branch.branchType)}
                                 ${familyMembers.filter(m => m.familyBranch === branch.name).length} members
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');
        }

        // Populate parent branch dropdown
        function populateParentBranchDropdown() {
            const parentBranchSelect = document.getElementById('parentBranch');
            parentBranchSelect.innerHTML = '<option value="">No Parent Branch</option>';
            
            familyBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = `${branch.name} (Gen ${branch.generationLevel || '?'})`;
                parentBranchSelect.appendChild(option);
            });
        }

        // Generate smart suggestions for branch creation
        function generateSmartSuggestions() {
            const suggestionsDiv = document.getElementById('smartSuggestions');
            const suggestionsList = document.getElementById('suggestionsList');
            
            if (!familyMembers.length) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const suggestions = [];
            
            // Analyze last names for family grouping suggestions
            const lastNameGroups = {};
            familyMembers.forEach(member => {
                if (!member.familyBranch || member.familyBranch.trim() === '') {
                    const lastName = member.lastName;
                    if (!lastNameGroups[lastName]) lastNameGroups[lastName] = [];
                    lastNameGroups[lastName].push(member);
                }
            });

            // Suggest nuclear families for groups with same last name
            Object.entries(lastNameGroups).forEach(([lastName, members]) => {
                if (members.length >= 2) {
                    const ages = members.map(m => new Date().getFullYear() - m.birthYear);
                    const hasAdults = ages.some(age => age >= 18);
                    const hasChildren = ages.some(age => age < 18);
                    
                    if (hasAdults && hasChildren) {
                        suggestions.push({
                            type: 'nuclear_family',
                            text: `Create "${lastName} Nuclear Family" for ${members.length} members`,
                            action: () => suggestBranchName(`${lastName} Nuclear Family`, 'nuclear_family', 2)
                        });
                    } else if (hasAdults) {
                        suggestions.push({
                            type: 'cousin_branch', 
                            text: `Create "${lastName} Cousin Branch" for ${members.length} members`,
                            action: () => suggestBranchName(`${lastName} Cousin Branch`, 'cousin_branch', 3)
                        });
                    }
                }
            });

            // Show suggestions
            if (suggestions.length > 0) {
                suggestionsList.innerHTML = suggestions.map(suggestion => 
                    `<div style="margin-bottom: 0.5rem;">
                        <button class="btn" onclick="(${suggestion.action})()" style="background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; font-size: 0.85rem;">
                            ${suggestion.text}
                        </button>
                    </div>`
                ).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        // Suggest branch name and type
        function suggestBranchName(name, type, generation) {
            document.getElementById('branchName').value = name;
            document.getElementById('branchType').value = type;
            document.getElementById('generationLevel').value = generation;
        }

        // Open branch management modal
        window.openManageBranchModal = function(branchId) {
            const branch = familyBranches.find(b => b.id === branchId);
            if (!branch) return;

            document.getElementById('manageBranchTitle').textContent = `Manage: ${branch.name}`;
            window.currentManagingBranch = branch;
            
            populateManageBranchData(branch);
            document.getElementById('manageBranchModal').classList.add('active');
        };

        // Populate management modal data
        function populateManageBranchData(branch) {
            // Populate source branch dropdown for moving
            const sourceBranchSelect = document.getElementById('sourceBranch');
            sourceBranchSelect.innerHTML = '<option value="">Select source branch</option>';
            
            familyBranches.forEach(b => {
                if (b.id !== branch.id) {
                    const option = document.createElement('option');
                    option.value = b.name;
                    option.textContent = `${b.name} (${familyMembers.filter(m => m.familyBranch === b.name).length} members)`;
                    sourceBranchSelect.appendChild(option);
                }
            });

            // Populate shareable members
            const shareableMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const shareableDiv = document.getElementById('shareableMembersList');
            
            if (shareableMembers.length > 0) {
                shareableDiv.innerHTML = shareableMembers.map(member => `
                    <div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${member.firstName} ${member.lastName}</strong>
                                <small style="color: #666; margin-left: 0.5rem;">${member.birthYear || ''}</small>
                            </div>
                            <button class="btn btn-primary" onclick="openShareMemberModal('${member.id}')" style="font-size: 0.8rem;">
                                Share with Other Branches
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                shareableDiv.innerHTML = '<p style="text-align: center; color: #666;">No members in this branch yet</p>';
            }

            // Generate branch-specific suggestions
            generateBranchSuggestions(branch);
        }

        // Load candidates for moving
        window.loadMoveCandidates = function() {
            const sourceBranchName = document.getElementById('sourceBranch').value;
            const candidatesDiv = document.getElementById('moveCandidates');
            const moveBtn = document.getElementById('moveSelectedBtn');

            if (!sourceBranchName) {
                candidatesDiv.innerHTML = '<p style="text-align: center; color: #666;">Select a source branch to see members</p>';
                moveBtn.style.display = 'none';
                return;
            }

            const candidates = familyMembers.filter(m => m.familyBranch === sourceBranchName);
            
            if (candidates.length === 0) {
                candidatesDiv.innerHTML = '<p style="text-align: center; color: #666;">No members in selected branch</p>';
                moveBtn.style.display = 'none';
                return;
            }

            candidatesDiv.innerHTML = candidates.map(member => `
                <div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${member.id}" style="margin-right: 0.5rem;" onchange="updateMoveButton()">
                        <div>
                            <strong>${member.firstName} ${member.lastName}</strong>
                            <small style="color: #666; margin-left: 0.5rem;">
                                Born ${member.birthMonth || ''} ${member.birthDay || ''}, ${member.birthYear || ''}
                            </small>
                            ${member.relationship ? `<br><small style="color: #666;">Relationship: ${member.relationship}</small>` : ''}
                        </div>
                    </label>
                </div>
            `).join('');

            moveBtn.style.display = 'block';
        };

        // Update move button state
        window.updateMoveButton = function() {
            const checkboxes = document.querySelectorAll('#moveCandidates input[type="checkbox"]:checked');
            const moveBtn = document.getElementById('moveSelectedBtn');
            moveBtn.textContent = `Move Selected Members (${checkboxes.length})`;
            moveBtn.disabled = checkboxes.length === 0;
        };

        // Move selected members
        window.moveSelectedMembers = async function() {
            const checkboxes = document.querySelectorAll('#moveCandidates input[type="checkbox"]:checked');
            const memberIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (memberIds.length === 0) return;

            const targetBranch = window.currentManagingBranch;
            if (!targetBranch) return;

            try {
                for (const memberId of memberIds) {
                    await updateDoc(doc(db, 'family_members', memberId), {
                        familyBranch: targetBranch.name,
                        updatedAt: new Date(),
                        updatedBy: currentUser.username
                    });
                }

                alert(`Successfully moved ${memberIds.length} members to ${targetBranch.name}`);
                
                // Refresh data
                await loadFamilyMembers();
                displayFamilyMembers();
                displayBranches();
                populateDropdowns();
                
                // Refresh management modal
                populateManageBranchData(targetBranch);
                
            } catch (error) {
                alert('Error moving members: ' + error.message);
            }
        };

        // Generate branch-specific suggestions
        function generateBranchSuggestions(branch) {
            const suggestionsDiv = document.getElementById('branchSuggestions');
            const suggestions = [];

            const branchMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const unassignedMembers = familyMembers.filter(m => !m.familyBranch || m.familyBranch.trim() === '');

            // Suggest adding unassigned family members with same last name
            if (branchMembers.length > 0) {
                const branchLastNames = [...new Set(branchMembers.map(m => m.lastName))];
                
                branchLastNames.forEach(lastName => {
                    const matchingUnassigned = unassignedMembers.filter(m => m.lastName === lastName);
                    if (matchingUnassigned.length > 0) {
                        suggestions.push({
                            text: `Add ${matchingUnassigned.length} unassigned ${lastName} members to this branch`,
                            action: `moveUnassignedByLastName('${lastName}', '${branch.name}')`
                        });
                    }
                });
            }

            // Suggest creating child branches
            if (branch.branchType === 'extended_family' && branchMembers.length > 6) {
                suggestions.push({
                    text: `This branch has ${branchMembers.length} members. Consider splitting into nuclear families`,
                    action: `suggestSplitBranch('${branch.id}')`
                });
            }

            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = suggestions.map(s => 
                    `<div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0 0 0.5rem 0;">${s.text}</p>
                        <button class="btn btn-primary" onclick="${s.action}" style="font-size: 0.85rem;">Apply Suggestion</button>
                    </div>`
                ).join('');
            } else {
                suggestionsDiv.innerHTML = '<p style="text-align: center; color: #666;">No suggestions for this branch right now</p>';
            }
        }

        // Tab switching for management modal
        window.switchManageTab = function(tabName) {
            document.querySelectorAll('.manage-tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('#manageBranchModal .tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        };

        // Helper functions for smart suggestions
        window.moveUnassignedByLastName = async function(lastName, targetBranchName) {
            const unassignedMembers = familyMembers.filter(m => 
                (!m.familyBranch || m.familyBranch.trim() === '') && m.lastName === lastName
            );

            if (unassignedMembers.length === 0) {
                alert('No unassigned members found with that last name');
                return;
            }

            const confirmMessage = `Move ${unassignedMembers.length} unassigned ${lastName} members to ${targetBranchName}?`;
            if (!confirm(confirmMessage)) return;

            try {
                for (const member of unassignedMembers) {
                    await updateDoc(doc(db, 'family_members', member.id), {
                        familyBranch: targetBranchName,
                        updatedAt: new Date(),
                        updatedBy: currentUser.username
                    });
                }

                alert(`Successfully moved ${unassignedMembers.length} ${lastName} members to ${targetBranchName}`);
                
                // Refresh data
                await loadFamilyMembers();
                displayFamilyMembers();
                displayBranches();
                
                // Refresh management modal if open
                if (window.currentManagingBranch) {
                    populateManageBranchData(window.currentManagingBranch);
                }
                
            } catch (error) {
                alert('Error moving members: ' + error.message);
            }
        };

        window.suggestSplitBranch = function(branchId) {
            const branch = familyBranches.find(b => b.id === branchId);
            if (!branch) return;

            const branchMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const lastNameGroups = {};
            
            branchMembers.forEach(member => {
                if (!lastNameGroups[member.lastName]) lastNameGroups[member.lastName] = [];
                lastNameGroups[member.lastName].push(member);
            });

            let suggestions = Object.entries(lastNameGroups)
                .filter(([lastName, members]) => members.length >= 2)
                .map(([lastName, members]) => ` ${lastName} family (${members.length} members)`)
                .join('\n');

            if (suggestions) {
                alert(`Consider creating separate nuclear family branches:\n\n${suggestions}\n\nUse the "Move Members" tab to organize them.`);
            } else {
                alert('No clear family groupings found for splitting this branch.');
            }
        };

        // Add smart suggestions to existing functions
        function enhanceLoadData() {
            const originalLoadData = window.loadData;
            window.loadData = async function() {
                await originalLoadData();
                generateSmartSuggestions();
            };
        }

        // Initialize smart suggestions
        if (typeof window.loadData !== 'undefined') {
            enhanceLoadData();
        }

        window.openAddUserModal = function() {
            if (!currentUser.isAdmin) return;
            document.getElementById('addUserModal').classList.add('active');
        };

        window.openAddMessageModal = function() {
            document.getElementById('addMessageModal').classList.add('active');
        };

        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                alert('Family member not found');
                return;
            }

            // Populate the edit form with existing data
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editFirstName').value = member.firstName || '';
            document.getElementById('editLastName').value = member.lastName || '';
            document.getElementById('editBirthMonth').value = member.birthMonth || '';
            document.getElementById('editBirthDay').value = member.birthDay || '';
            document.getElementById('editBirthYear').value = member.birthYear || '';
            document.getElementById('editFamilyBranch').value = member.familyBranch || '';
            document.getElementById('editRelationship').value = member.relationship || '';
            document.getElementById('editRelatedTo').value = member.relatedTo || '';
            document.getElementById('editMobilePhone').value = member.mobilePhone || '';
            document.getElementById('editHomePhone').value = member.homePhone || '';
            document.getElementById('editWorkPhone').value = member.workPhone || '';
            document.getElementById('editAddress').value = member.address || '';
            document.getElementById('editCity').value = member.city || '';
            document.getElementById('editState').value = member.state || '';
            document.getElementById('editZipCode').value = member.zipCode || '';
            document.getElementById('editAnniversaryDate').value = member.anniversaryDate || '';
            document.getElementById('editNotes').value = member.notes || '';

            // Populate marriage history
            populateEditMarriageHistory(member.marriageHistory || []);

            // Show the modal
            document.getElementById('editMemberModal').classList.add('active');
        };

        window.viewBranchMembers = function(branchName) {
            const branchMembers = familyMembers.filter(member => member.familyBranch === branchName);
            
            // Update modal title and stats
            document.getElementById('branchViewTitle').textContent = `${branchName} - Family Members`;
            document.getElementById('branchStatsName').textContent = branchName;
            document.getElementById('branchStatsCount').textContent = `${branchMembers.length} family member${branchMembers.length !== 1 ? 's' : ''}`;
            
            // Clear search input
            document.getElementById('branchSearchInput').value = '';
            
            // Display members or no members message
            if (branchMembers.length === 0) {
                document.getElementById('branchMembersGrid').style.display = 'none';
                document.getElementById('noBranchMembers').style.display = 'block';
            } else {
                document.getElementById('branchMembersGrid').style.display = 'grid';
                document.getElementById('noBranchMembers').style.display = 'none';
                displayBranchMembers(branchMembers);
            }
            
            // Show the modal
            document.getElementById('branchViewModal').classList.add('active');
            
            // Set up search functionality for this branch
            const searchInput = document.getElementById('branchSearchInput');
            searchInput.oninput = function() {
                const searchTerm = this.value.toLowerCase();
                const filteredMembers = branchMembers.filter(member => 
                    member.firstName.toLowerCase().includes(searchTerm) ||
                    member.lastName.toLowerCase().includes(searchTerm) ||
                    (member.relationship && member.relationship.toLowerCase().includes(searchTerm))
                );
                displayBranchMembers(filteredMembers);
            };
        };

        function displayBranchMembers(members) {
            const grid = document.getElementById('branchMembersGrid');
            
            // Sort members by age (oldest first) for better family tree view
            const sortedMembers = [...members].sort((a, b) => getAge(b) - getAge(a));
            
            grid.innerHTML = sortedMembers.map(member => {
                const age = getAge(member);
                const nextBirthday = getNextBirthday(member);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                <div class="family-card" style="border-left: 4px solid #28a745;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem; color: #28a745;">${member.firstName} ${member.lastName}</h3>
                            <div class="family-info" style="font-size: 0.9rem;">
                                <div><strong> Birthday:</strong> ${member.birthMonth} ${member.birthDay}, ${member.birthYear} <span style="color: #666;">(Age: ${age})</span></div>
                                <div><strong> Next Birthday:</strong> <span style="color: ${daysUntilBirthday <= 30 ? '#e74c3c' : '#666'};">${daysUntilBirthday} days</span></div>
                                ${member.relationship ? `<div><strong> Relationship:</strong> ${member.relationship}</div>` : ''}
                                ${member.mobilePhone ? `<div><strong> Mobile:</strong> ${member.mobilePhone}</div>` : ''}
                                ${member.homePhone ? `<div><strong> Home:</strong> ${member.homePhone}</div>` : ''}
                                ${member.workPhone ? `<div><strong> Work:</strong> ${member.workPhone}</div>` : ''}
                                ${member.address ? `<div><strong> Address:</strong> ${member.address}${member.city ? `, ${member.city}` : ''}${member.state ? `, ${member.state}` : ''}</div>` : ''}
                                ${member.anniversaryDate ? `<div><strong> Anniversary:</strong> ${member.anniversaryDate}</div>` : ''}
                                ${member.notes ? `<div style="margin-top: 0.5rem;"><strong> Notes:</strong> ${member.notes}</div>` : ''}
                            </div>
                        </div>
                        <div style="margin-left: 1rem;">
                            <div style="font-size: 2rem; opacity: 0.6;"></div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="font-size: 0.85rem;"> Edit</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="font-size: 0.85rem;"> Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        window.closeModal = function(modalId) {
            if (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    // Clear any inline styles that might interfere
                    modal.style.opacity = '';
                    modal.style.visibility = '';
                    modal.style.display = '';
                }
            } else {
                // If no modalId provided, close any active modal
                document.querySelectorAll('.modal.active, .modal[style*="visible"]').forEach(modal => {
                    modal.classList.remove('active');
                    // Clear any inline styles that might interfere
                    modal.style.opacity = '';
                    modal.style.visibility = '';
                    modal.style.display = '';
                });
            }
        };

        // Image Modal Functions
        window.openImageModal = function(imageUrl, title = 'Family Photo') {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('imageModalImg');
            const titleElement = document.getElementById('imageModalTitle');
            
            titleElement.textContent = title;
            img.src = imageUrl;
            modal.classList.add('active');
            
            // Add click outside to close
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            };
            
            // Add escape key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeImageModal();
                }
            });
        };

        window.closeImageModal = function() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            
            // Remove event listeners
            modal.onclick = null;
            document.removeEventListener('keydown', arguments.callee);
        };

        // General showModal function
        window.showModal = function(content, modalId = 'generalModal') {
            // Create modal if it doesn't exist
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    opacity: 0;
                    visibility: hidden;
                    transition: all 0.3s ease;
                `;
                
                // Add click-outside-to-close functionality
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal(modalId);
                    }
                });
                
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = content;
            modal.classList.add('active');
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            
            // Add escape key to close
            const escKeyHandler = function(e) {
                if (e.key === 'Escape') {
                    closeModal(modalId);
                    document.removeEventListener('keydown', escKeyHandler);
                }
            };
            document.addEventListener('keydown', escKeyHandler);
        };

        // Open edit member modal function - COMPLETELY REBUILT FOR FULL SCREEN
        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                console.error('Member not found:', memberId);
                return;
            }

            // Close any existing modals
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');

            // Get age-appropriate potential parents and children
            const potentialParents = getPotentialParents(member);
            const potentialChildren = getPotentialChildren(member);
            const potentialSpouses = familyMembers.filter(m => m.id !== memberId);

            // Create full-screen modal
            const fullScreenModal = document.createElement('div');
            fullScreenModal.id = 'fullScreenEditModal';
            fullScreenModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                box-sizing: border-box;
            `;

            fullScreenModal.innerHTML = `
                <div style="
                    background: white;
                    width: 100%;
                    max-width: 1200px;
                    height: 90vh;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    position: relative;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 2rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h2 style="margin: 0; font-size: 1.8rem; font-weight: 600;">
                             Edit Family Member
                        </h2>
                        <button onclick="closeFullScreenModal()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            font-size: 1.5rem;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: background 0.3s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'"></button>
                    </div>

                    <!-- Form Content -->
                    <div style="
                        flex: 1;
                        overflow-y: auto;
                        padding: 2rem;
                        background: #f8f9fa;
                    ">
                        <form id="fullScreenEditForm" onsubmit="submitFullScreenEdit(event, '${memberId}')" style="
                            max-width: 1000px;
                            margin: 0 auto;
                        ">
                            <!-- Basic Information -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                margin-bottom: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;"> Basic Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">First Name *</label>
                                        <input type="text" name="firstName" value="${member.firstName || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            transition: border-color 0.3s;
                                        " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e6ed'">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Last Name *</label>
                                        <input type="text" name="lastName" value="${member.lastName || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            transition: border-color 0.3s;
                                        " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e6ed'">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Birth Month *</label>
                                        <select name="birthMonth" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            background: white;
                                        ">
                                            <option value="">Select Month</option>
                                            ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map(month => 
                                                `<option value="${month}" ${member.birthMonth === month ? 'selected' : ''}>${month}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Birth Day *</label>
                                        <input type="number" name="birthDay" min="1" max="31" value="${member.birthDay || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Birth Year *</label>
                                        <input type="number" name="birthYear" min="1900" max="2030" value="${member.birthYear || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                            </div>

                            <!-- Family Relationships -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                margin-bottom: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;"> Family Relationships</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Family Group</label>
                                        <select name="familyBranch" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            background: white;
                                        ">
                                            <option value="">Select Group</option>
                                            ${familyBranches.map(branch => 
                                                `<option value="${branch.name}" ${member.familyBranch === branch.name ? 'selected' : ''}>${branch.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;"> Married To</label>
                                        <select name="marriedTo" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            background: white;
                                        ">
                                            <option value="">Select someone</option>
                                            ${potentialSpouses.map(spouse => 
                                                `<option value="${spouse.id}" ${member.marriedTo === spouse.id ? 'selected' : ''}>${spouse.firstName} ${spouse.lastName}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                    <!-- Parents -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;"> Parents (Select up to 2)</label>
                                        <div style="
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            max-height: 200px;
                                            overflow-y: auto;
                                            background: #f8f9fa;
                                        ">
                                            ${potentialParents.length > 0 ? potentialParents.map(parent => {
                                                const isSelected = member.parents && member.parents.includes(parent.id);
                                                return `
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    padding: 0.75rem;
                                                    border-bottom: 1px solid #e0e6ed;
                                                    background: white;
                                                    margin: 0.25rem;
                                                    border-radius: 6px;
                                                ">
                                                    <input type="checkbox" name="editParents" value="${parent.id}" ${isSelected ? 'checked' : ''} 
                                                           onchange="updateFullScreenParentsCount()" style="margin-right: 0.75rem; transform: scale(1.2);">
                                                    <span style="font-size: 0.95rem;">${parent.firstName} ${parent.lastName} (Age: ${getAge(parent)})</span>
                                                </div>
                                                `;
                                            }).join('') : `
                                                <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                                                    No potential parents found<br><small>(need people at least 15 years older)</small>
                                                </div>
                                            `}
                                        </div>
                                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                                            Selected: <span id="fullScreenParentsCount">0</span>/2 parents
                                        </small>
                                    </div>

                                    <!-- Children -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;"> Children (Select up to 15)</label>
                                        <div style="
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            max-height: 200px;
                                            overflow-y: auto;
                                            background: #f8f9fa;
                                        ">
                                            ${potentialChildren.length > 0 ? potentialChildren.map(child => {
                                                const isSelected = member.children && member.children.includes(child.id);
                                                return `
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    padding: 0.75rem;
                                                    border-bottom: 1px solid #e0e6ed;
                                                    background: white;
                                                    margin: 0.25rem;
                                                    border-radius: 6px;
                                                ">
                                                    <input type="checkbox" name="editChildren" value="${child.id}" ${isSelected ? 'checked' : ''} 
                                                           onchange="updateFullScreenChildrenCount()" style="margin-right: 0.75rem; transform: scale(1.2);">
                                                    <span style="font-size: 0.95rem;">${child.firstName} ${child.lastName} (Age: ${getAge(child)})</span>
                                                </div>
                                                `;
                                            }).join('') : `
                                                <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                                                    No potential children found<br><small>(need people at least 15 years younger)</small>
                                                </div>
                                            `}
                                        </div>
                                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                                            Selected: <span id="fullScreenChildrenCount">0</span>/15 children
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                margin-bottom: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;"> Contact Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Mobile Phone</label>
                                        <input type="tel" name="mobilePhone" value="${member.mobilePhone || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Home Phone</label>
                                        <input type="tel" name="homePhone" value="${member.homePhone || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Work Phone</label>
                                        <input type="tel" name="workPhone" value="${member.workPhone || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Email</label>
                                        <input type="email" name="email" value="${member.email || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Street Address</label>
                                        <input type="text" name="streetAddress" value="${member.streetAddress || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;"> Additional Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">City</label>
                                        <input type="text" name="city" value="${member.city || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">State</label>
                                        <input type="text" name="state" value="${member.state || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Zip Code</label>
                                        <input type="text" name="zipCode" value="${member.zipCode || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Anniversary Date</label>
                                        <input type="date" name="anniversaryDate" value="${member.anniversaryDate || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 600; color: #333;">
                                        <input type="checkbox" name="deceased" ${member.deceased ? 'checked' : ''} style="transform: scale(1.3);">
                                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                                             Deceased
                                            <small style="color: #666; font-weight: normal;">(Will be outlined in red on the family tree)</small>
                                        </span>
                                    </label>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Notes</label>
                                    <textarea name="notes" rows="4" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 2px solid #e0e6ed;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                        resize: vertical;
                                        font-family: inherit;
                                    ">${member.notes || ''}</textarea>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Footer with buttons -->
                    <div style="
                        background: white;
                        padding: 2rem;
                        border-top: 1px solid #e0e6ed;
                        display: flex;
                        justify-content: flex-end;
                        gap: 1rem;
                    ">
                        <button type="button" onclick="closeFullScreenModal()" style="
                            padding: 0.75rem 2rem;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.3s;
                        " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            Cancel
                        </button>
                        <button type="submit" form="fullScreenEditForm" style="
                            padding: 0.75rem 2rem;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.3s;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                             Save Changes
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(fullScreenModal);
            
            // Initialize counts
            setTimeout(() => {
                updateFullScreenParentsCount();
                updateFullScreenChildrenCount();
            }, 100);
        };

        // Function to update parents count and enforce 2-parent limit
        window.updateParentsCount = function() {
            // Check for both add and edit modal checkboxes
            const addCheckboxes = document.querySelectorAll('input[name="parents"]:checked');
            const editCheckboxes = document.querySelectorAll('input[name="editParents"]:checked');
            const addCountElement = document.getElementById('parentsCount');
            const editCountElement = document.getElementById('editParentsCount');
            const addAllCheckboxes = document.querySelectorAll('input[name="parents"]');
            const editAllCheckboxes = document.querySelectorAll('input[name="editParents"]');
            
            // Handle add modal
            if (addCountElement) {
                addCountElement.textContent = addCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (addCheckboxes.length >= 2) {
                    addAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    addAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
            
            // Handle edit modal
            if (editCountElement) {
                editCountElement.textContent = editCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (editCheckboxes.length >= 2) {
                    editAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    editAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Function to update children count and enforce 15-child limit
        window.updateChildrenCount = function() {
            // Check for both add and edit modal checkboxes
            const addCheckboxes = document.querySelectorAll('input[name="children"]:checked');
            const editCheckboxes = document.querySelectorAll('input[name="editChildren"]:checked');
            const addCountElement = document.getElementById('childrenCount');
            const editCountElement = document.getElementById('editChildrenCount');
            const addAllCheckboxes = document.querySelectorAll('input[name="children"]');
            const editAllCheckboxes = document.querySelectorAll('input[name="editChildren"]');
            
            // Handle add modal
            if (addCountElement) {
                addCountElement.textContent = addCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (addCheckboxes.length >= 15) {
                    addAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    addAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
            
            // Handle edit modal
            if (editCountElement) {
                editCountElement.textContent = editCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (editCheckboxes.length >= 15) {
                    editAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    editAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Open add member modal function
        window.openAddMemberModal = function() {
            const modal = document.getElementById('addMemberModal');
            if (!modal) return;
            
            // Build the complete form based on our database structure
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <h2> Add Family Member</h2>
                <form id="addMemberForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="addFirstName">First Name *</label>
                            <input type="text" id="addFirstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="addLastName">Last Name *</label>
                            <input type="text" id="addLastName" name="lastName" required>
                        </div>
                        <div class="form-group">
                            <label for="addBirthMonth">Birth Month *</label>
                            <select id="addBirthMonth" name="birthMonth" required>
                                <option value="">Select Month</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addBirthDay">Birth Day *</label>
                            <select id="addBirthDay" name="birthDay" required>
                                <option value="">Select Day</option>
                                ${Array.from({length: 31}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addBirthYear">Birth Year *</label>
                            <select id="addBirthYear" name="birthYear" required>
                                <option value="">Select Year</option>
                                ${Array.from({length: 100}, (_, i) => {
                                    const year = new Date().getFullYear() - i;
                                    return `<option value="${year}">${year}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label> Married To (Select all current spouses)</label>
                            <div style="margin-bottom: 0.5rem;">
                                <input type="text" id="spouseSearchInput" placeholder=" Search spouses by name..." 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                       oninput="filterSpouses(this.value)">
                            </div>
                            <div id="spousesSelectionContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: #f9f9f9;">
                                ${familyMembers.map(member => `
                                    <label class="spouse-option" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" name="spouses" value="${member.id}" style="margin-right: 0.5rem;" onchange="updateSpouseCount()">
                                        ${member.firstName} ${member.lastName} (${getAge(member)} years old)
                                    </label>
                                `).join('')}
                            </div>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">Select all people this person is currently married to (for remarriage scenarios)</p>
                        </div>
                        <div class="form-group full-width">
                            <label for="addEmail">Email</label>
                            <input type="email" id="addEmail" name="email" placeholder="Optional">
                        </div>
                        <div class="form-group full-width">
                            <label for="addMobilePhone">Mobile Phone</label>
                            <input type="tel" id="addMobilePhone" name="mobilePhone" placeholder="Optional">
                        </div>
                        <div class="form-group full-width">
                            <label for="addHomePhone">Home Phone</label>
                            <input type="tel" id="addHomePhone" name="homePhone" placeholder="Optional">
                        </div>
                        <div class="form-group full-width">
                            <label for="addAddress">Address</label>
                            <input type="text" id="addAddress" name="address" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="addCity">City</label>
                            <input type="text" id="addCity" name="city" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="addState">State</label>
                            <input type="text" id="addState" name="state" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="addZipCode">Zip Code</label>
                            <input type="text" id="addZipCode" name="zipCode" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="addWorkPhone">Work Phone</label>
                            <input type="tel" id="addWorkPhone" name="workPhone" placeholder="Optional">
                        </div>
                        <div class="form-group full-width">
                            <label for="addFamilyBranch">Family Branch</label>
                            <select id="addFamilyBranch" name="familyBranch">
                                <option value="">No group assigned</option>
                                ${familyBranches.map(branch => 
                                    `<option value="${branch.name}">${branch.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="addNotes">Notes</label>
                            <textarea id="addNotes" name="notes" rows="3" placeholder="Optional notes about this family member"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="addDeceased" name="deceased" style="transform: scale(1.2);">
                                <span> Deceased</span>
                                <small style="color: #666; font-weight: normal;">(Will be outlined in red on the family tree)</small>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Parents Selection -->
                    <div style="margin-top: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;"> Parents <span id="parentsCount" style="font-size: 0.8rem; color: #666;">(0/2)</span></h3>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="parentSearchInput" placeholder=" Search parents by name..." 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                   oninput="filterParents(this.value)">
                        </div>
                        <div id="parentsSelectionContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
                            ${getPotentialParentsForNew().map(member => `
                                <label class="parent-option" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="parents" value="${member.id}" style="margin-right: 0.5rem;" onchange="updateParentCount()">
                                    ${member.firstName} ${member.lastName} (${getAge(member)} years old)
                                </label>
                            `).join('')}
                        </div>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">Maximum 2 parents allowed</p>
                    </div>
                    
                    <!-- Children Selection -->
                    <div style="margin-top: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;"> Children <span id="childrenCount" style="font-size: 0.8rem; color: #666;">(0/15)</span></h3>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="childrenSearchInput" placeholder=" Search children by name..." 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                   oninput="filterChildren(this.value)">
                        </div>
                        <div id="childrenSelectionContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 1rem;">
                            ${getPotentialChildrenForNew().map(member => `
                                <label class="children-option" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="children" value="${member.id}" style="margin-right: 0.5rem;" onchange="updateChildrenCount()">
                                    ${member.firstName} ${member.lastName} (${getAge(member)} years old)
                                </label>
                            `).join('')}
                        </div>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">Maximum 15 children allowed</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('addMemberModal')" style="background: #6c757d; color: white;">Cancel</button>
                        <button type="submit" class="btn btn-primary"> Add Family Member</button>
                    </div>
                </form>
            `;
            
            // Add event listener to the newly created form
            const newForm = modal.querySelector('#addMemberForm');
            if (newForm) {
                newForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addFamilyMember(e);
                });
                console.log('Add member form listener attached to new form');
            }
            
            modal.classList.add('active');
        };

        // Real-time validation functions for add member modal
        window.updateParentCount = function() {
            const checkboxes = document.querySelectorAll('input[name="parents"]:checked');
            const countElement = document.getElementById('parentsCount');
            const allCheckboxes = document.querySelectorAll('input[name="parents"]');
            
            if (countElement) {
                countElement.textContent = `(${checkboxes.length}/2)`;
                countElement.style.color = checkboxes.length > 2 ? '#e74c3c' : '#666';
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (checkboxes.length >= 2) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                            checkbox.parentElement.style.opacity = '0.5';
                        }
                    });
                } else {
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                        checkbox.parentElement.style.opacity = '1';
                    });
                }
            }
        };

        window.updateChildrenCount = function() {
            const checkboxes = document.querySelectorAll('input[name="children"]:checked');
            const countElement = document.getElementById('childrenCount');
            const allCheckboxes = document.querySelectorAll('input[name="children"]');
            
            if (countElement) {
                countElement.textContent = `(${checkboxes.length}/15)`;
                countElement.style.color = checkboxes.length > 15 ? '#e74c3c' : '#666';
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (checkboxes.length >= 15) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                            checkbox.parentElement.style.opacity = '0.5';
                        }
                    });
                } else {
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                        checkbox.parentElement.style.opacity = '1';
                    });
                }
            }
        };

        // Search filter functions for add member modal
        window.filterParents = function(searchTerm) {
            const parentOptions = document.querySelectorAll('.parent-option');
            const searchLower = searchTerm.toLowerCase();
            
            parentOptions.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchLower)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        };

        window.filterChildren = function(searchTerm) {
            const childrenOptions = document.querySelectorAll('.children-option');
            const searchLower = searchTerm.toLowerCase();
            
            childrenOptions.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchLower)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        };

        window.filterSpouses = function(searchTerm) {
            const spouseOptions = document.querySelectorAll('.spouse-option');
            const searchLower = searchTerm.toLowerCase();
            
            spouseOptions.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchLower)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        };

        window.updateSpouseCount = function() {
            const spouseCheckboxes = document.querySelectorAll('input[name="spouses"]:checked');
            console.log(`Selected ${spouseCheckboxes.length} spouse(s)`);
        };

        // Marriage History Management Functions
        let marriageHistoryCounter = 0;

        window.addMarriageHistoryEntry = function() {
            marriageHistoryCounter++;
            const container = document.getElementById('marriageHistoryContainer');
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'marriage-history-entry';
            entryDiv.style.cssText = 'background: white; border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin: 0.5rem 0; position: relative;';
            entryDiv.id = `marriageEntry${marriageHistoryCounter}`;
            
            entryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                    <div>
                        <label style="font-size: 0.9rem; color: #333; margin-bottom: 0.25rem; display: block;">Previous Spouse</label>
                        <select name="previousSpouse${marriageHistoryCounter}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select Previous Spouse</option>
                            ${familyMembers.map(member => 
                                `<option value="${member.id}">${member.firstName} ${member.lastName}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; color: #333; margin-bottom: 0.25rem; display: block;">Status</label>
                        <select name="marriageStatus${marriageHistoryCounter}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="divorced">Divorced</option>
                            <option value="widowed">Widowed (Spouse Deceased)</option>
                            <option value="separated">Separated</option>
                            <option value="annulled">Annulled</option>
                        </select>
                    </div>
                    <button type="button" onclick="removeMarriageHistoryEntry('marriageEntry${marriageHistoryCounter}')" 
                            style="padding: 0.5rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        
                    </button>
                </div>
                <div style="margin-top: 0.5rem;">
                    <label style="font-size: 0.9rem; color: #333; margin-bottom: 0.25rem; display: block;">Marriage Duration (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <input type="number" name="marriageStartYear${marriageHistoryCounter}" placeholder="Start Year (e.g., 2010)" 
                               style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" name="marriageEndYear${marriageHistoryCounter}" placeholder="End Year (e.g., 2018)" 
                               style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            `;
            
            // Remove the initial message if this is the first entry
            const initialMessage = container.querySelector('p');
            if (initialMessage) {
                initialMessage.remove();
            }
            
            container.appendChild(entryDiv);
        };

        window.removeMarriageHistoryEntry = function(entryId) {
            const entry = document.getElementById(entryId);
            if (entry) {
                entry.remove();
                
                // If no entries left, show the initial message again
                const container = document.getElementById('marriageHistoryContainer');
                if (container.children.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-size: 0.9rem; margin: 0;">Click "Add Previous Marriage" to record past marriages (including deceased spouses)</p>';
                }
            }
        };

        window.collectMarriageHistory = function() {
            const marriageHistory = [];
            const container = document.getElementById('marriageHistoryContainer');
            const entries = container.querySelectorAll('.marriage-history-entry');
            
            entries.forEach((entry, index) => {
                const entryId = entry.id.replace('marriageEntry', '');
                const spouseSelect = entry.querySelector(`select[name="previousSpouse${entryId}"]`);
                const statusSelect = entry.querySelector(`select[name="marriageStatus${entryId}"]`);
                const startYearInput = entry.querySelector(`input[name="marriageStartYear${entryId}"]`);
                const endYearInput = entry.querySelector(`input[name="marriageEndYear${entryId}"]`);
                
                if (spouseSelect.value) {
                    const spouseMember = familyMembers.find(m => m.id === spouseSelect.value);
                    marriageHistory.push({
                        spouseId: spouseSelect.value,
                        spouseName: spouseMember ? `${spouseMember.firstName} ${spouseMember.lastName}` : 'Unknown',
                        status: statusSelect.value,
                        startYear: startYearInput.value ? parseInt(startYearInput.value) : null,
                        endYear: endYearInput.value ? parseInt(endYearInput.value) : null,
                        createdAt: new Date()
                    });
                }
            });
            
            return marriageHistory;
        };

        // Edit Modal Marriage History Management Functions
        function populateEditMarriageHistory(marriageHistory) {
            const container = document.getElementById('editMarriageHistoryEntries');
            container.innerHTML = '';
            
            marriageHistory.forEach((marriage, index) => {
                addEditMarriageHistoryEntry(marriage, index);
            });
        }

        function addEditMarriageHistoryEntry(existingMarriage = null, index = null) {
            const container = document.getElementById('editMarriageHistoryEntries');
            const entryId = index !== null ? index : Date.now();
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'marriage-history-entry';
            entryDiv.style.cssText = 'border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background: white;';
            
            entryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: #2c3e50;">Marriage Entry #${container.children.length + 1}</h4>
                    <button type="button" onclick="removeEditMarriageHistoryEntry(this)" style="background: #e74c3c; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                         Remove
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Previous Spouse</label>
                        <select class="edit-marriage-spouse" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select previous spouse</option>
                            ${familyMembers.map(member => 
                                `<option value="${member.id}" ${existingMarriage && existingMarriage.spouseId === member.id ? 'selected' : ''}>
                                    ${member.firstName} ${member.lastName}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Marriage Status</label>
                        <select class="edit-marriage-status" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="divorced" ${existingMarriage && existingMarriage.status === 'divorced' ? 'selected' : ''}>Divorced</option>
                            <option value="widowed" ${existingMarriage && existingMarriage.status === 'widowed' ? 'selected' : ''}>Widowed</option>
                            <option value="separated" ${existingMarriage && existingMarriage.status === 'separated' ? 'selected' : ''}>Separated</option>
                            <option value="annulled" ${existingMarriage && existingMarriage.status === 'annulled' ? 'selected' : ''}>Annulled</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Marriage Start Year</label>
                        <input type="number" class="edit-marriage-start-year" min="1900" max="2030" 
                               value="${existingMarriage ? existingMarriage.startYear || '' : ''}"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="e.g., 1995">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Marriage End Year</label>
                        <input type="number" class="edit-marriage-end-year" min="1900" max="2030" 
                               value="${existingMarriage ? existingMarriage.endYear || '' : ''}"
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" 
                               placeholder="e.g., 2010">
                    </div>
                </div>
            `;
            
            container.appendChild(entryDiv);
        }

        function removeEditMarriageHistoryEntry(button) {
            const entry = button.closest('.marriage-history-entry');
            entry.remove();
            
            // Renumber remaining entries
            const entries = document.querySelectorAll('#editMarriageHistoryEntries .marriage-history-entry h4');
            entries.forEach((header, index) => {
                header.textContent = `Marriage Entry #${index + 1}`;
            });
        }

        function collectEditMarriageHistory() {
            const entries = document.querySelectorAll('#editMarriageHistoryEntries .marriage-history-entry');
            const marriageHistory = [];
            
            entries.forEach(entry => {
                const spouseId = entry.querySelector('.edit-marriage-spouse').value;
                const status = entry.querySelector('.edit-marriage-status').value;
                const startYear = parseInt(entry.querySelector('.edit-marriage-start-year').value) || null;
                const endYear = parseInt(entry.querySelector('.edit-marriage-end-year').value) || null;
                
                if (spouseId && status) {
                    marriageHistory.push({
                        spouseId,
                        status,
                        startYear,
                        endYear
                    });
                }
            });
            
            return marriageHistory;
        }

        window.addEditMarriageHistoryEntry = addEditMarriageHistoryEntry;
        window.removeEditMarriageHistoryEntry = removeEditMarriageHistoryEntry;

        // Update family member function
        window.updateFamilyMember = async function(event, memberId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Get selected children (look for edit modal checkboxes)
            const selectedChildren = [];
            const childrenCheckboxes = document.querySelectorAll('input[name="editChildren"]:checked');
            childrenCheckboxes.forEach(checkbox => {
                selectedChildren.push(checkbox.value);
            });
            
            // Get selected parents (look for edit modal checkboxes)
            const selectedParents = [];
            const parentsCheckboxes = document.querySelectorAll('input[name="editParents"]:checked');
            parentsCheckboxes.forEach(checkbox => {
                selectedParents.push(checkbox.value);
            });
            
            try {
                // Get current member to check for marriage changes
                const currentMember = familyMembers.find(m => m.id === memberId);
                const oldSpouseId = currentMember?.marriedTo;
                const newSpouseId = formData.get('marriedTo') || null;
                
                const memberRef = doc(db, 'family_members', memberId);
                const updateData = {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    birthMonth: formData.get('birthMonth'),
                    birthDay: parseInt(formData.get('birthDay')),
                    birthYear: parseInt(formData.get('birthYear')),
                    familyBranch: formData.get('familyBranch'),
                    marriedTo: newSpouseId,
                    children: selectedChildren, // Save the children array
                    parents: selectedParents, // Save the parents array
                    mobilePhone: formData.get('mobilePhone'),
                    homePhone: formData.get('homePhone'),
                    workPhone: formData.get('workPhone'),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    state: formData.get('state'),
                    zipCode: formData.get('zipCode'),
                    anniversaryDate: formData.get('anniversaryDate'),
                    notes: formData.get('notes'),
                    updatedAt: new Date()
                };

                await updateDoc(memberRef, updateData);
                
                // Log the edit
                await logUserAction('edit', 'family_member', `Updated ${updateData.firstName} ${updateData.lastName}`, 'success');
                
                // Update bidirectional marriage relationships
                await updateBidirectionalMarriage(memberId, oldSpouseId, newSpouseId);
                
                // Update bidirectional parent/child relationships
                await updateBidirectionalRelationships(memberId, selectedParents, selectedChildren);
                
                closeModal('generalModal');
                await loadFamilyMembers(); // Refresh the data
                displayFamilyMembers(); // Refresh the display
                displayBranches(); // Refresh family trees
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member: ' + error.message, 'error');
            }
        };

        // Delete family member function
        window.deleteFamilyMember = async function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            if (!confirm(`Are you sure you want to delete ${member.firstName} ${member.lastName}? This action cannot be undone.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'family_members', memberId));
                
                // Log the deletion
                await logUserAction('delete', 'family_member', `Deleted ${member.firstName} ${member.lastName}`, 'success');
                
                loadFamilyMembers(); // Refresh the display
                showMessage('Family member deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting family member:', error);
                await logUserAction('delete', 'family_member', `Failed to delete ${member.firstName} ${member.lastName}: ${error.message}`, 'failed');
                showMessage('Error deleting family member: ' + error.message, 'error');
            }
        };

        // Show message function
        window.showMessage = function(message, type = 'success') {
            // Remove any existing message
            const existingMessage = document.querySelector('.floating-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'floating-message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 2000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
            `;
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            // Auto remove after 4 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 4000);
        };

        // Add CSS animation for messages
        if (!document.querySelector('#message-animations')) {
            const style = document.createElement('style');
            style.id = 'message-animations';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Tab switching
        window.switchTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // If switching to relationships tab, initialize the relationship system display
            if (tabName === 'relationships' && relationshipSystem && relationshipUI) {
                initializeRelationshipDisplay();
            }
            
            // If switching to branches tab, refresh the auto-generated family trees
            if (tabName === 'branches') {
                displayBranches();
            }
            
            // If switching to requests tab, refresh the account requests
            if (tabName === 'requests') {
                loadAccountRequests().then(() => {
                    displayAccountRequests();
                });
            }
        };

        // Relationship tab switching
        window.switchRelationshipTab = function(subTabName) {
            // Update sub-tab buttons
            const relationshipTabs = document.querySelectorAll('#relationships .tab');
            relationshipTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-sections
            document.querySelectorAll('.relationship-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            const targetSection = document.getElementById('relationships' + subTabName.charAt(0).toUpperCase() + subTabName.slice(1));
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }

            // Load appropriate content
            if (relationshipSystem && relationshipUI) {
                if (subTabName === 'people') {
                    relationshipUI.displayPeopleTab();
                } else if (subTabName === 'families') {
                    relationshipUI.displayFamiliesTab();
                }
            }
        };

        // Initialize relationship system display when first accessed
        async function initializeRelationshipDisplay() {
            try {
                if (relationshipSystem && relationshipUI) {
                    // Load data for relationship system
                    await relationshipSystem.loadAllData();
                    
                    // Display initial people tab
                    relationshipUI.displayPeopleTab();
                    
                    // Update upcoming birthdays to use new system if it has data
                    if (relationshipSystem.people.length > 0) {
                        relationshipUI.displayUpcomingBirthdays();
                    }
                }
            } catch (error) {
                console.error('Error initializing relationship display:', error);
            }
        }

        // Manual Family Card Functions
        let selectedManualMembers = new Set(); // Track selected members

        // Open manual family card modal
        window.openManualFamilyCardModal = function() {
            const modal = document.getElementById('manualFamilyCardModal');
            if (!modal) return;
            
            // Reset form
            document.getElementById('manualFamilyName').value = '';
            document.getElementById('manualFamilyDescription').value = '';
            selectedManualMembers.clear();
            
            // Populate member selection grid
            populateManualFamilyMembers();
            updateSelectedMembersPreview();
            
            modal.classList.add('active');
        };

        // Populate family members for selection
        function populateManualFamilyMembers() {
            const grid = document.getElementById('memberSelectionGrid');
            if (!grid) return;
            
            grid.innerHTML = familyMembers.map(member => {
                const age = getAge(member);
                const isDeceased = member.deceased;
                const deceasedStyle = isDeceased ? 'background: #ffebee; border: 2px solid #e74c3c;' : 'background: #f8f9ff; border: 1px solid #e0e6ed;';
                const deceasedIcon = isDeceased ? ' ' : '';
                
                return `
                    <div class="member-selection-item" data-member-id="${member.id}" 
                         style="${deceasedStyle} padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.3s;"
                         onclick="toggleManualMemberSelection('${member.id}')">
                        <div style="font-weight: 600; color: ${isDeceased ? '#c62828' : '#667eea'};">
                            ${deceasedIcon}${member.firstName} ${member.lastName}
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                            ${age ? `Age ${age}` : 'Age unknown'}
                            ${member.spouse ? `  Spouse: ${getSpouseName(member.spouse)}` : ''}
                        </div>
                        <div class="selection-checkbox" style="position: absolute; top: 0.5rem; right: 0.5rem; 
                             width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 4px; background: white;">
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle member selection
        window.toggleManualMemberSelection = function(memberId) {
            const memberItem = document.querySelector(`[data-member-id="${memberId}"]`);
            const checkbox = memberItem.querySelector('.selection-checkbox');
            
            if (selectedManualMembers.has(memberId)) {
                selectedManualMembers.delete(memberId);
                checkbox.style.background = 'white';
                checkbox.innerHTML = '';
                memberItem.style.transform = 'scale(1)';
            } else {
                selectedManualMembers.add(memberId);
                checkbox.style.background = '#27ae60';
                checkbox.innerHTML = '<span style="color: white; font-size: 12px;"></span>';
                memberItem.style.transform = 'scale(1.02)';
            }
            
            updateSelectedMembersPreview();
        };

        // Filter family members in manual selection
        window.filterManualFamilyMembers = function() {
            const searchTerm = document.getElementById('memberSearchInput').value.toLowerCase();
            const memberItems = document.querySelectorAll('.member-selection-item');
            
            memberItems.forEach(item => {
                const memberId = item.getAttribute('data-member-id');
                const member = familyMembers.find(m => m.id === memberId);
                const fullName = `${member.firstName} ${member.lastName}`.toLowerCase();
                
                if (fullName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Update selected members preview
        function updateSelectedMembersPreview() {
            const preview = document.getElementById('selectedMembersPreview');
            if (!preview) return;
            
            if (selectedManualMembers.size === 0) {
                preview.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">No members selected yet...</p>';
                return;
            }
            
            const selectedMembersList = Array.from(selectedManualMembers).map(memberId => {
                const member = familyMembers.find(m => m.id === memberId);
                const age = getAge(member);
                const isDeceased = member.deceased;
                const deceasedIcon = isDeceased ? ' ' : '';
                
                return `
                    <span style="display: inline-block; margin: 0.25rem; padding: 0.5rem; background: ${isDeceased ? '#ffebee' : '#e8f5e8'}; 
                          border: 1px solid ${isDeceased ? '#e74c3c' : '#b8e6b8'}; border-radius: 12px; font-size: 0.85rem;">
                        ${deceasedIcon}${member.firstName} ${member.lastName} ${age ? `(${age})` : ''}
                        <button onclick="toggleManualMemberSelection('${member.id}')" 
                                style="margin-left: 0.5rem; background: none; border: none; color: #e74c3c; cursor: pointer;"></button>
                    </span>
                `;
            }).join('');
            
            preview.innerHTML = `
                <div style="margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                    Selected Members (${selectedManualMembers.size}):
                </div>
                ${selectedMembersList}
            `;
        }

        // Create manual family card
        window.createManualFamilyCard = async function(event) {
            event.preventDefault();
            
            const familyName = document.getElementById('manualFamilyName').value.trim();
            const familyDescription = document.getElementById('manualFamilyDescription').value.trim();
            
            if (!familyName) {
                showMessage('Please enter a family name', 'error');
                return;
            }
            
            if (selectedManualMembers.size === 0) {
                showMessage('Please select at least one family member', 'error');
                return;
            }
            
            try {
                // Create manual family tree object
                const manualFamily = {
                    id: 'manual_' + Date.now(),
                    name: familyName,
                    description: familyDescription,
                    memberIds: Array.from(selectedManualMembers),
                    type: 'manual',
                    createdAt: new Date().toISOString(),
                    isMemorial: true
                };
                
                // Store in Firebase (optional - can be stored locally for now)
                await addDoc(collection(db, 'manual_family_trees'), manualFamily);
                
                // Add to local array
                manualFamilyTrees.push(manualFamily);
                
                showMessage(`Memorial family "${familyName}" created successfully!`, 'success');
                closeModal('manualFamilyCardModal');
                
                // Refresh the family groups display
                displayBranches();
                
            } catch (error) {
                console.error('Error creating manual family tree:', error);
                showMessage('Error creating memorial family. Please try again.', 'error');
            }
        };

        // Load manual family trees from Firebase - EXCLUDE VIRTUAL FAMILIES
        async function loadManualFamilyTrees() {
            try {
                // Load only manual families that are NOT virtual (exclude isVirtual: true)
                const querySnapshot = await getDocs(query(collection(db, 'manual_family_trees'), where('isVirtual', '!=', true)));
                manualFamilyTrees = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(` Loaded ${manualFamilyTrees.length} manual family trees (excluding virtual families)`);
            } catch (error) {
                console.error('Error loading manual family trees:', error);
            }
        }

        // View manual family detail
        window.viewManualFamilyDetail = function(manualFamilyId) {
            const manualFamily = manualFamilyTrees.find(f => f.id === manualFamilyId);
            if (!manualFamily) return;
            
            const members = manualFamily.memberIds.map(id => familyMembers.find(m => m.id === id)).filter(m => m);
            const deceasedMembers = members.filter(m => m.deceased);
            const livingMembers = members.filter(m => !m.deceased);
            
            const modalContent = `
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h2 style="margin: 0; font-size: 2rem;"> ${manualFamily.name}</h2>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Memorial Family Tree</p>
                    ${manualFamily.description ? `<p style="margin: 1rem 0 0 0; font-style: italic;">${manualFamily.description}</p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; color: #e74c3c; margin-bottom: 0.5rem;">${members.length}</div>
                        <div style="color: #666;">Total Members</div>
                    </div>
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; color: #e74c3c; margin-bottom: 0.5rem;">${deceasedMembers.length}</div>
                        <div style="color: #666;">Deceased</div>
                    </div>
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; color: #27ae60; margin-bottom: 0.5rem;">${livingMembers.length}</div>
                        <div style="color: #666;">Living</div>
                    </div>
                </div>
                
                ${deceasedMembers.length > 0 ? `
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                        <h3 style="color: #e74c3c; margin-bottom: 1rem;"> In Loving Memory</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                            ${deceasedMembers.map(member => {
                                const age = getAge(member);
                                return `
                                    <div style="background: #ffebee; border: 2px solid #e74c3c; border-radius: 8px; padding: 1rem;">
                                        <div style="font-weight: 600; color: #c62828; margin-bottom: 0.5rem;"> ${member.firstName} ${member.lastName}</div>
                                        <div style="color: #666; font-size: 0.9rem;">${age ? `Age ${age}` : 'Age unknown'}</div>
                                        ${member.spouse ? `<div style="color: #666; font-size: 0.9rem;">Spouse: ${getSpouseName(member.spouse)}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${livingMembers.length > 0 ? `
                    <div style="background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #27ae60; margin-bottom: 1rem;"> Living Family Members</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                            ${livingMembers.map(member => {
                                const age = getAge(member);
                                return `
                                    <div style="background: #e8f5e8; border: 2px solid #27ae60; border-radius: 8px; padding: 1rem; cursor: pointer;" onclick="openEditMemberModal('${member.id}')">
                                        <div style="font-weight: 600; color: #2d5a2d; margin-bottom: 0.5rem;">${member.firstName} ${member.lastName}</div>
                                        <div style="color: #666; font-size: 0.9rem;">${age ? `Age ${age}` : 'Age unknown'}</div>
                                        ${member.spouse ? `<div style="color: #666; font-size: 0.9rem;">Spouse: ${getSpouseName(member.spouse)}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('familyDetailModal').querySelector('.modal-content').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="color: #e74c3c;">Memorial Family Details</h2>
                    <button class="btn" onclick="closeModal('familyDetailModal')" style="background: #6c757d; color: white;"> Close</button>
                </div>
                ${modalContent}
            `;
            document.getElementById('familyDetailModal').classList.add('active');
        };

        // View virtual family detail - SIMPLIFIED TO MATCH NORMAL FAMILY VIEW
        window.viewVirtualFamilyDetail = function(virtualFamilyId) {
            console.log(' viewVirtualFamilyDetail called with ID:', virtualFamilyId);
            
            // First, try to find the virtual family in the loaded array
            let virtualFamily = virtualFamilyGroups.find(f => f.id === virtualFamilyId);
            
            if (!virtualFamily) {
                console.log(' Virtual family not found in memory, reloading...');
                console.log(' Available virtual family groups:', virtualFamilyGroups.length);
                
                // Reload virtual families and try again
                loadVirtualFamilyGroups().then(() => {
                    console.log(' Reloaded virtual families, retrying...');
                    virtualFamily = virtualFamilyGroups.find(f => f.id === virtualFamilyId);
                    if (virtualFamily) {
                        showVirtualFamilyDetailModal(virtualFamily);
                    } else {
                        console.error(' Still not found after reload');
                        // Try direct Firebase query as last resort
                        loadSingleVirtualFamily(virtualFamilyId);
                    }
                });
                return;
            }
            
            console.log(' Found virtual family:', virtualFamily);
            showVirtualFamilyDetailModal(virtualFamily);
        };

        // Direct Firebase query for single virtual family - FIXED TO USE CORRECT COLLECTION
        async function loadSingleVirtualFamily(virtualFamilyId) {
            try {
                // Virtual families are stored in manual_family_trees collection
                const docRef = doc(db, 'manual_family_trees', virtualFamilyId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const virtualFamily = { id: docSnap.id, ...docSnap.data() };
                    console.log(' Found virtual family via direct query:', virtualFamily);
                    if (virtualFamily.isVirtual) {
                        showVirtualFamilyDetailModal(virtualFamily);
                    } else {
                        console.error(' Document exists but is not a virtual family');
                        alert('This is not a virtual family group.');
                    }
                } else {
                    console.error(' Virtual family document does not exist');
                    alert('Virtual family group not found. It may have been deleted.');
                }
            } catch (error) {
                console.error(' Error loading virtual family:', error);
                alert('Error loading virtual family data. Please try again.');
            }
        }

        // Show virtual family detail modal - MATCHES NORMAL FAMILY VIEW EXACTLY
        function showVirtualFamilyDetailModal(virtualFamily) {
            console.log(' Displaying virtual family modal for:', virtualFamily.name);
            
            // Get all members (parents + children)
            const parentIds = virtualFamily.parentIds || [];
            const childrenIds = virtualFamily.childrenIds || [];
            const allMemberIds = [...parentIds, ...childrenIds];
            
            const allMembers = allMemberIds.map(id => familyMembers.find(m => m.id === id)).filter(m => m);
            const parents = parentIds.map(id => familyMembers.find(m => m.id === id)).filter(m => m);
            const children = childrenIds.map(id => familyMembers.find(m => m.id === id)).filter(m => m);
            
            const totalMembers = allMembers.length;
            const livingMembers = allMembers.filter(m => !m.deceased);
            const deceasedMembers = allMembers.filter(m => m.deceased);
            const avgAge = totalMembers > 0 ? Math.round(allMembers.reduce((sum, m) => sum + getAge(m), 0) / totalMembers) : 0;

            let modalContent = `
                <div class="family-groups-header" style="margin-bottom: 2rem;">
                    <h2> ${virtualFamily.name}</h2>
                    <p>${totalMembers} members  Enhanced Family Group</p>
                    <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid #4caf50; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                        <strong> Manual Creation:</strong> This family was manually created!
                    </div>
                </div>
                
                <div class="family-stats" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number">${totalMembers}</div>
                        <div class="stat-label">Total Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${parents.length}</div>
                        <div class="stat-label">Parents/Heads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${livingMembers.length}</div>
                        <div class="stat-label">Living Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${avgAge}</div>
                        <div class="stat-label">Average Age</div>
                    </div>
                </div>
            `;

            // Parents/Heads section
            if (parents.length > 0) {
                modalContent += `
                    <div class="generation-section" style="margin-bottom: 2rem;">
                        <div class="generation-header">
                            <span class="generation-icon"></span>
                            <h4 class="generation-title">Parents/Heads of Family</h4>
                            <span class="generation-count">${parents.length}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            ${parents.map(member => {
                                const age = getAge(member);
                                const deceasedStyle = member.deceased ? 'border: 3px solid #e74c3c; background: #ffebee;' : '';
                                const deceasedIcon = member.deceased ? ' ' : '';
                                
                                return `
                                    <div style="background: white; border: 2px solid #f0f0f0; border-radius: 15px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s; ${deceasedStyle}" onclick="openEditMemberModal('${member.id}')">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${member.deceased ? '' : ''}</div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 0.5rem;">
                                            ${deceasedIcon}${member.firstName} ${member.lastName}
                                        </div>
                                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                            ${age ? `Age ${age}` : 'Age unknown'}
                                        </div>
                                        <div style="color: #9c27b0; font-size: 0.8rem; margin-top: 0.5rem;"> Family Head</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Children/Family Members section
            if (children.length > 0) {
                modalContent += `
                    <div class="generation-section" style="margin-bottom: 2rem;">
                        <div class="generation-header">
                            <span class="generation-icon"></span>
                            <h4 class="generation-title">Children/Family Members</h4>
                            <span class="generation-count">${children.length}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            ${children.map(member => {
                                const age = getAge(member);
                                const deceasedStyle = member.deceased ? 'border: 3px solid #e74c3c; background: #ffebee;' : '';
                                const deceasedIcon = member.deceased ? ' ' : '';
                                
                                return `
                                    <div style="background: white; border: 2px solid #f0f0f0; border-radius: 15px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s; ${deceasedStyle}" onclick="openEditMemberModal('${member.id}')">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${member.deceased ? '' : ''}</div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #333; margin-bottom: 0.5rem;">
                                            ${deceasedIcon}${member.firstName} ${member.lastName}
                                        </div>
                                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                            ${age ? `Age ${age}` : 'Age unknown'}
                                        </div>
                                        <div style="color: #9c27b0; font-size: 0.8rem; margin-top: 0.5rem;"> Family Member</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Set modal content and show
            document.getElementById('familyDetailModal').querySelector('.modal-content').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="color: #9c27b0;">Enhanced Family Group Details</h2>
                    <button class="btn" onclick="closeModal('familyDetailModal')" style="background: #6c757d; color: white;"> Close</button>
                </div>
                ${modalContent}
            `;
            
            document.getElementById('familyDetailModal').classList.add('active');
            console.log(' Virtual family modal displayed successfully');
        }

        // Edit manual family - UPDATED TO HANDLE VIRTUAL FAMILIES
        window.editManualFamily = function(manualFamilyId) {
            // Admin permission check
            if (currentUser?.username !== 'dfinn12') {
                showMessage('Access denied. Only administrators can edit family trees.', 'error');
                return;
            }
            
            // First try to find in manual families
            let manualFamily = manualFamilyTrees.find(f => f.id === manualFamilyId);
            let isVirtual = false;
            
            // If not found, try virtual families
            if (!manualFamily) {
                manualFamily = virtualFamilyGroups.find(f => f.id === manualFamilyId);
                isVirtual = true;
            }
            
            if (!manualFamily) {
                console.error('Family not found:', manualFamilyId);
                alert('Family not found. Please refresh the page and try again.');
                return;
            }
            
            console.log(' Editing family:', manualFamily.name, 'Virtual:', isVirtual);
            
            // Pre-populate the form with existing data
            selectedManualMembers.clear();
            
            // Handle different data structures for virtual vs manual families
            const memberIds = isVirtual ? 
                [...(manualFamily.parentIds || []), ...(manualFamily.childrenIds || [])] : 
                (manualFamily.memberIds || []);
                
            memberIds.forEach(id => selectedManualMembers.add(id));
            
            document.getElementById('manualFamilyName').value = manualFamily.name;
            document.getElementById('manualFamilyDescription').value = manualFamily.description || '';
            
            populateManualFamilyMembers();
            updateSelectedMembersPreview();
            
            // Update the form to edit mode
            document.getElementById('manualFamilyForm').onsubmit = function(event) {
                updateManualFamilyCard(event, manualFamilyId);
            };
            
            // Update modal title based on family type
            const modalTitle = isVirtual ? ' Edit Enhanced Family Group' : ' Edit Memorial Family Tree';
            const buttonText = isVirtual ? ' Update Enhanced Group' : ' Update Memorial Family';
            
            document.querySelector('#manualFamilyCardModal h2').textContent = modalTitle;
            document.querySelector('#manualFamilyCardModal .btn-danger').innerHTML = buttonText;
            
            document.getElementById('manualFamilyCardModal').classList.add('active');
        };

        // Update manual family card - UPDATED TO HANDLE VIRTUAL FAMILIES
        window.updateManualFamilyCard = async function(event, manualFamilyId) {
            event.preventDefault();
            
            const familyName = document.getElementById('manualFamilyName').value.trim();
            const familyDescription = document.getElementById('manualFamilyDescription').value.trim();
            
            if (!familyName) {
                showMessage('Please enter a family name', 'error');
                return;
            }
            
            if (selectedManualMembers.size === 0) {
                showMessage('Please select at least one family member', 'error');
                return;
            }
            
            try {
                // Check if this is a virtual family
                const isVirtual = virtualFamilyGroups.some(f => f.id === manualFamilyId);
                
                let updatedFamily;
                
                if (isVirtual) {
                    // Virtual family structure - split members into parents and children
                    const allMemberIds = Array.from(selectedManualMembers);
                    
                    // For simplicity, treat all selected members as mixed (could be enhanced later)
                    updatedFamily = {
                        name: familyName,
                        description: familyDescription,
                        parentIds: allMemberIds, // For now, put all in parents (can be refined)
                        childrenIds: [],
                        updatedAt: new Date().toISOString(),
                        isVirtual: true
                    };
                } else {
                    // Regular manual family structure
                    updatedFamily = {
                        name: familyName,
                        description: familyDescription,
                        memberIds: Array.from(selectedManualMembers),
                        updatedAt: new Date().toISOString()
                    };
                }
                
                // Update in Firebase
                await updateDoc(doc(db, 'manual_family_trees', manualFamilyId), updatedFamily);
                
                // Update local array
                if (isVirtual) {
                    const index = virtualFamilyGroups.findIndex(f => f.id === manualFamilyId);
                    if (index !== -1) {
                        virtualFamilyGroups[index] = { ...virtualFamilyGroups[index], ...updatedFamily };
                    }
                } else {
                    const index = manualFamilyTrees.findIndex(f => f.id === manualFamilyId);
                    if (index !== -1) {
                        manualFamilyTrees[index] = { ...manualFamilyTrees[index], ...updatedFamily };
                    }
                }
                
                const familyType = isVirtual ? 'Enhanced family group' : 'Memorial family';
                showMessage(`${familyType} "${familyName}" updated successfully!`, 'success');
                closeModal('manualFamilyCardModal');
                
                // Reset form
                document.getElementById('manualFamilyForm').onsubmit = function(event) {
                    createManualFamilyCard(event);
                };
                document.querySelector('#manualFamilyCardModal h2').textContent = ' Create Memorial Family Tree';
                document.querySelector('#manualFamilyCardModal .btn-danger').innerHTML = ' Create Memorial Family';
                
                // Refresh the display
                displayBranches();
                
            } catch (error) {
                console.error('Error updating family:', error);
                showMessage('Error updating family. Please try again.', 'error');
            }
        };
                
                // Refresh the family groups display
                displayBranches();
                
         //   } catch (error) {
         //       console.error('Error updating manual family tree:', error);
         //       showMessage('Error updating memorial family. Please try again.', 'error');
         //   }
        //  }; -> //

        // Delete manual family
        window.deleteManualFamily = async function(manualFamilyId) {
            // Admin permission check
            if (currentUser?.username !== 'dfinn12') {
                showMessage('Access denied. Only administrators can delete family trees.', 'error');
                return;
            }
            
            // Look for the family in both manual and virtual family arrays
            let manualFamily = manualFamilyTrees.find(f => f.id === manualFamilyId);
            let isVirtual = false;
            
            if (!manualFamily) {
                manualFamily = virtualFamilyGroups.find(f => f.id === manualFamilyId);
                isVirtual = true;
            }
            
            if (!manualFamily) {
                showMessage('Family not found.', 'error');
                return;
            }
            
            const familyType = isVirtual ? 'virtual family group' : 'memorial family';
            if (!confirm(`Are you sure you want to delete the ${familyType} "${manualFamily.name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                // Delete from Firebase
                await deleteDoc(doc(db, 'manual_family_trees', manualFamilyId));
                
                // Remove from appropriate local array
                if (isVirtual) {
                    virtualFamilyGroups = virtualFamilyGroups.filter(f => f.id !== manualFamilyId);
                } else {
                    manualFamilyTrees = manualFamilyTrees.filter(f => f.id !== manualFamilyId);
                }
                
                showMessage(`${familyType.charAt(0).toUpperCase() + familyType.slice(1)} "${manualFamily.name}" deleted successfully!`, 'success');
                
                // Refresh the family groups display
                displayBranches();
                
            } catch (error) {
                console.error('Error deleting family tree:', error);
                showMessage(`Error deleting ${familyType}. Please try again.`, 'error');
            }
        };

        // Super Admin Functions (dfinn12 only) - Hide/Show Family Groups
        window.hideFamilyGroup = async function(familyId) {
            if (currentUser?.username !== 'dfinn12') {
                console.log('Access denied: Only dfinn12 can hide families');
                return;
            }
            
            try {
                // Add to hidden families set
                hiddenFamilyIds.add(familyId);
                
                // Save to Firebase for persistence across all users
                await addDoc(collection(db, 'hidden_families'), {
                    familyId: familyId,
                    hiddenBy: currentUser.username,
                    hiddenAt: new Date().toISOString()
                });
                
                // Generate current family trees to find the family name
                const currentFamilyTrees = generateFamilyTrees();
                const family = currentFamilyTrees.find(f => f.id === familyId) || 
                              manualFamilyTrees.find(f => f.id === familyId);
                const familyName = family ? family.name : 'Family';
                
                console.log(`Hidden family: ${familyName} (${familyId})`);
                showMessage(`${familyName} has been hidden from public view`, 'success');
                
                // Refresh the display
                displayBranches();
                displayHiddenFamilies();
                
            } catch (error) {
                console.error('Error hiding family:', error);
                showMessage('Error hiding family. Please try again.', 'error');
            }
        };

        window.unhideFamilyGroup = async function(familyId) {
            if (currentUser?.username !== 'dfinn12') {
                console.log('Access denied: Only dfinn12 can unhide families');
                return;
            }
            
            try {
                // Remove from hidden families set
                hiddenFamilyIds.delete(familyId);
                
                // Remove from Firebase
                const q = query(collection(db, 'hidden_families'), where('familyId', '==', familyId));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (docToDelete) => {
                    await deleteDoc(doc(db, 'hidden_families', docToDelete.id));
                });
                
                // Generate current family trees to find the family name
                const currentFamilyTrees = generateFamilyTrees();
                const family = currentFamilyTrees.find(f => f.id === familyId) || 
                              manualFamilyTrees.find(f => f.id === familyId);
                const familyName = family ? family.name : 'Family';
                
                console.log(`Unhidden family: ${familyName} (${familyId})`);
                showMessage(`${familyName} is now visible to all users`, 'success');
                
                // Refresh the display
                displayBranches();
                displayHiddenFamilies();
                
            } catch (error) {
                console.error('Error unhiding family:', error);
                showMessage('Error unhiding family. Please try again.', 'error');
            }
        };

        function displayHiddenFamilies() {
            if (currentUser?.username !== 'dfinn12') return;
            
            const hiddenContainer = document.getElementById('hiddenFamiliesContainer');
            if (!hiddenContainer) return;
            
            // Generate current family trees and get hidden families
            const currentFamilyTrees = generateFamilyTrees();
            const hiddenAuto = currentFamilyTrees.filter(f => hiddenFamilyIds.has(f.id));
            const hiddenManual = manualFamilyTrees.filter(f => hiddenFamilyIds.has(f.id));
            const allHidden = [...hiddenAuto, ...hiddenManual];
            
            if (allHidden.length === 0) {
                hiddenContainer.innerHTML = '<div class="no-families">No families are currently hidden</div>';
                return;
            }
            
            hiddenContainer.innerHTML = allHidden.map(family => `
                <div class="family-card small" style="border: 2px solid #e74c3c; background: #fdf2f2;">
                    <div class="family-header">
                        <h3>${family.name}</h3>
                        <span class="hidden-badge" style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">HIDDEN</span>
                    </div>
                    <div class="family-meta">
                        <span>Type: ${family.isManual ? 'Memorial' : 'Auto-Generated'}</span>
                        <span>Members: ${family.isManual ? family.members?.length || 0 : family.members?.length || 0}</span>
                    </div>
                    <div class="family-actions">
                        <button class="action-btn" onclick="unhideFamilyGroup('${family.id}')" 
                                style="background: #27ae60; color: white; border: 1px solid #27ae60;">
                            <span style="margin-right: 0.5rem;"></span>
                            Show
                        </button>
                        <button class="action-btn secondary" onclick="viewFamilyDetail('${family.id}')">
                            <span style="margin-right: 0.5rem;"></span>
                            Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Virtual Family Group Functions (Developer Only) - COMPLETELY REDESIGNED
        let selectedVirtualParents = new Set();
        let selectedVirtualChildren = new Set();

        // Load virtual family groups from Firebase - FIXED TO USE CORRECT COLLECTION
        async function loadVirtualFamilyGroups() {
            try {
                // Virtual families are stored in manual_family_trees with isVirtual: true
                const querySnapshot = await getDocs(query(collection(db, 'manual_family_trees'), where('isVirtual', '==', true)));
                virtualFamilyGroups = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(` Loaded ${virtualFamilyGroups.length} virtual family groups from manual_family_trees collection`);
                console.log(' Virtual families:', virtualFamilyGroups.map(f => ({ id: f.id, name: f.name })));
            } catch (error) {
                console.error(' Error loading virtual family groups:', error);
            }
        }

        window.openCreateFamilyGroupModal = function() {
            console.log(' CREATE FAMILY GROUP BUTTON CLICKED!');
            console.log('Current user:', currentUser);
            console.log('Is developer?', currentUser?.isDeveloper);
            console.log('Family members available:', familyMembers.length);
            
            if (!currentUser) {
                console.error(' No current user found!');
                alert('Error: No user logged in. Please refresh the page.');
                return;
            }
            
            if (!currentUser.isDeveloper) {
                console.log(' Access denied - not a developer');
                alert('Access denied: Only developers can create virtual family groups');
                return;
            }
            
            try {
                console.log(' Access granted - proceeding with modal opening...');
                
                // Reset selections
                selectedVirtualParents.clear();
                selectedVirtualChildren.clear();
                console.log(' Selections cleared');
                
                // Clear form
                const nameField = document.getElementById('virtualGroupName');
                const descField = document.getElementById('virtualGroupDescription');
                const typeField = document.getElementById('virtualGroupType');
                
                if (nameField) {
                    nameField.value = '';
                    console.log(' Name field cleared');
                } else {
                    console.error(' Name field not found!');
                }
                
                if (descField) {
                    descField.value = '';
                    console.log(' Description field cleared');
                } else {
                    console.error(' Description field not found!');
                }
                
                if (typeField) {
                    typeField.value = 'memorial';
                    console.log(' Type field set to memorial');
                } else {
                    console.error(' Type field not found!');
                }
                
                // Hide preview sections
                const parentsPreview = document.getElementById('selectedParentsPreview');
                const childrenPreview = document.getElementById('selectedChildrenPreview');
                
                if (parentsPreview) {
                    parentsPreview.style.display = 'none';
                    console.log(' Parents preview hidden');
                } else {
                    console.error(' Parents preview not found!');
                }
                
                if (childrenPreview) {
                    childrenPreview.style.display = 'none';
                    console.log(' Children preview hidden');
                } else {
                    console.error(' Children preview not found!');
                }
                
                // Populate the member lists
                console.log(' About to populate member lists...');
                populateVirtualFamilyMembers();
                
                // Open the modal
                const modal = document.getElementById('createFamilyGroupModal');
                if (modal) {
                    modal.classList.add('active');
                    console.log(' MODAL OPENED SUCCESSFULLY!');
                } else {
                    console.error(' MODAL ELEMENT NOT FOUND!');
                    alert('Error: Modal element not found. Please check the HTML structure.');
                }
            } catch (error) {
                console.error(' ERROR in openCreateFamilyGroupModal:', error);
                alert('Error opening family group modal: ' + error.message);
            }
        };

        function populateVirtualFamilyMembers() {
            console.log('populateVirtualFamilyMembers called');
            console.log('Family members count:', familyMembers.length);
            
            try {
                populateVirtualParentsList();
                populateVirtualChildrenList();
                console.log('Virtual family members populated successfully');
            } catch (error) {
                console.error('Error populating virtual family members:', error);
            }
        }

        function populateVirtualParentsList() {
            const container = document.getElementById('virtualParentsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            familyMembers.forEach(member => {
                const personItem = createVirtualPersonItem(member, 'parent');
                container.appendChild(personItem);
            });
        }

        function populateVirtualChildrenList() {
            const container = document.getElementById('virtualChildrenList');
            if (!container) return;
            
            container.innerHTML = '';
            
            familyMembers.forEach(member => {
                const personItem = createVirtualPersonItem(member, 'child');
                container.appendChild(personItem);
            });
        }

        function createVirtualPersonItem(member, type) {
            const div = document.createElement('div');
            div.className = 'virtual-person-item';
            div.dataset.memberId = member.id;
            div.dataset.memberName = `${member.firstName} ${member.lastName}`.toLowerCase();
            div.dataset.status = member.deceased ? 'deceased' : 'living';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'virtual-person-checkbox';
            checkbox.value = member.id;
            checkbox.addEventListener('change', () => toggleVirtualPersonSelection(member.id, type, checkbox.checked));
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'virtual-person-info';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'virtual-person-name';
            nameDiv.textContent = `${member.firstName} ${member.lastName}`;
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'virtual-person-details';
            const age = getAge(member);
            const ageText = age ? `Age ${age}` : 'Age unknown';
            const statusText = member.deceased ? 'Deceased' : 'Living';
            detailsDiv.textContent = `${ageText}  ${member.branch || 'No branch'}`;
            
            const statusSpan = document.createElement('span');
            statusSpan.className = `virtual-person-status ${member.deceased ? 'status-deceased' : 'status-living'}`;
            statusSpan.textContent = statusText;
            
            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(detailsDiv);
            
            div.appendChild(checkbox);
            div.appendChild(infoDiv);
            div.appendChild(statusSpan);
            
            // Add click handler for the entire item
            div.addEventListener('click', (e) => {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
            
            return div;
        }

        function toggleVirtualPersonSelection(memberId, type, isSelected) {
            const targetSet = type === 'parent' ? selectedVirtualParents : selectedVirtualChildren;
            const items = document.querySelectorAll(`[data-member-id="${memberId}"]`);
            
            if (isSelected) {
                targetSet.add(memberId);
                items.forEach(item => item.classList.add('selected'));
            } else {
                targetSet.delete(memberId);
                items.forEach(item => item.classList.remove('selected'));
            }
            
            updateVirtualSelectionPreview(type);
        }

        function updateVirtualSelectionPreview(type) {
            const isParent = type === 'parent';
            const selectedSet = isParent ? selectedVirtualParents : selectedVirtualChildren;
            const previewContainer = document.getElementById(isParent ? 'selectedParentsPreview' : 'selectedChildrenPreview');
            const listContainer = document.getElementById(isParent ? 'selectedParentsList' : 'selectedChildrenList');
            
            if (selectedSet.size === 0) {
                previewContainer.style.display = 'none';
                return;
            }
            
            previewContainer.style.display = 'block';
            listContainer.innerHTML = '';
            
            selectedSet.forEach(memberId => {
                const member = familyMembers.find(m => m.id === memberId);
                if (member) {
                    const tag = document.createElement('span');
                    tag.className = 'selected-person-tag';
                    tag.innerHTML = `${member.firstName} ${member.lastName} <span class="remove-tag" onclick="removeVirtualSelection('${memberId}', '${type}')""></span>`;
                    listContainer.appendChild(tag);
                }
            });
        }

        window.removeVirtualSelection = function(memberId, type) {
            const targetSet = type === 'parent' ? selectedVirtualParents : selectedVirtualChildren;
            const checkboxes = document.querySelectorAll(`[data-member-id="${memberId}"] input[type="checkbox"]`);
            
            targetSet.delete(memberId);
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.virtual-person-item').classList.remove('selected');
            });
            
            updateVirtualSelectionPreview(type);
        };

        // Filter functions
        window.filterVirtualParents = function() {
            const searchTerm = document.getElementById('parentSearch').value.toLowerCase();
            filterVirtualPersonList('virtualParentsList', searchTerm);
        };

        window.filterVirtualChildren = function() {
            const searchTerm = document.getElementById('childrenSearch').value.toLowerCase();
            filterVirtualPersonList('virtualChildrenList', searchTerm);
        };

        function filterVirtualPersonList(containerId, searchTerm) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const items = container.querySelectorAll('.virtual-person-item');
            items.forEach(item => {
                const name = item.dataset.memberName;
                const isVisible = name.includes(searchTerm);
                item.style.display = isVisible ? 'flex' : 'none';
            });
        }

        // Status filter functions
        window.filterParentsByStatus = function(status) {
            filterByStatus('virtualParentsList', status, 'parent');
            updateStatusFilterButtons('parent', status);
        };

        window.filterChildrenByStatus = function(status) {
            filterByStatus('virtualChildrenList', status, 'child');
            updateStatusFilterButtons('child', status);
        };

        function filterByStatus(containerId, status, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const items = container.querySelectorAll('.virtual-person-item');
            items.forEach(item => {
                const itemStatus = item.dataset.status;
                let isVisible = true;
                
                if (status === 'living') {
                    isVisible = itemStatus === 'living';
                } else if (status === 'deceased') {
                    isVisible = itemStatus === 'deceased';
                }
                
                item.style.display = isVisible ? 'flex' : 'none';
            });
        }

        function updateStatusFilterButtons(type, activeStatus) {
            const isParent = type === 'parent';
            const container = isParent ? 
                document.getElementById('virtualParentsList').closest('div[style*="background: #fff3e0"]') : 
                document.getElementById('virtualChildrenList').closest('div[style*="background: #f3e5f5"]');
            
            if (container) {
                const buttons = container.querySelectorAll('.status-filter-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.status === activeStatus) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // Create virtual family group - FIXED
        window.createCustomFamilyGroup = async function(event) {
            event.preventDefault();
            
            if (!currentUser?.isDeveloper) {
                showMessage('Access denied: Only developers can create virtual family groups', 'error');
                return;
            }
            
            try {
                const groupName = document.getElementById('virtualGroupName').value.trim();
                const groupType = document.getElementById('virtualGroupType').value;
                const description = document.getElementById('virtualGroupDescription').value.trim();
                
                if (!groupName) {
                    showMessage('Please enter a group name', 'error');
                    return;
                }
                
                if (selectedVirtualParents.size === 0) {
                    showMessage('Please select at least one parent/head of family', 'error');
                    return;
                }
                
                const virtualGroup = {
                    name: groupName,
                    type: groupType,
                    description: description,
                    parentIds: [...selectedVirtualParents],
                    childrenIds: [...selectedVirtualChildren],
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString(),
                    isVirtual: true
                };
                
                // Save to manual_family_trees collection with isVirtual flag
                const docRef = await addDoc(collection(db, 'manual_family_trees'), virtualGroup);
                virtualGroup.id = docRef.id;
                
                // Add to local array
                virtualFamilyGroups.push(virtualGroup);
                
                showMessage(`Virtual family group "${groupName}" created successfully!`, 'success');
                closeModal('createFamilyGroupModal');
                
                // Refresh the branches display to show the new virtual group
                displayBranches();
                
            } catch (error) {
                console.error('Error creating virtual family group:', error);
                showMessage('Error creating virtual family group. Please try again.', 'error');
            }
        };

        // Legacy function for backward compatibility
        function populateCustomFamilyMemberSelections() {
            populateVirtualFamilyMembers();
        }

        // Security Questions Button for all users
        function addSecurityQuestionsButton() {
            const userInfo = document.querySelector('.user-info');
            if (!userInfo) return;
            
            // Create Security Questions button
            const securityButton = document.createElement('button');
            securityButton.innerHTML = ' Security Questions';
            securityButton.className = 'btn';
            securityButton.style.cssText = `
                background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
                color: white;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                margin-right: 1rem;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
            `;
            
            // Add hover effect
            securityButton.addEventListener('mouseenter', () => {
                securityButton.style.transform = 'translateY(-2px)';
                securityButton.style.boxShadow = '0 4px 12px rgba(111, 66, 193, 0.4)';
            });
            
            securityButton.addEventListener('mouseleave', () => {
                securityButton.style.transform = 'translateY(0)';
                securityButton.style.boxShadow = '0 2px 8px rgba(111, 66, 193, 0.3)';
            });
            
            // Add click handler
            securityButton.addEventListener('click', () => {
                openSecurityQuestionsModal();
            });
            
            // Insert button before the admin badge or logout button
            const adminBadge = document.getElementById('adminBadge');
            const logoutBtn = userInfo.querySelector('.logout-btn');
            
            if (adminBadge && adminBadge.style.display !== 'none') {
                userInfo.insertBefore(securityButton, adminBadge);
            } else if (logoutBtn) {
                userInfo.insertBefore(securityButton, logoutBtn);
            } else {
                userInfo.appendChild(securityButton);
            }
        }

        // Admin Functions - Change Password Button for all admins
        function addChangePasswordButton() {
            const userInfo = document.querySelector('.user-info');
            if (!userInfo) return;
            
            // Create Change Password button
            const changePasswordButton = document.createElement('button');
            changePasswordButton.innerHTML = ' Change Password';
            changePasswordButton.className = 'btn';
            changePasswordButton.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                margin-right: 1rem;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            `;
            
            // Add hover effect
            changePasswordButton.addEventListener('mouseenter', () => {
                changePasswordButton.style.transform = 'translateY(-2px)';
                changePasswordButton.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
            });
            
            changePasswordButton.addEventListener('mouseleave', () => {
                changePasswordButton.style.transform = 'translateY(0)';
                changePasswordButton.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
            });
            
            // Add click handler
            changePasswordButton.addEventListener('click', () => {
                openChangePasswordRequestModal();
            });
            
            // Insert button before the admin badge
            const adminBadge = document.getElementById('adminBadge');
            if (adminBadge) {
                userInfo.insertBefore(changePasswordButton, adminBadge);
            } else {
                userInfo.appendChild(changePasswordButton);
            }
        }

        window.openChangePasswordRequestModal = function() {
            // Update the modal content with current user
            const modalContent = document.querySelector('#changePasswordRequestModal .modal-content');
            const signedInSection = modalContent.querySelector('[style*="background: #e3f2fd"]');
            if (signedInSection) {
                signedInSection.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;"></span>
                        <strong style="color: #1976d2;">Signed In Request</strong>
                    </div>
                    <p style="margin: 0; color: #1565c0; font-size: 0.9rem;">
                        Submitted as: <strong>${currentUser.username}</strong><br>
                        No security questions required since you're signed in.
                    </p>
                `;
            }
            
            document.getElementById('changePasswordRequestModal').style.display = 'block';
            
            // Clear previous values
            document.getElementById('newPasswordRequest').value = '';
            document.getElementById('confirmPasswordRequest').value = '';
            document.getElementById('changeReason').value = '';
            document.getElementById('changePasswordRequestError').textContent = '';
            document.getElementById('changePasswordRequestSuccess').textContent = '';
            
            // Log password change request modal access
            logUserAction('password_reset_request', 'modal_opened', 'User opened change password request modal', 'success');
        };

        // Developer Functions (dfinn12 only)
        function addDeveloperTestButton() {
            const userInfo = document.querySelector('.user-info');
            if (!userInfo) return;
            
            // Create Analytics button
            const analyticsButton = document.createElement('button');
            analyticsButton.innerHTML = ' Analytics';
            analyticsButton.className = 'btn';
            analyticsButton.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                margin-right: 1rem;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            `;
            
            // Add hover effect
            analyticsButton.addEventListener('mouseenter', () => {
                analyticsButton.style.transform = 'translateY(-2px)';
                analyticsButton.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
            });
            
            analyticsButton.addEventListener('mouseleave', () => {
                analyticsButton.style.transform = 'translateY(0)';
                analyticsButton.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
            });
            
            // Add click handler
            analyticsButton.addEventListener('click', () => {
                openAnalyticsModal();
            });
            
            // Create Password Resets button
            const passwordButton = document.createElement('button');
            passwordButton.innerHTML = ' Password Resets';
            passwordButton.className = 'btn';
            passwordButton.style.cssText = `
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                margin-right: 1rem;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            `;
            
            // Add hover effect
            passwordButton.addEventListener('mouseenter', () => {
                passwordButton.style.transform = 'translateY(-2px)';
                passwordButton.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.4)';
            });
            
            passwordButton.addEventListener('mouseleave', () => {
                passwordButton.style.transform = 'translateY(0)';
                passwordButton.style.boxShadow = '0 2px 8px rgba(40, 167, 69, 0.3)';
            });
            
            // Add click handler
            passwordButton.addEventListener('click', () => {
                openPasswordManagementModal();
            });

            // Create developer test button
            const testButton = document.createElement('button');
            testButton.innerHTML = ' Test Me';
            testButton.className = 'btn';
            testButton.style.cssText = `
                background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
                color: white;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
                margin-right: 1rem;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
            `;
            
            // Add hover effect
            testButton.addEventListener('mouseenter', () => {
                testButton.style.transform = 'translateY(-2px)';
                testButton.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.4)';
            });
            
            testButton.addEventListener('mouseleave', () => {
                testButton.style.transform = 'translateY(0)';
                testButton.style.boxShadow = '0 2px 8px rgba(255, 107, 107, 0.3)';
            });
            
            // Add click handler
            testButton.addEventListener('click', () => {
                showDeveloperTestPopup();
            });
            
            // Insert buttons before the logout button
            const logoutBtn = userInfo.querySelector('.logout-btn');
            userInfo.insertBefore(analyticsButton, logoutBtn);
            userInfo.insertBefore(passwordButton, logoutBtn);
            userInfo.insertBefore(testButton, logoutBtn);
        }

        // Show developer test popup
        function showDeveloperTestPopup() {
            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            // Create popup content
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: white;
                padding: 3rem;
                border-radius: 20px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
                animation: popIn 0.3s ease;
            `;
            
            popup.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                <h2 style="color: #ff6b6b; margin-bottom: 1rem; font-size: 2rem;">It Worked!</h2>
                <p style="color: #666; margin-bottom: 2rem; font-size: 1.1rem;">
                    Congratulations! Your developer privileges are working perfectly.<br>
                    <strong>Username:</strong> ${currentUser.username}<br>
                    <strong>Status:</strong> Developer Access 
                </p>
                <button onclick="closeDeveloperPopup()" style="
                    background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
                    color: white;
                    padding: 0.75rem 2rem;
                    border: none;
                    border-radius: 10px;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">Awesome! Close</button>
            `;
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes popIn {
                    from { opacity: 0; transform: scale(0.8) translateY(20px); }
                    to { opacity: 1; transform: scale(1) translateY(0); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // Store reference for closing
            window.currentDeveloperPopup = overlay;
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDeveloperPopup();
                }
            });
        }

        // Close developer popup
        window.closeDeveloperPopup = function() {
            const popup = window.currentDeveloperPopup;
            if (popup) {
                popup.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                    window.currentDeveloperPopup = null;
                }, 300);
            }
        };

        // ===== ANALYTICS AND LOGGING SYSTEM =====
        
        // Global variables for analytics
        let systemLogs = [];
        let analyticsData = {
            totalLogins: 0,
            failedLogins: 0,
            totalEdits: 0,
            totalAdditions: 0,
            totalDeletions: 0,
            uniqueUsers: new Set(),
            activeDays: new Set()
        };

        // Get IP address (for security logging)
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.warn('Failed to get IP address:', error);
                return 'Unknown';
            }
        }

        // Logging function - logs all user actions
        async function logUserAction(action, target, details = '', status = 'success') {
            if (!currentUser) return;
            
            try {
                // Get IP address if not provided
                const clientIP = await getClientIP();
                
                // Get more detailed browser/device information
                const browserInfo = getBrowserInfo();
                const deviceInfo = getDeviceInfo();
                
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    user: currentUser.username,
                    userId: currentUser.userId || 'unknown',
                    action: action,
                    target: target,
                    details: details,
                    status: status,
                    userAgent: navigator.userAgent,
                    ipAddress: clientIP,
                    browser: browserInfo.name,
                    browserVersion: browserInfo.version,
                    os: browserInfo.os,
                    device: deviceInfo.type,
                    screenResolution: `${screen.width}x${screen.height}`,
                    viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                    referrer: document.referrer || 'direct',
                    url: window.location.href,
                    sessionId: getSessionId(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    cookiesEnabled: navigator.cookieEnabled,
                    onlineStatus: navigator.onLine ? 'online' : 'offline'
                };

                // Add to Firestore logs collection
                await addDoc(collection(db, 'system_logs'), logEntry);
                
                // Update local analytics data
                updateAnalyticsData(action, status);
                
                console.log(' Logged action:', action, target);
            } catch (error) {
                console.error(' Failed to log action:', error);
            }
        }

        // Get browser information
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browser = 'Unknown';
            let version = 'Unknown';
            let os = 'Unknown';
            
            // Detect browser
            if (ua.includes('Chrome') && !ua.includes('Edg')) {
                browser = 'Chrome';
                version = ua.match(/Chrome\/([0-9.]+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Firefox')) {
                browser = 'Firefox';
                version = ua.match(/Firefox\/([0-9.]+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
                browser = 'Safari';
                version = ua.match(/Safari\/([0-9.]+)/)?.[1] || 'Unknown';
            } else if (ua.includes('Edg')) {
                browser = 'Edge';
                version = ua.match(/Edg\/([0-9.]+)/)?.[1] || 'Unknown';
            }
            
            // Detect OS
            if (ua.includes('Windows')) {
                os = 'Windows';
            } else if (ua.includes('Mac')) {
                os = 'macOS';
            } else if (ua.includes('Linux')) {
                os = 'Linux';
            } else if (ua.includes('Android')) {
                os = 'Android';
            } else if (ua.includes('iOS')) {
                os = 'iOS';
            }
            
            return { name: browser, version, os };
        }

        // Get device information
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let type = 'Desktop';
            
            if (/Mobi|Android/i.test(ua)) {
                type = 'Mobile';
            } else if (/Tablet|iPad/i.test(ua)) {
                type = 'Tablet';
            }
            
            return { type };
        }

        // Get or create session ID
        function getSessionId() {
            let sessionId = sessionStorage.getItem('familyTreeSessionId');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('familyTreeSessionId', sessionId);
            }
            return sessionId;
        }

        // Update analytics data
        function updateAnalyticsData(action, status) {
            if (status === 'success') {
                switch (action) {
                    case 'login':
                        analyticsData.totalLogins++;
                        break;
                    case 'edit':
                        analyticsData.totalEdits++;
                        break;
                    case 'add':
                        analyticsData.totalAdditions++;
                        break;
                    case 'delete':
                        analyticsData.totalDeletions++;
                        break;
                }
            } else if (action === 'login' && status === 'failed') {
                analyticsData.failedLogins++;
            }
            
            if (currentUser) {
                analyticsData.uniqueUsers.add(currentUser.username);
                analyticsData.activeDays.add(new Date().toDateString());
            }
        }

        // Load system logs from Firebase
        async function loadSystemLogs() {
            try {
                const logsRef = collection(db, 'system_logs');
                const q = query(logsRef, orderBy('timestamp', 'desc'), limit(1000));
                const querySnapshot = await getDocs(q);
                
                systemLogs = [];
                querySnapshot.forEach((doc) => {
                    systemLogs.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(` Loaded ${systemLogs.length} system logs`);
                return systemLogs;
            } catch (error) {
                console.error(' Failed to load system logs:', error);
                return [];
            }
        }

        // Open Analytics Modal
        window.openAnalyticsModal = async function() {
            const modal = document.getElementById('analyticsModal');
            modal.classList.add('active');
            
            // Load fresh data
            await loadSystemLogs();
            await calculateAnalyticsStats();
            
            // Show overview tab by default
            switchAnalyticsTab('overview');
        };

        // Switch Analytics Tabs
        window.switchAnalyticsTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.analytics-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`analytics-${tabName}`).style.display = 'block';
            
            // Load specific tab data
            switch (tabName) {
                case 'overview':
                    displayOverviewData();
                    break;
                case 'activity':
                    displayActivityLogs();
                    break;
                case 'security':
                    displaySecurityLogs();
                    break;
                case 'requests':
                    displayRequestsLogs();
                    break;
                case 'users':
                    displayUserActivity();
                    break;
            }
        };

        // Calculate analytics statistics
        async function calculateAnalyticsStats() {
            const stats = {
                totalLogins: 0,
                failedLogins: 0,
                totalEdits: 0,
                totalAdditions: 0,
                uniqueUsers: new Set(),
                activeDays: new Set()
            };
            
            systemLogs.forEach(log => {
                switch (log.action) {
                    case 'login':
                        if (log.status === 'success') {
                            stats.totalLogins++;
                        } else {
                            stats.failedLogins++;
                        }
                        break;
                    case 'edit':
                        stats.totalEdits++;
                        break;
                    case 'add':
                        stats.totalAdditions++;
                        break;
                }
                
                stats.uniqueUsers.add(log.user);
                stats.activeDays.add(new Date(log.timestamp).toDateString());
            });
            
            // Update display
            document.getElementById('totalLogins').textContent = stats.totalLogins;
            document.getElementById('failedLogins').textContent = stats.failedLogins;
            document.getElementById('totalEdits').textContent = stats.totalEdits;
            document.getElementById('totalAdditions').textContent = stats.totalAdditions;
            document.getElementById('uniqueUsers').textContent = stats.uniqueUsers.size;
            document.getElementById('activeDays').textContent = stats.activeDays.size;
        }

        // Display overview data
        function displayOverviewData() {
            const recentLogs = systemLogs.slice(0, 10);
            const container = document.getElementById('recentActivityOverview');
            
            if (recentLogs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No recent activity</p>';
                return;
            }
            
            const html = recentLogs.map(log => `
                <div style="padding: 0.75rem; border: 1px solid #eee; border-radius: 8px; margin-bottom: 0.5rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="log-action ${log.action} ${log.status === 'failed' ? 'login-failed' : ''}">${log.action.toUpperCase()}</span>
                        <span style="color: #666; font-size: 0.9rem;">${new Date(log.timestamp).toLocaleString()}</span>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <strong>${log.user}</strong> ${log.action}ed <em>${log.target}</em>
                        ${log.details ? `<br><small style="color: #666;">${log.details}</small>` : ''}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Update analytics overview (wrapper function for clear logs)
        function updateAnalyticsOverview() {
            calculateAnalyticsStats();
            displayOverviewData();
        }

        // Display activity logs
        function displayActivityLogs() {
            const tbody = document.getElementById('activityLogsBody');
            
            if (systemLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">No activity logs found</td></tr>';
                return;
            }
            
            const html = systemLogs.map(log => {
                // Only mark as login-failed if it's actually a failed login
                const isFailedLogin = log.action === 'login' && log.status === 'failed';
                const actionClass = isFailedLogin ? 'login-failed' : log.action;
                const statusColor = log.status === 'success' ? '#28a745' : log.status === 'failed' ? '#dc3545' : '#6c757d';
                
                return `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td><strong>${log.user}</strong></td>
                        <td><span class="log-action ${actionClass}">${log.action.toUpperCase().replace('_', ' ')}</span></td>
                        <td>${log.target || '-'}</td>
                        <td><span style="color: ${statusColor}; font-weight: bold;">${log.status.toUpperCase()}</span></td>
                        <td style="font-family: monospace; font-size: 0.8em;">${log.ipAddress || 'Unknown'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.userAgent || 'Unknown'}">${log.userAgent ? (log.userAgent.includes('Chrome') ? ' Chrome' : log.userAgent.includes('Firefox') ? ' Firefox' : log.userAgent.includes('Safari') ? ' Safari' : log.userAgent.includes('Edge') ? ' Edge' : ' Browser') : 'Unknown'}</td>
                        <td>${log.details || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        // Display security logs
        function displaySecurityLogs() {
            const securityLogs = systemLogs.filter(log => 
                log.action === 'login' || log.action === 'logout' || log.status === 'failed' || 
                log.action === 'password_reset_request' || log.action === 'security_questions'
            );
            
            const tbody = document.getElementById('securityLogsBody');
            
            if (securityLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">No security events found</td></tr>';
                return;
            }
            
            const html = securityLogs.map(log => {
                // Only mark as login-failed if it's actually a failed login
                const isFailedLogin = log.action === 'login' && log.status === 'failed';
                const actionClass = isFailedLogin ? 'login-failed' : log.action;
                const statusColor = log.status === 'success' ? '#28a745' : log.status === 'failed' ? '#dc3545' : '#6c757d';
                
                return `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td><strong>${log.user}</strong></td>
                        <td><span class="log-action ${actionClass}">${log.action.toUpperCase().replace('_', ' ')}</span></td>
                        <td style="font-family: monospace; font-size: 0.8em;">${log.ipAddress || 'Unknown'}</td>
                        <td><span style="color: ${statusColor}; font-weight: bold;">${log.status.toUpperCase()}</span></td>
                        <td>${log.browser || 'Unknown'} ${log.browserVersion || ''}</td>
                        <td>${log.os || 'Unknown'}</td>
                        <td>${log.device || 'Unknown'}</td>
                        <td>${log.details || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        // Display user activity
        function displayUserActivity() {
            const userStats = {};
            
            systemLogs.forEach(log => {
                if (!userStats[log.user]) {
                    userStats[log.user] = {
                        totalLogins: 0,
                        totalActions: 0,
                        memberEdits: 0,
                        lastLogin: null,
                        lastActivity: null
                    };
                }
                
                const stats = userStats[log.user];
                stats.totalActions++;
                stats.lastActivity = log.timestamp;
                
                if (log.action === 'login' && log.status === 'success') {
                    stats.totalLogins++;
                    if (!stats.lastLogin || log.timestamp > stats.lastLogin) {
                        stats.lastLogin = log.timestamp;
                    }
                }
                
                if (log.action === 'edit' && log.target.includes('member')) {
                    stats.memberEdits++;
                }
            });
            
            const tbody = document.getElementById('userActivityBody');
            
            if (Object.keys(userStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No user activity found</td></tr>';
                return;
            }
            
            const html = Object.entries(userStats).map(([user, stats]) => `
                <tr>
                    <td><strong>${user}</strong></td>
                    <td>${stats.lastLogin ? new Date(stats.lastLogin).toLocaleString() : 'Never'}</td>
                    <td>${stats.totalLogins}</td>
                    <td>${stats.totalActions}</td>
                    <td>${stats.memberEdits}</td>
                    <td>${stats.lastActivity ? new Date(stats.lastActivity).toLocaleString() : 'Never'}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            
            // Populate user filter dropdown
            const userFilter = document.getElementById('userActivityFilter');
            userFilter.innerHTML = '<option value="">All Users</option>' + 
                Object.keys(userStats).map(user => `<option value="${user}">${user}</option>`).join('');
        }

        // Refresh activity logs
        window.refreshActivityLogs = async function() {
            await loadSystemLogs();
            displayActivityLogs();
        };

        // Confirm clear all logs
        window.confirmClearAllLogs = function() {
            const totalLogs = systemLogs.length;
            const confirmation = confirm(
                ` DANGER: Clear All System Logs?\n\n` +
                `This will permanently delete ALL ${totalLogs} system logs including:\n` +
                ` Login/logout records\n` +
                ` User activity logs\n` +
                ` Security events\n` +
                ` Password reset requests\n` +
                ` All other system activities\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Are you absolutely sure you want to proceed?`
            );
            
            if (confirmation) {
                const secondConfirmation = confirm(
                    ` FINAL WARNING!\n\n` +
                    `You are about to delete ${totalLogs} log entries.\n` +
                    `This will remove all audit trails and security records.\n\n` +
                    `Type "YES DELETE ALL LOGS" in the next prompt to confirm.`
                );
                
                if (secondConfirmation) {
                    const finalConfirm = prompt(
                        'Type "YES DELETE ALL LOGS" to confirm deletion:'
                    );
                    
                    if (finalConfirm === "YES DELETE ALL LOGS") {
                        clearAllSystemLogs();
                    } else {
                        alert(' Deletion cancelled - exact phrase not entered.');
                    }
                } else {
                    alert(' Deletion cancelled.');
                }
            }
        };

        // Clear all system logs
        window.clearAllSystemLogs = async function() {
            try {
                const loadingMessage = document.createElement('div');
                loadingMessage.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 99999;">
                        <div style="background: white; padding: 2rem; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                            <h3>Deleting All System Logs...</h3>
                            <p>Please wait, this may take a moment.</p>
                            <div style="margin-top: 1rem; color: #666;">Do not close this window</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingMessage);

                // Get all log documents
                const logsRef = collection(db, 'system_logs');
                const querySnapshot = await getDocs(logsRef);
                
                let deletedCount = 0;
                const totalCount = querySnapshot.size;
                
                // Delete all log documents
                const deletePromises = [];
                querySnapshot.forEach((docSnapshot) => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });
                
                await Promise.all(deletePromises);
                deletedCount = totalCount;
                
                // Clear local logs array
                systemLogs.length = 0;
                
                // Refresh analytics data
                analyticsData = {
                    totalLogins: 0,
                    failedLogins: 0,
                    totalEdits: 0,
                    totalAdditions: 0,
                    totalDeletions: 0,
                    activeDays: new Set(),
                    uniqueUsers: new Set()
                };
                
                // Update displays
                displayActivityLogs();
                displaySecurityLogs();
                displayRequestsLogs();
                displayUserActivity();
                updateAnalyticsOverview();
                
                // Remove loading message
                document.body.removeChild(loadingMessage);
                
                alert(` Successfully deleted ${deletedCount} log entries.\n\nAll system logs have been cleared.`);
                
                // Log the clear action after a delay to prevent immediate reappearance
                setTimeout(async () => {
                    await logUserAction('clear_logs', 'system_logs', `Cleared all system logs (${deletedCount} entries deleted)`, 'success');
                }, 2000);
                
            } catch (error) {
                console.error(' Error clearing logs:', error);
                alert(` Error clearing logs: ${error.message}`);
                
                // Remove loading message if it exists
                const loadingMessage = document.querySelector('[style*="position: fixed"]');
                if (loadingMessage) {
                    document.body.removeChild(loadingMessage);
                }
            }
        };

        // Display requests logs (account requests and password resets)
        function displayRequestsLogs() {
            const requestsLogs = systemLogs.filter(log => 
                log.action === 'account_request' || log.action === 'password_reset' || log.action === 'approve' || log.action === 'deny'
            );
            
            const tbody = document.getElementById('requestsLogsBody');
            
            if (requestsLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No account requests found</td></tr>';
                return;
            }
            
            const html = requestsLogs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td><strong>${log.user}</strong></td>
                    <td><span class="log-action ${log.action}">${log.action.toUpperCase().replace('_', ' ')}</span></td>
                    <td><span style="color: ${log.status === 'success' ? 'green' : 'red'};">${log.status.toUpperCase()}</span></td>
                    <td>${log.ipAddress || 'Unknown'}</td>
                    <td>${log.details || '-'}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
        }

        // Refresh requests logs
        window.refreshRequestsLogs = async function() {
            await loadSystemLogs();
            displayRequestsLogs();
        };

        // Logout function
        window.logout = async function() {
            // Log the logout
            await logUserAction('logout', 'dashboard', 'User logged out', 'success');
            
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        };

        // Full-Screen Modal Functions
        window.closeFullScreenModal = function() {
            const modal = document.getElementById('fullScreenEditModal');
            if (modal) {
                modal.remove();
            }
        };

        window.updateFullScreenParentsCount = function() {
            const checkboxes = document.querySelectorAll('input[name="editParents"]:checked');
            const countElement = document.getElementById('fullScreenParentsCount');
            const allCheckboxes = document.querySelectorAll('input[name="editParents"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (checkboxes.length >= 2) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        window.updateFullScreenChildrenCount = function() {
            const checkboxes = document.querySelectorAll('input[name="editChildren"]:checked');
            const countElement = document.getElementById('fullScreenChildrenCount');
            const allCheckboxes = document.querySelectorAll('input[name="editChildren"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (checkboxes.length >= 15) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        window.submitFullScreenEdit = async function(event, memberId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Get selected parents and children
            const selectedParents = Array.from(document.querySelectorAll('input[name="editParents"]:checked')).map(cb => cb.value);
            const selectedChildren = Array.from(document.querySelectorAll('input[name="editChildren"]:checked')).map(cb => cb.value);
            
            // Get current member to check for marriage changes
            const currentMember = familyMembers.find(m => m.id === memberId);
            const oldSpouseId = currentMember?.marriedTo;
            const newSpouseId = data.marriedTo || null;
            
            try {
                // Update the member in Firestore
                const memberDoc = doc(db, 'family_members', memberId);
                await updateDoc(memberDoc, {
                    firstName: data.firstName,
                    lastName: data.lastName,
                    birthMonth: data.birthMonth,
                    birthDay: parseInt(data.birthDay),
                    birthYear: parseInt(data.birthYear),
                    familyBranch: data.familyBranch || null,
                    marriedTo: newSpouseId,
                    parents: selectedParents,
                    children: selectedChildren,
                    mobilePhone: data.mobilePhone || null,
                    homePhone: data.homePhone || null,
                    workPhone: data.workPhone || null,
                    email: data.email || null,
                    streetAddress: data.streetAddress || null,
                    city: data.city || null,
                    state: data.state || null,
                    zipCode: data.zipCode || null,
                    anniversaryDate: data.anniversaryDate || null,
                    notes: data.notes || null,
                    deceased: data.deceased === 'on' // Checkbox value conversion
                });

                // Update bidirectional marriage relationships
                await updateBidirectionalMarriage(memberId, oldSpouseId, newSpouseId);

                // Update bidirectional parent/child relationships
                await updateBidirectionalRelationships(memberId, selectedParents, selectedChildren);

                // AUTOMATIC CHILDREN SYNC: If member is married, automatically sync children with spouse
                if (newSpouseId) {
                    console.log(' Auto-syncing children with spouse after edit...');
                    await synchronizeMarriedCoupleChildren(memberId, newSpouseId);
                }

                // Close modal and refresh data
                closeFullScreenModal();
                await loadData();
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member. Please try again.', 'error');
            }
        };
            // forcing a push

        // Initialize modal event listeners
        function initializeModals() {
            // Add click-outside-to-close for family detail modal
            const familyDetailModal = document.getElementById('familyDetailModal');
            if (familyDetailModal) {
                familyDetailModal.addEventListener('click', function(e) {
                    if (e.target === familyDetailModal) {
                        closeModal('familyDetailModal');
                    }
                });
            }

            // Add escape key handler for all modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    // Close any active modal
                    const activeModal = document.querySelector('.modal.active');
                    if (activeModal) {
                        closeModal(activeModal.id);
                    }
                }
            });
        }

        // Password Management Functions
        window.openPasswordManagementModal = function() {
            document.getElementById('passwordManagementModal').style.display = 'block';
            loadUserPasswords();
            loadResetRequests();
        }

        window.closePasswordManagementModal = function() {
            document.getElementById('passwordManagementModal').style.display = 'none';
        }

        window.switchPasswordTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content-password').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.password-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            if (tabName === 'manage') {
                document.getElementById('managePasswordsTab').style.display = 'block';
                document.querySelector('[onclick="switchPasswordTab(\'manage\')"]').classList.add('active');
                loadUserPasswords();
            } else if (tabName === 'requests') {
                document.getElementById('resetRequestsTab').style.display = 'block';
                document.querySelector('[onclick="switchPasswordTab(\'requests\')"]').classList.add('active');
                loadResetRequests();
            }
        }

        async function loadUserPasswords() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const usersList = document.getElementById('userPasswordsList');
                usersList.innerHTML = '';

                if (usersSnapshot.empty) {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon"></div>
                            <h3>No users found</h3>
                            <p>No user accounts are registered in the system.</p>
                        </div>
                    `;
                    return;
                }

                // Create a grid container
                const gridContainer = document.createElement('div');
                gridContainer.className = 'password-grid';

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userCard = createUserPasswordCard(doc.id, userData);
                    gridContainer.appendChild(userCard);
                });

                usersList.appendChild(gridContainer);
            } catch (error) {
                console.error('Error loading user passwords:', error);
                document.getElementById('userPasswordsList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>Error loading users</h3>
                        <p>There was a problem loading user data. Please try again.</p>
                    </div>
                `;
            }
        }

        function createUserPasswordCard(userId, userData) {
            const card = document.createElement('div');
            card.className = 'user-password-card';
            
            card.innerHTML = `
                <div class="user-info-section">
                    <h3>${userData.username || 'N/A'}</h3>
                    <p><strong>Name:</strong> ${userData.fullName || userData.firstName + ' ' + userData.lastName || 'N/A'}</p>
                    <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${userData.phone || 'N/A'}</p>
                    <p><strong>Admin:</strong> ${userData.isAdmin ? 'Yes' : 'No'}</p>
                </div>
                <div class="password-section">
                    <div class="password-hidden" id="password-${userId}"></div>
                    <button class="reveal-btn" onclick="togglePasswordVisibility('${userId}', '${userData.password}')">
                        Show
                    </button>
                    <button class="change-password-btn" onclick="openChangePasswordModal('${userId}', '${userData.username || userData.name}')">
                        Change Password
                    </button>
                </div>
            `;
            
            return card;
        }

        window.togglePasswordVisibility = function(userId, password) {
            const passwordElement = document.getElementById(`password-${userId}`);
            const button = passwordElement.nextElementSibling;
            
            if (passwordElement.classList.contains('password-hidden')) {
                passwordElement.textContent = password;
                passwordElement.className = 'password-revealed';
                button.textContent = 'Hide';
            } else {
                passwordElement.textContent = '';
                passwordElement.className = 'password-hidden';
                button.textContent = 'Show';
            }
        }

        window.openChangePasswordModal = function(userId, username) {
            document.getElementById('changePasswordModal').style.display = 'block';
            document.getElementById('changePasswordUserId').value = userId;
            document.getElementById('changePasswordUser').textContent = username;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        window.closeChangePasswordModal = function() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }

        async function loadResetRequests() {
            try {
                const requestsSnapshot = await getDocs(collection(db, 'password_reset_requests'));
                const requestsList = document.getElementById('resetRequestsList');
                requestsList.innerHTML = '';

                if (requestsSnapshot.empty) {
                    requestsList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon"></div>
                            <h3>No reset requests</h3>
                            <p>No password reset requests have been submitted.</p>
                        </div>
                    `;
                    return;
                }

                const requests = [];
                requestsSnapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp (newest first)
                requests.sort((a, b) => (b.timestamp?.toDate() || new Date(0)) - (a.timestamp?.toDate() || new Date(0)));

                // Create a grid container for requests
                const gridContainer = document.createElement('div');
                gridContainer.className = 'password-grid';

                requests.forEach(request => {
                    const requestCard = createResetRequestCard(request);
                    gridContainer.appendChild(requestCard);
                });

                requestsList.appendChild(gridContainer);
            } catch (error) {
                console.error('Error loading reset requests:', error);
                document.getElementById('resetRequestsList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon"></div>
                        <h3>Error loading requests</h3>
                        <p>There was a problem loading reset requests. Please try again.</p>
                    </div>
                `;
            }
        }

        function createResetRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'reset-request-card';
            
            const date = request.timestamp ? request.timestamp.toDate().toLocaleString() : 'Unknown';
            const status = request.status || 'pending';
            
            card.innerHTML = `
                <div>
                    <strong>Password Reset Request</strong>
                    <span style="float: right; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; background: ${status === 'pending' ? '#fff3cd' : status === 'approved' ? '#d4edda' : '#f8d7da'}; color: ${status === 'pending' ? '#856404' : status === 'approved' ? '#155724' : '#721c24'};">
                        ${status.toUpperCase()}
                    </span>
                </div>
                <div style="margin: 0.5rem 0;">
                    <strong>Name:</strong> ${request.fullName}<br>
                    <strong>Username:</strong> ${request.username}<br>
                    <strong>Phone:</strong> ${request.phoneNumber}<br>
                    <strong>Date:</strong> ${date}
                </div>
                <div class="request-actions">
                    <button class="approve-btn" onclick="openResetRequestDetail('${request.id}')" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); width: 100%;">
                         View Details
                    </button>
                </div>
            `;
            
            return card;
        }

        window.openResetRequestDetail = async function(requestId) {
            try {
                // Get the request details
                const requestDoc = await getDoc(doc(db, 'password_reset_requests', requestId));
                if (!requestDoc.exists()) {
                    showMessage('Reset request not found', 'error');
                    return;
                }

                const request = { id: requestDoc.id, ...requestDoc.data() };
                const date = request.timestamp ? request.timestamp.toDate().toLocaleString() : 'Unknown';
                const status = request.status || 'pending';

                // Build the detailed view
                let securityQuestionsHtml = '';
                if (request.securityAnswers && request.securityAnswers.length > 0) {
                    securityQuestionsHtml = `
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 1rem 0;">
                            <h4 style="margin: 0 0 1rem 0; color: #6f42c1;"> Security Questions & Answers</h4>
                            ${request.securityAnswers.map((qa, index) => `
                                <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid ${qa.isCorrect ? '#28a745' : '#dc3545'};">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Q${index + 1}: ${qa.question}</div>
                                    <div style="margin-bottom: 0.5rem;"><strong>User's Answer:</strong> ${qa.userAnswer}</div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; background: ${qa.isCorrect ? '#d4edda' : '#f8d7da'}; color: ${qa.isCorrect ? '#155724' : '#721c24'};">
                                            ${qa.isCorrect ? ' CORRECT' : ' INCORRECT'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                            <div style="text-align: center; margin-top: 1rem; padding: 0.75rem; background: ${request.securityQuestionsCorrect >= Math.ceil(request.securityQuestionsTotalAsked / 2) ? '#d4edda' : '#f8d7da'}; border-radius: 8px;">
                                <strong>Security Verification: ${request.securityQuestionsCorrect}/${request.securityQuestionsTotalAsked} Correct</strong>
                                ${request.securityQuestionsCorrect >= Math.ceil(request.securityQuestionsTotalAsked / 2) ? '  PASSED' : '  FAILED'}
                            </div>
                        </div>
                    `;
                }

                const detailsHtml = `
                    <div style="max-height: 70vh; overflow-y: auto;">
                        <!-- Basic Information -->
                        <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h3 style="margin: 0 0 1rem 0; color: #1976d2;"> Request Information</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div><strong>Username:</strong> ${request.username}</div>
                                <div><strong>Full Name:</strong> ${request.fullName}</div>
                                <div><strong>Phone:</strong> ${request.phoneNumber}</div>
                                <div><strong>Email:</strong> ${request.email || 'Not provided'}</div>
                                <div><strong>IP Address:</strong> ${request.ipAddress || 'Unknown'}</div>
                                <div><strong>Date Submitted:</strong> ${date}</div>
                            </div>
                            ${request.isSignedIn ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="font-size: 1.2rem;"></span>
                                        <strong style="color: #155724;">Signed-In Request</strong>
                                    </div>
                                    <p style="margin: 0; color: #155724; font-size: 0.9rem;">
                                        This request was submitted by a signed-in user: <strong>${request.signedInAs || request.username}</strong><br>
                                        No security questions were required for verification.
                                    </p>
                                </div>
                            ` : ''}
                            <div style="margin-top: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <strong>Status:</strong>
                                    <span style="padding: 0.5rem 1rem; border-radius: 16px; font-weight: 600; background: ${status === 'pending' ? '#fff3cd' : status === 'approved' ? '#d4edda' : '#f8d7da'}; color: ${status === 'pending' ? '#856404' : status === 'approved' ? '#155724' : '#721c24'};">
                                        ${status.toUpperCase()}
                                    </span>
                                </div>
                            </div>
                            ${request.reason ? `
                                <div style="margin-top: 1rem;">
                                    <strong>Reason for ${request.isSignedIn ? 'Change' : 'Reset'}:</strong>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; border-left: 4px solid #2196f3;">
                                        ${request.reason}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- New Password Information -->
                        ${request.newPassword ? `
                            <div style="background: #fff3e0; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 1rem 0; color: #f57c00;"> New Password Request</h4>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <strong>Requested New Password:</strong> 
                                    <span style="font-family: monospace; background: #f5f5f5; padding: 0.25rem 0.5rem; border-radius: 4px;">${request.newPassword}</span>
                                </div>
                            </div>
                        ` : ''}

                        ${securityQuestionsHtml}

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef;">
                            ${status === 'pending' ? `
                                <button onclick="processResetRequestFromModal('${request.id}', 'approved')" 
                                        class="btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 500; flex: 1;">
                                     Approve & Change Password
                                </button>
                                <button onclick="processResetRequestFromModal('${request.id}', 'denied')" 
                                        class="btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                     Deny${request.isSignedIn ? ' Request' : ''}
                                </button>
                            ` : `
                                <div style="text-align: center; width: 100%; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                    <span style="color: #6c757d;">This ${request.isSignedIn ? 'change request' : 'reset request'} has already been ${status}.</span>
                                    ${request.processedAt ? `<br><small>Processed on: ${request.processedAt.toDate().toLocaleString()}</small>` : ''}
                                    ${request.processedBy ? `<br><small>Processed by: ${request.processedBy}</small>` : ''}
                                </div>
                            `}
                            <button onclick="removeResetRequest('${request.id}')" 
                                    class="btn" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                 Remove from Database
                            </button>
                            <button onclick="closeModal('resetRequestDetailModal')" 
                                    class="btn" style="background: #17a2b8; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('resetRequestDetails').innerHTML = detailsHtml;
                document.getElementById('resetRequestDetailModal').style.display = 'block';

            } catch (error) {
                console.error('Error loading reset request details:', error);
                showMessage('Error loading request details', 'error');
            }
        };

        window.processResetRequestFromModal = async function(requestId, action) {
            try {
                // Get the request details first to get the new password and username
                const requestDoc = await getDoc(doc(db, 'password_reset_requests', requestId));
                if (!requestDoc.exists()) {
                    showMessage('Reset request not found', 'error');
                    return;
                }

                const request = requestDoc.data();

                if (action === 'approved') {
                    // Update the user's password
                    if (request.newPassword && request.username) {
                        // Find the user document by username
                        const usersRef = collection(db, 'users');
                        const userQuery = query(usersRef, where('username', '==', request.username));
                        const userSnapshot = await getDocs(userQuery);
                        
                        if (!userSnapshot.empty) {
                            const userDoc = userSnapshot.docs[0];
                            await updateDoc(userDoc.ref, {
                                password: request.newPassword,
                                passwordChangedAt: new Date(),
                                passwordChangedBy: currentUser.username,
                                passwordResetApproved: true
                            });

                            showMessage(`Password successfully changed for ${request.username}!`, 'success');
                        } else {
                            showMessage('User not found in database', 'error');
                            return;
                        }
                    }

                    // Update request status
                    await updateDoc(doc(db, 'password_reset_requests', requestId), {
                        status: 'approved',
                        processedAt: new Date(),
                        processedBy: currentUser.username
                    });

                    // Log the action
                    await logUserAction('password_reset_approved', 'system', {
                        requestId: requestId,
                        username: request.username,
                        processedBy: currentUser.username
                    });

                    showMessage('Password reset request approved and password changed successfully!', 'success');
                } else if (action === 'denied') {
                    await updateDoc(doc(db, 'password_reset_requests', requestId), {
                        status: 'denied',
                        processedAt: new Date(),
                        processedBy: currentUser.username
                    });

                    await logUserAction('password_reset_denied', 'system', {
                        requestId: requestId,
                        username: request.username,
                        processedBy: currentUser.username
                    });

                    showMessage('Password reset request denied.', 'success');
                }

                // Close modal and refresh the requests list
                closeModal('resetRequestDetailModal');
                loadResetRequests();
            } catch (error) {
                console.error('Error processing reset request:', error);
                showMessage('Error processing request. Please try again.', 'error');
            }
        };

        window.removeResetRequest = async function(requestId) {
            if (!confirm('Are you sure you want to permanently remove this reset request from the database? This action cannot be undone.')) {
                return;
            }

            try {
                // Get request details for logging
                const requestDoc = await getDoc(doc(db, 'password_reset_requests', requestId));
                const request = requestDoc.exists() ? requestDoc.data() : null;

                // Delete the request
                await deleteDoc(doc(db, 'password_reset_requests', requestId));

                // Log the removal
                await logUserAction('password_reset_removed', 'system', {
                    requestId: requestId,
                    username: request?.username || 'unknown',
                    removedBy: currentUser.username
                });

                showMessage('Reset request removed from database.', 'success');
                closeModal('resetRequestDetailModal');
                loadResetRequests();
            } catch (error) {
                console.error('Error removing reset request:', error);
                showMessage('Error removing request. Please try again.', 'error');
            }
        };

        window.processResetRequest = async function(requestId, action) {
            try {
                if (action === 'approved') {
                    // Update request status
                    await updateDoc(doc(db, 'password_reset_requests', requestId), {
                        status: 'approved',
                        processedAt: new Date(),
                        processedBy: currentUser
                    });

                    // Log the action
                    await logUserAction('password_reset_approved', 'system', {
                        requestId: requestId,
                        processedBy: currentUser
                    });

                    showMessage('Password reset request approved successfully!', 'success');
                } else if (action === 'denied') {
                    await updateDoc(doc(db, 'password_reset_requests', requestId), {
                        status: 'denied',
                        processedAt: new Date(),
                        processedBy: currentUser
                    });

                    await logUserAction('password_reset_denied', 'system', {
                        requestId: requestId,
                        processedBy: currentUser
                    });

                    showMessage('Password reset request denied.', 'success');
                }

                // Refresh the requests list
                loadResetRequests();
            } catch (error) {
                console.error('Error processing reset request:', error);
                showMessage('Error processing request. Please try again.', 'error');
            }
        }

        // Handle change password form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Handle Change Password Request form submission (for signed-in users)
            const changePasswordRequestForm = document.getElementById('changePasswordRequestForm');
            if (changePasswordRequestForm) {
                changePasswordRequestForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const newPassword = document.getElementById('newPasswordRequest').value;
                    const confirmPassword = document.getElementById('confirmPasswordRequest').value;
                    const reason = document.getElementById('changeReason').value;
                    const errorDiv = document.getElementById('changePasswordRequestError');
                    const successDiv = document.getElementById('changePasswordRequestSuccess');
                    const loadingDiv = document.getElementById('changePasswordRequestLoading');
                    
                    errorDiv.textContent = '';
                    successDiv.textContent = '';
                    loadingDiv.style.display = 'block';
                    
                    // Validate passwords match
                    if (newPassword !== confirmPassword) {
                        errorDiv.textContent = 'Passwords do not match';
                        loadingDiv.style.display = 'none';
                        return;
                    }
                    
                    // Validate password requirements
                    if (newPassword.length < 8) {
                        errorDiv.textContent = 'Password must be at least 8 characters long';
                        loadingDiv.style.display = 'none';
                        return;
                    }
                    
                    if (!/[A-Z]/.test(newPassword) || !/[a-z]/.test(newPassword) || !/\d/.test(newPassword) || !/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                        errorDiv.textContent = 'Password must contain uppercase, lowercase, number, and special character';
                        loadingDiv.style.display = 'none';
                        return;
                    }
                    
                    try {
                        // Get client IP address
                        let ipAddress = 'unknown';
                        try {
                            const response = await fetch('https://api.ipify.org?format=json');
                            const data = await response.json();
                            ipAddress = data.ip;
                        } catch (ipError) {
                            console.log('Could not get IP address');
                        }
                        
                        // Submit password change request
                        const resetRequestsRef = collection(db, 'password_reset_requests');
                        await addDoc(resetRequestsRef, {
                            username: currentUser.username,
                            fullName: currentUser.username, // Since they're signed in, we use username
                            phoneNumber: 'N/A - Signed In Request',
                            email: 'N/A - Signed In Request',
                            reason: reason || 'Password change request from signed-in user',
                            newPassword: newPassword,
                            ipAddress: ipAddress,
                            timestamp: new Date(),
                            status: 'pending',
                            isSignedIn: true,
                            signedInAs: currentUser.username,
                            securityQuestionsAnswered: false,
                            securityQuestionsCorrect: 0,
                            securityQuestionsTotalAsked: 0,
                            securityAnswers: [] // No security questions for signed-in users
                        });
                        
                        // Log the password change request
                        await logUserAction('password_change_request', 'user', {
                            username: currentUser.username,
                            isSignedIn: true,
                            reason: reason || 'Password change request'
                        });
                        
                        successDiv.textContent = ' Password change request submitted successfully! An admin will review it shortly.';
                        
                        // Clear form
                        changePasswordRequestForm.reset();
                        
                        // Close modal after 2 seconds
                        setTimeout(() => {
                            closeModal('changePasswordRequestModal');
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Error submitting password change request:', error);
                        errorDiv.textContent = 'Error submitting request: ' + error.message;
                    } finally {
                        loadingDiv.style.display = 'none';
                    }
                });
            }

            // Password confirmation validation for change password request
            const newPasswordRequest = document.getElementById('newPasswordRequest');
            const confirmPasswordRequest = document.getElementById('confirmPasswordRequest');
            const passwordMatchRequest = document.getElementById('passwordMatchRequest');
            
            function updatePasswordMatchRequest() {
                if (!newPasswordRequest || !confirmPasswordRequest || !passwordMatchRequest) return;
                
                const password = newPasswordRequest.value;
                const confirmPassword = confirmPasswordRequest.value;
                
                if (confirmPassword.length > 0) {
                    if (password === confirmPassword) {
                        confirmPasswordRequest.style.borderColor = '#27ae60';
                        passwordMatchRequest.textContent = ' Passwords match';
                        passwordMatchRequest.style.color = '#27ae60';
                    } else {
                        confirmPasswordRequest.style.borderColor = '#e74c3c';
                        passwordMatchRequest.textContent = ' Passwords do not match';
                        passwordMatchRequest.style.color = '#e74c3c';
                    }
                } else {
                    confirmPasswordRequest.style.borderColor = '#ddd';
                    passwordMatchRequest.textContent = 'Must match the password above';
                    passwordMatchRequest.style.color = '#666';
                }
            }
            
            if (newPasswordRequest && confirmPasswordRequest) {
                newPasswordRequest.addEventListener('input', updatePasswordMatchRequest);
                confirmPasswordRequest.addEventListener('input', updatePasswordMatchRequest);
            }

            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('changePasswordUserId').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword !== confirmPassword) {
                        showMessage('Passwords do not match!', 'error');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        showMessage('Password must be at least 6 characters long!', 'error');
                        return;
                    }
                    
                    try {
                        // Update password in database
                        await updateDoc(doc(db, 'users', userId), {
                            password: newPassword,
                            passwordChangedAt: new Date(),
                            passwordChangedBy: currentUser
                        });

                        // Log the password change
                        await logUserAction('password_changed', 'user', {
                            targetUserId: userId,
                            changedBy: currentUser
                        });

                        showMessage('Password changed successfully!', 'success');
                        closeChangePasswordModal();
                        loadUserPasswords(); // Refresh the list
                    } catch (error) {
                        console.error('Error changing password:', error);
                        showMessage('Error changing password. Please try again.', 'error');
                    }
                });
            }
        });

        // Security Questions Functions
        window.openSecurityQuestionsModal = function() {
            document.getElementById('securityQuestionsModal').style.display = 'block';
            loadSecurityQuestions();
            // Log security questions access
            logUserAction('security_questions', 'modal_opened', 'User opened security questions management modal', 'success');
        }

        window.closeSecurityQuestionsModal = function() {
            document.getElementById('securityQuestionsModal').style.display = 'none';
        }

        let questionCount = 0;

        window.addSecurityQuestion = function() {
            if (questionCount >= 3) {
                showMessage('Maximum 3 security questions allowed', 'error');
                return;
            }

            questionCount++;
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.id = `question-${questionCount}`;
            
            questionDiv.innerHTML = `
                <h4>Security Question ${questionCount} 
                    <button class="remove-question-btn" onclick="removeSecurityQuestion(${questionCount})">Remove</button>
                </h4>
                <input type="text" class="question-input" placeholder="Enter your security question..." maxlength="200">
                <input type="text" class="answer-input" placeholder="Enter the answer..." maxlength="100">
            `;
            
            container.appendChild(questionDiv);
        }

        window.removeSecurityQuestion = function(questionId) {
            const questionDiv = document.getElementById(`question-${questionId}`);
            if (questionDiv) {
                questionDiv.remove();
                questionCount--;
            }
        }

        async function loadSecurityQuestions() {
            try {
                // Ensure currentUser is valid and has username property
                if (!currentUser || !currentUser.username || typeof currentUser.username !== 'string') {
                    console.error('Current user is not valid:', currentUser);
                    throw new Error('Current user is not set properly');
                }

                // Get the current user's document ID from the users collection
                const usersRef = collection(db, 'users');
                const userQuery = query(usersRef, where('username', '==', String(currentUser.username).trim()));
                const userSnapshot = await getDocs(userQuery);
                
                let userDocId = String(currentUser.username).trim(); // fallback to username
                if (!userSnapshot.empty) {
                    userDocId = userSnapshot.docs[0].id;
                }

                // Check if security_questions collection exists
                const questionsRef = doc(db, 'security_questions', userDocId);
                const questionsSnap = await getDoc(questionsRef);
                
                const container = document.getElementById('questionsContainer');
                container.innerHTML = '';
                questionCount = 0;

                if (questionsSnap.exists()) {
                    const data = questionsSnap.data();
                    const questions = data.questions || [];
                    
                    questions.forEach((item, index) => {
                        questionCount++;
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'question-item';
                        questionDiv.id = `question-${questionCount}`;
                        
                        questionDiv.innerHTML = `
                            <h4>Security Question ${questionCount} 
                                <button class="remove-question-btn" onclick="removeSecurityQuestion(${questionCount})">Remove</button>
                            </h4>
                            <input type="text" class="question-input" placeholder="Enter your security question..." maxlength="200" value="${item.question || ''}">
                            <input type="text" class="answer-input" placeholder="Enter the answer..." maxlength="100" value="${item.answer || ''}">
                        `;
                        
                        container.appendChild(questionDiv);
                    });
                }

                // Add one empty question if none exist
                if (questionCount === 0) {
                    addSecurityQuestion();
                }
            } catch (error) {
                console.error('Error loading security questions:', error);
                showMessage('Error loading security questions: ' + error.message, 'error');
                
                // Add empty question on error
                const container = document.getElementById('questionsContainer');
                container.innerHTML = '';
                questionCount = 0;
                addSecurityQuestion();
            }
        }

        window.saveSecurityQuestions = async function() {
            try {
                // Ensure currentUser is valid and has username property
                if (!currentUser || !currentUser.username || typeof currentUser.username !== 'string') {
                    showMessage('User session is invalid. Please log in again.', 'error');
                    return;
                }

                const questions = [];
                const questionItems = document.querySelectorAll('.question-item');
                
                questionItems.forEach(item => {
                    const question = item.querySelector('.question-input').value.trim();
                    const answer = item.querySelector('.answer-input').value.trim();
                    
                    if (question && answer) {
                        questions.push({ question, answer });
                    }
                });

                if (questions.length === 0) {
                    showMessage('Please add at least one security question', 'error');
                    return;
                }

                // Get the current user's document ID from the users collection
                const usersRef = collection(db, 'users');
                const userQuery = query(usersRef, where('username', '==', String(currentUser.username).trim()));
                const userSnapshot = await getDocs(userQuery);
                
                let userDocId = String(currentUser.username).trim(); // fallback to username
                if (!userSnapshot.empty) {
                    userDocId = userSnapshot.docs[0].id;
                }

                // Save to Firestore using the user's document ID
                const questionsRef = doc(db, 'security_questions', userDocId);
                await setDoc(questionsRef, {
                    questions: questions,
                    updatedAt: new Date(),
                    userId: currentUser.username,
                    userDocId: userDocId
                }, { merge: true });

                // Log the action
                await logUserAction('security_questions_updated', 'security', {
                    questionCount: questions.length,
                    updatedBy: currentUser.username,
                    userDocId: userDocId
                });

                showMessage(`Security questions saved successfully! (${questions.length} questions)`, 'success');
                closeSecurityQuestionsModal();
            } catch (error) {
                console.error('Error saving security questions:', error);
                showMessage('Error saving security questions: ' + error.message, 'error');
            }
        }

        // Initialize the app
        init();
        initializeModals();
        // force to push
    </script>
</body>
</html>