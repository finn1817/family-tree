<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree - Dashboard</title>
    <!-- SheetJS library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-badge {
            background: #e74c3c;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .requests-badge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            font-weight: bold;
            min-width: 1.2rem;
            text-align: center;
            display: inline-block;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #f8f9ff;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            border-bottom-color: #4a5fd8;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .upcoming-birthdays {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .birthday-item:last-child {
            border-bottom: none;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 250px;
        }
        
        .filter-select {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .family-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .family-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .family-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .family-info div {
            padding: 0.25rem 0;
        }
        
        .family-info strong {
            color: #333;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Branch View Modal Specific Styles */
        #branchViewModal .modal-content {
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #branchMembersGrid {
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1rem;
        }

        #branchMembersGrid .family-card {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }

        #branchMembersGrid .family-card:hover {
            border-left-color: #20c997;
            transform: translateX(5px);
        }

        #branchSearchInput {
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        #branchSearchInput:focus {
            outline: none;
            border-color: #28a745;
            background: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        /* Management Modal Styles */
        .manage-tab-content {
            min-height: 300px;
        }

        #manageBranchModal .tab {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 0.25rem;
            font-size: 0.9rem;
        }

        #manageBranchModal .tab.active {
            background: white;
            border-bottom: 2px solid #007bff;
        }

        #moveCandidates input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .message-board {
            background: #f8f9ff;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .message {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-author {
            font-weight: 600;
            color: #667eea;
        }
        
        .message-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .bulk-import {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .import-area {
            width: 100%;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            font-family: monospace;
            margin: 1rem 0;
        }
        
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            background: white;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #4a5fd8;
            background: #f8f9ff;
        }
        
        .file-upload-area.dragover {
            border-color: #4a5fd8;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin: 1rem;
        }
        
        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .file-info {
            margin: 1rem 0;
            padding: 1rem;
            background: #e8f4fd;
            border-radius: 10px;
            display: none;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .preview-table tr:hover {
            background: #f8f9ff;
        }
        
        /* New Relationship System Styles */
        .relationship-section {
            display: none;
        }
        
        .relationship-section.active {
            display: block;
        }
        
        .relationship-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .relationship-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            background: #f8f9fa;
        }
        
        .relationship-tab:hover {
            background: #e9ecef;
        }
        
        .relationship-tab.active {
            background: #28a745;
            color: white;
            border-bottom-color: #20c997;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .family-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≥ Family Tree Dashboard</h1>
        <div class="user-info">
            <span id="username"></span>
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-container">
        <div class="upcoming-birthdays">
            <h2>üéÇ Upcoming Birthdays</h2>
            <div id="upcomingBirthdays"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('family')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Members</div>
            <div class="tab" onclick="switchTab('branches')">üåø Family Groups</div>
            <div class="tab" onclick="switchTab('messages')">üí¨ Message Board</div>
            <div class="tab admin-only" onclick="switchTab('users')" style="display: none;">üë• Manage Users</div>
            <div class="tab admin-only" onclick="switchTab('requests')" style="display: none;">
                üìã Account Requests
                <span id="requestsBadge" class="requests-badge" style="display: none;">0</span>
            </div>
            <div class="tab admin-only" onclick="switchTab('import')" style="display: none;">üìã Bulk Import</div>
        </div>

        <div class="tab-content">
            <!-- Family Members Section -->
            <div id="family" class="section active">
                <div class="controls">
                    <div class="search-controls">
                        <input type="text" class="search-input" placeholder="Search family members..." id="searchInput">
                        <select class="filter-select" id="monthFilter">
                            <option value="">All Months</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                        <select class="filter-select" id="sortOrder">
                            <option value="name">Sort by Name</option>
                            <option value="age-oldest">Sort by Age (Oldest First)</option>
                            <option value="age-youngest">Sort by Age (Youngest First)</option>
                            <option value="birthday">Sort by Upcoming Birthday</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-primary" onclick="openAddMemberModal()">+ Add Family Member</button>
                    </div>
                </div>
                <div id="familyGrid" class="family-grid"></div>
            </div>

            <!-- Family Groups Section -->
            <div id="branches" class="section">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h2 style="margin-bottom: 0.5rem;">üåø Family Groups by Generation</h2>
                    <p style="margin: 0; opacity: 0.9;">Organize your family into generational groups - perfect for grandparents to see everyone!</p>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddBranchModal()">+ Create Family Group</button>
                    <button class="btn" onclick="autoCreateGenerations()" style="background: #28a745; color: white;">üîÑ Auto-Create Generations</button>
                </div>
                
                <div id="branchesGrid" class="family-grid"></div>
            </div>

            <!-- Message Board Section -->
            <div id="messages" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddMessageModal()">+ Post Message</button>
                </div>
                <div class="message-board">
                    <div id="messagesContainer"></div>
                </div>
            </div>

            <!-- Users Management Section (Admin Only) -->
            <div id="users" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddUserModal()">+ Add New User</button>
                </div>
                <div id="usersGrid" class="family-grid"></div>
            </div>

            <!-- Account Requests Section (Admin Only) -->
            <div id="requests" class="section">
                <div class="controls">
                    <h2>üìã Account Requests</h2>
                    <div id="requestsStats" style="margin: 1rem 0;"></div>
                </div>
                <div id="requestsGrid" class="family-grid"></div>
            </div>

            <!-- Bulk Import Section (Admin Only) -->
            <div id="import" class="section">
                <div class="bulk-import">
                    <h3>üìã Bulk Import Family Data</h3>
                    <p>Upload your Excel file (.xlsx, .xls) to automatically import family member data:</p>
                    
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="file-upload-content">
                            <h4>üìé Drop Excel file here or click to browse</h4>
                            <p>Supported formats: .xlsx, .xls</p>
                            <label for="excelFile" class="file-upload-btn">Choose Excel File</label>
                            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        </div>
                    </div>
                    
                    <div id="fileInfo" class="file-info">
                        <p><strong>File:</strong> <span id="fileName"></span></p>
                        <p><strong>Size:</strong> <span id="fileSize"></span></p>
                        <p><strong>Rows found:</strong> <span id="rowCount"></span></p>
                    </div>
                    
                    <div id="previewContainer" style="display: none;">
                        <h4>Preview Data (First 5 rows):</h4>
                        <div style="overflow-x: auto;">
                            <table id="previewTable" class="preview-table">
                                <thead>
                                    <tr>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Month</th>
                                        <th>Day</th>
                                        <th>Year</th>
                                        <th>Column G (Ignored)</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="confirmImport()" id="importBtn" style="margin-top: 1rem;">Import All Data</button>
                        <button class="btn btn-primary" onclick="clearFile()" style="margin-top: 1rem; margin-left: 0.5rem;">Choose Different File</button>
                        <button class="btn" onclick="testDatabase()" style="margin-top: 1rem; margin-left: 0.5rem; background: #ffc107; color: #000;">Test Database</button>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 10px; text-align: left;">
                        <h4>üìù Excel File Format Requirements:</h4>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li><strong>Column A:</strong> First Name</li>
                            <li><strong>Column B:</strong> Last Name</li>
                            <li><strong>Column C:</strong> Birth Month (e.g., "January", "February")</li>
                            <li><strong>Column D:</strong> Birth Day (1-31)</li>
                            <li><strong>Column E:</strong> Birth Year (e.g., 1990)</li>
                            <li><strong>Column G:</strong> Will be ignored during import</li>
                        </ul>
                        <p><em>Note: Family branches will be empty after import - organize into families later using the Family Branches tab</em></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Member</h2>
            <form id="addMemberForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="birthMonth">Birth Month *</label>
                        <select id="birthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDay">Birth Day *</label>
                        <input type="number" id="birthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="birthYear">Birth Year *</label>
                        <input type="number" id="birthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="familyBranch">Family Branch</label>
                        <select id="familyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="marriedTo">üíç Married To</label>
                        <select id="marriedTo">
                            <option value="">Select someone</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="parents">üë´ Parents (Select up to 2)</label>
                        <div id="addParentsSelection" style="border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; max-height: 200px; overflow-y: auto; background: #f9f9f9;">
                            <!-- Parents checkboxes will be populated by JavaScript -->
                        </div>
                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                            Selected: <span id="addParentsCount">0</span>/2 parents ‚Ä¢ Sorted by age (oldest first)
                        </small>
                    </div>
                    <div class="form-group full-width">
                        <label for="children">üë∂ Children (Select up to 15)</label>
                        <div id="addChildrenSelection" style="border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; max-height: 200px; overflow-y: auto; background: #f9f9f9;">
                            <!-- Children checkboxes will be populated by JavaScript -->
                        </div>
                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                            Selected: <span id="addChildrenCount">0</span>/15 children ‚Ä¢ Sorted by age (youngest first)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="mobilePhone">Mobile Phone</label>
                        <input type="tel" id="mobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="homePhone">Home Phone</label>
                        <input type="tel" id="homePhone">
                    </div>
                    <div class="form-group">
                        <label for="workPhone">Work Phone</label>
                        <input type="tel" id="workPhone">
                    </div>
                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" id="state">
                    </div>
                    <div class="form-group">
                        <label for="zipCode">Zip Code</label>
                        <input type="text" id="zipCode">
                    </div>
                    <div class="form-group">
                        <label for="anniversaryDate">Anniversary Date</label>
                        <input type="date" id="anniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h2>Edit Family Member</h2>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFirstName">First Name *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name *</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthMonth">Birth Month *</label>
                        <select id="editBirthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBirthDay">Birth Day *</label>
                        <input type="number" id="editBirthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthYear">Birth Year *</label>
                        <input type="number" id="editBirthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="editFamilyBranch">Family Branch</label>
                        <select id="editFamilyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMarriedTo">üíç Married To</label>
                        <select id="editMarriedTo">
                            <option value="">Select someone</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMobilePhone">Mobile Phone</label>
                        <input type="tel" id="editMobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="editHomePhone">Home Phone</label>
                        <input type="tel" id="editHomePhone">
                    </div>
                    <div class="form-group">
                        <label for="editWorkPhone">Work Phone</label>
                        <input type="tel" id="editWorkPhone">
                    </div>
                    <div class="form-group">
                        <label for="editAddress">Street Address</label>
                        <input type="text" id="editAddress">
                    </div>
                    <div class="form-group">
                        <label for="editCity">City</label>
                        <input type="text" id="editCity">
                    </div>
                    <div class="form-group">
                        <label for="editState">State</label>
                        <input type="text" id="editState">
                    </div>
                    <div class="form-group">
                        <label for="editZipCode">Zip Code</label>
                        <input type="text" id="editZipCode">
                    </div>
                    <div class="form-group">
                        <label for="editAnniversaryDate">Anniversary Date</label>
                        <input type="date" id="editAnniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('editMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Branch Modal -->
    <div id="addBranchModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Branch</h2>
            <form id="addBranchForm">
                <div class="form-group">
                    <label for="branchName">Branch Name *</label>
                    <input type="text" id="branchName" required placeholder="e.g., Finn - Danny's Nuclear Family">
                </div>
                <div class="form-group">
                    <label for="branchDescription">Description</label>
                    <textarea id="branchDescription" placeholder="Description of this family branch"></textarea>
                </div>
                <div class="form-group">
                    <label for="generationLevel">Generation Level *</label>
                    <select id="generationLevel" required>
                        <option value="">Select Generation</option>
                        <option value="1">üë¥üëµ Grandparents (Generation 1)</option>
                        <option value="2">üë®üë© Parents (Generation 2)</option>
                        <option value="3">üßëüëß Children (Generation 3)</option>
                        <option value="4">üë∂ Grandchildren (Generation 4)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="branchType">Branch Type *</label>
                    <select id="branchType" required>
                        <option value="">Select Type</option>
                        <option value="nuclear_family">üè† Nuclear Family (Parents + Children)</option>
                        <option value="extended_family">üèòÔ∏è Extended Family (Multiple Generations)</option>
                        <option value="cousin_branch">üë• Cousin Branch (Same Generation)</option>
                        <option value="grandparent_branch">üë¥ Grandparent Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parentBranch">Parent Branch (Optional)</label>
                    <select id="parentBranch">
                        <option value="">No Parent Branch</option>
                    </select>
                </div>
                <div id="smartSuggestions" style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; display: none;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">üí° Smart Suggestions:</h4>
                    <div id="suggestionsList"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addBranchModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Branch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Family Unit Modal -->
    <div id="createFamilyUnitModal" class="modal">
        <div class="modal-content">
            <h2>Create Family Unit</h2>
            <form id="createFamilyUnitForm">
                <div class="form-group">
                    <label for="unitName">Family Unit Name *</label>
                    <input type="text" id="unitName" required placeholder="e.g., The Finn Family, Smith Extended Family">
                </div>
                <div class="form-group">
                    <label for="unitDescription">Description</label>
                    <textarea id="unitDescription" placeholder="Description of this family unit"></textarea>
                </div>
                <div class="form-group">
                    <label for="unitType">Unit Type *</label>
                    <select id="unitType" required>
                        <option value="">Select Type</option>
                        <option value="nuclear">Nuclear Family (Parents + Children)</option>
                        <option value="extended">Extended Family (Multiple Generations)</option>
                        <option value="ancestral">Ancestral Line (Historical Family Tree)</option>
                        <option value="mixed">Mixed Family (Blended/Complex)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Branches to Include:</label>
                    <div id="branchCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                        <!-- Will be populated with available branches -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('createFamilyUnitModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Family Unit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal (Admin Only) -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Add New User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUsername">Username * (min 5 characters)</label>
                    <input type="text" id="newUsername" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password * (min 5 characters)</label>
                    <input type="password" id="newPassword" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="userPhone">Phone</label>
                    <input type="tel" id="userPhone">
                </div>
                <div class="form-group">
                    <label for="isAdmin">Admin Status</label>
                    <select id="isAdmin">
                        <option value="0">Regular User</option>
                        <option value="1">Administrator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Message Modal -->
    <div id="addMessageModal" class="modal">
        <div class="modal-content">
            <h2>Post Message</h2>
            <form id="addMessageForm">
                <div class="form-group">
                    <label for="messageTitle">Title</label>
                    <input type="text" id="messageTitle" placeholder="Message title (optional)">
                </div>
                <div class="form-group">
                    <label for="messageContent">Message *</label>
                    <textarea id="messageContent" required placeholder="Write your message here..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMessageModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Branch View Modal -->
    <div id="branchViewModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="branchViewTitle">Branch Members</h2>
                <button class="btn" onclick="closeModal('branchViewModal')" style="background: #6c757d; color: white;">‚úï Close</button>
            </div>
            
            <div id="branchStats" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: white;" id="branchStatsName">Branch Name</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;" id="branchStatsCount">0 family members</p>
                    </div>
                    <div style="font-size: 3rem; opacity: 0.7;">üåø</div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <input type="text" id="branchSearchInput" placeholder="Search branch members..." style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
            </div>

            <div id="branchMembersGrid" class="family-grid" style="max-height: 70vh; overflow-y: auto;"></div>
            
            <div id="noBranchMembers" style="display: none; text-align: center; padding: 2rem; color: #6c757d;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üë•</div>
                <h3>No family members in this branch yet</h3>
                <p>Add family members and assign them to this branch to see them here.</p>
            </div>
        </div>
    </div>

    <!-- Manage Branch Modal -->
    <div id="manageBranchModal" class="modal">
        <div class="modal-content" style="max-width: 80%; width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="manageBranchTitle">Manage Branch</h2>
                <button class="btn" onclick="closeModal('manageBranchModal')" style="background: #6c757d; color: white;">‚úï Close</button>
            </div>
            
            <div class="tabs" style="margin-bottom: 1rem;">
                <div class="tab active" onclick="switchManageTab('moveMembers')">üîÑ Move Members</div>
                <div class="tab" onclick="switchManageTab('shareMembers')">üë• Share Members</div>
                <div class="tab" onclick="switchManageTab('suggestions')">üí° Smart Suggestions</div>
            </div>

            <!-- Move Members Tab -->
            <div id="moveMembers" class="manage-tab-content active">
                <h4>Move Members to This Branch</h4>
                <p>Select family members from other branches to move to this branch:</p>
                
                <div style="margin-bottom: 1rem;">
                    <label for="sourceBranch">From Branch:</label>
                    <select id="sourceBranch" onchange="loadMoveCandidates()" style="margin-left: 0.5rem; padding: 0.5rem;">
                        <option value="">Select source branch</option>
                    </select>
                </div>
                
                <div id="moveCandidates" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <p style="text-align: center; color: #666;">Select a source branch to see members</p>
                </div>
                
                <button id="moveSelectedBtn" class="btn btn-primary" onclick="moveSelectedMembers()" style="margin-top: 1rem; display: none;">
                    Move Selected Members
                </button>
            </div>

            <!-- Share Members Tab -->
            <div id="shareMembers" class="manage-tab-content" style="display: none;">
                <h4>Share Members with Other Branches</h4>
                <p>Add members from this branch to appear in other branches (like parents appearing in children's families):</p>
                
                <div id="shareableMembersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated with current branch members -->
                </div>
            </div>

            <!-- Smart Suggestions Tab -->
            <div id="suggestions" class="manage-tab-content" style="display: none;">
                <h4>Smart Organization Suggestions</h4>
                <div id="branchSuggestions">
                    <!-- Will be populated with AI suggestions -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load the new relationship system -->
    <!-- Consolidated: relationship-system.js and relationship-ui.js code is now inline below -->

    <script>
        /**
         * CONSOLIDATED FAMILY RELATIONSHIP SYSTEM
         * 
         * This is a complete redesign of the family tree system from branch-based to relationship-based.
         * 
         * Core Concepts:
         * - People are individuals with basic info
         * - Families are groups of people with specific relationships
         * - Relationships define how people are connected (parent, child, spouse, etc.)
         * - One person can have multiple relationships in different families
         */

        class FamilyRelationshipSystem {
            constructor(firebaseDb, firebaseModules) {
                this.db = firebaseDb;
                // Inject Firebase modules
                Object.assign(this, firebaseModules);
                
                // Data stores
                this.people = [];
                this.families = [];
                this.relationships = [];
                
                // Collection names for the new system
                this.COLLECTIONS = {
                    PEOPLE: 'people_v2',
                    FAMILIES: 'families_v2', 
                    RELATIONSHIPS: 'family_relationships_v2'
                };
            }

            /**
             * PERSON MANAGEMENT
             */
            async addPerson(personData) {
                const person = {
                    firstName: personData.firstName,
                    lastName: personData.lastName,
                    birthMonth: personData.birthMonth,
                    birthDay: personData.birthDay,
                    birthYear: personData.birthYear,
                    mobilePhone: personData.mobilePhone || '',
                    homePhone: personData.homePhone || '',
                    workPhone: personData.workPhone || '',
                    email: personData.email || '',
                    address: personData.address || '',
                    city: personData.city || '',
                    state: personData.state || '',
                    zipCode: personData.zipCode || '',
                    anniversaryDate: personData.anniversaryDate || '',
                    notes: personData.notes || '',
                    createdAt: new Date(),
                    createdBy: personData.createdBy,
                    isActive: true
                };

                const docRef = await addDoc(collection(this.db, this.COLLECTIONS.PEOPLE), person);
                person.id = docRef.id;
                return person;
            }

            async updatePerson(personId, updateData) {
                updateData.updatedAt = new Date();
                await updateDoc(doc(this.db, this.COLLECTIONS.PEOPLE, personId), updateData);
            }

            async deletePerson(personId) {
                // Mark as inactive instead of deleting to preserve relationship history
                await this.updatePerson(personId, { isActive: false, deletedAt: new Date() });
            }

            /**
             * FAMILY MANAGEMENT
             */
            async createFamily(familyData) {
                const family = {
                    name: familyData.name,
                    description: familyData.description || '',
                    familyType: familyData.familyType || 'nuclear',
                    generationLevel: familyData.generationLevel || 0,
                    createdAt: new Date(),
                    createdBy: familyData.createdBy,
                    isActive: true
                };

                const docRef = await addDoc(collection(this.db, this.COLLECTIONS.FAMILIES), family);
                family.id = docRef.id;
                return family;
            }

            async updateFamily(familyId, updateData) {
                updateData.updatedAt = new Date();
                await updateDoc(doc(this.db, this.COLLECTIONS.FAMILIES, familyId), updateData);
            }

            async deleteFamily(familyId) {
                // Mark as inactive and remove all relationships
                await this.updateFamily(familyId, { isActive: false, deletedAt: new Date() });
                // Remove all relationships in this family
                const familyRelationships = this.relationships.filter(r => r.familyId === familyId);
                for (const relationship of familyRelationships) {
                    await this.removeRelationship(relationship.id);
                }
            }

            /**
             * RELATIONSHIP MANAGEMENT
             */
            async addRelationship(relationshipData) {
                const relationship = {
                    personId: relationshipData.personId,
                    familyId: relationshipData.familyId,
                    role: relationshipData.role,
                    relationshipToOthers: relationshipData.relationshipToOthers || '',
                    startDate: relationshipData.startDate || null,
                    endDate: relationshipData.endDate || null,
                    createdAt: new Date(),
                    createdBy: relationshipData.createdBy,
                    isActive: true
                };

                const docRef = await addDoc(collection(this.db, this.COLLECTIONS.RELATIONSHIPS), relationship);
                relationship.id = docRef.id;
                return relationship;
            }

            async updateRelationship(relationshipId, updateData) {
                updateData.updatedAt = new Date();
                await updateDoc(doc(this.db, this.COLLECTIONS.RELATIONSHIPS, relationshipId), updateData);
            }

            async removeRelationship(relationshipId) {
                await updateDoc(doc(this.db, this.COLLECTIONS.RELATIONSHIPS, relationshipId), {
                    isActive: false,
                    deletedAt: new Date()
                });
            }

            /**
             * DATA LOADING
             */
            async loadAllData() {
                await Promise.all([
                    this.loadPeople(),
                    this.loadFamilies(),
                    this.loadRelationships()
                ]);
            }

            async loadPeople() {
                try {
                    const snapshot = await getDocs(collection(this.db, this.COLLECTIONS.PEOPLE));
                    this.people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading people:', error);
                    this.people = [];
                }
            }

            async loadFamilies() {
                try {
                    const snapshot = await getDocs(collection(this.db, this.COLLECTIONS.FAMILIES));
                    this.families = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading families:', error);
                    this.families = [];
                }
            }

            async loadRelationships() {
                try {
                    const snapshot = await getDocs(collection(this.db, this.COLLECTIONS.RELATIONSHIPS));
                    this.relationships = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading relationships:', error);
                    this.relationships = [];
                }
            }

            /**
             * QUERY METHODS
             */
            getPerson(personId) {
                return this.people.find(p => p.id === personId);
            }

            getFamily(familyId) {
                return this.families.find(f => f.id === familyId);
            }

            getPersonRelationships(personId) {
                return this.relationships.filter(r => r.personId === personId && r.isActive);
            }

            getFamilyMembers(familyId) {
                const familyRelationships = this.relationships.filter(r => r.familyId === familyId && r.isActive);
                return familyRelationships.map(rel => ({
                    person: this.getPerson(rel.personId),
                    role: rel.role,
                    relationshipToOthers: rel.relationshipToOthers,
                    relationship: rel
                }));
            }

            getPersonFamilies(personId) {
                const personRelationships = this.getPersonRelationships(personId);
                return personRelationships.map(rel => ({
                    family: this.getFamily(rel.familyId),
                    role: rel.role,
                    relationshipToOthers: rel.relationshipToOthers,
                    relationship: rel
                }));
            }

            calculateAge(member) {
                if (!member.birthYear || !member.birthMonth || !member.birthDay) return 'Unknown';
                
                const today = new Date();
                const birthDate = new Date(member.birthYear, this.getMonthIndex(member.birthMonth), member.birthDay);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age;
            }

            getNextBirthday(person) {
                if (!person.birthMonth || !person.birthDay) return new Date(9999, 0, 1);
                
                const today = new Date();
                const currentYear = today.getFullYear();
                const monthIndex = this.getMonthIndex(person.birthMonth);
                
                let nextBirthday = new Date(currentYear, monthIndex, person.birthDay);
                
                if (nextBirthday < today) {
                    nextBirthday = new Date(currentYear + 1, monthIndex, person.birthDay);
                }
                
                return nextBirthday;
            }

            getMonthIndex(monthName) {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
                return months.indexOf(monthName);
            }

            renderFamiliesView() {
                if (this.families.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: #666;">No families created yet. Click "Create Family" to get started!</div>';
                }

                return this.families.map(family => this.renderFamilyCard(family)).join('');
            }

            renderFamilyCard(family) {
                const members = this.getFamilyMembers(family.id);
                const groupedMembers = this.groupMembersByRole(members);

                return `
                    <div class="family-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 0.5rem;">${this.getFamilyTypeIcon(family.familyType)} ${family.name}</h3>
                                <p style="color: #666; font-size: 0.9rem;">${this.formatFamilyType(family.familyType)} ‚Ä¢ ${members.length} member${members.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            ${Object.entries(groupedMembers).map(([role, roleMembers]) => `
                                <div style="margin-bottom: 0.5rem;">
                                    <strong style="color: #495057; font-size: 0.85rem; text-transform: capitalize;">${role}s:</strong>
                                    <div style="margin-top: 0.25rem;">
                                        ${roleMembers.map(m => `
                                            <span style="background: ${this.getFamilyTypeColor(family.familyType)}20; color: ${this.getFamilyTypeColor(family.familyType)}; 
                                                         padding: 0.2rem 0.4rem; border-radius: 4px; margin-right: 0.25rem; font-size: 0.8rem;">
                                                ${m.person.firstName} ${m.person.lastName}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="display: flex; gap: 0.5rem; font-size: 0.8rem;">
                            <button class="btn btn-primary" onclick="relationshipUI.viewFamilyDetails('${family.id}')" style="flex: 1;">üëÅÔ∏è View</button>
                            <button class="btn" onclick="relationshipUI.editFamily('${family.id}')" style="background: #17a2b8; color: white; flex: 1;">‚úèÔ∏è Edit</button>
                            <button class="btn" onclick="relationshipUI.manageRelationships('${family.id}')" style="background: #28a745; color: white; flex: 1;">üë• Manage</button>
                        </div>
                    </div>
                `;
            }

            groupMembersByRole(members) {
                const grouped = {};
                members.forEach(member => {
                    const role = member.role || 'member';
                    if (!grouped[role]) grouped[role] = [];
                    grouped[role].push(member);
                });
                return grouped;
            }

            getFamilyTypeColor(familyType) {
                const colors = {
                    'nuclear': '#007bff',
                    'extended': '#28a745',
                    'ancestral': '#6f42c1',
                    'mixed': '#fd7e14'
                };
                return colors[familyType] || '#6c757d';
            }

            getFamilyTypeIcon(familyType) {
                const icons = {
                    'nuclear': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                    'extended': 'üè†',
                    'ancestral': 'üå≥',
                    'mixed': 'üë•'
                };
                return icons[familyType] || 'üë•';
            }

            formatFamilyType(familyType) {
                const formatted = {
                    'nuclear': 'Nuclear Family',
                    'extended': 'Extended Family',
                    'ancestral': 'Ancestral Line',
                    'mixed': 'Mixed Family'
                };
                return formatted[familyType] || 'Family';
            }
        }

        /**
         * UI COMPONENTS FOR THE FAMILY RELATIONSHIP SYSTEM
         */
        class RelationshipSystemUI {
            constructor(relationshipSystem) {
                this.system = relationshipSystem;
                this.currentUser = null;
            }

            setCurrentUser(user) {
                this.currentUser = user;
            }

            displayPeopleTab() {
                let container = document.getElementById('relationshipsPeople');
                if (!container) {
                    container = document.querySelector('#relationships .section');
                }
                if (!container) return;

                const people = this.system.people.filter(p => p.isActive);
                
                container.innerHTML = `
                    <div class="controls">
                        <div class="search-controls">
                            <input type="text" id="peopleSearchInput" class="search-input" placeholder="Search people..." onkeyup="relationshipUI.filterPeople()">
                            <select id="peopleRoleFilter" class="filter-select" onchange="relationshipUI.filterPeople()">
                                <option value="">All Roles</option>
                                <option value="parent">Parents</option>
                                <option value="child">Children</option>
                                <option value="spouse">Spouses</option>
                                <option value="adult_child">Adult Children</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="relationshipUI.openAddPersonModal()">+ Add Person</button>
                    </div>
                    <div id="peopleGrid" class="family-grid">
                        ${this.renderPeopleGrid(people)}
                    </div>
                `;
            }

            renderPeopleGrid(people) {
                if (people.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: #666;">No people added yet. Click "Add Person" to get started!</div>';
                }

                return people.map(person => this.renderPersonCard(person)).join('');
            }

            renderPersonCard(person) {
                const age = this.system.calculateAge(person);
                const personFamilies = this.system.getPersonFamilies(person.id);
                const nextBirthday = this.system.getNextBirthday(person);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div class="family-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 0.5rem;">${person.firstName} ${person.lastName}</h3>
                                <p style="color: #666; font-size: 0.9rem;">Age: ${age} | Birthday: ${person.birthMonth} ${person.birthDay}</p>
                            </div>
                            ${daysUntilBirthday <= 30 ? `
                                <span style="background: #e74c3c20; color: #e74c3c; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                    üéÇ ${daysUntilBirthday} days
                                </span>
                            ` : ''}
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong style="color: #333;">Families:</strong>
                                ${personFamilies.length > 0 ? `
                                    <div style="margin-top: 0.25rem;">
                                        ${personFamilies.map(pf => `
                                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.2rem;">
                                                ‚Ä¢ ${pf.family.name} (${pf.role})
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<span style="color: #999; font-style: italic;">No families assigned</span>'}
                            </div>
                            
                            ${person.mobilePhone ? `
                                <div style="font-size: 0.8rem; color: #666;">üì± ${person.mobilePhone}</div>
                            ` : ''}
                            
                            ${person.email ? `
                                <div style="font-size: 0.8rem; color: #666;">‚úâÔ∏è ${person.email}</div>
                            ` : ''}
                        </div>

                        <div style="display: flex; gap: 0.5rem; font-size: 0.8rem;">
                            <button class="btn btn-primary" onclick="relationshipUI.viewPersonDetails('${person.id}')" style="flex: 1;">üëÅÔ∏è View</button>
                            <button class="btn" onclick="relationshipUI.editPerson('${person.id}')" style="background: #17a2b8; color: white; flex: 1;">‚úèÔ∏è Edit</button>
                            <button class="btn" onclick="relationshipUI.managePersonRelationships('${person.id}')" style="background: #28a745; color: white; flex: 1;">üë• Families</button>
                        </div>
                    </div>
                `;
            }

            // Placeholder methods for future implementation
            viewPersonDetails(personId) {
                showMessage('Person details view coming soon!', 'info');
            }

            editPerson(personId) {
                showMessage('Person editing coming soon!', 'info');
            }

            managePersonRelationships(personId) {
                showMessage('Relationship management coming soon!', 'info');
            }

            viewFamilyDetails(familyId) {
                showMessage('Family details view coming soon!', 'info');
            }

            editFamily(familyId) {
                showMessage('Family editing coming soon!', 'info');
            }

            manageRelationships(familyId) {
                showMessage('Relationship management coming soon!', 'info');
            }

            openAddPersonModal() {
                showMessage('Add person modal coming soon!', 'info');
            }
        }

        // Make these classes globally available
        window.FamilyRelationshipSystem = FamilyRelationshipSystem;
        window.RelationshipSystemUI = RelationshipSystemUI;
    </script>

    <script type="module">
        // Import Firebase using the correct v9+ modular syntax
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCWtVYdOiggwqw5CNMJbM13BdeLtwqBhbs",
            authDomain: "family-tree-6f16b.firebaseapp.com",
            projectId: "family-tree-6f16b",
            storageBucket: "family-tree-6f16b.firebasestorage.app",
            messagingSenderId: "801170939057",
            appId: "1:801170939057:web:87d35d8156789631f69690"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Initialize the new relationship system
        let relationshipSystem = null;
        let relationshipUI = null;
        let useNewSystem = false; // Flag to switch between old and new system

        // Global variables
        let currentUser = null;
        let familyMembers = [];
        let familyBranches = [];
        let familyUnits = [];  // New: Family Units that group branches together
        let users = [];
        let messages = [];
        let accountRequests = [];
        let deniedAccounts = [];

        // Initialize the app
        async function init() {
            // Check if user is logged in
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                // Temporary test user for debugging
                const testUser = {
                    username: 'testuser',
                    isAdmin: true
                };
                localStorage.setItem('currentUser', JSON.stringify(testUser));
                currentUser = testUser;
            } else {
                currentUser = JSON.parse(userData);
            }
            
            document.getElementById('username').textContent = currentUser.username;
            
            if (currentUser.isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                
                // Start real-time monitoring for account requests
                startRequestMonitoring();
            }

            // Initialize the new relationship system
            initializeRelationshipSystem();

            await loadData();
            setupEventListeners();
        }

        // Real-time monitoring for new account requests
        function startRequestMonitoring() {
            if (!currentUser.isAdmin) return;
            
            // Check for new requests every 5 seconds
            setInterval(async () => {
                const oldCount = accountRequests.filter(req => req.status === 'pending').length;
                await loadAccountRequests();
                const newCount = accountRequests.filter(req => req.status === 'pending').length;
                
                // If new requests appeared, refresh the display
                if (newCount > oldCount) {
                    displayAccountRequests();
                }
            }, 5000);
        }

        // Initialize the new relationship system
        function initializeRelationshipSystem() {
            try {
                // Create the relationship system with Firebase modules
                relationshipSystem = new FamilyRelationshipSystem(db, {
                    collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc
                });
                
                // Create the UI system
                relationshipUI = new RelationshipSystemUI(relationshipSystem);
                relationshipUI.setCurrentUser(currentUser);
                
                // Make them globally accessible
                window.relationshipSystem = relationshipSystem;
                window.relationshipUI = relationshipUI;
                
                console.log('New relationship system initialized successfully');
                
                // Check if user wants to use the new system
                const useNewSystemPref = localStorage.getItem('useNewRelationshipSystem');
                if (useNewSystemPref === 'true') {
                    useNewSystem = true;
                    console.log('Using new relationship system');
                }
                
            } catch (error) {
                console.error('Failed to initialize relationship system:', error);
            }
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadFamilyMembers(),
                loadFamilyBranches(),
                loadFamilyUnits(),  // New: Load family units
                loadUsers(),
                loadMessages(),
                loadAccountRequests(),
                loadDeniedAccounts()
            ]);
            
            displayFamilyMembers();
            displayBranches();
            displayUsers();
            displayMessages();
            displayAccountRequests();
            displayUpcomingBirthdays();
            populateDropdowns();
        }

        // Load family members
        async function loadFamilyMembers() {
            try {
                console.log('Loading family members...');
                const querySnapshot = await getDocs(collection(db, 'family_members'));
                familyMembers = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`Loaded ${familyMembers.length} family members:`, familyMembers);
            } catch (error) {
                console.error('Error loading family members:', error);
            }
        }

        // Load family branches
        async function loadFamilyBranches() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_branches'));
                familyBranches = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family branches:', error);
            }
        }

        // Load family units
        async function loadFamilyUnits() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_units'));
                familyUnits = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family units:', error);
            }
        }

        // Load users (admin only)
        async function loadUsers() {
            if (!currentUser.isAdmin) return;
            
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                users = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(20));
                const querySnapshot = await getDocs(q);
                messages = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Load account requests
        async function loadAccountRequests() {
            try {
                const q = query(collection(db, 'account_requests'), orderBy('requestDate', 'desc'));
                const querySnapshot = await getDocs(q);
                accountRequests = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateRequestsBadge();
            } catch (error) {
                console.error('Error loading account requests:', error);
            }
        }

        // Load denied accounts
        async function loadDeniedAccounts() {
            try {
                const q = query(collection(db, 'denied_accounts'));
                const querySnapshot = await getDocs(q);
                deniedAccounts = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading denied accounts:', error);
            }
        }

        // Display family members with proper relationships
        function displayFamilyMembers() {
            const grid = document.getElementById('familyGrid');
            if (!grid) {
                console.error('familyGrid element not found');
                return;
            }
            
            // Get filter values with null checks
            const searchInput = document.getElementById('searchInput');
            const monthFilterEl = document.getElementById('monthFilter');
            const branchFilterEl = document.getElementById('branchFilter');
            const sortOrderEl = document.getElementById('sortOrder');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const monthFilter = monthFilterEl ? monthFilterEl.value : '';
            const branchFilter = branchFilterEl ? branchFilterEl.value : '';
            const sortOrder = sortOrderEl ? sortOrderEl.value : 'name';

            let filtered = familyMembers.filter(member => {
                const matchesSearch = !searchTerm || 
                    (member.firstName && member.firstName.toLowerCase().includes(searchTerm)) ||
                    (member.lastName && member.lastName.toLowerCase().includes(searchTerm));
                const matchesMonth = !monthFilter || member.birthMonth === monthFilter;
                const matchesBranch = !branchFilter || member.familyBranch === branchFilter;
                
                return matchesSearch && matchesMonth && matchesBranch;
            });

            // Sort based on selected order
            filtered.sort((a, b) => {
                if (sortOrder === 'age-oldest') {
                    return getAge(b) - getAge(a);
                } else if (sortOrder === 'age-youngest') {
                    return getAge(a) - getAge(b);
                } else if (sortOrder === 'birthday') {
                    return getNextBirthday(a) - getNextBirthday(b);
                } else {
                    return `${a.firstName || ''} ${a.lastName || ''}`.localeCompare(`${b.firstName || ''} ${b.lastName || ''}`);
                }
            });

            grid.innerHTML = filtered.map(member => {
                const age = getAge(member);
                const nextBirthday = getNextBirthday(member);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                <div class="family-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: #667eea; margin-bottom: 0.5rem;">${member.firstName || ''} ${member.lastName || ''}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Age: ${age} | Birthday: ${member.birthMonth || 'N/A'} ${member.birthDay || 'N/A'}, ${member.birthYear || 'N/A'}</p>
                        </div>
                        ${daysUntilBirthday <= 30 ? `
                            <span style="background: #e74c3c20; color: #e74c3c; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                üéÇ ${daysUntilBirthday} days
                            </span>
                        ` : ''}
                    </div>



                    <!-- Basic Info -->
                    <div class="family-info" style="margin-bottom: 1rem;">
                        <div><strong>Family Group:</strong> ${member.familyBranch || 'No group assigned'}</div>
                        ${member.marriedTo ? `<div><strong>üíç Married To:</strong> ${getSpouseName(member.marriedTo)}</div>` : ''}
                        ${member.parents && member.parents.length > 0 ? `<div><strong>üë´ Parents:</strong> ${getParentsNames(member.parents)}</div>` : ''}
                        ${member.children && member.children.length > 0 ? `<div><strong>üë∂ Children:</strong> ${getChildrenNames(member.children)}</div>` : ''}
                        <div><strong>Mobile:</strong> ${member.mobilePhone || 'Not provided'}</div>
                        <div><strong>Email:</strong> ${member.email || 'Not provided'}</div>
                        <div><strong>Address:</strong> ${member.address ? `${member.address}, ${member.city || ''} ${member.state || ''}` : 'Not provided'}</div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="flex: 1;">‚úèÔ∏è Edit</button>
                        <button class="btn" onclick="viewFamilyTree('${member.id}')" style="background: #28a745; color: white; flex: 1;">üå≥ Family Tree</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="flex: 1;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Helper function to get spouse name
        function getSpouseName(spouseId) {
            const spouse = familyMembers.find(m => m.id === spouseId);
            return spouse ? `${spouse.firstName} ${spouse.lastName}` : 'Unknown';
        }

        // Helper function to get children names
        function getChildrenNames(childrenIds) {
            if (!childrenIds || childrenIds.length === 0) return 'None';
            
            const childNames = childrenIds.map(childId => {
                const child = familyMembers.find(m => m.id === childId);
                return child ? `${child.firstName} ${child.lastName}` : 'Unknown';
            }).filter(name => name !== 'Unknown');
            
            if (childNames.length === 0) return 'None';
            if (childNames.length <= 3) return childNames.join(', ');
            return `${childNames.slice(0, 3).join(', ')} and ${childNames.length - 3} more`;
        }

        // Helper function to get parents names
        function getParentsNames(parentsIds) {
            if (!parentsIds || parentsIds.length === 0) return 'None';
            
            const parentNames = parentsIds.map(parentId => {
                const parent = familyMembers.find(m => m.id === parentId);
                return parent ? `${parent.firstName} ${parent.lastName}` : 'Unknown';
            }).filter(name => name !== 'Unknown');
            
            if (parentNames.length === 0) return 'None';
            return parentNames.join(', ');
        }

        // Update bidirectional relationships and sync with spouse
        async function updateBidirectionalRelationships(memberId, parentIds, childrenIds) {
            try {
                const member = familyMembers.find(m => m.id === memberId);
                if (!member) return;

                // Update parents: add this member as their child
                for (const parentId of parentIds) {
                    const parent = familyMembers.find(m => m.id === parentId);
                    if (parent) {
                        const updatedChildren = [...(parent.children || [])];
                        if (!updatedChildren.includes(memberId)) {
                            updatedChildren.push(memberId);
                            await updateDoc(doc(db, 'family_members', parentId), {
                                children: updatedChildren
                            });
                        }

                        // If parent has a spouse, sync the children with them too
                        if (parent.marriedTo) {
                            await syncChildrenWithSpouse(parentId, parent.marriedTo, updatedChildren);
                        }
                    }
                }
                
                // Update children: add this member as their parent
                for (const childId of childrenIds) {
                    const child = familyMembers.find(m => m.id === childId);
                    if (child) {
                        const updatedParents = [...(child.parents || [])];
                        if (!updatedParents.includes(memberId)) {
                            updatedParents.push(memberId);
                            await updateDoc(doc(db, 'family_members', childId), {
                                parents: updatedParents
                            });
                        }
                    }
                }

                // If this member has a spouse, sync children with them
                if (member.marriedTo && childrenIds.length > 0) {
                    await syncChildrenWithSpouse(memberId, member.marriedTo, childrenIds);
                }

            } catch (error) {
                console.error('Error updating bidirectional relationships:', error);
            }
        }

        // Sync children between married spouses
        async function syncChildrenWithSpouse(parentId, spouseId, parentChildren) {
            try {
                const spouse = familyMembers.find(m => m.id === spouseId);
                if (!spouse) return;

                const spouseChildren = spouse.children || [];
                const combinedChildren = [...new Set([...spouseChildren, ...parentChildren])];

                // Only update if there's a difference
                if (spouseChildren.length !== combinedChildren.length || !spouseChildren.every(id => combinedChildren.includes(id))) {
                    await updateDoc(doc(db, 'family_members', spouseId), {
                        children: combinedChildren
                    });
                    console.log(`Synced children with spouse ${spouse.firstName}: added ${combinedChildren.length - spouseChildren.length} children`);

                    // Update the newly added children to have both parents
                    const newChildren = combinedChildren.filter(childId => !spouseChildren.includes(childId));
                    for (const childId of newChildren) {
                        const child = familyMembers.find(m => m.id === childId);
                        if (child) {
                            const childParents = child.parents || [];
                            if (!childParents.includes(spouseId)) {
                                const updatedParents = [...childParents, spouseId];
                                await updateDoc(doc(db, 'family_members', childId), {
                                    parents: updatedParents
                                });
                                console.log(`Added spouse ${spouse.firstName} as parent to child ${child.firstName}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error syncing children with spouse:', error);
            }
        }

        // Update bidirectional marriage relationships and synchronize children
        async function updateBidirectionalMarriage(memberId, oldSpouseId, newSpouseId) {
            try {
                const member = familyMembers.find(m => m.id === memberId);
                if (!member) return;

                // If there was an old spouse, remove the marriage connection and handle children
                if (oldSpouseId && oldSpouseId !== newSpouseId) {
                    const oldSpouse = familyMembers.find(m => m.id === oldSpouseId);
                    if (oldSpouse) {
                        await updateDoc(doc(db, 'family_members', oldSpouseId), { marriedTo: null });
                        console.log(`Removed marriage connection for old spouse: ${oldSpouse.firstName} ${oldSpouse.lastName}`);
                        
                        // Note: We don't automatically remove children from divorced spouses as they may still be co-parents
                    }
                }

                // If there's a new spouse, set up the bidirectional marriage and sync children
                if (newSpouseId && newSpouseId !== oldSpouseId) {
                    const newSpouse = familyMembers.find(m => m.id === newSpouseId);
                    if (newSpouse) {
                        // Check if the new spouse was married to someone else
                        if (newSpouse.marriedTo && newSpouse.marriedTo !== memberId) {
                            const formerSpouse = familyMembers.find(m => m.id === newSpouse.marriedTo);
                            if (formerSpouse) {
                                await updateDoc(doc(db, 'family_members', newSpouse.marriedTo), { marriedTo: null });
                                console.log(`Removed marriage connection for former spouse: ${formerSpouse.firstName} ${formerSpouse.lastName}`);
                            }
                        }

                        // Set the new spouse's marriedTo field
                        await updateDoc(doc(db, 'family_members', newSpouseId), { marriedTo: memberId });
                        console.log(`Set bidirectional marriage between ${memberId} and ${newSpouseId}`);
                        
                        // Synchronize children between the married couple
                        await synchronizeMarriedCoupleChildren(memberId, newSpouseId);
                    }
                }
            } catch (error) {
                console.error('Error updating bidirectional marriage:', error);
            }
        }

        // Synchronize children between married couples
        async function synchronizeMarriedCoupleChildren(spouse1Id, spouse2Id) {
            try {
                const spouse1 = familyMembers.find(m => m.id === spouse1Id);
                const spouse2 = familyMembers.find(m => m.id === spouse2Id);
                
                if (!spouse1 || !spouse2) return;

                // Get all children from both spouses
                const spouse1Children = spouse1.children || [];
                const spouse2Children = spouse2.children || [];
                
                // Combine and deduplicate children
                const allChildrenIds = [...new Set([...spouse1Children, ...spouse2Children])];
                
                console.log(`Synchronizing children for married couple: ${spouse1.firstName} & ${spouse2.firstName}`);
                console.log(`Combined children:`, allChildrenIds);

                // Update both spouses to have all children
                if (spouse1Children.length !== allChildrenIds.length || !spouse1Children.every(id => allChildrenIds.includes(id))) {
                    await updateDoc(doc(db, 'family_members', spouse1Id), { children: allChildrenIds });
                    console.log(`Updated ${spouse1.firstName}'s children to:`, allChildrenIds);
                }

                if (spouse2Children.length !== allChildrenIds.length || !spouse2Children.every(id => allChildrenIds.includes(id))) {
                    await updateDoc(doc(db, 'family_members', spouse2Id), { children: allChildrenIds });
                    console.log(`Updated ${spouse2.firstName}'s children to:`, allChildrenIds);
                }

                // Update each child to have both parents
                for (const childId of allChildrenIds) {
                    const child = familyMembers.find(m => m.id === childId);
                    if (child) {
                        const currentParents = child.parents || [];
                        const newParents = [...new Set([...currentParents, spouse1Id, spouse2Id])];
                        
                        if (currentParents.length !== newParents.length || !currentParents.every(id => newParents.includes(id))) {
                            await updateDoc(doc(db, 'family_members', childId), { parents: newParents });
                            console.log(`Updated ${child.firstName}'s parents to include both spouses`);
                        }
                    }
                }

                console.log(`Successfully synchronized children for married couple`);
            } catch (error) {
                console.error('Error synchronizing children for married couple:', error);
            }
        }
        }

        // Auto-generate family trees based on relationships
        function generateFamilyTrees() {
            const familyTrees = [];
            const processedMembers = new Set();

            // Find nuclear families (couples with children)
            const nuclearFamilies = findNuclearFamilies();
            
            // Create family trees for each nuclear family
            nuclearFamilies.forEach(family => {
                if (family.parents.some(p => processedMembers.has(p.id))) return;
                
                const familyTree = createFamilyTree(family, processedMembers);
                if (familyTree) {
                    familyTrees.push(familyTree);
                }
            });

            // Handle single parents and childless couples
            const remainingRoots = findRemainingRoots(processedMembers);
            remainingRoots.forEach(root => {
                const familyTree = createSingleParentTree(root, processedMembers);
                if (familyTree) {
                    familyTrees.push(familyTree);
                }
            });

            return familyTrees;
        }

        function findNuclearFamilies() {
            const families = [];
            const processedParentPairs = new Set();

            familyMembers.forEach(member => {
                if (member.children && member.children.length > 0) {
                    // Check if this person has a spouse who is also a parent to the same children
                    const spouse = member.marriedTo ? familyMembers.find(m => m.id === member.marriedTo) : null;
                    
                    if (spouse && spouse.children) {
                        // Check for shared children
                        const sharedChildren = member.children.filter(childId => 
                            spouse.children.includes(childId)
                        );
                        
                        if (sharedChildren.length > 0) {
                            const pairKey = [member.id, spouse.id].sort().join('-');
                            if (!processedParentPairs.has(pairKey)) {
                                processedParentPairs.add(pairKey);
                                families.push({
                                    parents: [member, spouse],
                                    children: sharedChildren.map(id => familyMembers.find(m => m.id === id)).filter(Boolean),
                                    name: `${member.firstName} & ${spouse.firstName} ${member.lastName} Family`
                                });
                            }
                        }
                    } else {
                        // Single parent family
                        families.push({
                            parents: [member],
                            children: member.children.map(id => familyMembers.find(m => m.id === id)).filter(Boolean),
                            name: `${member.firstName} ${member.lastName} Family`
                        });
                    }
                }
            });

            return families;
        }

        function createFamilyTree(family, processedMembers) {
            // Mark parents and children as processed
            family.parents.forEach(p => processedMembers.add(p.id));
            family.children.forEach(c => processedMembers.add(c.id));

            const familyTree = {
                id: `family_${family.parents[0].id}`,
                name: family.name,
                generations: [
                    {
                        level: 0,
                        members: family.parents,
                        type: 'parents'
                    },
                    {
                        level: 1,
                        members: family.children,
                        type: 'children'
                    }
                ]
            };

            // Add grandchildren if any
            const grandchildren = [];
            family.children.forEach(child => {
                if (child.children && child.children.length > 0) {
                    child.children.forEach(grandchildId => {
                        const grandchild = familyMembers.find(m => m.id === grandchildId);
                        if (grandchild && !processedMembers.has(grandchild.id)) {
                            grandchildren.push(grandchild);
                            processedMembers.add(grandchild.id);
                        }
                    });
                }
            });

            if (grandchildren.length > 0) {
                familyTree.generations.push({
                    level: 2,
                    members: grandchildren,
                    type: 'grandchildren'
                });
            }

            return familyTree;
        }

        function findRemainingRoots(processedMembers) {
            return familyMembers.filter(member => {
                if (processedMembers.has(member.id)) return false;
                // Find people with no parents or whose parents aren't in the system
                return !member.parents || member.parents.length === 0 || 
                       !member.parents.some(parentId => familyMembers.find(m => m.id === parentId));
            });
        }

        function createSingleParentTree(rootMember, processedMembers) {
            if (processedMembers.has(rootMember.id)) return null;

            const familyTree = {
                id: `family_${rootMember.id}`,
                name: `${rootMember.firstName} ${rootMember.lastName} Family`,
                generations: []
            };

            // Add root generation
            const rootGeneration = [rootMember];
            if (rootMember.marriedTo) {
                const spouse = familyMembers.find(m => m.id === rootMember.marriedTo);
                if (spouse && !processedMembers.has(spouse.id)) {
                    rootGeneration.push(spouse);
                    processedMembers.add(spouse.id);
                }
            }

            familyTree.generations.push({
                level: 0,
                members: rootGeneration,
                type: 'parents'
            });

            processedMembers.add(rootMember.id);

            // Add children if any
            if (rootMember.children && rootMember.children.length > 0) {
                const children = rootMember.children
                    .map(id => familyMembers.find(m => m.id === id))
                    .filter(child => child && !processedMembers.has(child.id));

                if (children.length > 0) {
                    children.forEach(child => processedMembers.add(child.id));
                    familyTree.generations.push({
                        level: 1,
                        members: children,
                        type: 'children'
                    });
                }
            }

            return familyTree.generations.length > 1 ? familyTree : null;
        }

        // Display branches with auto-generated family trees
        function displayBranches() {
            const branchesSection = document.getElementById('branchesGrid');
            if (!branchesSection) return;

            // Auto-generate family trees from relationships
            const familyTrees = generateFamilyTrees();

            if (familyTrees.length === 0) {
                branchesSection.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <h3>üå≥ No Family Trees Yet</h3>
                        <p>Family trees will automatically appear here when you add parent-child relationships in the Family Members section.</p>
                        <p>Start by editing family members and selecting their parents and children!</p>
                    </div>
                `;
                return;
            }

            branchesSection.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: #667eea; margin-bottom: 1rem; text-align: center;">üå≥ Family Trees</h2>
                </div>
                <div id="autoFamilyTrees" style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: flex-start;">
                    ${familyTrees.map(tree => renderFamilyTree(tree)).join('')}
                </div>
            `;
        }

        function renderFamilyTree(familyTree) {
            return `
                <div style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex: 1; min-width: 400px; max-width: 500px;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; text-align: center;">${familyTree.name}</h3>
                    
                    <div class="family-tree-container" style="overflow-x: auto; padding: 1rem;">
                        ${familyTree.generations.map((generation, index) => `
                            <div class="generation-${generation.type}" style="margin-bottom: 2rem;">
                                <h4 style="text-align: center; color: #666; margin-bottom: 1rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                                    ${getGenerationLabel(generation.type, index)}
                                </h4>
                                
                                <!-- Connection Lines -->
                                ${index > 0 ? `
                                    <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                                        <div style="width: 2px; height: 2rem; background: #ddd;"></div>
                                    </div>
                                ` : ''}
                                
                                <div class="generation-members" style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                                    ${generation.members.sort((a, b) => getAge(b) - getAge(a)).map(member => renderFamilyMember(member, generation.type)).join('')}
                                </div>
                                
                                ${index < familyTree.generations.length - 1 ? `
                                    <div style="display: flex; justify-content: center; margin-top: 1rem;">
                                        <div style="width: 2px; height: 2rem; background: #ddd;"></div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getGenerationLabel(type, index) {
            const labels = {
                'parents': index === 0 ? 'Parents' : 'Ancestors',
                'children': 'Children',
                'grandchildren': 'Grandchildren'
            };
            return labels[type] || `Generation ${index + 1}`;
        }

        function renderFamilyMember(member, generationType) {
            const isMarried = member.marriedTo;
            const hasChildren = member.children && member.children.length > 0;
            const marriageIcon = isMarried ? 'üíç' : '';
            
            return `
                <div class="family-member-node" style="text-align: center; position: relative; margin: 0 1rem;">
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 1rem;
                        border-radius: 50%;
                        width: 100px;
                        height: 100px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 0.5rem;
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        cursor: pointer;
                        position: relative;
                    " onclick="openEditMemberModal('${member.id}')">
                        <div style="text-align: center; font-size: 0.8rem; line-height: 1.2;">
                            <div style="font-weight: bold;">${member.firstName}</div>
                            <div>${member.lastName}</div>
                        </div>
                        ${marriageIcon ? `
                            <div style="position: absolute; top: -5px; right: -5px; background: #e74c3c; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                ${marriageIcon}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="font-size: 0.9rem; color: #333; font-weight: 600; margin-bottom: 0.25rem;">
                        ${member.firstName} ${member.lastName}
                    </div>
                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.5rem;">
                        Age: ${getAge(member)}
                    </div>
                    
                    ${hasChildren ? `
                        <div style="font-size: 0.7rem; color: #28a745; font-weight: 500;">
                            üë∂ ${member.children.length} child${member.children.length === 1 ? '' : 'ren'}
                        </div>
                    ` : ''}
                </div>
            `;
        }



        // Helper functions for branch display
        function getBranchColor(generationLevel) {
            const colors = {
                1: '#8e24aa', // Purple for grandparents
                2: '#1976d2', // Blue for parents  
                3: '#388e3c', // Green for children
                4: '#f57c00'  // Orange for grandchildren
            };
            return colors[generationLevel] || '#666';
        }

        function getGenerationIcon(generationLevel) {
            const icons = {
                1: 'üë¥üëµ', // Grandparents
                2: 'üë®üë©', // Parents  
                3: 'üë¶üëß', // Children
                4: 'üë∂'   // Grandchildren
            };
            return icons[generationLevel] || 'üë•';
        }

        function getBranchTypeIcon(branchType) {
            const icons = {
                'nuclear_family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                'extended_family': 'üèòÔ∏è',
                'cousin_branch': 'üë´',
                'grandparent_branch': 'üë¥üëµ'
            };
            return icons[branchType] || 'üë•';
        }

        function formatBranchType(branchType) {
            const types = {
                'nuclear_family': 'Nuclear Family',
                'extended_family': 'Extended Family', 
                'cousin_branch': 'Cousin Branch',
                'grandparent_branch': 'Grandparent Branch'
            };
            return types[branchType] || 'Family Branch';
        }

        // Helper function to get potential parents (older than the member)
        function getPotentialParents(currentMember) {
            const currentAge = getAge(currentMember);
            return familyMembers
                .filter(fm => {
                    if (fm.id === currentMember.id) return false;
                    const parentAge = getAge(fm);
                    // Parents should be at least 15 years older (reasonable minimum)
                    return parentAge >= currentAge + 15;
                })
                .sort((a, b) => getAge(b) - getAge(a)); // Oldest first
        }

        // Helper function to get potential children (younger than the member)
        function getPotentialChildren(currentMember) {
            const currentAge = getAge(currentMember);
            return familyMembers
                .filter(fm => {
                    if (fm.id === currentMember.id) return false;
                    const childAge = getAge(fm);
                    // Children should be at least 15 years younger (reasonable minimum)
                    return childAge <= currentAge - 15;
                })
                .sort((a, b) => getAge(a) - getAge(b)); // Youngest first
        }

        // Helper functions for age and birthday calculations
        function getAge(member) {
            if (!member.birthYear || !member.birthMonth || !member.birthDay) return 0;
            
            const today = new Date();
            const birthDate = new Date(member.birthYear, getMonthIndex(member.birthMonth), member.birthDay);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function getNextBirthday(member) {
            if (!member.birthMonth || !member.birthDay) return new Date(9999, 11, 31); // Return far future date for invalid data
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const monthIndex = getMonthIndex(member.birthMonth);
            
            // Create birthday for this year
            let nextBirthday = new Date(currentYear, monthIndex, member.birthDay);
            
            // If the birthday this year has already passed, move to next year
            if (nextBirthday <= today) {
                nextBirthday = new Date(currentYear + 1, monthIndex, member.birthDay);
            }
            
            return nextBirthday;
        }

        function getMonthIndex(monthName) {
            const months = {
                'January': 0, 'February': 1, 'March': 2, 'April': 3,
                'May': 4, 'June': 5, 'July': 6, 'August': 7,
                'September': 8, 'October': 9, 'November': 10, 'December': 11
            };
            return months[monthName] || 0;
        }

        // Display users (admin only)
        function displayUsers() {
            if (!currentUser.isAdmin) return;
            
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = users.map(user => `
                <div class="family-card">
                    <h3>${user.fullName || user.username}</h3>
                    <div class="family-info">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Email:</strong> ${user.email || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${user.phone || 'N/A'}</div>
                        <div><strong>Admin:</strong> ${user.isAdmin ? 'Yes' : 'No'}</div>
                        <div><strong>Created:</strong> ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Display account requests (admin only)
        function displayAccountRequests() {
            if (!currentUser.isAdmin) return;
            
            const grid = document.getElementById('requestsGrid');
            const stats = document.getElementById('requestsStats');
            
            const pendingRequests = accountRequests.filter(req => req.status === 'pending');
            
            stats.innerHTML = `
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 10px; border-left: 4px solid #2196f3;">
                    <strong>üìä Statistics:</strong> 
                    ${pendingRequests.length} pending requests | 
                    ${accountRequests.filter(req => req.status === 'approved').length} approved | 
                    ${deniedAccounts.length} denied
                </div>
            `;
            
            if (pendingRequests.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><h3>No pending requests</h3><p>All account requests have been processed.</p></div>';
                return;
            }
            
            grid.innerHTML = pendingRequests.map(request => `
                <div class="family-card" style="border-left: 4px solid #ff9800;">
                    <h3>üîî ${request.firstName} ${request.lastName}</h3>
                    <div class="family-info">
                        <div><strong>Username:</strong> ${request.username}</div>
                        <div><strong>Name:</strong> ${request.firstName} ${request.lastName}</div>
                        <div><strong>Requested:</strong> ${new Date(request.requestDate).toLocaleDateString()}</div>
                        <div><strong>Status:</strong> <span style="color: #ff9800; font-weight: bold;">Pending</span></div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="approveRequest('${request.id}', '${request.username}', '${request.password}', '${request.firstName}', '${request.lastName}')">‚úÖ Approve</button>
                        <button class="btn btn-danger" onclick="denyRequest('${request.id}', '${request.username}')">‚ùå Deny</button>
                    </div>
                </div>
            `).join('');
        }

        // Update requests badge
        function updateRequestsBadge() {
            if (!currentUser.isAdmin) return;
            
            const badge = document.getElementById('requestsBadge');
            const pendingCount = accountRequests.filter(req => req.status === 'pending').length;
            
            if (pendingCount > 0) {
                badge.textContent = pendingCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Display messages
        function displayMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map(message => `
                <div class="message">
                    <div class="message-header">
                        <span class="message-author">${message.author}</span>
                        <span class="message-date">${new Date(message.createdAt.seconds * 1000).toLocaleDateString()}</span>
                    </div>
                    ${message.title ? `<h4>${message.title}</h4>` : ''}
                    <p>${message.content}</p>
                    ${currentUser.isAdmin ? `<button class="btn btn-danger" onclick="deleteMessage('${message.id}')">Delete</button>` : ''}
                </div>
            `).join('');
        }

        // Display upcoming birthdays
        function displayUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdays');
            
            if (!container) {
                console.warn('Upcoming birthdays container not found');
                return;
            }
            
            if (!familyMembers || familyMembers.length === 0) {
                console.log('No family members found');
                container.innerHTML = '<div class="birthday-item"><span>No family members added yet</span><span>Add some family members to see birthdays</span></div>';
                return;
            }
            
            const today = new Date();
            
            // Filter members with valid birth data and calculate upcoming birthdays
            const validMembers = familyMembers.filter(member => {
                // Check if member has valid birth data
                return member.birthMonth && member.birthDay && member.birthMonth.trim() !== '' && member.birthDay > 0;
            });
            
            const upcoming = validMembers.map(member => {
                const nextBirthday = getNextBirthday(member);
                const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                
                return {
                    ...member,
                    nextBirthday: nextBirthday,
                    daysUntil: daysUntil
                };
            })
            .filter(member => member.daysUntil >= 0 && member.daysUntil < 9999) // Filter out any invalid dates
            .sort((a, b) => a.nextBirthday - b.nextBirthday) // Sort by next birthday date
            .slice(0, 5); // Show only the next 5 birthdays

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="birthday-item"><span>No upcoming birthdays</span><span>Add birth dates to family members</span></div>';
                return;
            }

            container.innerHTML = upcoming.map(member => {
                // Format the birthday display
                const dayLabel = member.daysUntil === 0 ? 'Today!' : 
                                member.daysUntil === 1 ? 'Tomorrow' : 
                                `${member.daysUntil} day${member.daysUntil === 1 ? '' : 's'}`;
                
                return `
                    <div class="birthday-item">
                        <span>${member.firstName} ${member.lastName}</span>
                        <span>${member.birthMonth} ${member.birthDay} (${dayLabel})</span>
                    </div>
                `;
            }).join('');
        }

        // Simple family tree view function
        function viewFamilyTree(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            // Find all related family members
            const parents = familyMembers.filter(m => 
                m.id !== memberId && isParentRelationship(m, member)
            );
            
            const children = familyMembers.filter(m => 
                m.id !== memberId && isChildRelationship(member, m)
            );

            // Find siblings (same parents)
            const siblings = familyMembers.filter(m => 
                m.id !== memberId && 
                parents.some(parent => isParentRelationship(parent, m))
            );

            const modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; text-align: center;">üå≥ Family Tree - ${member.firstName} ${member.lastName}</h3>
                    
                    <!-- Parents Section -->
                    ${parents.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;">üë´ Parents</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${parents.map(p => `
                                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 2px solid #e9ecef;">
                                        <strong>${p.firstName} ${p.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(p)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Focus Person -->
                    <div style="margin: 2rem 0; text-align: center;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; display: inline-block;">
                            <h4 style="margin: 0; color: white;">${member.firstName} ${member.lastName}</h4>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Age: ${getAge(member)} | ${member.familyBranch || 'No group'}</div>
                        </div>
                    </div>

                    <!-- Siblings Section -->
                    ${siblings.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;">üë• Siblings</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${siblings.map(s => `
                                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 2px solid #ffeaa7;">
                                        <strong>${s.firstName} ${s.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(s)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Children Section -->
                    ${children.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;">üë∂ Children</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${children.map(c => `
                                    <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; border: 2px solid #bee5eb;">
                                        <strong>${c.firstName} ${c.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(c)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${parents.length === 0 && siblings.length === 0 && children.length === 0 ? `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No family relationships have been established yet.</p>
                            <p>Family relationships are managed through the Family Groups system.</p>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="closeModal('generalModal')" style="flex: 1; padding: 0.75rem; background: #667eea; color: white; border: none; border-radius: 6px;">Close</button>
                    </div>
                </div>
            `;

            showModal(modalContent);
        }

        // Populate dropdowns
        function populateDropdowns() {
            // Family branch dropdown
            const branchSelects = [
                document.getElementById('familyBranch'),
                document.getElementById('editFamilyBranch'),
                document.getElementById('branchFilter')
            ];
            
            branchSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Branch</option>';
                    
                    // Sort branches by generation for better organization
                    const sortedBranches = [...familyBranches].sort((a, b) => {
                        const genA = a.generationLevel || 999;
                        const genB = b.generationLevel || 999;
                        if (genA !== genB) return genA - genB;
                        return a.name.localeCompare(b.name);
                    });
                    
                    sortedBranches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.name;
                        option.textContent = `${branch.name} (Gen ${branch.generationLevel || '?'})`;
                        select.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });

            // Married to dropdown
            const marriedToSelects = [
                document.getElementById('marriedTo'),
                document.getElementById('editMarriedTo')
            ];
            
            marriedToSelects.forEach(marriedSelect => {
                if (marriedSelect) {
                    const currentValue = marriedSelect.value;
                    marriedSelect.innerHTML = '<option value="">Select someone</option>';
                    
                    // Sort family members by last name, then first name
                    const sortedMembers = [...familyMembers].sort((a, b) => {
                        const lastNameComp = a.lastName.localeCompare(b.lastName);
                        if (lastNameComp !== 0) return lastNameComp;
                        return a.firstName.localeCompare(b.firstName);
                    });
                    
                    sortedMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.firstName} ${member.lastName}`;
                        marriedSelect.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && [...marriedSelect.options].some(opt => opt.value === currentValue)) {
                        marriedSelect.value = currentValue;
                    }
                }
            });

            // Populate children checkboxes for add form (no filtering since no current member yet)
            const addChildrenContainer = document.getElementById('addChildrenSelection');
            if (addChildrenContainer) {
                const sortedChildrenCandidates = [...familyMembers].sort((a, b) => getAge(a) - getAge(b));
                addChildrenContainer.innerHTML = sortedChildrenCandidates.map(member => `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                        <input type="checkbox" name="children" value="${member.id}" 
                               onchange="updateAddChildrenCount()" style="margin-right: 0.5rem;">
                        <span>${member.firstName} ${member.lastName} (Age: ${getAge(member)})</span>
                    </div>
                `).join('');
                updateAddChildrenCount();
            }

            // Populate parents checkboxes for add form (no filtering since no current member yet)
            const addParentsContainer = document.getElementById('addParentsSelection');
            if (addParentsContainer) {
                const sortedParentCandidates = [...familyMembers].sort((a, b) => getAge(b) - getAge(a));
                addParentsContainer.innerHTML = sortedParentCandidates.map(member => `
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">
                        <input type="checkbox" name="parents" value="${member.id}" 
                               onchange="updateAddParentsCount()" style="margin-right: 0.5rem;">
                        <span>${member.firstName} ${member.lastName} (Age: ${getAge(member)})</span>
                    </div>
                `).join('');
                updateAddParentsCount();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Search and filter
            const searchInput = document.getElementById('searchInput');
            const monthFilter = document.getElementById('monthFilter');
            const branchFilter = document.getElementById('branchFilter');
            const sortOrder = document.getElementById('sortOrder');
            
            if (searchInput) {
                searchInput.addEventListener('input', displayFamilyMembers);
                console.log('Search input listener added');
            } else {
                console.warn('searchInput element not found');
            }
            
            if (monthFilter) {
                monthFilter.addEventListener('change', displayFamilyMembers);
                console.log('Month filter listener added');
            } else {
                console.warn('monthFilter element not found');
            }
            
            if (branchFilter) {
                branchFilter.addEventListener('change', displayFamilyMembers);
                console.log('Branch filter listener added');
            } else {
                console.warn('branchFilter element not found');
            }
            
            if (sortOrder) {
                sortOrder.addEventListener('change', displayFamilyMembers);
                console.log('Sort order listener added');
            } else {
                console.warn('sortOrder element not found');
            }

            // Add member form
            const addMemberForm = document.getElementById('addMemberForm');
            if (addMemberForm) {
                addMemberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addFamilyMember();
                });
                console.log('Add member form listener added');
            } else {
                console.warn('addMemberForm not found');
            }

            // Add branch form
            const addBranchForm = document.getElementById('addBranchForm');
            if (addBranchForm) {
                addBranchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addFamilyBranch();
                });
                console.log('Add branch form listener added');
            } else {
                console.warn('addBranchForm not found');
            }

            // Create family unit form
            const createFamilyUnitForm = document.getElementById('createFamilyUnitForm');
            if (createFamilyUnitForm) {
                createFamilyUnitForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createFamilyUnit();
                });
                console.log('Create family unit form listener added');
            } else {
                console.warn('createFamilyUnitForm not found');
            }

            // Add user form
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addUser();
                });
                console.log('Add user form listener added');
            } else {
                console.warn('addUserForm not found');
            }

            // Add message form
            const addMessageForm = document.getElementById('addMessageForm');
            if (addMessageForm) {
                addMessageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addMessage();
                });
                console.log('Add message form listener added');
            } else {
                console.warn('addMessageForm not found');
            }

            // Edit member form
            const editMemberForm = document.getElementById('editMemberForm');
            if (editMemberForm) {
                editMemberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateFamilyMember();
                });
                console.log('Edit member form listener added');
            } else {
                console.warn('editMemberForm not found');
            }
            
            console.log('Event listeners setup complete');
        }

        // Add family member
        async function addFamilyMember() {
            try {
                // Get selected children
                const selectedChildren = [];
                const childrenCheckboxes = document.querySelectorAll('#addChildrenSelection input[name="children"]:checked');
                childrenCheckboxes.forEach(checkbox => {
                    selectedChildren.push(checkbox.value);
                });

                // Get selected parents
                const selectedParents = [];
                const parentsCheckboxes = document.querySelectorAll('#addParentsSelection input[name="parents"]:checked');
                parentsCheckboxes.forEach(checkbox => {
                    selectedParents.push(checkbox.value);
                });

                const memberData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    birthMonth: document.getElementById('birthMonth').value,
                    birthDay: parseInt(document.getElementById('birthDay').value),
                    birthYear: parseInt(document.getElementById('birthYear').value),
                    familyBranch: document.getElementById('familyBranch').value,
                    marriedTo: document.getElementById('marriedTo').value || null,
                    children: selectedChildren, // Add children array
                    parents: selectedParents, // Add parents array
                    mobilePhone: document.getElementById('mobilePhone').value,
                    homePhone: document.getElementById('homePhone').value,
                    workPhone: document.getElementById('workPhone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value,
                    anniversaryDate: document.getElementById('anniversaryDate').value,
                    notes: document.getElementById('notes').value,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                const docRef = await addDoc(collection(db, 'family_members'), memberData);
                const newMemberId = docRef.id;
                
                // Update bidirectional marriage relationships
                const spouseId = memberData.marriedTo;
                if (spouseId) {
                    await updateBidirectionalMarriage(newMemberId, null, spouseId);
                    // Synchronize children with spouse
                    await synchronizeMarriedCoupleChildren(newMemberId, spouseId);
                }
                
                // Update bidirectional parent/child relationships
                await updateBidirectionalRelationships(newMemberId, selectedParents, selectedChildren);
                
                closeModal('addMemberModal');
                document.getElementById('addMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                displayBranches(); // Refresh family trees
                populateDropdowns();
                showMessage('Family member added successfully!', 'success');
            } catch (error) {
                console.error('Error adding family member:', error);
                showMessage('Error adding family member: ' + error.message, 'error');
            }
        }

        // Function to update children count for add form
        window.updateAddChildrenCount = function() {
            const checkboxes = document.querySelectorAll('#addChildrenSelection input[name="children"]:checked');
            const countElement = document.getElementById('addChildrenCount');
            const allCheckboxes = document.querySelectorAll('#addChildrenSelection input[name="children"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (checkboxes.length >= 15) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Function to update parents count for add form
        window.updateAddParentsCount = function() {
            const checkboxes = document.querySelectorAll('#addParentsSelection input[name="parents"]:checked');
            const countElement = document.getElementById('addParentsCount');
            const allCheckboxes = document.querySelectorAll('#addParentsSelection input[name="parents"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (checkboxes.length >= 2) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Update family member (old modal version - will be replaced by new modal)
        async function updateFamilyMember() {
            try {
                const memberId = document.getElementById('editMemberId').value;
                
                // Get original member data to detect changes
                const originalMember = familyMembers.find(m => m.id === memberId);
                const originalSpouseId = originalMember ? originalMember.marriedTo : null;
                
                // Get selected children
                const selectedChildren = [];
                const childrenCheckboxes = document.querySelectorAll('#editChildrenSelection input[name="editChildren"]:checked');
                childrenCheckboxes.forEach(checkbox => {
                    selectedChildren.push(checkbox.value);
                });

                // Get selected parents
                const selectedParents = [];
                const parentsCheckboxes = document.querySelectorAll('#editParentsSelection input[name="editParents"]:checked');
                parentsCheckboxes.forEach(checkbox => {
                    selectedParents.push(checkbox.value);
                });

                const memberData = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    birthMonth: document.getElementById('editBirthMonth').value,
                    birthDay: parseInt(document.getElementById('editBirthDay').value),
                    birthYear: parseInt(document.getElementById('editBirthYear').value),
                    familyBranch: document.getElementById('editFamilyBranch').value,
                    marriedTo: document.getElementById('editMarriedTo').value || null,
                    children: selectedChildren, // Add children array
                    parents: selectedParents, // Add parents array
                    mobilePhone: document.getElementById('editMobilePhone').value,
                    homePhone: document.getElementById('editHomePhone').value,
                    workPhone: document.getElementById('editWorkPhone').value,
                    address: document.getElementById('editAddress').value,
                    city: document.getElementById('editCity').value,
                    state: document.getElementById('editState').value,
                    zipCode: document.getElementById('editZipCode').value,
                    anniversaryDate: document.getElementById('editAnniversaryDate').value,
                    notes: document.getElementById('editNotes').value,
                    updatedAt: new Date(),
                    updatedBy: currentUser.username
                };

                await updateDoc(doc(db, 'family_members', memberId), memberData);
                
                // Handle marriage changes if applicable
                const newSpouseId = memberData.marriedTo;
                if (originalSpouseId !== newSpouseId) {
                    await updateBidirectionalMarriage(memberId, originalSpouseId, newSpouseId);
                    // Synchronize children with new spouse if married
                    if (newSpouseId) {
                        await synchronizeMarriedCoupleChildren(memberId, newSpouseId);
                    }
                }
                
                // Update bidirectional relationships
                await updateBidirectionalRelationships(memberId, selectedParents, selectedChildren);
                
                closeModal('editMemberModal');
                document.getElementById('editMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                displayBranches(); // Refresh family trees
                populateDropdowns();
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member: ' + error.message, 'error');
            }
        }

        // Add family branch
        async function addFamilyBranch() {
            try {
                const branchData = {
                    name: document.getElementById('branchName').value,
                    description: document.getElementById('branchDescription').value,
                    generationLevel: parseInt(document.getElementById('generationLevel').value),
                    branchType: document.getElementById('branchType').value,
                    parentBranch: document.getElementById('parentBranch').value || null,
                    sharedMembers: [], // Array to store member IDs who appear in multiple branches
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_branches'), branchData);
                closeModal('addBranchModal');
                document.getElementById('addBranchForm').reset();
                await loadFamilyBranches();
                displayBranches();
                populateDropdowns();
                generateSmartSuggestions(); // Generate suggestions after adding
                alert('Family branch added successfully!');
            } catch (error) {
                alert('Error adding family branch: ' + error.message);
            }
        }

        // Create family unit
        async function createFamilyUnit() {
            try {
                const selectedBranches = Array.from(
                    document.querySelectorAll('#branchCheckboxes input[type="checkbox"]:checked')
                ).map(checkbox => checkbox.value);

                if (selectedBranches.length === 0) {
                    alert('Please select at least one branch for this family unit.');
                    return;
                }

                const unitData = {
                    name: document.getElementById('unitName').value,
                    description: document.getElementById('unitDescription').value,
                    type: document.getElementById('unitType').value,
                    branches: selectedBranches,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_units'), unitData);
                closeModal('createFamilyUnitModal');
                document.getElementById('createFamilyUnitForm').reset();
                await loadFamilyUnits();
                displayBranches();
                alert('Family unit created successfully!');
            } catch (error) {
                alert('Error creating family unit: ' + error.message);
            }
        }

        // Add user (admin only)
        async function addUser() {
            if (!currentUser.isAdmin) return;

            try {
                const userData = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('userPhone').value,
                    isAdmin: parseInt(document.getElementById('isAdmin').value),
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'users'), userData);
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                await loadUsers();
                displayUsers();
                alert('User added successfully!');
            } catch (error) {
                alert('Error adding user: ' + error.message);
            }
        }

        // Add message
        async function addMessage() {
            try {
                const messageData = {
                    title: document.getElementById('messageTitle').value,
                    content: document.getElementById('messageContent').value,
                    author: currentUser.username,
                    createdAt: new Date()
                };

                await addDoc(collection(db, 'messages'), messageData);
                closeModal('addMessageModal');
                document.getElementById('addMessageForm').reset();
                await loadMessages();
                displayMessages();
                alert('Message posted successfully!');
            } catch (error) {
                alert('Error posting message: ' + error.message);
            }
        }

        // Bulk import
        let selectedFileData = null;

        // File upload handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        // Drag and drop handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processExcelFile(files[0]);
            }
        });

        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON (array of arrays)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Filter out empty rows
                    const filteredData = jsonData.filter(row => 
                        row.length > 0 && row.some(cell => cell && cell.toString().trim())
                    );
                    
                    if (filteredData.length === 0) {
                        alert('No data found in the Excel file');
                        return;
                    }
                    
                    selectedFileData = filteredData;
                    displayFileInfo(file, filteredData.length);
                    displayPreview(filteredData);
                    
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayFileInfo(file, rowCount) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('rowCount').textContent = rowCount;
            document.getElementById('fileInfo').style.display = 'block';
        }

        function displayPreview(data) {
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            // Show first 5 rows (skip header if it exists)
            const startRow = (data[0] && typeof data[0][0] === 'string' && data[0][0].toLowerCase().includes('name')) ? 1 : 0;
            const previewRows = data.slice(startRow, startRow + 5);
            
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                
                // Map columns: A, B, C, D, E, skip F, G
                const firstName = row[0] || '';
                const lastName = row[1] || '';
                const month = row[2] || '';
                const day = row[3] || '';
                const year = row[4] || '';
                const columnG = row[6] || ''; // Column G (shows what's there but won't be imported)
                
                tr.innerHTML = `
                    <td>${firstName}</td>
                    <td>${lastName}</td>
                    <td>${month}</td>
                    <td>${day}</td>
                    <td>${year}</td>
                    <td style="opacity: 0.5; font-style: italic;">${columnG}<br><small>(ignored)</small></td>
                `;
                previewBody.appendChild(tr);
            });
            
            document.getElementById('previewContainer').style.display = 'block';
        }

        async function confirmImport() {
            console.log('confirmImport called');
            
            if (!currentUser.isAdmin) {
                alert('Only admin users can import data');
                return;
            }
            
            if (!selectedFileData) {
                alert('No file data selected');
                return;
            }

            console.log('Selected file data length:', selectedFileData.length);

            const confirmMessage = `Are you sure you want to import ${selectedFileData.length} records? This will add all valid entries to the database.`;
            if (!confirm(confirmMessage)) return;

            // Show loading message
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.textContent;
            importBtn.textContent = 'Importing...';
            importBtn.disabled = true;

            try {
                let imported = 0;
                let skipped = 0;
                
                // Skip header row if it exists
                const startRow = (selectedFileData[0] && typeof selectedFileData[0][0] === 'string' && 
                                selectedFileData[0][0].toLowerCase().includes('name')) ? 1 : 0;
                
                const dataRows = selectedFileData.slice(startRow);
                console.log('Processing', dataRows.length, 'rows');
                
                for (const row of dataRows) {
                    try {
                        // Map columns: A, B, C, D, E, skip F, G
                        const firstName = row[0]?.toString().trim() || '';
                        const lastName = row[1]?.toString().trim() || '';
                        const month = row[2]?.toString().trim() || '';
                        const day = parseInt(row[3]) || 1;
                        const year = parseInt(row[4]) || new Date().getFullYear();
                        // Note: Column G in your data appears to be birthday dates, not family branches
                        // We'll leave familyBranch empty for now and you can organize families later
                        
                        // Only import if we have at least first and last name
                        if (firstName && lastName) {
                            const memberData = {
                                firstName: firstName,
                                lastName: lastName,
                                birthMonth: month,
                                birthDay: day,
                                birthYear: year,
                                familyBranch: '', // Leave empty - you'll organize into families later
                                relationship: '', // Can be updated later
                                relatedTo: '',
                                mobilePhone: '',
                                homePhone: '',
                                workPhone: '',
                                address: '',
                                city: '',
                                state: '',
                                zipCode: '',
                                anniversaryDate: '',
                                notes: '',
                                createdAt: new Date(),
                                createdBy: currentUser.username
                            };

                            console.log('Adding member:', firstName, lastName);
                            await addDoc(collection(db, 'family_members'), memberData);
                            imported++;
                        } else {
                            console.log('Skipping row - missing name:', firstName, lastName);
                            skipped++;
                        }
                    } catch (rowError) {
                        console.error('Error processing row:', row, rowError);
                        skipped++;
                    }
                }

                console.log('Import completed. Imported:', imported, 'Skipped:', skipped);

                // Clear the file selection
                clearFile();
                
                // Refresh the display
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                
                alert(`Import completed!\nImported: ${imported} family members\nSkipped: ${skipped} incomplete records`);
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing data: ' + error.message);
            } finally {
                // Restore button
                importBtn.textContent = originalText;
                importBtn.disabled = false;
            }
        }

        // Make sure the function is globally accessible
        window.confirmImport = confirmImport;

        function clearFile() {
            selectedFileData = null;
            document.getElementById('excelFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('previewContainer').style.display = 'none';
        }

        // Make sure functions are globally accessible
        window.handleFileSelect = handleFileSelect;
        window.clearFile = clearFile;
        
        // Test function to verify database connectivity
        window.testDatabase = async function() {
            try {
                console.log('Testing database connection...');
                
                // Just try to read from the users collection (which we know exists)
                const usersSnapshot = await getDocs(collection(db, 'users'));
                console.log('Successfully connected to database. Found', usersSnapshot.size, 'users');
                
                // Try to read from family_members collection (might not exist yet)
                const familySnapshot = await getDocs(collection(db, 'family_members'));
                console.log('Family members collection exists. Found', familySnapshot.size, 'members');
                
                alert(`Database connection successful!\nUsers: ${usersSnapshot.size}\nFamily Members: ${familySnapshot.size}`);
                
            } catch (error) {
                console.error('Database test failed:', error);
                alert('Database test failed: ' + error.message + '\n\nThis might be a Firestore security rules issue.');
            }
        };

        // Legacy bulk import function (keeping for backward compatibility)
        async function bulkImport() {
            if (!currentUser.isAdmin) return;

            const data = document.getElementById('importData').value;
            if (!data.trim()) {
                alert('Please paste data to import');
                return;
            }

            try {
                const lines = data.split('\n').filter(line => line.trim());
                let imported = 0;

                for (const line of lines) {
                    const fields = line.split('\t');
                    if (fields.length >= 5) {
                        const memberData = {
                            firstName: fields[0]?.trim() || '',
                            lastName: fields[1]?.trim() || '',
                            birthMonth: fields[2]?.trim() || '',
                            birthDay: parseInt(fields[3]?.trim()) || 1,
                            birthYear: parseInt(fields[4]?.trim()) || new Date().getFullYear(),
                            familyBranch: fields[5]?.trim() || '',
                            relationship: fields[6]?.trim() || '',
                            createdAt: new Date(),
                            createdBy: currentUser.username
                        };

                        if (memberData.firstName && memberData.lastName) {
                            await addDoc(collection(db, 'family_members'), memberData);
                            imported++;
                        }
                    }
                }

                document.getElementById('importData').value = '';
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully imported ${imported} family members!`);
            } catch (error) {
                alert('Error importing data: ' + error.message);
            }
        }

        // Delete functions
        window.deleteFamilyMember = async function(id) {
            if (confirm('Are you sure you want to delete this family member?')) {
                try {
                    await deleteDoc(doc(db, 'family_members', id));
                    await loadFamilyMembers();
                    displayFamilyMembers();
                    displayUpcomingBirthdays();
                    alert('Family member deleted successfully!');
                } catch (error) {
                    alert('Error deleting family member: ' + error.message);
                }
            }
        };

        window.deleteBranch = async function(id) {
            if (confirm('Are you sure you want to delete this branch?')) {
                try {
                    await deleteDoc(doc(db, 'family_branches', id));
                    await loadFamilyBranches();
                    displayBranches();
                    populateDropdowns();
                    alert('Branch deleted successfully!');
                } catch (error) {
                    alert('Error deleting branch: ' + error.message);
                }
            }
        };

        // Family Unit Management Functions
        window.deleteFamilyUnit = async function(id) {
            if (confirm('Are you sure you want to delete this family unit? The branches will remain but will no longer be grouped together.')) {
                try {
                    await deleteDoc(doc(db, 'family_units', id));
                    await loadFamilyUnits();
                    displayBranches();
                    alert('Family unit deleted successfully!');
                } catch (error) {
                    alert('Error deleting family unit: ' + error.message);
                }
            }
        };

        window.manageFamilyUnit = function(id) {
            // For now, just show an alert. This could be expanded to a full management modal
            const unit = familyUnits.find(u => u.id === id);
            alert(`Managing ${unit.name}\n\nBranches: ${unit.branches.join(', ')}\n\nThis feature can be expanded to allow editing the unit, adding/removing branches, etc.`);
        };

        window.removeBranchFromUnit = async function(branchName, unitId) {
            if (confirm(`Remove ${branchName} from this family unit?`)) {
                try {
                    const unit = familyUnits.find(u => u.id === unitId);
                    const updatedBranches = unit.branches.filter(b => b !== branchName);
                    
                    await updateDoc(doc(db, 'family_units', unitId), {
                        branches: updatedBranches
                    });
                    
                    await loadFamilyUnits();
                    displayBranches();
                    alert('Branch removed from family unit successfully!');
                } catch (error) {
                    alert('Error removing branch from unit: ' + error.message);
                }
            }
        };

        window.deleteUser = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await deleteDoc(doc(db, 'users', id));
                    await loadUsers();
                    displayUsers();
                    alert('User deleted successfully!');
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        };

        // Approve account request
        window.approveRequest = async function(requestId, username, password, firstName, lastName) {
            if (!currentUser.isAdmin) return;
            
            try {
                // Add user to users collection as admin
                await addDoc(collection(db, 'users'), {
                    username: username,
                    password: password,
                    fullName: `${firstName} ${lastName}`,
                    firstName: firstName,
                    lastName: lastName,
                    isAdmin: 1,  // All approved users are admins
                    createdAt: new Date()
                });
                
                // Delete the request
                await deleteDoc(doc(db, 'account_requests', requestId));
                
                // Reload data
                await loadAccountRequests();
                await loadUsers();
                displayAccountRequests();
                displayUsers();
                
                alert(`Account approved! ${firstName} ${lastName} has been added as an admin.`);
            } catch (error) {
                alert('Error approving request: ' + error.message);
            }
        };

        // Deny account request
        window.denyRequest = async function(requestId, username) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to deny this account request? This username will be permanently blocked.')) {
                try {
                    // Get the request data first
                    const requestData = accountRequests.find(req => req.id === requestId);
                    
                    // Add to denied accounts
                    await addDoc(collection(db, 'denied_accounts'), {
                        username: username,
                        deniedDate: new Date().toISOString(),
                        deniedBy: currentUser.username,
                        originalRequest: requestData
                    });
                    
                    // Delete the request
                    await deleteDoc(doc(db, 'account_requests', requestId));
                    
                    // Reload data
                    await loadAccountRequests();
                    await loadDeniedAccounts();
                    displayAccountRequests();
                    
                    alert(`Account request denied. ${username} has been permanently blocked from creating an account.`);
                } catch (error) {
                    alert('Error denying request: ' + error.message);
                }
            }
        };

        window.deleteMessage = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await deleteDoc(doc(db, 'messages', id));
                    await loadMessages();
                    displayMessages();
                    alert('Message deleted successfully!');
                } catch (error) {
                    alert('Error deleting message: ' + error.message);
                }
            }
        };

        // Remove all family members (admin only)
        window.removeAllFamilyMembers = async function() {
            console.log('removeAllFamilyMembers called');
            console.log('Current user:', currentUser);
            console.log('Is admin:', currentUser?.isAdmin);
            console.log('Family members count:', familyMembers.length);
            
            if (!currentUser || !currentUser.isAdmin) {
                alert('Only admin users can delete all family members');
                return;
            }
            
            if (familyMembers.length === 0) {
                alert('No family members to delete');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è DANGER: This will permanently delete ALL ${familyMembers.length} family members from the database!\n\nThis action cannot be undone. Are you absolutely sure?`;
            if (!confirm(confirmMessage)) return;
            
            const doubleConfirm = prompt('Type "DELETE ALL" to confirm this dangerous action:');
            if (doubleConfirm !== 'DELETE ALL') {
                alert('Action cancelled - text did not match exactly.');
                return;
            }
            
            try {
                let deleted = 0;
                console.log('Starting deletion process...');
                
                for (const member of familyMembers) {
                    console.log('Deleting member:', member.firstName, member.lastName, 'ID:', member.id);
                    await deleteDoc(doc(db, 'family_members', member.id));
                    deleted++;
                }
                
                console.log('Deletion completed. Refreshing data...');
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully deleted ${deleted} family members. Database is now clean for proper import.`);
            } catch (error) {
                console.error('Error deleting family members:', error);
                alert('Error deleting family members: ' + error.message);
            }
        };

        // Modal functions
        window.openAddMemberModal = function() {
            document.getElementById('addMemberModal').classList.add('active');
        };

        window.openAddBranchModal = function() {
            populateParentBranchDropdown();
            generateSmartSuggestions();
            document.getElementById('addBranchModal').classList.add('active');
        };

        // Family Unit Modal Functions
        window.openCreateFamilyUnitModal = function() {
            populateBranchCheckboxes();
            document.getElementById('createFamilyUnitModal').classList.add('active');
        };

        function populateBranchCheckboxes() {
            const container = document.getElementById('branchCheckboxes');
            
            // Get branches that are not already in a family unit
            const branchesInUnits = familyUnits.flatMap(unit => unit.branches || []);
            const availableBranches = familyBranches.filter(branch => 
                !branchesInUnits.includes(branch.name)
            );

            if (availableBranches.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No available branches to add to a family unit.</p>';
                return;
            }

            container.innerHTML = availableBranches.map(branch => `
                <div style="margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #e9ecef; border-radius: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${branch.name}" style="margin-right: 0.5rem;">
                        <div>
                            <strong>${branch.name}</strong>
                            <div style="font-size: 0.8rem; color: #666;">
                                Generation ${branch.generationLevel || '?'} ‚Ä¢ ${formatBranchType(branch.branchType)}
                                ‚Ä¢ ${familyMembers.filter(m => m.familyBranch === branch.name).length} members
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');
        }

        // Populate parent branch dropdown
        function populateParentBranchDropdown() {
            const parentBranchSelect = document.getElementById('parentBranch');
            parentBranchSelect.innerHTML = '<option value="">No Parent Branch</option>';
            
            familyBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = `${branch.name} (Gen ${branch.generationLevel || '?'})`;
                parentBranchSelect.appendChild(option);
            });
        }

        // Generate smart suggestions for branch creation
        function generateSmartSuggestions() {
            const suggestionsDiv = document.getElementById('smartSuggestions');
            const suggestionsList = document.getElementById('suggestionsList');
            
            if (!familyMembers.length) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const suggestions = [];
            
            // Analyze last names for family grouping suggestions
            const lastNameGroups = {};
            familyMembers.forEach(member => {
                if (!member.familyBranch || member.familyBranch.trim() === '') {
                    const lastName = member.lastName;
                    if (!lastNameGroups[lastName]) lastNameGroups[lastName] = [];
                    lastNameGroups[lastName].push(member);
                }
            });

            // Suggest nuclear families for groups with same last name
            Object.entries(lastNameGroups).forEach(([lastName, members]) => {
                if (members.length >= 2) {
                    const ages = members.map(m => new Date().getFullYear() - m.birthYear);
                    const hasAdults = ages.some(age => age >= 18);
                    const hasChildren = ages.some(age => age < 18);
                    
                    if (hasAdults && hasChildren) {
                        suggestions.push({
                            type: 'nuclear_family',
                            text: `Create "${lastName} Nuclear Family" for ${members.length} members`,
                            action: () => suggestBranchName(`${lastName} Nuclear Family`, 'nuclear_family', 2)
                        });
                    } else if (hasAdults) {
                        suggestions.push({
                            type: 'cousin_branch', 
                            text: `Create "${lastName} Cousin Branch" for ${members.length} members`,
                            action: () => suggestBranchName(`${lastName} Cousin Branch`, 'cousin_branch', 3)
                        });
                    }
                }
            });

            // Show suggestions
            if (suggestions.length > 0) {
                suggestionsList.innerHTML = suggestions.map(suggestion => 
                    `<div style="margin-bottom: 0.5rem;">
                        <button class="btn" onclick="(${suggestion.action})()" style="background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; font-size: 0.85rem;">
                            ${suggestion.text}
                        </button>
                    </div>`
                ).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        // Suggest branch name and type
        function suggestBranchName(name, type, generation) {
            document.getElementById('branchName').value = name;
            document.getElementById('branchType').value = type;
            document.getElementById('generationLevel').value = generation;
        }

        // Open branch management modal
        window.openManageBranchModal = function(branchId) {
            const branch = familyBranches.find(b => b.id === branchId);
            if (!branch) return;

            document.getElementById('manageBranchTitle').textContent = `Manage: ${branch.name}`;
            window.currentManagingBranch = branch;
            
            populateManageBranchData(branch);
            document.getElementById('manageBranchModal').classList.add('active');
        };

        // Populate management modal data
        function populateManageBranchData(branch) {
            // Populate source branch dropdown for moving
            const sourceBranchSelect = document.getElementById('sourceBranch');
            sourceBranchSelect.innerHTML = '<option value="">Select source branch</option>';
            
            familyBranches.forEach(b => {
                if (b.id !== branch.id) {
                    const option = document.createElement('option');
                    option.value = b.name;
                    option.textContent = `${b.name} (${familyMembers.filter(m => m.familyBranch === b.name).length} members)`;
                    sourceBranchSelect.appendChild(option);
                }
            });

            // Populate shareable members
            const shareableMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const shareableDiv = document.getElementById('shareableMembersList');
            
            if (shareableMembers.length > 0) {
                shareableDiv.innerHTML = shareableMembers.map(member => `
                    <div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${member.firstName} ${member.lastName}</strong>
                                <small style="color: #666; margin-left: 0.5rem;">${member.birthYear || ''}</small>
                            </div>
                            <button class="btn btn-primary" onclick="openShareMemberModal('${member.id}')" style="font-size: 0.8rem;">
                                Share with Other Branches
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                shareableDiv.innerHTML = '<p style="text-align: center; color: #666;">No members in this branch yet</p>';
            }

            // Generate branch-specific suggestions
            generateBranchSuggestions(branch);
        }

        // Load candidates for moving
        window.loadMoveCandidates = function() {
            const sourceBranchName = document.getElementById('sourceBranch').value;
            const candidatesDiv = document.getElementById('moveCandidates');
            const moveBtn = document.getElementById('moveSelectedBtn');

            if (!sourceBranchName) {
                candidatesDiv.innerHTML = '<p style="text-align: center; color: #666;">Select a source branch to see members</p>';
                moveBtn.style.display = 'none';
                return;
            }

            const candidates = familyMembers.filter(m => m.familyBranch === sourceBranchName);
            
            if (candidates.length === 0) {
                candidatesDiv.innerHTML = '<p style="text-align: center; color: #666;">No members in selected branch</p>';
                moveBtn.style.display = 'none';
                return;
            }

            candidatesDiv.innerHTML = candidates.map(member => `
                <div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${member.id}" style="margin-right: 0.5rem;" onchange="updateMoveButton()">
                        <div>
                            <strong>${member.firstName} ${member.lastName}</strong>
                            <small style="color: #666; margin-left: 0.5rem;">
                                Born ${member.birthMonth || ''} ${member.birthDay || ''}, ${member.birthYear || ''}
                            </small>
                            ${member.relationship ? `<br><small style="color: #666;">Relationship: ${member.relationship}</small>` : ''}
                        </div>
                    </label>
                </div>
            `).join('');

            moveBtn.style.display = 'block';
        };

        // Update move button state
        window.updateMoveButton = function() {
            const checkboxes = document.querySelectorAll('#moveCandidates input[type="checkbox"]:checked');
            const moveBtn = document.getElementById('moveSelectedBtn');
            moveBtn.textContent = `Move Selected Members (${checkboxes.length})`;
            moveBtn.disabled = checkboxes.length === 0;
        };

        // Move selected members
        window.moveSelectedMembers = async function() {
            const checkboxes = document.querySelectorAll('#moveCandidates input[type="checkbox"]:checked');
            const memberIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (memberIds.length === 0) return;

            const targetBranch = window.currentManagingBranch;
            if (!targetBranch) return;

            try {
                for (const memberId of memberIds) {
                    await updateDoc(doc(db, 'family_members', memberId), {
                        familyBranch: targetBranch.name,
                        updatedAt: new Date(),
                        updatedBy: currentUser.username
                    });
                }

                alert(`Successfully moved ${memberIds.length} members to ${targetBranch.name}`);
                
                // Refresh data
                await loadFamilyMembers();
                displayFamilyMembers();
                displayBranches();
                populateDropdowns();
                
                // Refresh management modal
                populateManageBranchData(targetBranch);
                
            } catch (error) {
                alert('Error moving members: ' + error.message);
            }
        };

        // Generate branch-specific suggestions
        function generateBranchSuggestions(branch) {
            const suggestionsDiv = document.getElementById('branchSuggestions');
            const suggestions = [];

            const branchMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const unassignedMembers = familyMembers.filter(m => !m.familyBranch || m.familyBranch.trim() === '');

            // Suggest adding unassigned family members with same last name
            if (branchMembers.length > 0) {
                const branchLastNames = [...new Set(branchMembers.map(m => m.lastName))];
                
                branchLastNames.forEach(lastName => {
                    const matchingUnassigned = unassignedMembers.filter(m => m.lastName === lastName);
                    if (matchingUnassigned.length > 0) {
                        suggestions.push({
                            text: `Add ${matchingUnassigned.length} unassigned ${lastName} members to this branch`,
                            action: `moveUnassignedByLastName('${lastName}', '${branch.name}')`
                        });
                    }
                });
            }

            // Suggest creating child branches
            if (branch.branchType === 'extended_family' && branchMembers.length > 6) {
                suggestions.push({
                    text: `This branch has ${branchMembers.length} members. Consider splitting into nuclear families`,
                    action: `suggestSplitBranch('${branch.id}')`
                });
            }

            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = suggestions.map(s => 
                    `<div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0 0 0.5rem 0;">${s.text}</p>
                        <button class="btn btn-primary" onclick="${s.action}" style="font-size: 0.85rem;">Apply Suggestion</button>
                    </div>`
                ).join('');
            } else {
                suggestionsDiv.innerHTML = '<p style="text-align: center; color: #666;">No suggestions for this branch right now</p>';
            }
        }

        // Tab switching for management modal
        window.switchManageTab = function(tabName) {
            document.querySelectorAll('.manage-tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('#manageBranchModal .tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        };

        // Helper functions for smart suggestions
        window.moveUnassignedByLastName = async function(lastName, targetBranchName) {
            const unassignedMembers = familyMembers.filter(m => 
                (!m.familyBranch || m.familyBranch.trim() === '') && m.lastName === lastName
            );

            if (unassignedMembers.length === 0) {
                alert('No unassigned members found with that last name');
                return;
            }

            const confirmMessage = `Move ${unassignedMembers.length} unassigned ${lastName} members to ${targetBranchName}?`;
            if (!confirm(confirmMessage)) return;

            try {
                for (const member of unassignedMembers) {
                    await updateDoc(doc(db, 'family_members', member.id), {
                        familyBranch: targetBranchName,
                        updatedAt: new Date(),
                        updatedBy: currentUser.username
                    });
                }

                alert(`Successfully moved ${unassignedMembers.length} ${lastName} members to ${targetBranchName}`);
                
                // Refresh data
                await loadFamilyMembers();
                displayFamilyMembers();
                displayBranches();
                
                // Refresh management modal if open
                if (window.currentManagingBranch) {
                    populateManageBranchData(window.currentManagingBranch);
                }
                
            } catch (error) {
                alert('Error moving members: ' + error.message);
            }
        };

        window.suggestSplitBranch = function(branchId) {
            const branch = familyBranches.find(b => b.id === branchId);
            if (!branch) return;

            const branchMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const lastNameGroups = {};
            
            branchMembers.forEach(member => {
                if (!lastNameGroups[member.lastName]) lastNameGroups[member.lastName] = [];
                lastNameGroups[member.lastName].push(member);
            });

            let suggestions = Object.entries(lastNameGroups)
                .filter(([lastName, members]) => members.length >= 2)
                .map(([lastName, members]) => `‚Ä¢ ${lastName} family (${members.length} members)`)
                .join('\n');

            if (suggestions) {
                alert(`Consider creating separate nuclear family branches:\n\n${suggestions}\n\nUse the "Move Members" tab to organize them.`);
            } else {
                alert('No clear family groupings found for splitting this branch.');
            }
        };

        // Add smart suggestions to existing functions
        function enhanceLoadData() {
            const originalLoadData = window.loadData;
            window.loadData = async function() {
                await originalLoadData();
                generateSmartSuggestions();
            };
        }

        // Initialize smart suggestions
        if (typeof window.loadData !== 'undefined') {
            enhanceLoadData();
        }

        window.openAddUserModal = function() {
            if (!currentUser.isAdmin) return;
            document.getElementById('addUserModal').classList.add('active');
        };

        window.openAddMessageModal = function() {
            document.getElementById('addMessageModal').classList.add('active');
        };

        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                alert('Family member not found');
                return;
            }

            // Populate the edit form with existing data
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editFirstName').value = member.firstName || '';
            document.getElementById('editLastName').value = member.lastName || '';
            document.getElementById('editBirthMonth').value = member.birthMonth || '';
            document.getElementById('editBirthDay').value = member.birthDay || '';
            document.getElementById('editBirthYear').value = member.birthYear || '';
            document.getElementById('editFamilyBranch').value = member.familyBranch || '';
            document.getElementById('editRelationship').value = member.relationship || '';
            document.getElementById('editRelatedTo').value = member.relatedTo || '';
            document.getElementById('editMobilePhone').value = member.mobilePhone || '';
            document.getElementById('editHomePhone').value = member.homePhone || '';
            document.getElementById('editWorkPhone').value = member.workPhone || '';
            document.getElementById('editAddress').value = member.address || '';
            document.getElementById('editCity').value = member.city || '';
            document.getElementById('editState').value = member.state || '';
            document.getElementById('editZipCode').value = member.zipCode || '';
            document.getElementById('editAnniversaryDate').value = member.anniversaryDate || '';
            document.getElementById('editNotes').value = member.notes || '';

            // Show the modal
            document.getElementById('editMemberModal').classList.add('active');
        };

        window.viewBranchMembers = function(branchName) {
            const branchMembers = familyMembers.filter(member => member.familyBranch === branchName);
            
            // Update modal title and stats
            document.getElementById('branchViewTitle').textContent = `${branchName} - Family Members`;
            document.getElementById('branchStatsName').textContent = branchName;
            document.getElementById('branchStatsCount').textContent = `${branchMembers.length} family member${branchMembers.length !== 1 ? 's' : ''}`;
            
            // Clear search input
            document.getElementById('branchSearchInput').value = '';
            
            // Display members or no members message
            if (branchMembers.length === 0) {
                document.getElementById('branchMembersGrid').style.display = 'none';
                document.getElementById('noBranchMembers').style.display = 'block';
            } else {
                document.getElementById('branchMembersGrid').style.display = 'grid';
                document.getElementById('noBranchMembers').style.display = 'none';
                displayBranchMembers(branchMembers);
            }
            
            // Show the modal
            document.getElementById('branchViewModal').classList.add('active');
            
            // Set up search functionality for this branch
            const searchInput = document.getElementById('branchSearchInput');
            searchInput.oninput = function() {
                const searchTerm = this.value.toLowerCase();
                const filteredMembers = branchMembers.filter(member => 
                    member.firstName.toLowerCase().includes(searchTerm) ||
                    member.lastName.toLowerCase().includes(searchTerm) ||
                    (member.relationship && member.relationship.toLowerCase().includes(searchTerm))
                );
                displayBranchMembers(filteredMembers);
            };
        };

        function displayBranchMembers(members) {
            const grid = document.getElementById('branchMembersGrid');
            
            // Sort members by age (oldest first) for better family tree view
            const sortedMembers = [...members].sort((a, b) => getAge(b) - getAge(a));
            
            grid.innerHTML = sortedMembers.map(member => {
                const age = getAge(member);
                const nextBirthday = getNextBirthday(member);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                <div class="family-card" style="border-left: 4px solid #28a745;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem; color: #28a745;">${member.firstName} ${member.lastName}</h3>
                            <div class="family-info" style="font-size: 0.9rem;">
                                <div><strong>üéÇ Birthday:</strong> ${member.birthMonth} ${member.birthDay}, ${member.birthYear} <span style="color: #666;">(Age: ${age})</span></div>
                                <div><strong>‚è∞ Next Birthday:</strong> <span style="color: ${daysUntilBirthday <= 30 ? '#e74c3c' : '#666'};">${daysUntilBirthday} days</span></div>
                                ${member.relationship ? `<div><strong>üë™ Relationship:</strong> ${member.relationship}</div>` : ''}
                                ${member.mobilePhone ? `<div><strong>üì± Mobile:</strong> ${member.mobilePhone}</div>` : ''}
                                ${member.homePhone ? `<div><strong>üè† Home:</strong> ${member.homePhone}</div>` : ''}
                                ${member.workPhone ? `<div><strong>üíº Work:</strong> ${member.workPhone}</div>` : ''}
                                ${member.address ? `<div><strong>üìç Address:</strong> ${member.address}${member.city ? `, ${member.city}` : ''}${member.state ? `, ${member.state}` : ''}</div>` : ''}
                                ${member.anniversaryDate ? `<div><strong>üíí Anniversary:</strong> ${member.anniversaryDate}</div>` : ''}
                                ${member.notes ? `<div style="margin-top: 0.5rem;"><strong>üìù Notes:</strong> ${member.notes}</div>` : ''}
                            </div>
                        </div>
                        <div style="margin-left: 1rem;">
                            <div style="font-size: 2rem; opacity: 0.6;">üë§</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="font-size: 0.85rem;">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="font-size: 0.85rem;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        window.closeModal = function(modalId) {
            if (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    modal.style.opacity = '0';
                    modal.style.visibility = 'hidden';
                }
            } else {
                // If no modalId provided, close any active modal
                document.querySelectorAll('.modal.active, .modal[style*="visible"]').forEach(modal => {
                    modal.classList.remove('active');
                    modal.style.opacity = '0';
                    modal.style.visibility = 'hidden';
                });
            }
        };

        // General showModal function
        window.showModal = function(content, modalId = 'generalModal') {
            // Create modal if it doesn't exist
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    opacity: 0;
                    visibility: hidden;
                    transition: all 0.3s ease;
                `;
                
                // Add click-outside-to-close functionality
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal(modalId);
                    }
                });
                
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = content;
            modal.classList.add('active');
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            
            // Add escape key to close
            const escKeyHandler = function(e) {
                if (e.key === 'Escape') {
                    closeModal(modalId);
                    document.removeEventListener('keydown', escKeyHandler);
                }
            };
            document.addEventListener('keydown', escKeyHandler);
        };

        // Open edit member modal function - COMPLETELY REBUILT FOR FULL SCREEN
        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                console.error('Member not found:', memberId);
                return;
            }

            // Close any existing modals
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');

            // Get age-appropriate potential parents and children
            const potentialParents = getPotentialParents(member);
            const potentialChildren = getPotentialChildren(member);
            const potentialSpouses = familyMembers.filter(m => m.id !== memberId);

            // Create full-screen modal
            const fullScreenModal = document.createElement('div');
            fullScreenModal.id = 'fullScreenEditModal';
            fullScreenModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                box-sizing: border-box;
            `;

            fullScreenModal.innerHTML = `
                <div style="
                    background: white;
                    width: 100%;
                    max-width: 1200px;
                    height: 90vh;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    position: relative;
                ">
                    <!-- Header -->
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 2rem;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h2 style="margin: 0; font-size: 1.8rem; font-weight: 600;">
                            ‚úèÔ∏è Edit Family Member
                        </h2>
                        <button onclick="closeFullScreenModal()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            font-size: 1.5rem;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: background 0.3s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
                    </div>

                    <!-- Form Content -->
                    <div style="
                        flex: 1;
                        overflow-y: auto;
                        padding: 2rem;
                        background: #f8f9fa;
                    ">
                        <form id="fullScreenEditForm" onsubmit="submitFullScreenEdit(event, '${memberId}')" style="
                            max-width: 1000px;
                            margin: 0 auto;
                        ">
                            <!-- Basic Information -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                margin-bottom: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;">üë§ Basic Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">First Name *</label>
                                        <input type="text" name="firstName" value="${member.firstName || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            transition: border-color 0.3s;
                                        " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e6ed'">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Last Name *</label>
                                        <input type="text" name="lastName" value="${member.lastName || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            transition: border-color 0.3s;
                                        " onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e6ed'">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Birth Month *</label>
                                        <select name="birthMonth" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            background: white;
                                        ">
                                            <option value="">Select Month</option>
                                            ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map(month => 
                                                `<option value="${month}" ${member.birthMonth === month ? 'selected' : ''}>${month}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Birth Day *</label>
                                        <input type="number" name="birthDay" min="1" max="31" value="${member.birthDay || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Birth Year *</label>
                                        <input type="number" name="birthYear" min="1900" max="2030" value="${member.birthYear || ''}" required style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                            </div>

                            <!-- Family Relationships -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                margin-bottom: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Relationships</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Family Group</label>
                                        <select name="familyBranch" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            background: white;
                                        ">
                                            <option value="">Select Group</option>
                                            ${familyBranches.map(branch => 
                                                `<option value="${branch.name}" ${member.familyBranch === branch.name ? 'selected' : ''}>${branch.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">üíç Married To</label>
                                        <select name="marriedTo" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                            background: white;
                                        ">
                                            <option value="">Select someone</option>
                                            ${potentialSpouses.map(spouse => 
                                                `<option value="${spouse.id}" ${member.marriedTo === spouse.id ? 'selected' : ''}>${spouse.firstName} ${spouse.lastName}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                    <!-- Parents -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">üë´ Parents (Select up to 2)</label>
                                        <div style="
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            max-height: 200px;
                                            overflow-y: auto;
                                            background: #f8f9fa;
                                        ">
                                            ${potentialParents.length > 0 ? potentialParents.map(parent => {
                                                const isSelected = member.parents && member.parents.includes(parent.id);
                                                return `
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    padding: 0.75rem;
                                                    border-bottom: 1px solid #e0e6ed;
                                                    background: white;
                                                    margin: 0.25rem;
                                                    border-radius: 6px;
                                                ">
                                                    <input type="checkbox" name="editParents" value="${parent.id}" ${isSelected ? 'checked' : ''} 
                                                           onchange="updateFullScreenParentsCount()" style="margin-right: 0.75rem; transform: scale(1.2);">
                                                    <span style="font-size: 0.95rem;">${parent.firstName} ${parent.lastName} (Age: ${getAge(parent)})</span>
                                                </div>
                                                `;
                                            }).join('') : `
                                                <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                                                    No potential parents found<br><small>(need people at least 15 years older)</small>
                                                </div>
                                            `}
                                        </div>
                                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                                            Selected: <span id="fullScreenParentsCount">0</span>/2 parents
                                        </small>
                                    </div>

                                    <!-- Children -->
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">üë∂ Children (Select up to 15)</label>
                                        <div style="
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            max-height: 200px;
                                            overflow-y: auto;
                                            background: #f8f9fa;
                                        ">
                                            ${potentialChildren.length > 0 ? potentialChildren.map(child => {
                                                const isSelected = member.children && member.children.includes(child.id);
                                                return `
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    padding: 0.75rem;
                                                    border-bottom: 1px solid #e0e6ed;
                                                    background: white;
                                                    margin: 0.25rem;
                                                    border-radius: 6px;
                                                ">
                                                    <input type="checkbox" name="editChildren" value="${child.id}" ${isSelected ? 'checked' : ''} 
                                                           onchange="updateFullScreenChildrenCount()" style="margin-right: 0.75rem; transform: scale(1.2);">
                                                    <span style="font-size: 0.95rem;">${child.firstName} ${child.lastName} (Age: ${getAge(child)})</span>
                                                </div>
                                                `;
                                            }).join('') : `
                                                <div style="text-align: center; padding: 2rem; color: #666; font-style: italic;">
                                                    No potential children found<br><small>(need people at least 15 years younger)</small>
                                                </div>
                                            `}
                                        </div>
                                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                                            Selected: <span id="fullScreenChildrenCount">0</span>/15 children
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                margin-bottom: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;">üìû Contact Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Mobile Phone</label>
                                        <input type="tel" name="mobilePhone" value="${member.mobilePhone || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Home Phone</label>
                                        <input type="tel" name="homePhone" value="${member.homePhone || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Work Phone</label>
                                        <input type="tel" name="workPhone" value="${member.workPhone || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Email</label>
                                        <input type="email" name="email" value="${member.email || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Street Address</label>
                                        <input type="text" name="streetAddress" value="${member.streetAddress || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div style="
                                background: white;
                                border-radius: 15px;
                                padding: 2rem;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            ">
                                <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.3rem;">üìù Additional Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">City</label>
                                        <input type="text" name="city" value="${member.city || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">State</label>
                                        <input type="text" name="state" value="${member.state || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Zip Code</label>
                                        <input type="text" name="zipCode" value="${member.zipCode || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Anniversary Date</label>
                                        <input type="date" name="anniversaryDate" value="${member.anniversaryDate || ''}" style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 2px solid #e0e6ed;
                                            border-radius: 8px;
                                            font-size: 1rem;
                                        ">
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Notes</label>
                                    <textarea name="notes" rows="4" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border: 2px solid #e0e6ed;
                                        border-radius: 8px;
                                        font-size: 1rem;
                                        resize: vertical;
                                        font-family: inherit;
                                    ">${member.notes || ''}</textarea>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Footer with buttons -->
                    <div style="
                        background: white;
                        padding: 2rem;
                        border-top: 1px solid #e0e6ed;
                        display: flex;
                        justify-content: flex-end;
                        gap: 1rem;
                    ">
                        <button type="button" onclick="closeFullScreenModal()" style="
                            padding: 0.75rem 2rem;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.3s;
                        " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            Cancel
                        </button>
                        <button type="submit" form="fullScreenEditForm" style="
                            padding: 0.75rem 2rem;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.3s;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üíæ Save Changes
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(fullScreenModal);
            
            // Initialize counts
            setTimeout(() => {
                updateFullScreenParentsCount();
                updateFullScreenChildrenCount();
            }, 100);
        };

        // Function to update parents count and enforce 2-parent limit
        window.updateParentsCount = function() {
            // Check for both add and edit modal checkboxes
            const addCheckboxes = document.querySelectorAll('input[name="parents"]:checked');
            const editCheckboxes = document.querySelectorAll('input[name="editParents"]:checked');
            const addCountElement = document.getElementById('parentsCount');
            const editCountElement = document.getElementById('editParentsCount');
            const addAllCheckboxes = document.querySelectorAll('input[name="parents"]');
            const editAllCheckboxes = document.querySelectorAll('input[name="editParents"]');
            
            // Handle add modal
            if (addCountElement) {
                addCountElement.textContent = addCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (addCheckboxes.length >= 2) {
                    addAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    addAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
            
            // Handle edit modal
            if (editCountElement) {
                editCountElement.textContent = editCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (editCheckboxes.length >= 2) {
                    editAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    editAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Function to update children count and enforce 15-child limit
        window.updateChildrenCount = function() {
            // Check for both add and edit modal checkboxes
            const addCheckboxes = document.querySelectorAll('input[name="children"]:checked');
            const editCheckboxes = document.querySelectorAll('input[name="editChildren"]:checked');
            const addCountElement = document.getElementById('childrenCount');
            const editCountElement = document.getElementById('editChildrenCount');
            const addAllCheckboxes = document.querySelectorAll('input[name="children"]');
            const editAllCheckboxes = document.querySelectorAll('input[name="editChildren"]');
            
            // Handle add modal
            if (addCountElement) {
                addCountElement.textContent = addCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (addCheckboxes.length >= 15) {
                    addAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    addAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
            
            // Handle edit modal
            if (editCountElement) {
                editCountElement.textContent = editCheckboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (editCheckboxes.length >= 15) {
                    editAllCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    // Re-enable all checkboxes if under limit
                    editAllCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        // Open add member modal function
        window.openAddMemberModal = function() {
            const modal = document.getElementById('addMemberModal');
            if (modal) {
                populateDropdowns(); // Make sure dropdowns are populated
                modal.classList.add('active');
            }
        };

        // Update family member function
        window.updateFamilyMember = async function(event, memberId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Get selected children (look for edit modal checkboxes)
            const selectedChildren = [];
            const childrenCheckboxes = document.querySelectorAll('input[name="editChildren"]:checked');
            childrenCheckboxes.forEach(checkbox => {
                selectedChildren.push(checkbox.value);
            });
            
            // Get selected parents (look for edit modal checkboxes)
            const selectedParents = [];
            const parentsCheckboxes = document.querySelectorAll('input[name="editParents"]:checked');
            parentsCheckboxes.forEach(checkbox => {
                selectedParents.push(checkbox.value);
            });
            
            try {
                // Get current member to check for marriage changes
                const currentMember = familyMembers.find(m => m.id === memberId);
                const oldSpouseId = currentMember?.marriedTo;
                const newSpouseId = formData.get('marriedTo') || null;
                
                const memberRef = doc(db, 'family_members', memberId);
                const updateData = {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    birthMonth: formData.get('birthMonth'),
                    birthDay: parseInt(formData.get('birthDay')),
                    birthYear: parseInt(formData.get('birthYear')),
                    familyBranch: formData.get('familyBranch'),
                    marriedTo: newSpouseId,
                    children: selectedChildren, // Save the children array
                    parents: selectedParents, // Save the parents array
                    mobilePhone: formData.get('mobilePhone'),
                    homePhone: formData.get('homePhone'),
                    workPhone: formData.get('workPhone'),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    state: formData.get('state'),
                    zipCode: formData.get('zipCode'),
                    anniversaryDate: formData.get('anniversaryDate'),
                    notes: formData.get('notes'),
                    updatedAt: new Date()
                };

                await updateDoc(memberRef, updateData);
                
                // Update bidirectional marriage relationships
                await updateBidirectionalMarriage(memberId, oldSpouseId, newSpouseId);
                
                // Update bidirectional parent/child relationships
                await updateBidirectionalRelationships(memberId, selectedParents, selectedChildren);
                
                closeModal('generalModal');
                await loadFamilyMembers(); // Refresh the data
                displayFamilyMembers(); // Refresh the display
                displayBranches(); // Refresh family trees
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member: ' + error.message, 'error');
            }
        };

        // Delete family member function
        window.deleteFamilyMember = async function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            if (!confirm(`Are you sure you want to delete ${member.firstName} ${member.lastName}? This action cannot be undone.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'family_members', memberId));
                loadFamilyMembers(); // Refresh the display
                showMessage('Family member deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting family member:', error);
                showMessage('Error deleting family member: ' + error.message, 'error');
            }
        };

        // Show message function
        window.showMessage = function(message, type = 'success') {
            // Remove any existing message
            const existingMessage = document.querySelector('.floating-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'floating-message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 2000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
            `;
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            // Auto remove after 4 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 4000);
        };

        // Add CSS animation for messages
        if (!document.querySelector('#message-animations')) {
            const style = document.createElement('style');
            style.id = 'message-animations';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Tab switching
        window.switchTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // If switching to relationships tab, initialize the relationship system display
            if (tabName === 'relationships' && relationshipSystem && relationshipUI) {
                initializeRelationshipDisplay();
            }
            
            // If switching to branches tab, refresh the auto-generated family trees
            if (tabName === 'branches') {
                displayBranches();
            }
            
            // If switching to requests tab, refresh the account requests
            if (tabName === 'requests') {
                loadAccountRequests().then(() => {
                    displayAccountRequests();
                });
            }
        };

        // Relationship tab switching
        window.switchRelationshipTab = function(subTabName) {
            // Update sub-tab buttons
            const relationshipTabs = document.querySelectorAll('#relationships .tab');
            relationshipTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-sections
            document.querySelectorAll('.relationship-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            const targetSection = document.getElementById('relationships' + subTabName.charAt(0).toUpperCase() + subTabName.slice(1));
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }

            // Load appropriate content
            if (relationshipSystem && relationshipUI) {
                if (subTabName === 'people') {
                    relationshipUI.displayPeopleTab();
                } else if (subTabName === 'families') {
                    relationshipUI.displayFamiliesTab();
                }
            }
        };

        // Initialize relationship system display when first accessed
        async function initializeRelationshipDisplay() {
            try {
                if (relationshipSystem && relationshipUI) {
                    // Load data for relationship system
                    await relationshipSystem.loadAllData();
                    
                    // Display initial people tab
                    relationshipUI.displayPeopleTab();
                    
                    // Update upcoming birthdays to use new system if it has data
                    if (relationshipSystem.people.length > 0) {
                        relationshipUI.displayUpcomingBirthdays();
                    }
                }
            } catch (error) {
                console.error('Error initializing relationship display:', error);
            }
        }

        // Logout function
        window.logout = function() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        };

        // Full-Screen Modal Functions
        window.closeFullScreenModal = function() {
            const modal = document.getElementById('fullScreenEditModal');
            if (modal) {
                modal.remove();
            }
        };

        window.updateFullScreenParentsCount = function() {
            const checkboxes = document.querySelectorAll('input[name="editParents"]:checked');
            const countElement = document.getElementById('fullScreenParentsCount');
            const allCheckboxes = document.querySelectorAll('input[name="editParents"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 2
                if (checkboxes.length >= 2) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        window.updateFullScreenChildrenCount = function() {
            const checkboxes = document.querySelectorAll('input[name="editChildren"]:checked');
            const countElement = document.getElementById('fullScreenChildrenCount');
            const allCheckboxes = document.querySelectorAll('input[name="editChildren"]');
            
            if (countElement) {
                countElement.textContent = checkboxes.length;
                
                // Disable unchecked checkboxes if we've reached the limit of 15
                if (checkboxes.length >= 15) {
                    allCheckboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    allCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        };

        window.submitFullScreenEdit = async function(event, memberId) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // Get selected parents and children
            const selectedParents = Array.from(document.querySelectorAll('input[name="editParents"]:checked')).map(cb => cb.value);
            const selectedChildren = Array.from(document.querySelectorAll('input[name="editChildren"]:checked')).map(cb => cb.value);
            
            // Get current member to check for marriage changes
            const currentMember = familyMembers.find(m => m.id === memberId);
            const oldSpouseId = currentMember?.marriedTo;
            const newSpouseId = data.marriedTo || null;
            
            try {
                // Update the member in Firestore
                const memberDoc = doc(db, 'family_members', memberId);
                await updateDoc(memberDoc, {
                    firstName: data.firstName,
                    lastName: data.lastName,
                    birthMonth: data.birthMonth,
                    birthDay: parseInt(data.birthDay),
                    birthYear: parseInt(data.birthYear),
                    familyBranch: data.familyBranch || null,
                    marriedTo: newSpouseId,
                    parents: selectedParents,
                    children: selectedChildren,
                    mobilePhone: data.mobilePhone || null,
                    homePhone: data.homePhone || null,
                    workPhone: data.workPhone || null,
                    email: data.email || null,
                    streetAddress: data.streetAddress || null,
                    city: data.city || null,
                    state: data.state || null,
                    zipCode: data.zipCode || null,
                    anniversaryDate: data.anniversaryDate || null,
                    notes: data.notes || null
                });

                // Update bidirectional marriage relationships
                await updateBidirectionalMarriage(memberId, oldSpouseId, newSpouseId);

                // Update bidirectional parent/child relationships
                await updateBidirectionalRelationships(memberId, selectedParents, selectedChildren);

                // Close modal and refresh data
                closeFullScreenModal();
                await loadData();
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member. Please try again.', 'error');
            }
        };

        // Initialize the app
        init();
    </script>
</body>
</html>
