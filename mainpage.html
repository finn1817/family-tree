<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree - Dashboard</title>
    <!-- SheetJS library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-badge {
            background: #e74c3c;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #f8f9ff;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            border-bottom-color: #4a5fd8;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .upcoming-birthdays {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .birthday-item:last-child {
            border-bottom: none;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 250px;
        }
        
        .filter-select {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .family-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .family-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .family-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .family-info div {
            padding: 0.25rem 0;
        }
        
        .family-info strong {
            color: #333;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Branch View Modal Specific Styles */
        #branchViewModal .modal-content {
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #branchMembersGrid {
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1rem;
        }

        #branchMembersGrid .family-card {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }

        #branchMembersGrid .family-card:hover {
            border-left-color: #20c997;
            transform: translateX(5px);
        }

        #branchSearchInput {
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        #branchSearchInput:focus {
            outline: none;
            border-color: #28a745;
            background: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .message-board {
            background: #f8f9ff;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .message {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-author {
            font-weight: 600;
            color: #667eea;
        }
        
        .message-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .bulk-import {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .import-area {
            width: 100%;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            font-family: monospace;
            margin: 1rem 0;
        }
        
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            background: white;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #4a5fd8;
            background: #f8f9ff;
        }
        
        .file-upload-area.dragover {
            border-color: #4a5fd8;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin: 1rem;
        }
        
        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .file-info {
            margin: 1rem 0;
            padding: 1rem;
            background: #e8f4fd;
            border-radius: 10px;
            display: none;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .preview-table tr:hover {
            background: #f8f9ff;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .family-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌳 Family Tree Dashboard</h1>
        <div class="user-info">
            <span id="username"></span>
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-container">
        <div class="upcoming-birthdays">
            <h2>🎂 Upcoming Birthdays</h2>
            <div id="upcomingBirthdays"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('family')">👨‍👩‍👧‍👦 Family Members</div>
            <div class="tab" onclick="switchTab('branches')">🌿 Family Branches</div>
            <div class="tab" onclick="switchTab('messages')">💬 Message Board</div>
            <div class="tab admin-only" onclick="switchTab('users')" style="display: none;">👥 Manage Users</div>
            <div class="tab admin-only" onclick="switchTab('import')" style="display: none;">📋 Bulk Import</div>
        </div>

        <div class="tab-content">
            <!-- Family Members Section -->
            <div id="family" class="section active">
                <div class="controls">
                    <div class="search-controls">
                        <input type="text" class="search-input" placeholder="Search family members..." id="searchInput">
                        <select class="filter-select" id="monthFilter">
                            <option value="">All Months</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-primary" onclick="openAddMemberModal()">+ Add Family Member</button>
                        <button class="btn btn-danger admin-only" onclick="removeAllFamilyMembers()" style="display: none; background: #dc3545; font-weight: bold;" id="deleteAllBtn">🗑️ DELETE ALL MEMBERS</button>
                    </div>
                </div>
                <div id="familyGrid" class="family-grid"></div>
            </div>

            <!-- Family Branches Section -->
            <div id="branches" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddBranchModal()">+ Add Family Branch</button>
                </div>
                <div id="branchesGrid" class="family-grid"></div>
            </div>

            <!-- Message Board Section -->
            <div id="messages" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddMessageModal()">+ Post Message</button>
                </div>
                <div class="message-board">
                    <div id="messagesContainer"></div>
                </div>
            </div>

            <!-- Users Management Section (Admin Only) -->
            <div id="users" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddUserModal()">+ Add New User</button>
                </div>
                <div id="usersGrid" class="family-grid"></div>
            </div>

            <!-- Bulk Import Section (Admin Only) -->
            <div id="import" class="section">
                <div class="bulk-import">
                    <h3>📋 Bulk Import Family Data</h3>
                    <p>Upload your Excel file (.xlsx, .xls) to automatically import family member data:</p>
                    
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="file-upload-content">
                            <h4>📎 Drop Excel file here or click to browse</h4>
                            <p>Supported formats: .xlsx, .xls</p>
                            <label for="excelFile" class="file-upload-btn">Choose Excel File</label>
                            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        </div>
                    </div>
                    
                    <div id="fileInfo" class="file-info">
                        <p><strong>File:</strong> <span id="fileName"></span></p>
                        <p><strong>Size:</strong> <span id="fileSize"></span></p>
                        <p><strong>Rows found:</strong> <span id="rowCount"></span></p>
                    </div>
                    
                    <div id="previewContainer" style="display: none;">
                        <h4>Preview Data (First 5 rows):</h4>
                        <div style="overflow-x: auto;">
                            <table id="previewTable" class="preview-table">
                                <thead>
                                    <tr>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Month</th>
                                        <th>Day</th>
                                        <th>Year</th>
                                        <th>Column G (Ignored)</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="confirmImport()" id="importBtn" style="margin-top: 1rem;">Import All Data</button>
                        <button class="btn btn-primary" onclick="clearFile()" style="margin-top: 1rem; margin-left: 0.5rem;">Choose Different File</button>
                        <button class="btn" onclick="testDatabase()" style="margin-top: 1rem; margin-left: 0.5rem; background: #ffc107; color: #000;">Test Database</button>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 10px; text-align: left;">
                        <h4>📝 Excel File Format Requirements:</h4>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li><strong>Column A:</strong> First Name</li>
                            <li><strong>Column B:</strong> Last Name</li>
                            <li><strong>Column C:</strong> Birth Month (e.g., "January", "February")</li>
                            <li><strong>Column D:</strong> Birth Day (1-31)</li>
                            <li><strong>Column E:</strong> Birth Year (e.g., 1990)</li>
                            <li><strong>Column G:</strong> Will be ignored during import</li>
                        </ul>
                        <p><em>Note: Family branches will be empty after import - organize into families later using the Family Branches tab</em></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Member</h2>
            <form id="addMemberForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="birthMonth">Birth Month *</label>
                        <select id="birthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDay">Birth Day *</label>
                        <input type="number" id="birthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="birthYear">Birth Year *</label>
                        <input type="number" id="birthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="familyBranch">Family Branch</label>
                        <select id="familyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relationship">Relationship</label>
                        <select id="relationship">
                            <option value="">Select Relationship</option>
                            <option value="spouse">Spouse</option>
                            <option value="parent">Parent</option>
                            <option value="child">Child</option>
                            <option value="sibling">Sibling</option>
                            <option value="grandparent">Grandparent</option>
                            <option value="grandchild">Grandchild</option>
                            <option value="aunt_uncle">Aunt/Uncle</option>
                            <option value="niece_nephew">Niece/Nephew</option>
                            <option value="cousin">Cousin</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relatedTo">Related To</label>
                        <select id="relatedTo">
                            <option value="">Select Person</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mobilePhone">Mobile Phone</label>
                        <input type="tel" id="mobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="homePhone">Home Phone</label>
                        <input type="tel" id="homePhone">
                    </div>
                    <div class="form-group">
                        <label for="workPhone">Work Phone</label>
                        <input type="tel" id="workPhone">
                    </div>
                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" id="state">
                    </div>
                    <div class="form-group">
                        <label for="zipCode">Zip Code</label>
                        <input type="text" id="zipCode">
                    </div>
                    <div class="form-group">
                        <label for="anniversaryDate">Anniversary Date</label>
                        <input type="date" id="anniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h2>Edit Family Member</h2>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFirstName">First Name *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name *</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthMonth">Birth Month *</label>
                        <select id="editBirthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBirthDay">Birth Day *</label>
                        <input type="number" id="editBirthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthYear">Birth Year *</label>
                        <input type="number" id="editBirthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="editFamilyBranch">Family Branch</label>
                        <select id="editFamilyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editRelationship">Relationship</label>
                        <select id="editRelationship">
                            <option value="">Select Relationship</option>
                            <option value="spouse">Spouse</option>
                            <option value="parent">Parent</option>
                            <option value="child">Child</option>
                            <option value="sibling">Sibling</option>
                            <option value="grandparent">Grandparent</option>
                            <option value="grandchild">Grandchild</option>
                            <option value="aunt_uncle">Aunt/Uncle</option>
                            <option value="niece_nephew">Niece/Nephew</option>
                            <option value="cousin">Cousin</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editRelatedTo">Related To</label>
                        <select id="editRelatedTo">
                            <option value="">Select Person</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMobilePhone">Mobile Phone</label>
                        <input type="tel" id="editMobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="editHomePhone">Home Phone</label>
                        <input type="tel" id="editHomePhone">
                    </div>
                    <div class="form-group">
                        <label for="editWorkPhone">Work Phone</label>
                        <input type="tel" id="editWorkPhone">
                    </div>
                    <div class="form-group">
                        <label for="editAddress">Street Address</label>
                        <input type="text" id="editAddress">
                    </div>
                    <div class="form-group">
                        <label for="editCity">City</label>
                        <input type="text" id="editCity">
                    </div>
                    <div class="form-group">
                        <label for="editState">State</label>
                        <input type="text" id="editState">
                    </div>
                    <div class="form-group">
                        <label for="editZipCode">Zip Code</label>
                        <input type="text" id="editZipCode">
                    </div>
                    <div class="form-group">
                        <label for="editAnniversaryDate">Anniversary Date</label>
                        <input type="date" id="editAnniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('editMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Branch Modal -->
    <div id="addBranchModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Branch</h2>
            <form id="addBranchForm">
                <div class="form-group">
                    <label for="branchName">Branch Name *</label>
                    <input type="text" id="branchName" required placeholder="e.g., Smith Family, Johnson Branch">
                </div>
                <div class="form-group">
                    <label for="branchDescription">Description</label>
                    <textarea id="branchDescription" placeholder="Description of this family branch"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addBranchModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Branch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal (Admin Only) -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Add New User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUsername">Username * (min 5 characters)</label>
                    <input type="text" id="newUsername" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password * (min 5 characters)</label>
                    <input type="password" id="newPassword" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="userPhone">Phone</label>
                    <input type="tel" id="userPhone">
                </div>
                <div class="form-group">
                    <label for="isAdmin">Admin Status</label>
                    <select id="isAdmin">
                        <option value="0">Regular User</option>
                        <option value="1">Administrator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Message Modal -->
    <div id="addMessageModal" class="modal">
        <div class="modal-content">
            <h2>Post Message</h2>
            <form id="addMessageForm">
                <div class="form-group">
                    <label for="messageTitle">Title</label>
                    <input type="text" id="messageTitle" placeholder="Message title (optional)">
                </div>
                <div class="form-group">
                    <label for="messageContent">Message *</label>
                    <textarea id="messageContent" required placeholder="Write your message here..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMessageModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Branch View Modal -->
    <div id="branchViewModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="branchViewTitle">Branch Members</h2>
                <button class="btn" onclick="closeModal('branchViewModal')" style="background: #6c757d; color: white;">✕ Close</button>
            </div>
            
            <div id="branchStats" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: white;" id="branchStatsName">Branch Name</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;" id="branchStatsCount">0 family members</p>
                    </div>
                    <div style="font-size: 3rem; opacity: 0.7;">🌿</div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <input type="text" id="branchSearchInput" placeholder="Search branch members..." style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
            </div>

            <div id="branchMembersGrid" class="family-grid" style="max-height: 70vh; overflow-y: auto;"></div>
            
            <div id="noBranchMembers" style="display: none; text-align: center; padding: 2rem; color: #6c757d;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">👥</div>
                <h3>No family members in this branch yet</h3>
                <p>Add family members and assign them to this branch to see them here.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase using the correct v9+ modular syntax
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCWtVYdOiggwqw5CNMJbM13BdeLtwqBhbs",
            authDomain: "family-tree-6f16b.firebaseapp.com",
            projectId: "family-tree-6f16b",
            storageBucket: "family-tree-6f16b.firebasestorage.app",
            messagingSenderId: "801170939057",
            appId: "1:801170939057:web:87d35d8156789631f69690"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let familyMembers = [];
        let familyBranches = [];
        let users = [];
        let messages = [];

        // Initialize the app
        async function init() {
            // Check if user is logged in
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('username').textContent = currentUser.username;
            
            if (currentUser.isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }

            await loadData();
            setupEventListeners();
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadFamilyMembers(),
                loadFamilyBranches(),
                loadUsers(),
                loadMessages()
            ]);
            
            displayFamilyMembers();
            displayBranches();
            displayUsers();
            displayMessages();
            displayUpcomingBirthdays();
            populateDropdowns();
        }

        // Load family members
        async function loadFamilyMembers() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_members'));
                familyMembers = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family members:', error);
            }
        }

        // Load family branches
        async function loadFamilyBranches() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_branches'));
                familyBranches = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family branches:', error);
            }
        }

        // Load users (admin only)
        async function loadUsers() {
            if (!currentUser.isAdmin) return;
            
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                users = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(20));
                const querySnapshot = await getDocs(q);
                messages = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display family members
        function displayFamilyMembers() {
            const grid = document.getElementById('familyGrid');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const monthFilter = document.getElementById('monthFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;

            let filtered = familyMembers.filter(member => {
                const matchesSearch = !searchTerm || 
                    member.firstName.toLowerCase().includes(searchTerm) ||
                    member.lastName.toLowerCase().includes(searchTerm);
                const matchesMonth = !monthFilter || member.birthMonth === monthFilter;
                const matchesBranch = !branchFilter || member.familyBranch === branchFilter;
                
                return matchesSearch && matchesMonth && matchesBranch;
            });

            grid.innerHTML = filtered.map(member => `
                <div class="family-card">
                    <h3>${member.firstName} ${member.lastName}</h3>
                    <div class="family-info">
                        <div><strong>Birthday:</strong> ${member.birthMonth} ${member.birthDay}, ${member.birthYear}</div>
                        <div><strong>Branch:</strong> ${member.familyBranch || 'None'}</div>
                        <div><strong>Relationship:</strong> ${member.relationship || 'Not specified'}</div>
                        <div><strong>Mobile:</strong> ${member.mobilePhone || 'N/A'}</div>
                        <div><strong>Home:</strong> ${member.homePhone || 'N/A'}</div>
                        <div><strong>Work:</strong> ${member.workPhone || 'N/A'}</div>
                        <div><strong>Address:</strong> ${member.address || 'N/A'}</div>
                        <div><strong>City:</strong> ${member.city || 'N/A'}</div>
                        <div><strong>State:</strong> ${member.state || 'N/A'}</div>
                        <div><strong>Zip:</strong> ${member.zipCode || 'N/A'}</div>
                        <div><strong>Anniversary:</strong> ${member.anniversaryDate || 'N/A'}</div>
                        <div class="full-width"><strong>Notes:</strong> ${member.notes || 'None'}</div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Display branches
        function displayBranches() {
            const grid = document.getElementById('branchesGrid');
            grid.innerHTML = familyBranches.map(branch => {
                const membersInBranch = familyMembers.filter(member => member.familyBranch === branch.name);
                return `
                    <div class="family-card">
                        <h3>${branch.name}</h3>
                        <p>${branch.description || 'No description'}</p>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 5px;">
                            <small><strong>Members:</strong> ${membersInBranch.length} people</small>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="viewBranchMembers('${branch.name}')" style="background: #28a745;">
                                👁️ View Branch
                            </button>
                            <button class="btn btn-danger" onclick="deleteBranch('${branch.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Display users (admin only)
        function displayUsers() {
            if (!currentUser.isAdmin) return;
            
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = users.map(user => `
                <div class="family-card">
                    <h3>${user.fullName || user.username}</h3>
                    <div class="family-info">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Email:</strong> ${user.email || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${user.phone || 'N/A'}</div>
                        <div><strong>Admin:</strong> ${user.isAdmin ? 'Yes' : 'No'}</div>
                        <div><strong>Created:</strong> ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Display messages
        function displayMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map(message => `
                <div class="message">
                    <div class="message-header">
                        <span class="message-author">${message.author}</span>
                        <span class="message-date">${new Date(message.createdAt.seconds * 1000).toLocaleDateString()}</span>
                    </div>
                    ${message.title ? `<h4>${message.title}</h4>` : ''}
                    <p>${message.content}</p>
                    ${currentUser.isAdmin ? `<button class="btn btn-danger" onclick="deleteMessage('${message.id}')">Delete</button>` : ''}
                </div>
            `).join('');
        }

        // Display upcoming birthdays
        function displayUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdays');
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // Calculate upcoming birthdays
            const upcoming = familyMembers.map(member => {
                const monthIndex = new Date(Date.parse(member.birthMonth + " 1, 2000")).getMonth();
                let birthdayThisYear = new Date(currentYear, monthIndex, member.birthDay);
                
                if (birthdayThisYear < today) {
                    birthdayThisYear = new Date(currentYear + 1, monthIndex, member.birthDay);
                }
                
                return {
                    ...member,
                    nextBirthday: birthdayThisYear,
                    daysUntil: Math.ceil((birthdayThisYear - today) / (1000 * 60 * 60 * 24))
                };
            }).sort((a, b) => a.nextBirthday - b.nextBirthday).slice(0, 5);

            container.innerHTML = upcoming.map(member => `
                <div class="birthday-item">
                    <span>${member.firstName} ${member.lastName}</span>
                    <span>${member.birthMonth} ${member.birthDay} (${member.daysUntil} days)</span>
                </div>
            `).join('');
        }

        // Populate dropdowns
        function populateDropdowns() {
            // Family branch dropdown
            const branchSelects = [
                document.getElementById('familyBranch'),
                document.getElementById('editFamilyBranch'),
                document.getElementById('branchFilter')
            ];
            
            branchSelects.forEach(select => {
                if (select) {
                    const currentOptions = Array.from(select.options).map(opt => opt.value);
                    familyBranches.forEach(branch => {
                        if (!currentOptions.includes(branch.name)) {
                            const option = document.createElement('option');
                            option.value = branch.name;
                            option.textContent = branch.name;
                            select.appendChild(option);
                        }
                    });
                }
            });

            // Related to dropdown
            const relatedSelects = [
                document.getElementById('relatedTo'),
                document.getElementById('editRelatedTo')
            ];
            
            relatedSelects.forEach(relatedSelect => {
                if (relatedSelect) {
                    relatedSelect.innerHTML = '<option value="">Select Person</option>';
                    familyMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.firstName} ${member.lastName}`;
                        relatedSelect.appendChild(option);
                    });
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search and filter
            document.getElementById('searchInput').addEventListener('input', displayFamilyMembers);
            document.getElementById('monthFilter').addEventListener('change', displayFamilyMembers);
            document.getElementById('branchFilter').addEventListener('change', displayFamilyMembers);

            // Add member form
            document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addFamilyMember();
            });

            // Add branch form
            document.getElementById('addBranchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addFamilyBranch();
            });

            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addUser();
            });

            // Add message form
            document.getElementById('addMessageForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addMessage();
            });

            // Edit member form
            document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateFamilyMember();
            });
        }

        // Add family member
        async function addFamilyMember() {
            try {
                const memberData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    birthMonth: document.getElementById('birthMonth').value,
                    birthDay: parseInt(document.getElementById('birthDay').value),
                    birthYear: parseInt(document.getElementById('birthYear').value),
                    familyBranch: document.getElementById('familyBranch').value,
                    relationship: document.getElementById('relationship').value,
                    relatedTo: document.getElementById('relatedTo').value,
                    mobilePhone: document.getElementById('mobilePhone').value,
                    homePhone: document.getElementById('homePhone').value,
                    workPhone: document.getElementById('workPhone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value,
                    anniversaryDate: document.getElementById('anniversaryDate').value,
                    notes: document.getElementById('notes').value,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_members'), memberData);
                closeModal('addMemberModal');
                document.getElementById('addMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                populateDropdowns();
                alert('Family member added successfully!');
            } catch (error) {
                alert('Error adding family member: ' + error.message);
            }
        }

        // Update family member
        async function updateFamilyMember() {
            try {
                const memberId = document.getElementById('editMemberId').value;
                const memberData = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    birthMonth: document.getElementById('editBirthMonth').value,
                    birthDay: parseInt(document.getElementById('editBirthDay').value),
                    birthYear: parseInt(document.getElementById('editBirthYear').value),
                    familyBranch: document.getElementById('editFamilyBranch').value,
                    relationship: document.getElementById('editRelationship').value,
                    relatedTo: document.getElementById('editRelatedTo').value,
                    mobilePhone: document.getElementById('editMobilePhone').value,
                    homePhone: document.getElementById('editHomePhone').value,
                    workPhone: document.getElementById('editWorkPhone').value,
                    address: document.getElementById('editAddress').value,
                    city: document.getElementById('editCity').value,
                    state: document.getElementById('editState').value,
                    zipCode: document.getElementById('editZipCode').value,
                    anniversaryDate: document.getElementById('editAnniversaryDate').value,
                    notes: document.getElementById('editNotes').value,
                    updatedAt: new Date(),
                    updatedBy: currentUser.username
                };

                await updateDoc(doc(db, 'family_members', memberId), memberData);
                closeModal('editMemberModal');
                document.getElementById('editMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                populateDropdowns();
                alert('Family member updated successfully!');
            } catch (error) {
                alert('Error updating family member: ' + error.message);
            }
        }

        // Add family branch
        async function addFamilyBranch() {
            try {
                const branchData = {
                    name: document.getElementById('branchName').value,
                    description: document.getElementById('branchDescription').value,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_branches'), branchData);
                closeModal('addBranchModal');
                document.getElementById('addBranchForm').reset();
                await loadFamilyBranches();
                displayBranches();
                populateDropdowns();
                alert('Family branch added successfully!');
            } catch (error) {
                alert('Error adding family branch: ' + error.message);
            }
        }

        // Add user (admin only)
        async function addUser() {
            if (!currentUser.isAdmin) return;

            try {
                const userData = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('userPhone').value,
                    isAdmin: parseInt(document.getElementById('isAdmin').value),
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'users'), userData);
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                await loadUsers();
                displayUsers();
                alert('User added successfully!');
            } catch (error) {
                alert('Error adding user: ' + error.message);
            }
        }

        // Add message
        async function addMessage() {
            try {
                const messageData = {
                    title: document.getElementById('messageTitle').value,
                    content: document.getElementById('messageContent').value,
                    author: currentUser.username,
                    createdAt: new Date()
                };

                await addDoc(collection(db, 'messages'), messageData);
                closeModal('addMessageModal');
                document.getElementById('addMessageForm').reset();
                await loadMessages();
                displayMessages();
                alert('Message posted successfully!');
            } catch (error) {
                alert('Error posting message: ' + error.message);
            }
        }

        // Bulk import
        let selectedFileData = null;

        // File upload handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        // Drag and drop handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processExcelFile(files[0]);
            }
        });

        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON (array of arrays)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Filter out empty rows
                    const filteredData = jsonData.filter(row => 
                        row.length > 0 && row.some(cell => cell && cell.toString().trim())
                    );
                    
                    if (filteredData.length === 0) {
                        alert('No data found in the Excel file');
                        return;
                    }
                    
                    selectedFileData = filteredData;
                    displayFileInfo(file, filteredData.length);
                    displayPreview(filteredData);
                    
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayFileInfo(file, rowCount) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('rowCount').textContent = rowCount;
            document.getElementById('fileInfo').style.display = 'block';
        }

        function displayPreview(data) {
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            // Show first 5 rows (skip header if it exists)
            const startRow = (data[0] && typeof data[0][0] === 'string' && data[0][0].toLowerCase().includes('name')) ? 1 : 0;
            const previewRows = data.slice(startRow, startRow + 5);
            
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                
                // Map columns: A, B, C, D, E, skip F, G
                const firstName = row[0] || '';
                const lastName = row[1] || '';
                const month = row[2] || '';
                const day = row[3] || '';
                const year = row[4] || '';
                const columnG = row[6] || ''; // Column G (shows what's there but won't be imported)
                
                tr.innerHTML = `
                    <td>${firstName}</td>
                    <td>${lastName}</td>
                    <td>${month}</td>
                    <td>${day}</td>
                    <td>${year}</td>
                    <td style="opacity: 0.5; font-style: italic;">${columnG}<br><small>(ignored)</small></td>
                `;
                previewBody.appendChild(tr);
            });
            
            document.getElementById('previewContainer').style.display = 'block';
        }

        async function confirmImport() {
            console.log('confirmImport called');
            
            if (!currentUser.isAdmin) {
                alert('Only admin users can import data');
                return;
            }
            
            if (!selectedFileData) {
                alert('No file data selected');
                return;
            }

            console.log('Selected file data length:', selectedFileData.length);

            const confirmMessage = `Are you sure you want to import ${selectedFileData.length} records? This will add all valid entries to the database.`;
            if (!confirm(confirmMessage)) return;

            // Show loading message
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.textContent;
            importBtn.textContent = 'Importing...';
            importBtn.disabled = true;

            try {
                let imported = 0;
                let skipped = 0;
                
                // Skip header row if it exists
                const startRow = (selectedFileData[0] && typeof selectedFileData[0][0] === 'string' && 
                                selectedFileData[0][0].toLowerCase().includes('name')) ? 1 : 0;
                
                const dataRows = selectedFileData.slice(startRow);
                console.log('Processing', dataRows.length, 'rows');
                
                for (const row of dataRows) {
                    try {
                        // Map columns: A, B, C, D, E, skip F, G
                        const firstName = row[0]?.toString().trim() || '';
                        const lastName = row[1]?.toString().trim() || '';
                        const month = row[2]?.toString().trim() || '';
                        const day = parseInt(row[3]) || 1;
                        const year = parseInt(row[4]) || new Date().getFullYear();
                        // Note: Column G in your data appears to be birthday dates, not family branches
                        // We'll leave familyBranch empty for now and you can organize families later
                        
                        // Only import if we have at least first and last name
                        if (firstName && lastName) {
                            const memberData = {
                                firstName: firstName,
                                lastName: lastName,
                                birthMonth: month,
                                birthDay: day,
                                birthYear: year,
                                familyBranch: '', // Leave empty - you'll organize into families later
                                relationship: '', // Can be updated later
                                relatedTo: '',
                                mobilePhone: '',
                                homePhone: '',
                                workPhone: '',
                                address: '',
                                city: '',
                                state: '',
                                zipCode: '',
                                anniversaryDate: '',
                                notes: '',
                                createdAt: new Date(),
                                createdBy: currentUser.username
                            };

                            console.log('Adding member:', firstName, lastName);
                            await addDoc(collection(db, 'family_members'), memberData);
                            imported++;
                        } else {
                            console.log('Skipping row - missing name:', firstName, lastName);
                            skipped++;
                        }
                    } catch (rowError) {
                        console.error('Error processing row:', row, rowError);
                        skipped++;
                    }
                }

                console.log('Import completed. Imported:', imported, 'Skipped:', skipped);

                // Clear the file selection
                clearFile();
                
                // Refresh the display
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                
                alert(`Import completed!\nImported: ${imported} family members\nSkipped: ${skipped} incomplete records`);
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing data: ' + error.message);
            } finally {
                // Restore button
                importBtn.textContent = originalText;
                importBtn.disabled = false;
            }
        }

        // Make sure the function is globally accessible
        window.confirmImport = confirmImport;

        function clearFile() {
            selectedFileData = null;
            document.getElementById('excelFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('previewContainer').style.display = 'none';
        }

        // Make sure functions are globally accessible
        window.handleFileSelect = handleFileSelect;
        window.clearFile = clearFile;
        
        // Test function to verify database connectivity
        window.testDatabase = async function() {
            try {
                console.log('Testing database connection...');
                
                // Just try to read from the users collection (which we know exists)
                const usersSnapshot = await getDocs(collection(db, 'users'));
                console.log('Successfully connected to database. Found', usersSnapshot.size, 'users');
                
                // Try to read from family_members collection (might not exist yet)
                const familySnapshot = await getDocs(collection(db, 'family_members'));
                console.log('Family members collection exists. Found', familySnapshot.size, 'members');
                
                alert(`Database connection successful!\nUsers: ${usersSnapshot.size}\nFamily Members: ${familySnapshot.size}`);
                
            } catch (error) {
                console.error('Database test failed:', error);
                alert('Database test failed: ' + error.message + '\n\nThis might be a Firestore security rules issue.');
            }
        };

        // Legacy bulk import function (keeping for backward compatibility)
        async function bulkImport() {
            if (!currentUser.isAdmin) return;

            const data = document.getElementById('importData').value;
            if (!data.trim()) {
                alert('Please paste data to import');
                return;
            }

            try {
                const lines = data.split('\n').filter(line => line.trim());
                let imported = 0;

                for (const line of lines) {
                    const fields = line.split('\t');
                    if (fields.length >= 5) {
                        const memberData = {
                            firstName: fields[0]?.trim() || '',
                            lastName: fields[1]?.trim() || '',
                            birthMonth: fields[2]?.trim() || '',
                            birthDay: parseInt(fields[3]?.trim()) || 1,
                            birthYear: parseInt(fields[4]?.trim()) || new Date().getFullYear(),
                            familyBranch: fields[5]?.trim() || '',
                            relationship: fields[6]?.trim() || '',
                            createdAt: new Date(),
                            createdBy: currentUser.username
                        };

                        if (memberData.firstName && memberData.lastName) {
                            await addDoc(collection(db, 'family_members'), memberData);
                            imported++;
                        }
                    }
                }

                document.getElementById('importData').value = '';
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully imported ${imported} family members!`);
            } catch (error) {
                alert('Error importing data: ' + error.message);
            }
        }

        // Delete functions
        window.deleteFamilyMember = async function(id) {
            if (confirm('Are you sure you want to delete this family member?')) {
                try {
                    await deleteDoc(doc(db, 'family_members', id));
                    await loadFamilyMembers();
                    displayFamilyMembers();
                    displayUpcomingBirthdays();
                    alert('Family member deleted successfully!');
                } catch (error) {
                    alert('Error deleting family member: ' + error.message);
                }
            }
        };

        window.deleteBranch = async function(id) {
            if (confirm('Are you sure you want to delete this branch?')) {
                try {
                    await deleteDoc(doc(db, 'family_branches', id));
                    await loadFamilyBranches();
                    displayBranches();
                    populateDropdowns();
                    alert('Branch deleted successfully!');
                } catch (error) {
                    alert('Error deleting branch: ' + error.message);
                }
            }
        };

        window.deleteUser = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await deleteDoc(doc(db, 'users', id));
                    await loadUsers();
                    displayUsers();
                    alert('User deleted successfully!');
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        };

        window.deleteMessage = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await deleteDoc(doc(db, 'messages', id));
                    await loadMessages();
                    displayMessages();
                    alert('Message deleted successfully!');
                } catch (error) {
                    alert('Error deleting message: ' + error.message);
                }
            }
        };

        // Remove all family members (admin only)
        window.removeAllFamilyMembers = async function() {
            console.log('removeAllFamilyMembers called');
            console.log('Current user:', currentUser);
            console.log('Is admin:', currentUser?.isAdmin);
            console.log('Family members count:', familyMembers.length);
            
            if (!currentUser || !currentUser.isAdmin) {
                alert('Only admin users can delete all family members');
                return;
            }
            
            if (familyMembers.length === 0) {
                alert('No family members to delete');
                return;
            }
            
            const confirmMessage = `⚠️ DANGER: This will permanently delete ALL ${familyMembers.length} family members from the database!\n\nThis action cannot be undone. Are you absolutely sure?`;
            if (!confirm(confirmMessage)) return;
            
            const doubleConfirm = prompt('Type "DELETE ALL" to confirm this dangerous action:');
            if (doubleConfirm !== 'DELETE ALL') {
                alert('Action cancelled - text did not match exactly.');
                return;
            }
            
            try {
                let deleted = 0;
                console.log('Starting deletion process...');
                
                for (const member of familyMembers) {
                    console.log('Deleting member:', member.firstName, member.lastName, 'ID:', member.id);
                    await deleteDoc(doc(db, 'family_members', member.id));
                    deleted++;
                }
                
                console.log('Deletion completed. Refreshing data...');
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully deleted ${deleted} family members. Database is now clean for proper import.`);
            } catch (error) {
                console.error('Error deleting family members:', error);
                alert('Error deleting family members: ' + error.message);
            }
        };

        // Modal functions
        window.openAddMemberModal = function() {
            document.getElementById('addMemberModal').classList.add('active');
        };

        window.openAddBranchModal = function() {
            document.getElementById('addBranchModal').classList.add('active');
        };

        window.openAddUserModal = function() {
            if (!currentUser.isAdmin) return;
            document.getElementById('addUserModal').classList.add('active');
        };

        window.openAddMessageModal = function() {
            document.getElementById('addMessageModal').classList.add('active');
        };

        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                alert('Family member not found');
                return;
            }

            // Populate the edit form with existing data
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editFirstName').value = member.firstName || '';
            document.getElementById('editLastName').value = member.lastName || '';
            document.getElementById('editBirthMonth').value = member.birthMonth || '';
            document.getElementById('editBirthDay').value = member.birthDay || '';
            document.getElementById('editBirthYear').value = member.birthYear || '';
            document.getElementById('editFamilyBranch').value = member.familyBranch || '';
            document.getElementById('editRelationship').value = member.relationship || '';
            document.getElementById('editRelatedTo').value = member.relatedTo || '';
            document.getElementById('editMobilePhone').value = member.mobilePhone || '';
            document.getElementById('editHomePhone').value = member.homePhone || '';
            document.getElementById('editWorkPhone').value = member.workPhone || '';
            document.getElementById('editAddress').value = member.address || '';
            document.getElementById('editCity').value = member.city || '';
            document.getElementById('editState').value = member.state || '';
            document.getElementById('editZipCode').value = member.zipCode || '';
            document.getElementById('editAnniversaryDate').value = member.anniversaryDate || '';
            document.getElementById('editNotes').value = member.notes || '';

            // Show the modal
            document.getElementById('editMemberModal').classList.add('active');
        };

        window.viewBranchMembers = function(branchName) {
            const branchMembers = familyMembers.filter(member => member.familyBranch === branchName);
            
            // Update modal title and stats
            document.getElementById('branchViewTitle').textContent = `${branchName} - Family Members`;
            document.getElementById('branchStatsName').textContent = branchName;
            document.getElementById('branchStatsCount').textContent = `${branchMembers.length} family member${branchMembers.length !== 1 ? 's' : ''}`;
            
            // Clear search input
            document.getElementById('branchSearchInput').value = '';
            
            // Display members or no members message
            if (branchMembers.length === 0) {
                document.getElementById('branchMembersGrid').style.display = 'none';
                document.getElementById('noBranchMembers').style.display = 'block';
            } else {
                document.getElementById('branchMembersGrid').style.display = 'grid';
                document.getElementById('noBranchMembers').style.display = 'none';
                displayBranchMembers(branchMembers);
            }
            
            // Show the modal
            document.getElementById('branchViewModal').classList.add('active');
            
            // Set up search functionality for this branch
            const searchInput = document.getElementById('branchSearchInput');
            searchInput.oninput = function() {
                const searchTerm = this.value.toLowerCase();
                const filteredMembers = branchMembers.filter(member => 
                    member.firstName.toLowerCase().includes(searchTerm) ||
                    member.lastName.toLowerCase().includes(searchTerm) ||
                    (member.relationship && member.relationship.toLowerCase().includes(searchTerm))
                );
                displayBranchMembers(filteredMembers);
            };
        };

        function displayBranchMembers(members) {
            const grid = document.getElementById('branchMembersGrid');
            grid.innerHTML = members.map(member => `
                <div class="family-card" style="border-left: 4px solid #28a745;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem; color: #28a745;">${member.firstName} ${member.lastName}</h3>
                            <div class="family-info" style="font-size: 0.9rem;">
                                <div><strong>🎂 Birthday:</strong> ${member.birthMonth} ${member.birthDay}, ${member.birthYear}</div>
                                ${member.relationship ? `<div><strong>👪 Relationship:</strong> ${member.relationship}</div>` : ''}
                                ${member.mobilePhone ? `<div><strong>📱 Mobile:</strong> ${member.mobilePhone}</div>` : ''}
                                ${member.homePhone ? `<div><strong>🏠 Home:</strong> ${member.homePhone}</div>` : ''}
                                ${member.workPhone ? `<div><strong>💼 Work:</strong> ${member.workPhone}</div>` : ''}
                                ${member.address ? `<div><strong>📍 Address:</strong> ${member.address}${member.city ? `, ${member.city}` : ''}${member.state ? `, ${member.state}` : ''}</div>` : ''}
                                ${member.anniversaryDate ? `<div><strong>💒 Anniversary:</strong> ${member.anniversaryDate}</div>` : ''}
                                ${member.notes ? `<div style="margin-top: 0.5rem;"><strong>📝 Notes:</strong> ${member.notes}</div>` : ''}
                            </div>
                        </div>
                        <div style="margin-left: 1rem;">
                            <div style="font-size: 2rem; opacity: 0.6;">👤</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="font-size: 0.85rem;">✏️ Edit</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="font-size: 0.85rem;">🗑️ Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        // Tab switching
        window.switchTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        };

        // Logout function
        window.logout = function() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        };

        // Initialize the app
        init();
    </script>
</body>
</html>
