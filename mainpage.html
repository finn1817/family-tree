<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree - Dashboard</title>
    <!-- SheetJS library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .admin-badge {
            background: #e74c3c;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #f8f9ff;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            border-bottom-color: #4a5fd8;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .upcoming-birthdays {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .birthday-item:last-child {
            border-bottom: none;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 250px;
        }
        
        .filter-select {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .family-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .family-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .family-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .family-info div {
            padding: 0.25rem 0;
        }
        
        .family-info strong {
            color: #333;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Branch View Modal Specific Styles */
        #branchViewModal .modal-content {
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #branchMembersGrid {
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1rem;
        }

        #branchMembersGrid .family-card {
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }

        #branchMembersGrid .family-card:hover {
            border-left-color: #20c997;
            transform: translateX(5px);
        }

        #branchSearchInput {
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        #branchSearchInput:focus {
            outline: none;
            border-color: #28a745;
            background: white;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        /* Management Modal Styles */
        .manage-tab-content {
            min-height: 300px;
        }

        #manageBranchModal .tab {
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 0.25rem;
            font-size: 0.9rem;
        }

        #manageBranchModal .tab.active {
            background: white;
            border-bottom: 2px solid #007bff;
        }

        #moveCandidates input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        .message-board {
            background: #f8f9ff;
            border: 1px solid #e0e6ed;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .message {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-author {
            font-weight: 600;
            color: #667eea;
        }
        
        .message-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .bulk-import {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .import-area {
            width: 100%;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            font-family: monospace;
            margin: 1rem 0;
        }
        
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            background: white;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #4a5fd8;
            background: #f8f9ff;
        }
        
        .file-upload-area.dragover {
            border-color: #4a5fd8;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin: 1rem;
        }
        
        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .file-info {
            margin: 1rem 0;
            padding: 1rem;
            background: #e8f4fd;
            border-radius: 10px;
            display: none;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .preview-table tr:hover {
            background: #f8f9ff;
        }
        
        /* New Relationship System Styles */
        .relationship-section {
            display: none;
        }
        
        .relationship-section.active {
            display: block;
        }
        
        .relationship-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .relationship-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            background: #f8f9fa;
        }
        
        .relationship-tab:hover {
            background: #e9ecef;
        }
        
        .relationship-tab.active {
            background: #28a745;
            color: white;
            border-bottom-color: #20c997;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .search-input {
                min-width: auto;
            }
            
            .family-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≥ Family Tree Dashboard</h1>
        <div class="user-info">
            <span id="username"></span>
            <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-container">
        <div class="upcoming-birthdays">
            <h2>üéÇ Upcoming Birthdays</h2>
            <div id="upcomingBirthdays"></div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('family')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Members</div>
            <div class="tab" onclick="switchTab('branches')">üåø Family Groups</div>
            <div class="tab" onclick="switchTab('messages')">üí¨ Message Board</div>
            <div class="tab admin-only" onclick="switchTab('users')" style="display: none;">üë• Manage Users</div>
            <div class="tab admin-only" onclick="switchTab('import')" style="display: none;">üìã Bulk Import</div>
        </div>

        <div class="tab-content">
            <!-- Family Members Section -->
            <div id="family" class="section active">
                <div class="controls">
                    <div class="search-controls">
                        <input type="text" class="search-input" placeholder="Search family members..." id="searchInput">
                        <select class="filter-select" id="monthFilter">
                            <option value="">All Months</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                        <select class="filter-select" id="sortOrder">
                            <option value="name">Sort by Name</option>
                            <option value="age-oldest">Sort by Age (Oldest First)</option>
                            <option value="age-youngest">Sort by Age (Youngest First)</option>
                            <option value="birthday">Sort by Upcoming Birthday</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-primary" onclick="openAddMemberModal()">+ Add Family Member</button>
                        <button class="btn btn-danger admin-only" onclick="removeAllFamilyMembers()" style="display: none; background: #dc3545; font-weight: bold;" id="deleteAllBtn">üóëÔ∏è DELETE ALL MEMBERS</button>
                    </div>
                </div>
                <div id="familyGrid" class="family-grid"></div>
            </div>

            <!-- Family Groups Section -->
            <div id="branches" class="section">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                    <h2 style="margin-bottom: 0.5rem;">üåø Family Groups by Generation</h2>
                    <p style="margin: 0; opacity: 0.9;">Organize your family into generational groups - perfect for grandparents to see everyone!</p>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddBranchModal()">+ Create Family Group</button>
                    <button class="btn" onclick="autoCreateGenerations()" style="background: #28a745; color: white;">üîÑ Auto-Create Generations</button>
                </div>
                
                <div id="branchesGrid" class="family-grid"></div>
            </div>

            <!-- Message Board Section -->
            <div id="messages" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddMessageModal()">+ Post Message</button>
                </div>
                <div class="message-board">
                    <div id="messagesContainer"></div>
                </div>
            </div>

            <!-- Users Management Section (Admin Only) -->
            <div id="users" class="section">
                <div class="controls">
                    <button class="btn btn-primary" onclick="openAddUserModal()">+ Add New User</button>
                </div>
                <div id="usersGrid" class="family-grid"></div>
            </div>

            <!-- Bulk Import Section (Admin Only) -->
            <div id="import" class="section">
                <div class="bulk-import">
                    <h3>üìã Bulk Import Family Data</h3>
                    <p>Upload your Excel file (.xlsx, .xls) to automatically import family member data:</p>
                    
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="file-upload-content">
                            <h4>üìé Drop Excel file here or click to browse</h4>
                            <p>Supported formats: .xlsx, .xls</p>
                            <label for="excelFile" class="file-upload-btn">Choose Excel File</label>
                            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        </div>
                    </div>
                    
                    <div id="fileInfo" class="file-info">
                        <p><strong>File:</strong> <span id="fileName"></span></p>
                        <p><strong>Size:</strong> <span id="fileSize"></span></p>
                        <p><strong>Rows found:</strong> <span id="rowCount"></span></p>
                    </div>
                    
                    <div id="previewContainer" style="display: none;">
                        <h4>Preview Data (First 5 rows):</h4>
                        <div style="overflow-x: auto;">
                            <table id="previewTable" class="preview-table">
                                <thead>
                                    <tr>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Month</th>
                                        <th>Day</th>
                                        <th>Year</th>
                                        <th>Column G (Ignored)</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success" onclick="confirmImport()" id="importBtn" style="margin-top: 1rem;">Import All Data</button>
                        <button class="btn btn-primary" onclick="clearFile()" style="margin-top: 1rem; margin-left: 0.5rem;">Choose Different File</button>
                        <button class="btn" onclick="testDatabase()" style="margin-top: 1rem; margin-left: 0.5rem; background: #ffc107; color: #000;">Test Database</button>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 10px; text-align: left;">
                        <h4>üìù Excel File Format Requirements:</h4>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li><strong>Column A:</strong> First Name</li>
                            <li><strong>Column B:</strong> Last Name</li>
                            <li><strong>Column C:</strong> Birth Month (e.g., "January", "February")</li>
                            <li><strong>Column D:</strong> Birth Day (1-31)</li>
                            <li><strong>Column E:</strong> Birth Year (e.g., 1990)</li>
                            <li><strong>Column G:</strong> Will be ignored during import</li>
                        </ul>
                        <p><em>Note: Family branches will be empty after import - organize into families later using the Family Branches tab</em></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Member</h2>
            <form id="addMemberForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="birthMonth">Birth Month *</label>
                        <select id="birthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDay">Birth Day *</label>
                        <input type="number" id="birthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="birthYear">Birth Year *</label>
                        <input type="number" id="birthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="familyBranch">Family Branch</label>
                        <select id="familyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="marriedTo">üíç Married To</label>
                        <select id="marriedTo">
                            <option value="">Select someone</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mobilePhone">Mobile Phone</label>
                        <input type="tel" id="mobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="homePhone">Home Phone</label>
                        <input type="tel" id="homePhone">
                    </div>
                    <div class="form-group">
                        <label for="workPhone">Work Phone</label>
                        <input type="tel" id="workPhone">
                    </div>
                    <div class="form-group">
                        <label for="address">Street Address</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city">
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <input type="text" id="state">
                    </div>
                    <div class="form-group">
                        <label for="zipCode">Zip Code</label>
                        <input type="text" id="zipCode">
                    </div>
                    <div class="form-group">
                        <label for="anniversaryDate">Anniversary Date</label>
                        <input type="date" id="anniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h2>Edit Family Member</h2>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFirstName">First Name *</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name *</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthMonth">Birth Month *</label>
                        <select id="editBirthMonth" required>
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBirthDay">Birth Day *</label>
                        <input type="number" id="editBirthDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="editBirthYear">Birth Year *</label>
                        <input type="number" id="editBirthYear" min="1900" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="editFamilyBranch">Family Branch</label>
                        <select id="editFamilyBranch">
                            <option value="">Select Branch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMarriedTo">üíç Married To</label>
                        <select id="editMarriedTo">
                            <option value="">Select someone</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMobilePhone">Mobile Phone</label>
                        <input type="tel" id="editMobilePhone">
                    </div>
                    <div class="form-group">
                        <label for="editHomePhone">Home Phone</label>
                        <input type="tel" id="editHomePhone">
                    </div>
                    <div class="form-group">
                        <label for="editWorkPhone">Work Phone</label>
                        <input type="tel" id="editWorkPhone">
                    </div>
                    <div class="form-group">
                        <label for="editAddress">Street Address</label>
                        <input type="text" id="editAddress">
                    </div>
                    <div class="form-group">
                        <label for="editCity">City</label>
                        <input type="text" id="editCity">
                    </div>
                    <div class="form-group">
                        <label for="editState">State</label>
                        <input type="text" id="editState">
                    </div>
                    <div class="form-group">
                        <label for="editZipCode">Zip Code</label>
                        <input type="text" id="editZipCode">
                    </div>
                    <div class="form-group">
                        <label for="editAnniversaryDate">Anniversary Date</label>
                        <input type="date" id="editAnniversaryDate">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" placeholder="Occupation, fun facts, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('editMemberModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Branch Modal -->
    <div id="addBranchModal" class="modal">
        <div class="modal-content">
            <h2>Add Family Branch</h2>
            <form id="addBranchForm">
                <div class="form-group">
                    <label for="branchName">Branch Name *</label>
                    <input type="text" id="branchName" required placeholder="e.g., Finn - Danny's Nuclear Family">
                </div>
                <div class="form-group">
                    <label for="branchDescription">Description</label>
                    <textarea id="branchDescription" placeholder="Description of this family branch"></textarea>
                </div>
                <div class="form-group">
                    <label for="generationLevel">Generation Level *</label>
                    <select id="generationLevel" required>
                        <option value="">Select Generation</option>
                        <option value="1">üë¥üëµ Grandparents (Generation 1)</option>
                        <option value="2">üë®üë© Parents (Generation 2)</option>
                        <option value="3">üßëüëß Children (Generation 3)</option>
                        <option value="4">üë∂ Grandchildren (Generation 4)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="branchType">Branch Type *</label>
                    <select id="branchType" required>
                        <option value="">Select Type</option>
                        <option value="nuclear_family">üè† Nuclear Family (Parents + Children)</option>
                        <option value="extended_family">üèòÔ∏è Extended Family (Multiple Generations)</option>
                        <option value="cousin_branch">üë• Cousin Branch (Same Generation)</option>
                        <option value="grandparent_branch">üë¥ Grandparent Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parentBranch">Parent Branch (Optional)</label>
                    <select id="parentBranch">
                        <option value="">No Parent Branch</option>
                    </select>
                </div>
                <div id="smartSuggestions" style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; display: none;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1976d2;">üí° Smart Suggestions:</h4>
                    <div id="suggestionsList"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addBranchModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Branch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Family Unit Modal -->
    <div id="createFamilyUnitModal" class="modal">
        <div class="modal-content">
            <h2>Create Family Unit</h2>
            <form id="createFamilyUnitForm">
                <div class="form-group">
                    <label for="unitName">Family Unit Name *</label>
                    <input type="text" id="unitName" required placeholder="e.g., The Finn Family, Smith Extended Family">
                </div>
                <div class="form-group">
                    <label for="unitDescription">Description</label>
                    <textarea id="unitDescription" placeholder="Description of this family unit"></textarea>
                </div>
                <div class="form-group">
                    <label for="unitType">Unit Type *</label>
                    <select id="unitType" required>
                        <option value="">Select Type</option>
                        <option value="nuclear">Nuclear Family (Parents + Children)</option>
                        <option value="extended">Extended Family (Multiple Generations)</option>
                        <option value="ancestral">Ancestral Line (Historical Family Tree)</option>
                        <option value="mixed">Mixed Family (Blended/Complex)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Branches to Include:</label>
                    <div id="branchCheckboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                        <!-- Will be populated with available branches -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('createFamilyUnitModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Family Unit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal (Admin Only) -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Add New User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUsername">Username * (min 5 characters)</label>
                    <input type="text" id="newUsername" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password * (min 5 characters)</label>
                    <input type="password" id="newPassword" required minlength="5">
                </div>
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="userPhone">Phone</label>
                    <input type="tel" id="userPhone">
                </div>
                <div class="form-group">
                    <label for="isAdmin">Admin Status</label>
                    <select id="isAdmin">
                        <option value="0">Regular User</option>
                        <option value="1">Administrator</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Message Modal -->
    <div id="addMessageModal" class="modal">
        <div class="modal-content">
            <h2>Post Message</h2>
            <form id="addMessageForm">
                <div class="form-group">
                    <label for="messageTitle">Title</label>
                    <input type="text" id="messageTitle" placeholder="Message title (optional)">
                </div>
                <div class="form-group">
                    <label for="messageContent">Message *</label>
                    <textarea id="messageContent" required placeholder="Write your message here..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal('addMessageModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Message</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Branch View Modal -->
    <div id="branchViewModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 1200px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="branchViewTitle">Branch Members</h2>
                <button class="btn" onclick="closeModal('branchViewModal')" style="background: #6c757d; color: white;">‚úï Close</button>
            </div>
            
            <div id="branchStats" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; color: white;" id="branchStatsName">Branch Name</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;" id="branchStatsCount">0 family members</p>
                    </div>
                    <div style="font-size: 3rem; opacity: 0.7;">üåø</div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <input type="text" id="branchSearchInput" placeholder="Search branch members..." style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
            </div>

            <div id="branchMembersGrid" class="family-grid" style="max-height: 70vh; overflow-y: auto;"></div>
            
            <div id="noBranchMembers" style="display: none; text-align: center; padding: 2rem; color: #6c757d;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üë•</div>
                <h3>No family members in this branch yet</h3>
                <p>Add family members and assign them to this branch to see them here.</p>
            </div>
        </div>
    </div>

    <!-- Manage Branch Modal -->
    <div id="manageBranchModal" class="modal">
        <div class="modal-content" style="max-width: 80%; width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 id="manageBranchTitle">Manage Branch</h2>
                <button class="btn" onclick="closeModal('manageBranchModal')" style="background: #6c757d; color: white;">‚úï Close</button>
            </div>
            
            <div class="tabs" style="margin-bottom: 1rem;">
                <div class="tab active" onclick="switchManageTab('moveMembers')">üîÑ Move Members</div>
                <div class="tab" onclick="switchManageTab('shareMembers')">üë• Share Members</div>
                <div class="tab" onclick="switchManageTab('suggestions')">üí° Smart Suggestions</div>
            </div>

            <!-- Move Members Tab -->
            <div id="moveMembers" class="manage-tab-content active">
                <h4>Move Members to This Branch</h4>
                <p>Select family members from other branches to move to this branch:</p>
                
                <div style="margin-bottom: 1rem;">
                    <label for="sourceBranch">From Branch:</label>
                    <select id="sourceBranch" onchange="loadMoveCandidates()" style="margin-left: 0.5rem; padding: 0.5rem;">
                        <option value="">Select source branch</option>
                    </select>
                </div>
                
                <div id="moveCandidates" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 8px;">
                    <p style="text-align: center; color: #666;">Select a source branch to see members</p>
                </div>
                
                <button id="moveSelectedBtn" class="btn btn-primary" onclick="moveSelectedMembers()" style="margin-top: 1rem; display: none;">
                    Move Selected Members
                </button>
            </div>

            <!-- Share Members Tab -->
            <div id="shareMembers" class="manage-tab-content" style="display: none;">
                <h4>Share Members with Other Branches</h4>
                <p>Add members from this branch to appear in other branches (like parents appearing in children's families):</p>
                
                <div id="shareableMembersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Will be populated with current branch members -->
                </div>
            </div>

            <!-- Smart Suggestions Tab -->
            <div id="suggestions" class="manage-tab-content" style="display: none;">
                <h4>Smart Organization Suggestions</h4>
                <div id="branchSuggestions">
                    <!-- Will be populated with AI suggestions -->
                </div>
            </div>
        </div>
    </div>

    <!-- Load the new relationship system -->
    <script src="relationship-system.js"></script>
    <script src="relationship-ui.js"></script>

    <script type="module">
        // Import Firebase using the correct v9+ modular syntax
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCWtVYdOiggwqw5CNMJbM13BdeLtwqBhbs",
            authDomain: "family-tree-6f16b.firebaseapp.com",
            projectId: "family-tree-6f16b",
            storageBucket: "family-tree-6f16b.firebasestorage.app",
            messagingSenderId: "801170939057",
            appId: "1:801170939057:web:87d35d8156789631f69690"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Initialize the new relationship system
        let relationshipSystem = null;
        let relationshipUI = null;
        let useNewSystem = false; // Flag to switch between old and new system

        // Global variables
        let currentUser = null;
        let familyMembers = [];
        let familyBranches = [];
        let familyUnits = [];  // New: Family Units that group branches together
        let users = [];
        let messages = [];

        // Initialize the app
        async function init() {
            // Check if user is logged in
            const userData = localStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('username').textContent = currentUser.username;
            
            if (currentUser.isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }

            // Initialize the new relationship system
            initializeRelationshipSystem();

            await loadData();
            setupEventListeners();
        }

        // Initialize the new relationship system
        function initializeRelationshipSystem() {
            try {
                // Create the relationship system with Firebase modules
                relationshipSystem = new FamilyRelationshipSystem(db, {
                    collection, addDoc, getDocs, query, where, orderBy, limit, deleteDoc, doc, updateDoc
                });
                
                // Create the UI system
                relationshipUI = new RelationshipSystemUI(relationshipSystem);
                relationshipUI.setCurrentUser(currentUser);
                
                // Make them globally accessible
                window.relationshipSystem = relationshipSystem;
                window.relationshipUI = relationshipUI;
                
                console.log('New relationship system initialized successfully');
                
                // Check if user wants to use the new system
                const useNewSystemPref = localStorage.getItem('useNewRelationshipSystem');
                if (useNewSystemPref === 'true') {
                    useNewSystem = true;
                    console.log('Using new relationship system');
                }
                
            } catch (error) {
                console.error('Failed to initialize relationship system:', error);
            }
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadFamilyMembers(),
                loadFamilyBranches(),
                loadFamilyUnits(),  // New: Load family units
                loadUsers(),
                loadMessages()
            ]);
            
            displayFamilyMembers();
            displayBranches();
            displayUsers();
            displayMessages();
            displayUpcomingBirthdays();
            populateDropdowns();
        }

        // Load family members
        async function loadFamilyMembers() {
            try {
                console.log('Loading family members...');
                const querySnapshot = await getDocs(collection(db, 'family_members'));
                familyMembers = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`Loaded ${familyMembers.length} family members:`, familyMembers);
            } catch (error) {
                console.error('Error loading family members:', error);
            }
        }

        // Load family branches
        async function loadFamilyBranches() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_branches'));
                familyBranches = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family branches:', error);
            }
        }

        // Load family units
        async function loadFamilyUnits() {
            try {
                const querySnapshot = await getDocs(collection(db, 'family_units'));
                familyUnits = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading family units:', error);
            }
        }

        // Load users (admin only)
        async function loadUsers() {
            if (!currentUser.isAdmin) return;
            
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                users = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(20));
                const querySnapshot = await getDocs(q);
                messages = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display family members with proper relationships
        function displayFamilyMembers() {
            const grid = document.getElementById('familyGrid');
            if (!grid) {
                console.error('familyGrid element not found');
                return;
            }
            
            // Get filter values with null checks
            const searchInput = document.getElementById('searchInput');
            const monthFilterEl = document.getElementById('monthFilter');
            const branchFilterEl = document.getElementById('branchFilter');
            const sortOrderEl = document.getElementById('sortOrder');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const monthFilter = monthFilterEl ? monthFilterEl.value : '';
            const branchFilter = branchFilterEl ? branchFilterEl.value : '';
            const sortOrder = sortOrderEl ? sortOrderEl.value : 'name';

            let filtered = familyMembers.filter(member => {
                const matchesSearch = !searchTerm || 
                    (member.firstName && member.firstName.toLowerCase().includes(searchTerm)) ||
                    (member.lastName && member.lastName.toLowerCase().includes(searchTerm));
                const matchesMonth = !monthFilter || member.birthMonth === monthFilter;
                const matchesBranch = !branchFilter || member.familyBranch === branchFilter;
                
                return matchesSearch && matchesMonth && matchesBranch;
            });

            // Sort based on selected order
            filtered.sort((a, b) => {
                if (sortOrder === 'age-oldest') {
                    return getAge(b) - getAge(a);
                } else if (sortOrder === 'age-youngest') {
                    return getAge(a) - getAge(b);
                } else if (sortOrder === 'birthday') {
                    return getNextBirthday(a) - getNextBirthday(b);
                } else {
                    return `${a.firstName || ''} ${a.lastName || ''}`.localeCompare(`${b.firstName || ''} ${b.lastName || ''}`);
                }
            });

            grid.innerHTML = filtered.map(member => {
                const age = getAge(member);
                const nextBirthday = getNextBirthday(member);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));
                
                // Find potential parents and children
                const potentialParents = findPotentialParents(member);
                const potentialChildren = findPotentialChildren(member);
                
                return `
                <div class="family-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: #667eea; margin-bottom: 0.5rem;">${member.firstName || ''} ${member.lastName || ''}</h3>
                            <p style="color: #666; font-size: 0.9rem;">Age: ${age} | Birthday: ${member.birthMonth || 'N/A'} ${member.birthDay || 'N/A'}, ${member.birthYear || 'N/A'}</p>
                        </div>
                        ${daysUntilBirthday <= 30 ? `
                            <span style="background: #e74c3c20; color: #e74c3c; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                üéÇ ${daysUntilBirthday} days
                            </span>
                        ` : ''}
                    </div>

                    <!-- Family Relationships Section -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="color: #495057; margin-bottom: 0.75rem; font-size: 0.9rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Relationships</h4>
                        
                        <!-- Parents Section -->
                        <div style="margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <strong style="color: #495057; font-size: 0.85rem;">üë´ Parents:</strong>
                                <button class="btn" onclick="openAddParentModal('${member.id}')" style="background: #28a745; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem;">+ Add Parent</button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${getParentsDisplay(member)}
                            </div>
                        </div>

                        <!-- Children Section -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <strong style="color: #495057; font-size: 0.85rem;">üë∂ Children:</strong>
                                <button class="btn" onclick="openAddChildModal('${member.id}')" style="background: #007bff; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem;">+ Add Child</button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${getChildrenDisplay(member)}
                            </div>
                        </div>
                    </div>

                    <!-- Basic Info -->
                    <div class="family-info" style="margin-bottom: 1rem;">
                        <div><strong>Family Group:</strong> ${member.familyBranch || 'No group assigned'}</div>
                        ${member.marriedTo ? `<div><strong>üíç Married To:</strong> ${getSpouseName(member.marriedTo)}</div>` : ''}
                        <div><strong>Mobile:</strong> ${member.mobilePhone || 'Not provided'}</div>
                        <div><strong>Email:</strong> ${member.email || 'Not provided'}</div>
                        <div><strong>Address:</strong> ${member.address ? `${member.address}, ${member.city || ''} ${member.state || ''}` : 'Not provided'}</div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; font-size: 0.85rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="flex: 1;">‚úèÔ∏è Edit</button>
                        <button class="btn" onclick="viewFamilyTree('${member.id}')" style="background: #28a745; color: white; flex: 1;">üå≥ Family Tree</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="flex: 1;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Helper functions for relationship display
        function getParentsDisplay(member) {
            // For now, use relationship field and relatedTo field as hints
            const parents = familyMembers.filter(m => 
                m.id !== member.id && 
                (isParentRelationship(m, member) || member.relatedTo === m.id)
            );
            
            if (parents.length === 0) {
                return '<span style="color: #999; font-style: italic;">No parents assigned</span>';
            }
            
            return parents.map(parent => 
                `<span style="background: #e9ecef; padding: 0.2rem 0.4rem; border-radius: 4px; margin-right: 0.25rem;">
                    ${parent.firstName} ${parent.lastName}
                    <button onclick="removeParent('${member.id}', '${parent.id}')" style="background: none; border: none; color: #dc3545; margin-left: 0.25rem; cursor: pointer;">&times;</button>
                </span>`
            ).join('');
        }

        function getChildrenDisplay(member) {
            const children = familyMembers.filter(m => 
                m.id !== member.id && 
                (isChildRelationship(member, m) || m.relatedTo === member.id)
            );
            
            if (children.length === 0) {
                return '<span style="color: #999; font-style: italic;">No children assigned</span>';
            }
            
            return children.map(child => 
                `<span style="background: #e9ecef; padding: 0.2rem 0.4rem; border-radius: 4px; margin-right: 0.25rem;">
                    ${child.firstName} ${child.lastName}
                    <button onclick="removeChild('${member.id}', '${child.id}')" style="background: none; border: none; color: #dc3545; margin-left: 0.25rem; cursor: pointer;">&times;</button>
                </span>`
            ).join('');
        }

        function isParentRelationship(potential_parent, member) {
            // Simple age-based check for now - parents should be older
            const parentAge = getAge(potential_parent);
            const memberAge = getAge(member);
            return parentAge > memberAge + 15; // At least 15 years older
        }

        function isChildRelationship(member, potential_child) {
            // Simple age-based check - children should be younger
            const memberAge = getAge(member);
            const childAge = getAge(potential_child);
            return memberAge > childAge + 15; // At least 15 years older
        }

        function findPotentialParents(member) {
            return familyMembers.filter(m => 
                m.id !== member.id && 
                isParentRelationship(m, member)
            ).slice(0, 10); // Limit to 10 suggestions
        }

        function findPotentialChildren(member) {
            return familyMembers.filter(m => 
                m.id !== member.id && 
                isChildRelationship(member, m)
            ).slice(0, 10); // Limit to 10 suggestions
        }

        // Helper function to get spouse name
        function getSpouseName(spouseId) {
            const spouse = familyMembers.find(m => m.id === spouseId);
            return spouse ? `${spouse.firstName} ${spouse.lastName}` : 'Unknown';
        }

        // Display branches
        function displayBranches() {
            const grid = document.getElementById('branchesGrid');
            
            // Check if we have family units
            if (familyUnits.length > 0) {
                grid.innerHTML = renderFamilyUnitsView();
            } else {
                // Fallback to original branch hierarchy view
                const branchHierarchy = createBranchHierarchy();
                grid.innerHTML = renderBranchHierarchy(branchHierarchy);
            }
        }

        // Create hierarchical structure of branches
        function createBranchHierarchy() {
            // Sort branches by generation level, then by name
            const sortedBranches = [...familyBranches].sort((a, b) => {
                const genA = a.generationLevel || 999;
                const genB = b.generationLevel || 999;
                if (genA !== genB) return genA - genB;
                return a.name.localeCompare(b.name);
            });

            // Group by generation
            const generations = {};
            sortedBranches.forEach(branch => {
                const gen = branch.generationLevel || 'Unknown';
                if (!generations[gen]) generations[gen] = [];
                generations[gen].push(branch);
            });

            return generations;
        }

        // Render the hierarchical branch structure
        function renderBranchHierarchy(generations) {
            const generationNames = {
                1: 'Grandparents Generation',
                2: 'Parents Generation', 
                3: 'Children Generation',
                4: 'Grandchildren Generation'
            };

            let html = '';
            
            Object.keys(generations).sort((a, b) => a - b).forEach(genLevel => {
                const branches = generations[genLevel];
                const genName = generationNames[genLevel] || `Generation ${genLevel}`;
                const genColor = getBranchColor(parseInt(genLevel));
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, ${genColor}, ${genColor}aa); color: white; padding: 1rem; border-radius: 10px 10px 0 0; position: relative; overflow: hidden;">
                            <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 2rem;">${getGenerationIcon(genLevel)}</span>
                                ${genName}
                                <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; margin-left: auto;">
                                    ${branches.length} ${branches.length === 1 ? 'branch' : 'branches'}
                                </span>
                            </h2>
                            <div style="position: absolute; right: -20px; top: -20px; font-size: 6rem; opacity: 0.1; transform: rotate(15deg);">
                                üå≥
                            </div>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid ${genColor}; border-top: none; border-radius: 0 0 10px 10px; padding: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                                ${branches.map(branch => renderBranchCard(branch, genLevel)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            return html || '<div style="text-align: center; padding: 2rem; color: #666;"><h3>No family branches yet</h3><p>Create your first family branch to get started!</p></div>';
        }

        // Render individual branch card
        function renderBranchCard(branch, genLevel) {
            const membersInBranch = familyMembers.filter(member => member.familyBranch === branch.name);
            const sharedMembersCount = branch.sharedMembers ? branch.sharedMembers.length : 0;
            const totalMembers = membersInBranch.length + sharedMembersCount;
            
            // Get average age for the branch
            const avgAge = membersInBranch.length > 0 ? 
                Math.round(membersInBranch.reduce((sum, member) => sum + getAge(member), 0) / membersInBranch.length) : 0;
            
            const typeIcon = getBranchTypeIcon(branch.branchType);
            
            return `
                <div class="family-card" style="border-left: 4px solid ${getBranchColor(genLevel)}; margin: 0; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0; color: ${getBranchColor(genLevel)}; font-size: 1.1rem;">
                            ${typeIcon} ${branch.name}
                        </h3>
                        <div style="font-size: 1.2rem; opacity: 0.7;">${getGenerationIcon(genLevel)}</div>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <span style="background: ${getBranchColor(genLevel)}20; color: ${getBranchColor(genLevel)}; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
                            ${formatBranchType(branch.branchType)}
                        </span>
                    </div>
                    
                    <p style="margin: 0.5rem 0; color: #555; font-size: 0.9rem;">${branch.description || 'No description'}</p>
                    
                    ${branch.parentBranch ? `<div style="margin-bottom: 0.5rem; padding: 0.25rem 0.5rem; background: #fff3cd; border-radius: 4px; font-size: 0.8rem;">
                        <strong>‚ÜóÔ∏è Parent:</strong> ${branch.parentBranch}
                    </div>` : ''}
                    
                    <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 5px; border-left: 3px solid ${getBranchColor(genLevel)};">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
                            <div><strong>üë• Members:</strong> ${totalMembers}</div>
                            <div><strong>üìä Avg Age:</strong> ${avgAge || 'N/A'}</div>
                            <div><strong>üè† Direct:</strong> ${membersInBranch.length}</div>
                            <div><strong>ü§ù Shared:</strong> ${sharedMembersCount}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="viewBranchMembers('${branch.name}')" style="background: #28a745; font-size: 0.8rem; flex: 1;">
                            üëÅÔ∏è View Branch
                        </button>
                        <button class="btn" onclick="openManageBranchModal('${branch.id}')" style="background: #17a2b8; color: white; font-size: 0.8rem; flex: 1;">
                            ‚öôÔ∏è Manage
                        </button>
                        <button class="btn btn-danger" onclick="deleteBranch('${branch.id}')" style="font-size: 0.8rem;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        // Render Family Units View
        function renderFamilyUnitsView() {
            let html = `
                <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #333;">üè† Family Units</h2>
                    <button class="btn btn-primary" onclick="openCreateFamilyUnitModal()" style="background: #007bff;">
                        + Create Family Unit
                    </button>
                </div>
            `;

            // Get branches that are not in any family unit
            const branchesInUnits = familyUnits.flatMap(unit => unit.branches || []);
            const unassignedBranches = familyBranches.filter(branch => 
                !branchesInUnits.includes(branch.name)
            );

            // Render family units
            familyUnits.forEach(unit => {
                html += renderFamilyUnit(unit);
            });

            // Show unassigned branches if any
            if (unassignedBranches.length > 0) {
                html += `
                    <div style="margin-top: 2rem;">
                        <div style="background: linear-gradient(135deg, #6c757d, #6c757daa); color: white; padding: 1rem; border-radius: 10px 10px 0 0;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                üìÇ Unassigned Branches
                                <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; margin-left: auto;">
                                    ${unassignedBranches.length} ${unassignedBranches.length === 1 ? 'branch' : 'branches'}
                                </span>
                            </h3>
                        </div>
                        <div style="background: #f8f9fa; border: 2px solid #6c757d; border-top: none; border-radius: 0 0 10px 10px; padding: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                                ${unassignedBranches.map(branch => renderBranchCard(branch, branch.generationLevel)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            return html || '<div style="text-align: center; padding: 2rem; color: #666;"><h3>No family units yet</h3><p>Create your first family unit to organize your branches!</p></div>';
        }

        // Render individual Family Unit
        function renderFamilyUnit(unit) {
            const unitBranches = familyBranches.filter(branch => 
                unit.branches && unit.branches.includes(branch.name)
            );
            
            // Calculate total members across all branches in this unit
            const totalMembers = unitBranches.reduce((total, branch) => {
                const branchMembers = familyMembers.filter(member => member.familyBranch === branch.name);
                const sharedMembers = branch.sharedMembers ? branch.sharedMembers.length : 0;
                return total + branchMembers.length + sharedMembers;
            }, 0);

            // Get the primary generation (most common generation in the unit)
            const generations = unitBranches.map(b => b.generationLevel).filter(g => g);
            const primaryGeneration = generations.length > 0 ? 
                generations.sort((a,b) => generations.filter(v => v===a).length - generations.filter(v => v===b).length).pop() : 2;

            const unitColor = getFamilyUnitColor(unit.type || 'extended');

            return `
                <div style="margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, ${unitColor}, ${unitColor}aa); color: white; padding: 1rem; border-radius: 10px 10px 0 0; position: relative; overflow: hidden;">
                        <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 2rem;">${getFamilyUnitIcon(unit.type)}</span>
                            ${unit.name}
                            <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 15px; font-size: 0.8rem; margin-left: auto;">
                                ${unitBranches.length} ${unitBranches.length === 1 ? 'branch' : 'branches'} ‚Ä¢ ${totalMembers} members
                            </span>
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">${unit.description || 'No description'}</p>
                        <div style="position: absolute; right: -20px; top: -20px; font-size: 6rem; opacity: 0.1; transform: rotate(15deg);">
                            üè†
                        </div>
                    </div>
                    <div style="background: #f8f9fa; border: 2px solid ${unitColor}; border-top: none; border-radius: 0 0 10px 10px; padding: 1rem;">
                        <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn" onclick="manageFamilyUnit('${unit.id}')" style="background: #17a2b8; color: white; font-size: 0.85rem;">
                                ‚öôÔ∏è Manage Unit
                            </button>
                            <button class="btn btn-danger" onclick="deleteFamilyUnit('${unit.id}')" style="font-size: 0.85rem;">
                                üóëÔ∏è Delete Unit
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem;">
                            ${unitBranches.map(branch => renderBranchCardInUnit(branch, unit.id)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render branch card within a family unit (simplified version)
        function renderBranchCardInUnit(branch, unitId) {
            const membersInBranch = familyMembers.filter(member => member.familyBranch === branch.name);
            const sharedMembersCount = branch.sharedMembers ? branch.sharedMembers.length : 0;
            const totalMembers = membersInBranch.length + sharedMembersCount;
            
            const avgAge = membersInBranch.length > 0 ? 
                Math.round(membersInBranch.reduce((sum, member) => sum + getAge(member), 0) / membersInBranch.length) : 0;
            
            const typeIcon = getBranchTypeIcon(branch.branchType);
            const genColor = getBranchColor(branch.generationLevel);
            
            return `
                <div class="family-card" style="border-left: 4px solid ${genColor}; margin: 0; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; color: ${genColor}; font-size: 1rem;">
                            ${typeIcon} ${branch.name}
                        </h4>
                        <div style="font-size: 1rem; opacity: 0.7;">${getGenerationIcon(branch.generationLevel)}</div>
                    </div>
                    
                    <div style="margin-bottom: 0.5rem;">
                        <span style="background: ${genColor}20; color: ${genColor}; padding: 0.15rem 0.4rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">
                            Gen ${branch.generationLevel} ‚Ä¢ ${formatBranchType(branch.branchType)}
                        </span>
                    </div>
                    
                    <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f8f9fa; border-radius: 4px; font-size: 0.8rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                            <div><strong>üë•</strong> ${totalMembers} members</div>
                            <div><strong>üìä</strong> Avg ${avgAge}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 0.8rem; display: flex; gap: 0.3rem;">
                        <button class="btn btn-primary" onclick="viewBranchMembers('${branch.name}')" style="background: #28a745; font-size: 0.75rem; flex: 1;">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn" onclick="openManageBranchModal('${branch.id}')" style="background: #17a2b8; color: white; font-size: 0.75rem; flex: 1;">
                            ‚öôÔ∏è Edit
                        </button>
                        <button class="btn" onclick="removeBranchFromUnit('${branch.name}', '${unitId}')" style="background: #ffc107; color: #212529; font-size: 0.75rem;">
                            ‚ÜóÔ∏è
                        </button>
                    </div>
                </div>
            `;
        }

        // Helper functions for Family Units
        function getFamilyUnitColor(unitType) {
            const colors = {
                'nuclear': '#28a745',      // Green for nuclear families
                'extended': '#007bff',     // Blue for extended families  
                'ancestral': '#8e24aa',    // Purple for ancestral lines
                'mixed': '#fd7e14'         // Orange for mixed families
            };
            return colors[unitType] || '#007bff';
        }

        function getFamilyUnitIcon(unitType) {
            const icons = {
                'nuclear': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                'extended': 'üèòÔ∏è',
                'ancestral': 'üå≥',
                'mixed': 'ÔøΩ'
            };
            return icons[unitType] || 'üè†';
        }

        // Helper functions for branch display
        function getBranchColor(generationLevel) {
            const colors = {
                1: '#8e24aa', // Purple for grandparents
                2: '#1976d2', // Blue for parents  
                3: '#388e3c', // Green for children
                4: '#f57c00'  // Orange for grandchildren
            };
            return colors[generationLevel] || '#666';
        }

        function getGenerationIcon(generationLevel) {
            const icons = {
                1: 'üë¥üëµ', // Grandparents
                2: 'üë®üë©', // Parents  
                3: 'üë¶üëß', // Children
                4: 'üë∂'   // Grandchildren
            };
            return icons[generationLevel] || 'üë•';
        }

        function getBranchTypeIcon(branchType) {
            const icons = {
                'nuclear_family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                'extended_family': 'üèòÔ∏è',
                'cousin_branch': 'üë´',
                'grandparent_branch': 'üë¥üëµ'
            };
            return icons[branchType] || 'üë•';
        }

        function formatBranchType(branchType) {
            const types = {
                'nuclear_family': 'Nuclear Family',
                'extended_family': 'Extended Family', 
                'cousin_branch': 'Cousin Branch',
                'grandparent_branch': 'Grandparent Branch'
            };
            return types[branchType] || 'Family Branch';
        }

        // Helper functions for age and birthday calculations
        function getAge(member) {
            if (!member.birthYear || !member.birthMonth || !member.birthDay) return 0;
            
            const today = new Date();
            const birthDate = new Date(member.birthYear, getMonthIndex(member.birthMonth), member.birthDay);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function getNextBirthday(member) {
            if (!member.birthMonth || !member.birthDay) return new Date(9999, 11, 31); // Return far future date for invalid data
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const monthIndex = getMonthIndex(member.birthMonth);
            
            // Create birthday for this year
            let nextBirthday = new Date(currentYear, monthIndex, member.birthDay);
            
            // If the birthday this year has already passed, move to next year
            if (nextBirthday <= today) {
                nextBirthday = new Date(currentYear + 1, monthIndex, member.birthDay);
            }
            
            return nextBirthday;
        }

        function getMonthIndex(monthName) {
            const months = {
                'January': 0, 'February': 1, 'March': 2, 'April': 3,
                'May': 4, 'June': 5, 'July': 6, 'August': 7,
                'September': 8, 'October': 9, 'November': 10, 'December': 11
            };
            return months[monthName] || 0;
        }

        // Display users (admin only)
        function displayUsers() {
            if (!currentUser.isAdmin) return;
            
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = users.map(user => `
                <div class="family-card">
                    <h3>${user.fullName || user.username}</h3>
                    <div class="family-info">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Email:</strong> ${user.email || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${user.phone || 'N/A'}</div>
                        <div><strong>Admin:</strong> ${user.isAdmin ? 'Yes' : 'No'}</div>
                        <div><strong>Created:</strong> ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Display messages
        function displayMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map(message => `
                <div class="message">
                    <div class="message-header">
                        <span class="message-author">${message.author}</span>
                        <span class="message-date">${new Date(message.createdAt.seconds * 1000).toLocaleDateString()}</span>
                    </div>
                    ${message.title ? `<h4>${message.title}</h4>` : ''}
                    <p>${message.content}</p>
                    ${currentUser.isAdmin ? `<button class="btn btn-danger" onclick="deleteMessage('${message.id}')">Delete</button>` : ''}
                </div>
            `).join('');
        }

        // Display upcoming birthdays
        function displayUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdays');
            
            if (!container) {
                console.warn('Upcoming birthdays container not found');
                return;
            }
            
            if (!familyMembers || familyMembers.length === 0) {
                console.log('No family members found');
                container.innerHTML = '<div class="birthday-item"><span>No family members added yet</span><span>Add some family members to see birthdays</span></div>';
                return;
            }
            
            const today = new Date();
            
            // Filter members with valid birth data and calculate upcoming birthdays
            const validMembers = familyMembers.filter(member => {
                // Check if member has valid birth data
                return member.birthMonth && member.birthDay && member.birthMonth.trim() !== '' && member.birthDay > 0;
            });
            
            const upcoming = validMembers.map(member => {
                const nextBirthday = getNextBirthday(member);
                const daysUntil = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                
                return {
                    ...member,
                    nextBirthday: nextBirthday,
                    daysUntil: daysUntil
                };
            })
            .filter(member => member.daysUntil >= 0 && member.daysUntil < 9999) // Filter out any invalid dates
            .sort((a, b) => a.nextBirthday - b.nextBirthday) // Sort by next birthday date
            .slice(0, 5); // Show only the next 5 birthdays

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="birthday-item"><span>No upcoming birthdays</span><span>Add birth dates to family members</span></div>';
                return;
            }

            container.innerHTML = upcoming.map(member => {
                // Format the birthday display
                const dayLabel = member.daysUntil === 0 ? 'Today!' : 
                                member.daysUntil === 1 ? 'Tomorrow' : 
                                `${member.daysUntil} day${member.daysUntil === 1 ? '' : 's'}`;
                
                return `
                    <div class="birthday-item">
                        <span>${member.firstName} ${member.lastName}</span>
                        <span>${member.birthMonth} ${member.birthDay} (${dayLabel})</span>
                    </div>
                `;
            }).join('');
        }

        // Modal functions for adding relationships
        function openAddParentModal(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            const potentialParents = familyMembers.filter(m => 
                m.id !== memberId && isParentRelationship(m, member)
            );

            const modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Add Parent for ${member.firstName} ${member.lastName}</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="parentSearch" placeholder="Search for a parent..." 
                               style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 1rem;" 
                               oninput="filterParentList()">
                    </div>

                    <div id="parentList" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 0.5rem;">
                        ${potentialParents.length > 0 ? 
                            potentialParents.map(p => `
                                <div class="parent-option" data-id="${p.id}" onclick="selectParent('${memberId}', '${p.id}')" 
                                     style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer; background: white;">
                                    <strong>${p.firstName} ${p.lastName}</strong> 
                                    <span style="color: #666;">(Age: ${getAge(p)})</span>
                                    <div style="font-size: 0.8rem; color: #666;">${p.familyBranch || 'No group'}</div>
                                </div>
                            `).join('') 
                            : '<p style="color: #666; text-align: center; padding: 1rem;">No potential parents found. Consider adjusting ages or adding more family members.</p>'
                        }
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button onclick="closeModal()" style="flex: 1; padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 6px;">Cancel</button>
                    </div>
                </div>
            `;

            showModal(modalContent);
        }

        function openAddChildModal(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            const potentialChildren = familyMembers.filter(m => 
                m.id !== memberId && isChildRelationship(member, m)
            );

            const modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 1rem;">Add Child for ${member.firstName} ${member.lastName}</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="childSearch" placeholder="Search for a child..." 
                               style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 1rem;" 
                               oninput="filterChildList()">
                    </div>

                    <div id="childList" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 0.5rem;">
                        ${potentialChildren.length > 0 ? 
                            potentialChildren.map(c => `
                                <div class="child-option" data-id="${c.id}" onclick="selectChild('${memberId}', '${c.id}')" 
                                     style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer; background: white;">
                                    <strong>${c.firstName} ${c.lastName}</strong> 
                                    <span style="color: #666;">(Age: ${getAge(c)})</span>
                                    <div style="font-size: 0.8rem; color: #666;">${c.familyBranch || 'No group'}</div>
                                </div>
                            `).join('') 
                            : '<p style="color: #666; text-align: center; padding: 1rem;">No potential children found. Consider adjusting ages or adding more family members.</p>'
                        }
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button onclick="closeModal()" style="flex: 1; padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 6px;">Cancel</button>
                    </div>
                </div>
            `;

            showModal(modalContent);
        }

        function filterParentList() {
            const searchTerm = document.getElementById('parentSearch').value.toLowerCase();
            const options = document.querySelectorAll('.parent-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function filterChildList() {
            const searchTerm = document.getElementById('childSearch').value.toLowerCase();
            const options = document.querySelectorAll('.child-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function selectParent(childId, parentId) {
            try {
                // For now, we'll use the relatedTo field to store parent relationship
                const childRef = doc(db, 'family_members', childId);
                await updateDoc(childRef, {
                    relatedTo: parentId,
                    relationship: 'Child'
                });

                // Also update the parent to show they have a child
                const parentRef = doc(db, 'family_members', parentId);
                const parentDoc = await getDoc(parentRef);
                if (parentDoc.exists()) {
                    await updateDoc(parentRef, {
                        relationship: 'Parent'
                    });
                }

                closeModal();
                loadFamilyMembers(); // Refresh the display
                showMessage('Parent relationship added successfully!', 'success');
            } catch (error) {
                console.error('Error adding parent relationship:', error);
                showMessage('Error adding parent relationship', 'error');
            }
        }

        async function selectChild(parentId, childId) {
            try {
                // For now, we'll use the relatedTo field to store parent relationship
                const childRef = doc(db, 'family_members', childId);
                await updateDoc(childRef, {
                    relatedTo: parentId,
                    relationship: 'Child'
                });

                // Also update the parent to show they have a child
                const parentRef = doc(db, 'family_members', parentId);
                const parentDoc = await getDoc(parentRef);
                if (parentDoc.exists()) {
                    await updateDoc(parentRef, {
                        relationship: 'Parent'
                    });
                }

                closeModal();
                loadFamilyMembers(); // Refresh the display
                showMessage('Child relationship added successfully!', 'success');
            } catch (error) {
                console.error('Error adding child relationship:', error);
                showMessage('Error adding child relationship', 'error');
            }
        }

        async function removeParent(childId, parentId) {
            if (!confirm('Are you sure you want to remove this parent relationship?')) return;

            try {
                const childRef = doc(db, 'family_members', childId);
                await updateDoc(childRef, {
                    relatedTo: null,
                    relationship: 'Family Member'
                });

                loadFamilyMembers(); // Refresh the display
                showMessage('Parent relationship removed successfully!', 'success');
            } catch (error) {
                console.error('Error removing parent relationship:', error);
                showMessage('Error removing parent relationship', 'error');
            }
        }

        async function removeChild(parentId, childId) {
            if (!confirm('Are you sure you want to remove this child relationship?')) return;

            try {
                const childRef = doc(db, 'family_members', childId);
                await updateDoc(childRef, {
                    relatedTo: null,
                    relationship: 'Family Member'
                });

                loadFamilyMembers(); // Refresh the display
                showMessage('Child relationship removed successfully!', 'success');
            } catch (error) {
                console.error('Error removing child relationship:', error);
                showMessage('Error removing child relationship', 'error');
            }
        }

        // Simple family tree view function
        function viewFamilyTree(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            // Find all related family members
            const parents = familyMembers.filter(m => 
                m.id !== memberId && isParentRelationship(m, member)
            );
            
            const children = familyMembers.filter(m => 
                m.id !== memberId && isChildRelationship(member, m)
            );

            // Find siblings (same parents)
            const siblings = familyMembers.filter(m => 
                m.id !== memberId && 
                parents.some(parent => isParentRelationship(parent, m))
            );

            const modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; text-align: center;">üå≥ Family Tree - ${member.firstName} ${member.lastName}</h3>
                    
                    <!-- Parents Section -->
                    ${parents.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;">üë´ Parents</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${parents.map(p => `
                                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 2px solid #e9ecef;">
                                        <strong>${p.firstName} ${p.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(p)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Focus Person -->
                    <div style="margin: 2rem 0; text-align: center;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; display: inline-block;">
                            <h4 style="margin: 0; color: white;">${member.firstName} ${member.lastName}</h4>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Age: ${getAge(member)} | ${member.familyBranch || 'No group'}</div>
                        </div>
                    </div>

                    <!-- Siblings Section -->
                    ${siblings.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;">üë• Siblings</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${siblings.map(s => `
                                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border: 2px solid #ffeaa7;">
                                        <strong>${s.firstName} ${s.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(s)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Children Section -->
                    ${children.length > 0 ? `
                        <div style="margin-bottom: 2rem; text-align: center;">
                            <h4 style="color: #495057; margin-bottom: 1rem;">üë∂ Children</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                ${children.map(c => `
                                    <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; border: 2px solid #bee5eb;">
                                        <strong>${c.firstName} ${c.lastName}</strong>
                                        <div style="font-size: 0.8rem; color: #666;">Age: ${getAge(c)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${parents.length === 0 && siblings.length === 0 && children.length === 0 ? `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No family relationships have been established yet.</p>
                            <p>Use the "Add Parent" and "Add Child" buttons to build the family tree!</p>
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="closeModal()" style="flex: 1; padding: 0.75rem; background: #667eea; color: white; border: none; border-radius: 6px;">Close</button>
                    </div>
                </div>
            `;

            showModal(modalContent);
        }

        // Populate dropdowns
        function populateDropdowns() {
            // Family branch dropdown
            const branchSelects = [
                document.getElementById('familyBranch'),
                document.getElementById('editFamilyBranch'),
                document.getElementById('branchFilter')
            ];
            
            branchSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Branch</option>';
                    
                    // Sort branches by generation for better organization
                    const sortedBranches = [...familyBranches].sort((a, b) => {
                        const genA = a.generationLevel || 999;
                        const genB = b.generationLevel || 999;
                        if (genA !== genB) return genA - genB;
                        return a.name.localeCompare(b.name);
                    });
                    
                    sortedBranches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch.name;
                        option.textContent = `${branch.name} (Gen ${branch.generationLevel || '?'})`;
                        select.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });

            // Married to dropdown
            const marriedToSelects = [
                document.getElementById('marriedTo'),
                document.getElementById('editMarriedTo')
            ];
            
            marriedToSelects.forEach(marriedSelect => {
                if (marriedSelect) {
                    const currentValue = marriedSelect.value;
                    marriedSelect.innerHTML = '<option value="">Select someone</option>';
                    
                    // Sort family members by last name, then first name
                    const sortedMembers = [...familyMembers].sort((a, b) => {
                        const lastNameComp = a.lastName.localeCompare(b.lastName);
                        if (lastNameComp !== 0) return lastNameComp;
                        return a.firstName.localeCompare(b.firstName);
                    });
                    
                    sortedMembers.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.firstName} ${member.lastName}`;
                        marriedSelect.appendChild(option);
                    });
                    
                    // Restore previous selection if it still exists
                    if (currentValue && [...marriedSelect.options].some(opt => opt.value === currentValue)) {
                        marriedSelect.value = currentValue;
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Search and filter
            const searchInput = document.getElementById('searchInput');
            const monthFilter = document.getElementById('monthFilter');
            const branchFilter = document.getElementById('branchFilter');
            const sortOrder = document.getElementById('sortOrder');
            
            if (searchInput) {
                searchInput.addEventListener('input', displayFamilyMembers);
                console.log('Search input listener added');
            } else {
                console.warn('searchInput element not found');
            }
            
            if (monthFilter) {
                monthFilter.addEventListener('change', displayFamilyMembers);
                console.log('Month filter listener added');
            } else {
                console.warn('monthFilter element not found');
            }
            
            if (branchFilter) {
                branchFilter.addEventListener('change', displayFamilyMembers);
                console.log('Branch filter listener added');
            } else {
                console.warn('branchFilter element not found');
            }
            
            if (sortOrder) {
                sortOrder.addEventListener('change', displayFamilyMembers);
                console.log('Sort order listener added');
            } else {
                console.warn('sortOrder element not found');
            }

            // Add member form
            const addMemberForm = document.getElementById('addMemberForm');
            if (addMemberForm) {
                addMemberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addFamilyMember();
                });
                console.log('Add member form listener added');
            } else {
                console.warn('addMemberForm not found');
            }

            // Add branch form
            const addBranchForm = document.getElementById('addBranchForm');
            if (addBranchForm) {
                addBranchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addFamilyBranch();
                });
                console.log('Add branch form listener added');
            } else {
                console.warn('addBranchForm not found');
            }

            // Create family unit form
            const createFamilyUnitForm = document.getElementById('createFamilyUnitForm');
            if (createFamilyUnitForm) {
                createFamilyUnitForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createFamilyUnit();
                });
                console.log('Create family unit form listener added');
            } else {
                console.warn('createFamilyUnitForm not found');
            }

            // Add user form
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addUser();
                });
                console.log('Add user form listener added');
            } else {
                console.warn('addUserForm not found');
            }

            // Add message form
            const addMessageForm = document.getElementById('addMessageForm');
            if (addMessageForm) {
                addMessageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addMessage();
                });
                console.log('Add message form listener added');
            } else {
                console.warn('addMessageForm not found');
            }

            // Edit member form
            const editMemberForm = document.getElementById('editMemberForm');
            if (editMemberForm) {
                editMemberForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateFamilyMember();
                });
                console.log('Edit member form listener added');
            } else {
                console.warn('editMemberForm not found');
            }
            
            console.log('Event listeners setup complete');
        }

        // Add family member
        async function addFamilyMember() {
            try {
                const memberData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    birthMonth: document.getElementById('birthMonth').value,
                    birthDay: parseInt(document.getElementById('birthDay').value),
                    birthYear: parseInt(document.getElementById('birthYear').value),
                    familyBranch: document.getElementById('familyBranch').value,
                    marriedTo: document.getElementById('marriedTo').value || null,
                    mobilePhone: document.getElementById('mobilePhone').value,
                    homePhone: document.getElementById('homePhone').value,
                    workPhone: document.getElementById('workPhone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value,
                    anniversaryDate: document.getElementById('anniversaryDate').value,
                    notes: document.getElementById('notes').value,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_members'), memberData);
                closeModal('addMemberModal');
                document.getElementById('addMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                populateDropdowns();
                showMessage('Family member added successfully!', 'success');
            } catch (error) {
                console.error('Error adding family member:', error);
                showMessage('Error adding family member: ' + error.message, 'error');
            }
        }

        // Update family member (old modal version - will be replaced by new modal)
        async function updateFamilyMember() {
            try {
                const memberId = document.getElementById('editMemberId').value;
                const memberData = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    birthMonth: document.getElementById('editBirthMonth').value,
                    birthDay: parseInt(document.getElementById('editBirthDay').value),
                    birthYear: parseInt(document.getElementById('editBirthYear').value),
                    familyBranch: document.getElementById('editFamilyBranch').value,
                    marriedTo: document.getElementById('editMarriedTo').value || null,
                    mobilePhone: document.getElementById('editMobilePhone').value,
                    homePhone: document.getElementById('editHomePhone').value,
                    workPhone: document.getElementById('editWorkPhone').value,
                    address: document.getElementById('editAddress').value,
                    city: document.getElementById('editCity').value,
                    state: document.getElementById('editState').value,
                    zipCode: document.getElementById('editZipCode').value,
                    anniversaryDate: document.getElementById('editAnniversaryDate').value,
                    notes: document.getElementById('editNotes').value,
                    updatedAt: new Date(),
                    updatedBy: currentUser.username
                };

                await updateDoc(doc(db, 'family_members', memberId), memberData);
                closeModal('editMemberModal');
                document.getElementById('editMemberForm').reset();
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                populateDropdowns();
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member: ' + error.message, 'error');
            }
        }

        // Add family branch
        async function addFamilyBranch() {
            try {
                const branchData = {
                    name: document.getElementById('branchName').value,
                    description: document.getElementById('branchDescription').value,
                    generationLevel: parseInt(document.getElementById('generationLevel').value),
                    branchType: document.getElementById('branchType').value,
                    parentBranch: document.getElementById('parentBranch').value || null,
                    sharedMembers: [], // Array to store member IDs who appear in multiple branches
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_branches'), branchData);
                closeModal('addBranchModal');
                document.getElementById('addBranchForm').reset();
                await loadFamilyBranches();
                displayBranches();
                populateDropdowns();
                generateSmartSuggestions(); // Generate suggestions after adding
                alert('Family branch added successfully!');
            } catch (error) {
                alert('Error adding family branch: ' + error.message);
            }
        }

        // Create family unit
        async function createFamilyUnit() {
            try {
                const selectedBranches = Array.from(
                    document.querySelectorAll('#branchCheckboxes input[type="checkbox"]:checked')
                ).map(checkbox => checkbox.value);

                if (selectedBranches.length === 0) {
                    alert('Please select at least one branch for this family unit.');
                    return;
                }

                const unitData = {
                    name: document.getElementById('unitName').value,
                    description: document.getElementById('unitDescription').value,
                    type: document.getElementById('unitType').value,
                    branches: selectedBranches,
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'family_units'), unitData);
                closeModal('createFamilyUnitModal');
                document.getElementById('createFamilyUnitForm').reset();
                await loadFamilyUnits();
                displayBranches();
                alert('Family unit created successfully!');
            } catch (error) {
                alert('Error creating family unit: ' + error.message);
            }
        }

        // Add user (admin only)
        async function addUser() {
            if (!currentUser.isAdmin) return;

            try {
                const userData = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('userPhone').value,
                    isAdmin: parseInt(document.getElementById('isAdmin').value),
                    createdAt: new Date(),
                    createdBy: currentUser.username
                };

                await addDoc(collection(db, 'users'), userData);
                closeModal('addUserModal');
                document.getElementById('addUserForm').reset();
                await loadUsers();
                displayUsers();
                alert('User added successfully!');
            } catch (error) {
                alert('Error adding user: ' + error.message);
            }
        }

        // Add message
        async function addMessage() {
            try {
                const messageData = {
                    title: document.getElementById('messageTitle').value,
                    content: document.getElementById('messageContent').value,
                    author: currentUser.username,
                    createdAt: new Date()
                };

                await addDoc(collection(db, 'messages'), messageData);
                closeModal('addMessageModal');
                document.getElementById('addMessageForm').reset();
                await loadMessages();
                displayMessages();
                alert('Message posted successfully!');
            } catch (error) {
                alert('Error posting message: ' + error.message);
            }
        }

        // Bulk import
        let selectedFileData = null;

        // File upload handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        // Drag and drop handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processExcelFile(files[0]);
            }
        });

        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON (array of arrays)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Filter out empty rows
                    const filteredData = jsonData.filter(row => 
                        row.length > 0 && row.some(cell => cell && cell.toString().trim())
                    );
                    
                    if (filteredData.length === 0) {
                        alert('No data found in the Excel file');
                        return;
                    }
                    
                    selectedFileData = filteredData;
                    displayFileInfo(file, filteredData.length);
                    displayPreview(filteredData);
                    
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function displayFileInfo(file, rowCount) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('rowCount').textContent = rowCount;
            document.getElementById('fileInfo').style.display = 'block';
        }

        function displayPreview(data) {
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            // Show first 5 rows (skip header if it exists)
            const startRow = (data[0] && typeof data[0][0] === 'string' && data[0][0].toLowerCase().includes('name')) ? 1 : 0;
            const previewRows = data.slice(startRow, startRow + 5);
            
            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                
                // Map columns: A, B, C, D, E, skip F, G
                const firstName = row[0] || '';
                const lastName = row[1] || '';
                const month = row[2] || '';
                const day = row[3] || '';
                const year = row[4] || '';
                const columnG = row[6] || ''; // Column G (shows what's there but won't be imported)
                
                tr.innerHTML = `
                    <td>${firstName}</td>
                    <td>${lastName}</td>
                    <td>${month}</td>
                    <td>${day}</td>
                    <td>${year}</td>
                    <td style="opacity: 0.5; font-style: italic;">${columnG}<br><small>(ignored)</small></td>
                `;
                previewBody.appendChild(tr);
            });
            
            document.getElementById('previewContainer').style.display = 'block';
        }

        async function confirmImport() {
            console.log('confirmImport called');
            
            if (!currentUser.isAdmin) {
                alert('Only admin users can import data');
                return;
            }
            
            if (!selectedFileData) {
                alert('No file data selected');
                return;
            }

            console.log('Selected file data length:', selectedFileData.length);

            const confirmMessage = `Are you sure you want to import ${selectedFileData.length} records? This will add all valid entries to the database.`;
            if (!confirm(confirmMessage)) return;

            // Show loading message
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.textContent;
            importBtn.textContent = 'Importing...';
            importBtn.disabled = true;

            try {
                let imported = 0;
                let skipped = 0;
                
                // Skip header row if it exists
                const startRow = (selectedFileData[0] && typeof selectedFileData[0][0] === 'string' && 
                                selectedFileData[0][0].toLowerCase().includes('name')) ? 1 : 0;
                
                const dataRows = selectedFileData.slice(startRow);
                console.log('Processing', dataRows.length, 'rows');
                
                for (const row of dataRows) {
                    try {
                        // Map columns: A, B, C, D, E, skip F, G
                        const firstName = row[0]?.toString().trim() || '';
                        const lastName = row[1]?.toString().trim() || '';
                        const month = row[2]?.toString().trim() || '';
                        const day = parseInt(row[3]) || 1;
                        const year = parseInt(row[4]) || new Date().getFullYear();
                        // Note: Column G in your data appears to be birthday dates, not family branches
                        // We'll leave familyBranch empty for now and you can organize families later
                        
                        // Only import if we have at least first and last name
                        if (firstName && lastName) {
                            const memberData = {
                                firstName: firstName,
                                lastName: lastName,
                                birthMonth: month,
                                birthDay: day,
                                birthYear: year,
                                familyBranch: '', // Leave empty - you'll organize into families later
                                relationship: '', // Can be updated later
                                relatedTo: '',
                                mobilePhone: '',
                                homePhone: '',
                                workPhone: '',
                                address: '',
                                city: '',
                                state: '',
                                zipCode: '',
                                anniversaryDate: '',
                                notes: '',
                                createdAt: new Date(),
                                createdBy: currentUser.username
                            };

                            console.log('Adding member:', firstName, lastName);
                            await addDoc(collection(db, 'family_members'), memberData);
                            imported++;
                        } else {
                            console.log('Skipping row - missing name:', firstName, lastName);
                            skipped++;
                        }
                    } catch (rowError) {
                        console.error('Error processing row:', row, rowError);
                        skipped++;
                    }
                }

                console.log('Import completed. Imported:', imported, 'Skipped:', skipped);

                // Clear the file selection
                clearFile();
                
                // Refresh the display
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                
                alert(`Import completed!\nImported: ${imported} family members\nSkipped: ${skipped} incomplete records`);
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Error importing data: ' + error.message);
            } finally {
                // Restore button
                importBtn.textContent = originalText;
                importBtn.disabled = false;
            }
        }

        // Make sure the function is globally accessible
        window.confirmImport = confirmImport;

        function clearFile() {
            selectedFileData = null;
            document.getElementById('excelFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('previewContainer').style.display = 'none';
        }

        // Make sure functions are globally accessible
        window.handleFileSelect = handleFileSelect;
        window.clearFile = clearFile;
        
        // Test function to verify database connectivity
        window.testDatabase = async function() {
            try {
                console.log('Testing database connection...');
                
                // Just try to read from the users collection (which we know exists)
                const usersSnapshot = await getDocs(collection(db, 'users'));
                console.log('Successfully connected to database. Found', usersSnapshot.size, 'users');
                
                // Try to read from family_members collection (might not exist yet)
                const familySnapshot = await getDocs(collection(db, 'family_members'));
                console.log('Family members collection exists. Found', familySnapshot.size, 'members');
                
                alert(`Database connection successful!\nUsers: ${usersSnapshot.size}\nFamily Members: ${familySnapshot.size}`);
                
            } catch (error) {
                console.error('Database test failed:', error);
                alert('Database test failed: ' + error.message + '\n\nThis might be a Firestore security rules issue.');
            }
        };

        // Legacy bulk import function (keeping for backward compatibility)
        async function bulkImport() {
            if (!currentUser.isAdmin) return;

            const data = document.getElementById('importData').value;
            if (!data.trim()) {
                alert('Please paste data to import');
                return;
            }

            try {
                const lines = data.split('\n').filter(line => line.trim());
                let imported = 0;

                for (const line of lines) {
                    const fields = line.split('\t');
                    if (fields.length >= 5) {
                        const memberData = {
                            firstName: fields[0]?.trim() || '',
                            lastName: fields[1]?.trim() || '',
                            birthMonth: fields[2]?.trim() || '',
                            birthDay: parseInt(fields[3]?.trim()) || 1,
                            birthYear: parseInt(fields[4]?.trim()) || new Date().getFullYear(),
                            familyBranch: fields[5]?.trim() || '',
                            relationship: fields[6]?.trim() || '',
                            createdAt: new Date(),
                            createdBy: currentUser.username
                        };

                        if (memberData.firstName && memberData.lastName) {
                            await addDoc(collection(db, 'family_members'), memberData);
                            imported++;
                        }
                    }
                }

                document.getElementById('importData').value = '';
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully imported ${imported} family members!`);
            } catch (error) {
                alert('Error importing data: ' + error.message);
            }
        }

        // Delete functions
        window.deleteFamilyMember = async function(id) {
            if (confirm('Are you sure you want to delete this family member?')) {
                try {
                    await deleteDoc(doc(db, 'family_members', id));
                    await loadFamilyMembers();
                    displayFamilyMembers();
                    displayUpcomingBirthdays();
                    alert('Family member deleted successfully!');
                } catch (error) {
                    alert('Error deleting family member: ' + error.message);
                }
            }
        };

        window.deleteBranch = async function(id) {
            if (confirm('Are you sure you want to delete this branch?')) {
                try {
                    await deleteDoc(doc(db, 'family_branches', id));
                    await loadFamilyBranches();
                    displayBranches();
                    populateDropdowns();
                    alert('Branch deleted successfully!');
                } catch (error) {
                    alert('Error deleting branch: ' + error.message);
                }
            }
        };

        // Family Unit Management Functions
        window.deleteFamilyUnit = async function(id) {
            if (confirm('Are you sure you want to delete this family unit? The branches will remain but will no longer be grouped together.')) {
                try {
                    await deleteDoc(doc(db, 'family_units', id));
                    await loadFamilyUnits();
                    displayBranches();
                    alert('Family unit deleted successfully!');
                } catch (error) {
                    alert('Error deleting family unit: ' + error.message);
                }
            }
        };

        window.manageFamilyUnit = function(id) {
            // For now, just show an alert. This could be expanded to a full management modal
            const unit = familyUnits.find(u => u.id === id);
            alert(`Managing ${unit.name}\n\nBranches: ${unit.branches.join(', ')}\n\nThis feature can be expanded to allow editing the unit, adding/removing branches, etc.`);
        };

        window.removeBranchFromUnit = async function(branchName, unitId) {
            if (confirm(`Remove ${branchName} from this family unit?`)) {
                try {
                    const unit = familyUnits.find(u => u.id === unitId);
                    const updatedBranches = unit.branches.filter(b => b !== branchName);
                    
                    await updateDoc(doc(db, 'family_units', unitId), {
                        branches: updatedBranches
                    });
                    
                    await loadFamilyUnits();
                    displayBranches();
                    alert('Branch removed from family unit successfully!');
                } catch (error) {
                    alert('Error removing branch from unit: ' + error.message);
                }
            }
        };

        window.deleteUser = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await deleteDoc(doc(db, 'users', id));
                    await loadUsers();
                    displayUsers();
                    alert('User deleted successfully!');
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        };

        window.deleteMessage = async function(id) {
            if (!currentUser.isAdmin) return;
            
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await deleteDoc(doc(db, 'messages', id));
                    await loadMessages();
                    displayMessages();
                    alert('Message deleted successfully!');
                } catch (error) {
                    alert('Error deleting message: ' + error.message);
                }
            }
        };

        // Remove all family members (admin only)
        window.removeAllFamilyMembers = async function() {
            console.log('removeAllFamilyMembers called');
            console.log('Current user:', currentUser);
            console.log('Is admin:', currentUser?.isAdmin);
            console.log('Family members count:', familyMembers.length);
            
            if (!currentUser || !currentUser.isAdmin) {
                alert('Only admin users can delete all family members');
                return;
            }
            
            if (familyMembers.length === 0) {
                alert('No family members to delete');
                return;
            }
            
            const confirmMessage = `‚ö†Ô∏è DANGER: This will permanently delete ALL ${familyMembers.length} family members from the database!\n\nThis action cannot be undone. Are you absolutely sure?`;
            if (!confirm(confirmMessage)) return;
            
            const doubleConfirm = prompt('Type "DELETE ALL" to confirm this dangerous action:');
            if (doubleConfirm !== 'DELETE ALL') {
                alert('Action cancelled - text did not match exactly.');
                return;
            }
            
            try {
                let deleted = 0;
                console.log('Starting deletion process...');
                
                for (const member of familyMembers) {
                    console.log('Deleting member:', member.firstName, member.lastName, 'ID:', member.id);
                    await deleteDoc(doc(db, 'family_members', member.id));
                    deleted++;
                }
                
                console.log('Deletion completed. Refreshing data...');
                await loadFamilyMembers();
                displayFamilyMembers();
                displayUpcomingBirthdays();
                alert(`Successfully deleted ${deleted} family members. Database is now clean for proper import.`);
            } catch (error) {
                console.error('Error deleting family members:', error);
                alert('Error deleting family members: ' + error.message);
            }
        };

        // Modal functions
        window.openAddMemberModal = function() {
            document.getElementById('addMemberModal').classList.add('active');
        };

        window.openAddBranchModal = function() {
            populateParentBranchDropdown();
            generateSmartSuggestions();
            document.getElementById('addBranchModal').classList.add('active');
        };

        // Family Unit Modal Functions
        window.openCreateFamilyUnitModal = function() {
            populateBranchCheckboxes();
            document.getElementById('createFamilyUnitModal').classList.add('active');
        };

        function populateBranchCheckboxes() {
            const container = document.getElementById('branchCheckboxes');
            
            // Get branches that are not already in a family unit
            const branchesInUnits = familyUnits.flatMap(unit => unit.branches || []);
            const availableBranches = familyBranches.filter(branch => 
                !branchesInUnits.includes(branch.name)
            );

            if (availableBranches.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No available branches to add to a family unit.</p>';
                return;
            }

            container.innerHTML = availableBranches.map(branch => `
                <div style="margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #e9ecef; border-radius: 4px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${branch.name}" style="margin-right: 0.5rem;">
                        <div>
                            <strong>${branch.name}</strong>
                            <div style="font-size: 0.8rem; color: #666;">
                                Generation ${branch.generationLevel || '?'} ‚Ä¢ ${formatBranchType(branch.branchType)}
                                ‚Ä¢ ${familyMembers.filter(m => m.familyBranch === branch.name).length} members
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');
        }

        // Populate parent branch dropdown
        function populateParentBranchDropdown() {
            const parentBranchSelect = document.getElementById('parentBranch');
            parentBranchSelect.innerHTML = '<option value="">No Parent Branch</option>';
            
            familyBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = `${branch.name} (Gen ${branch.generationLevel || '?'})`;
                parentBranchSelect.appendChild(option);
            });
        }

        // Generate smart suggestions for branch creation
        function generateSmartSuggestions() {
            const suggestionsDiv = document.getElementById('smartSuggestions');
            const suggestionsList = document.getElementById('suggestionsList');
            
            if (!familyMembers.length) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const suggestions = [];
            
            // Analyze last names for family grouping suggestions
            const lastNameGroups = {};
            familyMembers.forEach(member => {
                if (!member.familyBranch || member.familyBranch.trim() === '') {
                    const lastName = member.lastName;
                    if (!lastNameGroups[lastName]) lastNameGroups[lastName] = [];
                    lastNameGroups[lastName].push(member);
                }
            });

            // Suggest nuclear families for groups with same last name
            Object.entries(lastNameGroups).forEach(([lastName, members]) => {
                if (members.length >= 2) {
                    const ages = members.map(m => new Date().getFullYear() - m.birthYear);
                    const hasAdults = ages.some(age => age >= 18);
                    const hasChildren = ages.some(age => age < 18);
                    
                    if (hasAdults && hasChildren) {
                        suggestions.push({
                            type: 'nuclear_family',
                            text: `Create "${lastName} Nuclear Family" for ${members.length} members`,
                            action: () => suggestBranchName(`${lastName} Nuclear Family`, 'nuclear_family', 2)
                        });
                    } else if (hasAdults) {
                        suggestions.push({
                            type: 'cousin_branch', 
                            text: `Create "${lastName} Cousin Branch" for ${members.length} members`,
                            action: () => suggestBranchName(`${lastName} Cousin Branch`, 'cousin_branch', 3)
                        });
                    }
                }
            });

            // Show suggestions
            if (suggestions.length > 0) {
                suggestionsList.innerHTML = suggestions.map(suggestion => 
                    `<div style="margin-bottom: 0.5rem;">
                        <button class="btn" onclick="(${suggestion.action})()" style="background: #e3f2fd; color: #1976d2; border: 1px solid #90caf9; font-size: 0.85rem;">
                            ${suggestion.text}
                        </button>
                    </div>`
                ).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        // Suggest branch name and type
        function suggestBranchName(name, type, generation) {
            document.getElementById('branchName').value = name;
            document.getElementById('branchType').value = type;
            document.getElementById('generationLevel').value = generation;
        }

        // Open branch management modal
        window.openManageBranchModal = function(branchId) {
            const branch = familyBranches.find(b => b.id === branchId);
            if (!branch) return;

            document.getElementById('manageBranchTitle').textContent = `Manage: ${branch.name}`;
            window.currentManagingBranch = branch;
            
            populateManageBranchData(branch);
            document.getElementById('manageBranchModal').classList.add('active');
        };

        // Populate management modal data
        function populateManageBranchData(branch) {
            // Populate source branch dropdown for moving
            const sourceBranchSelect = document.getElementById('sourceBranch');
            sourceBranchSelect.innerHTML = '<option value="">Select source branch</option>';
            
            familyBranches.forEach(b => {
                if (b.id !== branch.id) {
                    const option = document.createElement('option');
                    option.value = b.name;
                    option.textContent = `${b.name} (${familyMembers.filter(m => m.familyBranch === b.name).length} members)`;
                    sourceBranchSelect.appendChild(option);
                }
            });

            // Populate shareable members
            const shareableMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const shareableDiv = document.getElementById('shareableMembersList');
            
            if (shareableMembers.length > 0) {
                shareableDiv.innerHTML = shareableMembers.map(member => `
                    <div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${member.firstName} ${member.lastName}</strong>
                                <small style="color: #666; margin-left: 0.5rem;">${member.birthYear || ''}</small>
                            </div>
                            <button class="btn btn-primary" onclick="openShareMemberModal('${member.id}')" style="font-size: 0.8rem;">
                                Share with Other Branches
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                shareableDiv.innerHTML = '<p style="text-align: center; color: #666;">No members in this branch yet</p>';
            }

            // Generate branch-specific suggestions
            generateBranchSuggestions(branch);
        }

        // Load candidates for moving
        window.loadMoveCandidates = function() {
            const sourceBranchName = document.getElementById('sourceBranch').value;
            const candidatesDiv = document.getElementById('moveCandidates');
            const moveBtn = document.getElementById('moveSelectedBtn');

            if (!sourceBranchName) {
                candidatesDiv.innerHTML = '<p style="text-align: center; color: #666;">Select a source branch to see members</p>';
                moveBtn.style.display = 'none';
                return;
            }

            const candidates = familyMembers.filter(m => m.familyBranch === sourceBranchName);
            
            if (candidates.length === 0) {
                candidatesDiv.innerHTML = '<p style="text-align: center; color: #666;">No members in selected branch</p>';
                moveBtn.style.display = 'none';
                return;
            }

            candidatesDiv.innerHTML = candidates.map(member => `
                <div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${member.id}" style="margin-right: 0.5rem;" onchange="updateMoveButton()">
                        <div>
                            <strong>${member.firstName} ${member.lastName}</strong>
                            <small style="color: #666; margin-left: 0.5rem;">
                                Born ${member.birthMonth || ''} ${member.birthDay || ''}, ${member.birthYear || ''}
                            </small>
                            ${member.relationship ? `<br><small style="color: #666;">Relationship: ${member.relationship}</small>` : ''}
                        </div>
                    </label>
                </div>
            `).join('');

            moveBtn.style.display = 'block';
        };

        // Update move button state
        window.updateMoveButton = function() {
            const checkboxes = document.querySelectorAll('#moveCandidates input[type="checkbox"]:checked');
            const moveBtn = document.getElementById('moveSelectedBtn');
            moveBtn.textContent = `Move Selected Members (${checkboxes.length})`;
            moveBtn.disabled = checkboxes.length === 0;
        };

        // Move selected members
        window.moveSelectedMembers = async function() {
            const checkboxes = document.querySelectorAll('#moveCandidates input[type="checkbox"]:checked');
            const memberIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (memberIds.length === 0) return;

            const targetBranch = window.currentManagingBranch;
            if (!targetBranch) return;

            try {
                for (const memberId of memberIds) {
                    await updateDoc(doc(db, 'family_members', memberId), {
                        familyBranch: targetBranch.name,
                        updatedAt: new Date(),
                        updatedBy: currentUser.username
                    });
                }

                alert(`Successfully moved ${memberIds.length} members to ${targetBranch.name}`);
                
                // Refresh data
                await loadFamilyMembers();
                displayFamilyMembers();
                displayBranches();
                populateDropdowns();
                
                // Refresh management modal
                populateManageBranchData(targetBranch);
                
            } catch (error) {
                alert('Error moving members: ' + error.message);
            }
        };

        // Generate branch-specific suggestions
        function generateBranchSuggestions(branch) {
            const suggestionsDiv = document.getElementById('branchSuggestions');
            const suggestions = [];

            const branchMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const unassignedMembers = familyMembers.filter(m => !m.familyBranch || m.familyBranch.trim() === '');

            // Suggest adding unassigned family members with same last name
            if (branchMembers.length > 0) {
                const branchLastNames = [...new Set(branchMembers.map(m => m.lastName))];
                
                branchLastNames.forEach(lastName => {
                    const matchingUnassigned = unassignedMembers.filter(m => m.lastName === lastName);
                    if (matchingUnassigned.length > 0) {
                        suggestions.push({
                            text: `Add ${matchingUnassigned.length} unassigned ${lastName} members to this branch`,
                            action: `moveUnassignedByLastName('${lastName}', '${branch.name}')`
                        });
                    }
                });
            }

            // Suggest creating child branches
            if (branch.branchType === 'extended_family' && branchMembers.length > 6) {
                suggestions.push({
                    text: `This branch has ${branchMembers.length} members. Consider splitting into nuclear families`,
                    action: `suggestSplitBranch('${branch.id}')`
                });
            }

            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = suggestions.map(s => 
                    `<div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0 0 0.5rem 0;">${s.text}</p>
                        <button class="btn btn-primary" onclick="${s.action}" style="font-size: 0.85rem;">Apply Suggestion</button>
                    </div>`
                ).join('');
            } else {
                suggestionsDiv.innerHTML = '<p style="text-align: center; color: #666;">No suggestions for this branch right now</p>';
            }
        }

        // Tab switching for management modal
        window.switchManageTab = function(tabName) {
            document.querySelectorAll('.manage-tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('#manageBranchModal .tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
        };

        // Helper functions for smart suggestions
        window.moveUnassignedByLastName = async function(lastName, targetBranchName) {
            const unassignedMembers = familyMembers.filter(m => 
                (!m.familyBranch || m.familyBranch.trim() === '') && m.lastName === lastName
            );

            if (unassignedMembers.length === 0) {
                alert('No unassigned members found with that last name');
                return;
            }

            const confirmMessage = `Move ${unassignedMembers.length} unassigned ${lastName} members to ${targetBranchName}?`;
            if (!confirm(confirmMessage)) return;

            try {
                for (const member of unassignedMembers) {
                    await updateDoc(doc(db, 'family_members', member.id), {
                        familyBranch: targetBranchName,
                        updatedAt: new Date(),
                        updatedBy: currentUser.username
                    });
                }

                alert(`Successfully moved ${unassignedMembers.length} ${lastName} members to ${targetBranchName}`);
                
                // Refresh data
                await loadFamilyMembers();
                displayFamilyMembers();
                displayBranches();
                
                // Refresh management modal if open
                if (window.currentManagingBranch) {
                    populateManageBranchData(window.currentManagingBranch);
                }
                
            } catch (error) {
                alert('Error moving members: ' + error.message);
            }
        };

        window.suggestSplitBranch = function(branchId) {
            const branch = familyBranches.find(b => b.id === branchId);
            if (!branch) return;

            const branchMembers = familyMembers.filter(m => m.familyBranch === branch.name);
            const lastNameGroups = {};
            
            branchMembers.forEach(member => {
                if (!lastNameGroups[member.lastName]) lastNameGroups[member.lastName] = [];
                lastNameGroups[member.lastName].push(member);
            });

            let suggestions = Object.entries(lastNameGroups)
                .filter(([lastName, members]) => members.length >= 2)
                .map(([lastName, members]) => `‚Ä¢ ${lastName} family (${members.length} members)`)
                .join('\n');

            if (suggestions) {
                alert(`Consider creating separate nuclear family branches:\n\n${suggestions}\n\nUse the "Move Members" tab to organize them.`);
            } else {
                alert('No clear family groupings found for splitting this branch.');
            }
        };

        // Add smart suggestions to existing functions
        function enhanceLoadData() {
            const originalLoadData = window.loadData;
            window.loadData = async function() {
                await originalLoadData();
                generateSmartSuggestions();
            };
        }

        // Initialize smart suggestions
        if (typeof window.loadData !== 'undefined') {
            enhanceLoadData();
        }

        window.openAddUserModal = function() {
            if (!currentUser.isAdmin) return;
            document.getElementById('addUserModal').classList.add('active');
        };

        window.openAddMessageModal = function() {
            document.getElementById('addMessageModal').classList.add('active');
        };

        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                alert('Family member not found');
                return;
            }

            // Populate the edit form with existing data
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editFirstName').value = member.firstName || '';
            document.getElementById('editLastName').value = member.lastName || '';
            document.getElementById('editBirthMonth').value = member.birthMonth || '';
            document.getElementById('editBirthDay').value = member.birthDay || '';
            document.getElementById('editBirthYear').value = member.birthYear || '';
            document.getElementById('editFamilyBranch').value = member.familyBranch || '';
            document.getElementById('editRelationship').value = member.relationship || '';
            document.getElementById('editRelatedTo').value = member.relatedTo || '';
            document.getElementById('editMobilePhone').value = member.mobilePhone || '';
            document.getElementById('editHomePhone').value = member.homePhone || '';
            document.getElementById('editWorkPhone').value = member.workPhone || '';
            document.getElementById('editAddress').value = member.address || '';
            document.getElementById('editCity').value = member.city || '';
            document.getElementById('editState').value = member.state || '';
            document.getElementById('editZipCode').value = member.zipCode || '';
            document.getElementById('editAnniversaryDate').value = member.anniversaryDate || '';
            document.getElementById('editNotes').value = member.notes || '';

            // Show the modal
            document.getElementById('editMemberModal').classList.add('active');
        };

        window.viewBranchMembers = function(branchName) {
            const branchMembers = familyMembers.filter(member => member.familyBranch === branchName);
            
            // Update modal title and stats
            document.getElementById('branchViewTitle').textContent = `${branchName} - Family Members`;
            document.getElementById('branchStatsName').textContent = branchName;
            document.getElementById('branchStatsCount').textContent = `${branchMembers.length} family member${branchMembers.length !== 1 ? 's' : ''}`;
            
            // Clear search input
            document.getElementById('branchSearchInput').value = '';
            
            // Display members or no members message
            if (branchMembers.length === 0) {
                document.getElementById('branchMembersGrid').style.display = 'none';
                document.getElementById('noBranchMembers').style.display = 'block';
            } else {
                document.getElementById('branchMembersGrid').style.display = 'grid';
                document.getElementById('noBranchMembers').style.display = 'none';
                displayBranchMembers(branchMembers);
            }
            
            // Show the modal
            document.getElementById('branchViewModal').classList.add('active');
            
            // Set up search functionality for this branch
            const searchInput = document.getElementById('branchSearchInput');
            searchInput.oninput = function() {
                const searchTerm = this.value.toLowerCase();
                const filteredMembers = branchMembers.filter(member => 
                    member.firstName.toLowerCase().includes(searchTerm) ||
                    member.lastName.toLowerCase().includes(searchTerm) ||
                    (member.relationship && member.relationship.toLowerCase().includes(searchTerm))
                );
                displayBranchMembers(filteredMembers);
            };
        };

        function displayBranchMembers(members) {
            const grid = document.getElementById('branchMembersGrid');
            
            // Sort members by age (oldest first) for better family tree view
            const sortedMembers = [...members].sort((a, b) => getAge(b) - getAge(a));
            
            grid.innerHTML = sortedMembers.map(member => {
                const age = getAge(member);
                const nextBirthday = getNextBirthday(member);
                const daysUntilBirthday = Math.ceil((nextBirthday - new Date()) / (1000 * 60 * 60 * 24));
                
                return `
                <div class="family-card" style="border-left: 4px solid #28a745;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 0.5rem; color: #28a745;">${member.firstName} ${member.lastName}</h3>
                            <div class="family-info" style="font-size: 0.9rem;">
                                <div><strong>üéÇ Birthday:</strong> ${member.birthMonth} ${member.birthDay}, ${member.birthYear} <span style="color: #666;">(Age: ${age})</span></div>
                                <div><strong>‚è∞ Next Birthday:</strong> <span style="color: ${daysUntilBirthday <= 30 ? '#e74c3c' : '#666'};">${daysUntilBirthday} days</span></div>
                                ${member.relationship ? `<div><strong>üë™ Relationship:</strong> ${member.relationship}</div>` : ''}
                                ${member.mobilePhone ? `<div><strong>üì± Mobile:</strong> ${member.mobilePhone}</div>` : ''}
                                ${member.homePhone ? `<div><strong>üè† Home:</strong> ${member.homePhone}</div>` : ''}
                                ${member.workPhone ? `<div><strong>üíº Work:</strong> ${member.workPhone}</div>` : ''}
                                ${member.address ? `<div><strong>üìç Address:</strong> ${member.address}${member.city ? `, ${member.city}` : ''}${member.state ? `, ${member.state}` : ''}</div>` : ''}
                                ${member.anniversaryDate ? `<div><strong>üíí Anniversary:</strong> ${member.anniversaryDate}</div>` : ''}
                                ${member.notes ? `<div style="margin-top: 0.5rem;"><strong>üìù Notes:</strong> ${member.notes}</div>` : ''}
                            </div>
                        </div>
                        <div style="margin-left: 1rem;">
                            <div style="font-size: 2rem; opacity: 0.6;">üë§</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openEditMemberModal('${member.id}')" style="font-size: 0.85rem;">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteFamilyMember('${member.id}')" style="font-size: 0.85rem;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        window.closeModal = function(modalId) {
            if (modalId) {
                document.getElementById(modalId).classList.remove('active');
            } else {
                // If no modalId provided, close any active modal
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        };

        // General showModal function
        window.showModal = function(content, modalId = 'generalModal') {
            // Create modal if it doesn't exist
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    opacity: 0;
                    visibility: hidden;
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = content;
            modal.classList.add('active');
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
        };

        // Open edit member modal function
        window.openEditMemberModal = function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) {
                console.error('Member not found:', memberId);
                return;
            }

            // Get list of potential spouses (exclude self)
            const potentialSpouses = familyMembers
                .filter(m => m.id !== memberId)
                .sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));

            const modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem;">‚úèÔ∏è Edit Family Member</h3>
                    <form id="editMemberForm" onsubmit="updateFamilyMember(event, '${memberId}')">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">First Name *</label>
                                <input type="text" name="firstName" value="${member.firstName || ''}" required 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Last Name *</label>
                                <input type="text" name="lastName" value="${member.lastName || ''}" required 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Birth Month *</label>
                                <select name="birthMonth" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Select Month</option>
                                    <option value="January" ${member.birthMonth === 'January' ? 'selected' : ''}>January</option>
                                    <option value="February" ${member.birthMonth === 'February' ? 'selected' : ''}>February</option>
                                    <option value="March" ${member.birthMonth === 'March' ? 'selected' : ''}>March</option>
                                    <option value="April" ${member.birthMonth === 'April' ? 'selected' : ''}>April</option>
                                    <option value="May" ${member.birthMonth === 'May' ? 'selected' : ''}>May</option>
                                    <option value="June" ${member.birthMonth === 'June' ? 'selected' : ''}>June</option>
                                    <option value="July" ${member.birthMonth === 'July' ? 'selected' : ''}>July</option>
                                    <option value="August" ${member.birthMonth === 'August' ? 'selected' : ''}>August</option>
                                    <option value="September" ${member.birthMonth === 'September' ? 'selected' : ''}>September</option>
                                    <option value="October" ${member.birthMonth === 'October' ? 'selected' : ''}>October</option>
                                    <option value="November" ${member.birthMonth === 'November' ? 'selected' : ''}>November</option>
                                    <option value="December" ${member.birthMonth === 'December' ? 'selected' : ''}>December</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Birth Day *</label>
                                <input type="number" name="birthDay" min="1" max="31" value="${member.birthDay || ''}" required 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Birth Year *</label>
                                <input type="number" name="birthYear" min="1900" max="2030" value="${member.birthYear || ''}" required 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Family Group</label>
                                <select name="familyBranch" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Select Group</option>
                                    ${familyBranches.map(branch => 
                                        `<option value="${branch.name}" ${member.familyBranch === branch.name ? 'selected' : ''}>${branch.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">üíç Married To</label>
                                <select name="marriedTo" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="">Select someone</option>
                                    ${potentialSpouses.map(spouse => 
                                        `<option value="${spouse.id}" ${member.marriedTo === spouse.id ? 'selected' : ''}>${spouse.firstName} ${spouse.lastName}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Mobile Phone</label>
                                <input type="tel" name="mobilePhone" value="${member.mobilePhone || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Home Phone</label>
                                <input type="tel" name="homePhone" value="${member.homePhone || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Work Phone</label>
                                <input type="tel" name="workPhone" value="${member.workPhone || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Email</label>
                            <input type="email" name="email" value="${member.email || ''}" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>

                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Street Address</label>
                                <input type="text" name="address" value="${member.address || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">City</label>
                                <input type="text" name="city" value="${member.city || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">State</label>
                                <input type="text" name="state" value="${member.state || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Zip Code</label>
                                <input type="text" name="zipCode" value="${member.zipCode || ''}" 
                                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Anniversary Date</label>
                            <input type="date" name="anniversaryDate" value="${member.anniversaryDate || ''}" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500;">Notes</label>
                            <textarea name="notes" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical;">${member.notes || ''}</textarea>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="closeModal()" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                            <button type="submit" style="padding: 0.75rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">üíæ Save Changes</button>
                        </div>
                    </form>
                </div>
            `;

            showModal(modalContent);
        };

        // Open add member modal function
        window.openAddMemberModal = function() {
            const modal = document.getElementById('addMemberModal');
            if (modal) {
                populateDropdowns(); // Make sure dropdowns are populated
                modal.classList.add('active');
            }
        };

        // Update family member function
        window.updateFamilyMember = async function(event, memberId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const memberRef = doc(db, 'family_members', memberId);
                const updateData = {
                    firstName: formData.get('firstName'),
                    lastName: formData.get('lastName'),
                    birthMonth: formData.get('birthMonth'),
                    birthDay: parseInt(formData.get('birthDay')),
                    birthYear: parseInt(formData.get('birthYear')),
                    familyBranch: formData.get('familyBranch'),
                    marriedTo: formData.get('marriedTo') || null,
                    mobilePhone: formData.get('mobilePhone'),
                    homePhone: formData.get('homePhone'),
                    workPhone: formData.get('workPhone'),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    state: formData.get('state'),
                    zipCode: formData.get('zipCode'),
                    anniversaryDate: formData.get('anniversaryDate'),
                    notes: formData.get('notes'),
                    updatedAt: new Date()
                };

                await updateDoc(memberRef, updateData);
                
                closeModal();
                loadFamilyMembers(); // Refresh the display
                showMessage('Family member updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating family member:', error);
                showMessage('Error updating family member: ' + error.message, 'error');
            }
        };

        // Delete family member function
        window.deleteFamilyMember = async function(memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return;

            if (!confirm(`Are you sure you want to delete ${member.firstName} ${member.lastName}? This action cannot be undone.`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'family_members', memberId));
                loadFamilyMembers(); // Refresh the display
                showMessage('Family member deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting family member:', error);
                showMessage('Error deleting family member: ' + error.message, 'error');
            }
        };

        // Show message function
        window.showMessage = function(message, type = 'success') {
            // Remove any existing message
            const existingMessage = document.querySelector('.floating-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'floating-message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 2000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
            `;
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            // Auto remove after 4 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 4000);
        };

        // Add CSS animation for messages
        if (!document.querySelector('#message-animations')) {
            const style = document.createElement('style');
            style.id = 'message-animations';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Tab switching
        window.switchTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // If switching to relationships tab, initialize the relationship system display
            if (tabName === 'relationships' && relationshipSystem && relationshipUI) {
                initializeRelationshipDisplay();
            }
        };

        // Relationship tab switching
        window.switchRelationshipTab = function(subTabName) {
            // Update sub-tab buttons
            const relationshipTabs = document.querySelectorAll('#relationships .tab');
            relationshipTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-sections
            document.querySelectorAll('.relationship-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            const targetSection = document.getElementById('relationships' + subTabName.charAt(0).toUpperCase() + subTabName.slice(1));
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }

            // Load appropriate content
            if (relationshipSystem && relationshipUI) {
                if (subTabName === 'people') {
                    relationshipUI.displayPeopleTab();
                } else if (subTabName === 'families') {
                    relationshipUI.displayFamiliesTab();
                }
            }
        };

        // Initialize relationship system display when first accessed
        async function initializeRelationshipDisplay() {
            try {
                if (relationshipSystem && relationshipUI) {
                    // Load data for relationship system
                    await relationshipSystem.loadAllData();
                    
                    // Display initial people tab
                    relationshipUI.displayPeopleTab();
                    
                    // Update upcoming birthdays to use new system if it has data
                    if (relationshipSystem.people.length > 0) {
                        relationshipUI.displayUpcomingBirthdays();
                    }
                }
            } catch (error) {
                console.error('Error initializing relationship display:', error);
            }
        }

        // Logout function
        window.logout = function() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        };

        // Initialize the app
        init();
    </script>
</body>
</html>
